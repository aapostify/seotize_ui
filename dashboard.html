<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEOTIZE Dashboard - Manage Your SEO Tasks & Earnings</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
    --bg:#f5f7fa;--sidebar-bg:#ffffff;--card-bg:#ffffff;--text:#1f2937;--text-light:#4b5563;
    --border:#e5e7eb;--primary:#3b82f6;--primary-light:rgba(59,130,246,0.1);--secondary:#10b981;
    --shadow:0 4px 6px rgba(0,0,0,0.05);--radius:0.5rem
}
body.dark{
    --bg:#0f172a;--sidebar-bg:#1f2937;--card-bg:#1f2937;--text:#f9fafb;--text-light:#9ca3af;
    --border:#334155;--primary-light:rgba(59,130,246,0.15)
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);display:flex;height:100vh;overflow:hidden;transition:all .3s}

/* Layout */
.sidebar{width:280px;background:var(--sidebar-bg);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:1.5rem;transform:translateX(-100%);transition:transform .8s ease}
.main{flex:1;display:flex;flex-direction:column;padding:2rem;overflow:hidden}

/* Sidebar */
.logo{font-size:1.75rem;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:2rem;text-decoration:none;display:block}
.nav-links{list-style:none;flex:1}
.nav-links a{display:flex;align-items:center;gap:.75rem;padding:.75rem 1rem;border-radius:var(--radius);text-decoration:none;color:var(--text-light);font-weight:500;transition:all .2s;margin-bottom:.5rem}
.nav-links a:hover{background:var(--primary-light);color:var(--primary);transform:translateX(4px)}
.nav-links a.active{background:var(--primary);color:white;box-shadow:0 5px 15px rgba(59,130,246,0.3)}
.sidebar-footer{margin-top:auto;border-top:1px solid var(--border);padding-top:1.5rem}
.user-profile{display:flex;align-items:center;gap:.75rem;margin-bottom:1rem}
.user-avatar{width:40px;height:40px;border-radius:50%;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-weight:600;text-transform:uppercase}
.user-email{font-size:.875rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.btn{width:100%;padding:.75rem;border:1px solid var(--border);border-radius:var(--radius);background:transparent;font-weight:500;color:var(--text-light);display:flex;align-items:center;justify-content:center;gap:.5rem;cursor:pointer;transition:all .2s;margin-bottom:.5rem}
.btn:hover{border-color:var(--primary);color:var(--primary)}
.btn-primary{background:var(--primary);color:white;border:none;border-radius:var(--radius);padding:.75rem 1.5rem;font-weight:600;display:flex;align-items:center;gap:.5rem;cursor:pointer;transition:all .2s}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(59,130,246,0.3)}

/* Header */
.main-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem}
.main-header h1{font-size:2rem;font-weight:800}

/* Stats Grid */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1.5rem;margin-bottom:2rem}
.stat-card{background:var(--card-bg);padding:1.5rem;border-radius:var(--radius);border:1px solid var(--border);box-shadow:var(--shadow);transition:all .3s}
.stat-card:hover{transform:translateY(-5px) scale(1.03);box-shadow:0 10px 15px rgba(0,0,0,0.1)}
.stat-header{display:flex;align-items:center;gap:.5rem;color:var(--text-light);font-weight:500;margin-bottom:.5rem}
.stat-value{font-size:2rem;font-weight:800}
.stat-desc{font-size:.875rem;color:var(--text-light)}

/* Content Sections */
.section{display:none}
.section.active{display:block}
.card{background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:1.5rem}
.card-header{padding:1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.card-title{font-size:1.125rem;font-weight:600}
.card-body{padding:1.5rem}

/* Tasks */
.tasks{flex:1;background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);display:flex;flex-direction:column;overflow:hidden;margin-bottom:2rem}
.tasks-header{padding:1rem 1.5rem;border-bottom:1px solid var(--border);font-size:1.125rem;font-weight:600}
.tasks-list{flex:1;overflow-y:auto;padding:.5rem}
.task-item{display:grid;grid-template-columns:3fr 1fr 1fr 1fr;align-items:center;padding:1rem 1.5rem;border-radius:var(--radius);margin-bottom:.5rem;transition:background .2s}
.task-item:hover{background:var(--primary-light)}
.task-url{font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.task-stat{text-align:center;color:var(--text-light)}
.progress-bar{width:100%;height:6px;background:var(--border);border-radius:var(--radius);overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--secondary),var(--primary));width:0%;transition:width 1s ease-in-out}

/* Forms */
.form-group{margin-bottom:1.5rem}
.form-label{display:block;margin-bottom:.5rem;font-weight:500;color:var(--text)}
.form-input,.form-select{width:100%;padding:.75rem;border:1px solid var(--border);border-radius:var(--radius);background:var(--card-bg);color:var(--text);transition:border-color .2s}
.form-input:focus,.form-select:focus{outline:none;border-color:var(--primary)}

/* Tables */
.table-container{overflow-x:auto;border-radius:var(--radius);border:1px solid var(--border)}
.table{width:100%;border-collapse:collapse;background:var(--card-bg)}
.table th,.table td{padding:.875rem 1rem;text-align:left;border-bottom:1px solid var(--border)}
.table th{background:var(--primary-light);font-weight:600;font-size:.875rem;color:var(--text-light)}
.table tbody tr:hover{background:var(--primary-light)}

/* Badges */
.badge{display:inline-flex;align-items:center;gap:.25rem;padding:.25rem .75rem;border-radius:20px;font-size:.75rem;font-weight:600}
.badge-success{background:rgba(16,185,129,.1);color:var(--secondary)}
.badge-warning{background:rgba(245,158,11,.1);color:#f59e0b}
.badge-primary{background:var(--primary-light);color:var(--primary)}

/* Sub Cards */
.card-group{display:flex;gap:1.5rem;margin-bottom:2rem}
.sub-card{flex:1;background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;box-shadow:var(--shadow)}
.sub-card h3{margin-bottom:.5rem;font-size:1rem;color:var(--text-light)}
.sub-card p{font-weight:600;margin:.25rem 0}

/* Modal */
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000}
.modal.active{display:flex}
.modal-content{background:var(--card-bg);border-radius:var(--radius);max-width:500px;width:90%;max-height:90vh;overflow-y:auto}
.modal-header{padding:1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.modal-title{font-size:1.25rem;font-weight:700}
.modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-light)}
.modal-body{padding:1.5rem}

/* Loading */
.loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:1000}
.spinner{width:60px;height:60px;border:4px solid var(--border);border-top:4px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

/* Responsive */
@media(max-width:768px){
    .sidebar{transform:translateY(-100%);width:100%;flex-direction:row;justify-content:space-between;padding:1rem}
    .nav-links,.sidebar-footer{display:none}
    .main{padding:1rem}
    .stats-grid{grid-template-columns:1fr 1fr}
    .card-group{flex-direction:column}
    .task-item{grid-template-columns:1fr;text-align:center;gap:.5rem}
}
</style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <a href="#" class="logo">SEOTIZE</a>
        <nav class="nav-links">
            <a href="#" class="active" onclick="showSection('dashboard')"><span>üè†</span> Dashboard</a>
            <a href="#" onclick="showSection('tasks')"><span>üéØ</span> SEO Tasks</a>
            <a href="#" onclick="showSection('partner')"><span>üí∞</span> Partner Jobs</a>
            <a href="#" onclick="showSection('articles')"><span>üìù</span> Articles</a>
            <a href="#" onclick="showSection('images')"><span>üñºÔ∏è</span> Images</a>
            <a href="#" onclick="showSection('hosting')"><span>üåê</span> Hosting</a>
            <a href="#" onclick="showSection('billing')"><span>üí≥</span> Billing</a>
            <a href="#" onclick="showSection('domains')"><span>üîó</span> Domains</a>
        </nav>
        <div class="sidebar-footer">
            <div class="user-profile">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-email" id="userEmail">Loading...</div>
            </div>
            <button class="btn" id="themeToggle"><span>üåô</span> Switch Theme</button>
            <button class="btn" id="logoutBtn"><span>üö™</span> Log Out</button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main">
        <!-- Dashboard Section -->
        <div class="section active" id="dashboard">
            <div class="main-header">
                <h1 id="welcomeMessage">Welcome!</h1>
                <button class="btn-primary" onclick="showSection('tasks')"><span>‚ûï</span> Add New Task</button>
            </div>

            <!-- Stats Cards -->
            <section class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header"><span>üëÄ</span>Total Views</div>
                    <div class="stat-value" id="statTotalViews">0</div>
                    <div class="stat-desc">Across all tasks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><span>üîë</span>Total Keywords</div>
                    <div class="stat-value" id="statTotalKeywords">0</div>
                    <div class="stat-desc">Driving your traffic</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><span>‚ö°Ô∏è</span>Total Charge</div>
                    <div class="stat-value" id="statTotalCharge">$0</div>
                    <div class="stat-desc">Total task value</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><span>üîã</span>Available Charge</div>
                    <div class="stat-value" id="statAvailableCharge">$0</div>
                    <div class="stat-desc">Remaining credits</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><span>üí∞</span>Partner Balance</div>
                    <div class="stat-value" id="statPartnerBalance">$0</div>
                    <div class="stat-desc">Available to withdraw</div>
                </div>
            </section>

            <!-- Active Tasks -->
            <section class="tasks">
                <div class="tasks-header">Your Active Tasks</div>
                <div class="tasks-list" id="tasksList">
                    <p style="text-align:center; color:var(--text-light); padding:2rem;">
                        Loading tasks...
                    </p>
                </div>
            </section>

            <!-- Hosting & Partner Stats -->
            <div class="card-group">
                <div class="sub-card">
                    <h3>Articles Uploaded</h3>
                    <p id="hostArticles">‚Äî</p>
                </div>
                <div class="sub-card">
                    <h3>Images Uploaded</h3>
                    <p id="hostImages">‚Äî</p>
                </div>
                <div class="sub-card">
                    <h3>Hosting Plan</h3>
                    <p id="hostPlan">‚Äî</p>
                    <small>Expires <span id="hostExpiry">‚Äî</span></small>
                </div>
                <div class="sub-card">
                    <h3>Partner Earnings</h3>
                    <p id="partnerEarnings">$0</p>
                    <small><span id="partnerTasks">0</span> tasks completed</small>
                </div>
            </div>
        </div>

        <!-- Tasks Section -->
        <div class="section" id="tasks">
            <div class="main-header">
                <h1>SEO Tasks</h1>
                <button class="btn-primary" onclick="showTaskForm()"><span>‚ûï</span> Create Task</button>
            </div>

            <div class="card" id="taskFormCard" style="display:none">
                <div class="card-header">
                    <h3 class="card-title">Create New Task</h3>
                    <button onclick="hideTaskForm()" style="background:none;border:none;font-size:1.2rem;cursor:pointer">√ó</button>
                </div>
                <div class="card-body">
                    <form id="taskForm">
                        <div class="form-group">
                            <label class="form-label">Website URL</label>
                            <input type="url" class="form-input" id="taskUrl" placeholder="https://example.com" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Keywords (comma separated)</label>
                            <input type="text" class="form-input" id="taskKeywords" placeholder="SEO, marketing, optimization" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Task Priority</label>
                            <select class="form-select" id="taskPriority">
                                <option value="basic">Basic ($0.10/click)</option>
                                <option value="standard" selected>Standard ($0.12/click)</option>
                                <option value="premium">Premium ($0.15/click)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Total Budget ($)</label>
                            <input type="number" class="form-input" id="taskCharge" min="10" value="150" required>
                        </div>
                        <button type="submit" class="btn-primary">Create Task</button>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Your Tasks</h3>
                    <button class="btn" onclick="loadTasks()">Refresh</button>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>URL</th>
                                    <th>Keywords</th>
                                    <th>Views</th>
                                    <th>Budget</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tasksTable">
                                <tr><td colspan="6">Loading tasks...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Partner Section -->
        <div class="section" id="partner">
            <div class="main-header">
                <h1>Partner Jobs</h1>
                <button class="btn-primary" onclick="loadPartnerTasks()"><span>üîÑ</span> Refresh Jobs</button>
            </div>

            <div class="stats-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:2rem">
                <div class="stat-card">
                    <div class="stat-header"><span>üí∞</span>Current Balance</div>
                    <div class="stat-value" id="partnerCurrentBalance">$0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><span>üìà</span>Total Earned</div>
                    <div class="stat-value" id="partnerTotalEarned">$0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><span>‚úÖ</span>Tasks Done</div>
                    <div class="stat-value" id="partnerTasksDone">0</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Available Partner Tasks</h3>
                </div>
                <div class="card-body">
                    <div id="partnerTasks">Loading available tasks...</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Withdraw Earnings</h3>
                </div>
                <div class="card-body">
                    <form id="withdrawForm">
                        <div class="form-group">
                            <label class="form-label">Amount ($)</label>
                            <input type="number" class="form-input" id="withdrawAmount" min="1" step="0.01" placeholder="Enter amount">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Crypto Wallet Address</label>
                            <input type="text" class="form-input" id="withdrawAddress" placeholder="0x...">
                        </div>
                        <button type="submit" class="btn-primary">Request Withdrawal</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Other sections (Articles, Images, etc.) -->
        <div class="section" id="articles">
            <div class="main-header">
                <h1>Articles</h1>
            </div>
            <div class="card">
                <div class="card-body">
                    <p>Article management coming soon...</p>
                </div>
            </div>
        </div>

        <div class="section" id="images">
            <div class="main-header">
                <h1>Images</h1>
            </div>
            <div class="card">
                <div class="card-body">
                    <p>Image management coming soon...</p>
                </div>
            </div>
        </div>

        <div class="section" id="hosting">
            <div class="main-header">
                <h1>Hosting</h1>
            </div>
            <div class="card">
                <div class="card-body">
                    <p>Hosting management coming soon...</p>
                </div>
            </div>
        </div>

        <div class="section" id="billing">
            <div class="main-header">
                <h1>Billing</h1>
            </div>
            <div class="card">
                <div class="card-body">
                    <p>Billing management coming soon...</p>
                </div>
            </div>
        </div>

        <div class="section" id="domains">
            <div class="main-header">
                <h1>Domains</h1>
            </div>
            <div class="card">
                <div class="card-body">
                    <p>Domain management coming soon...</p>
                </div>
            </div>
        </div>
    </main>

<script>
const baseUrl = 'https://api.seotize.net';
let currentUser = null;
let isPartner = false;

document.addEventListener('DOMContentLoaded', () => {
    const token = getCookie('session_token');
    if (!token) {
        window.location.href = 'login.html';
        return;
    }

    loadTheme();
    setupListeners();

    // Load dashboard data
    Promise.all([
        fetchDashboard(token),
        fetchPartnerDashboard(token)
    ]).then(([userDash, partnerDash]) => {
        if (userDash) {
            currentUser = userDash;
            populateDashboard(userDash);
        }
        if (partnerDash) {
            isPartner = true;
            populatePartnerData(partnerDash);
        }
    }).catch(e => {
        console.error('Dashboard error:', e);
    }).finally(() => {
        runAnimations();
    });
});

// Cookie helper function (matching your working version)
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    return parts.length === 2 ? parts.pop().split(';').shift() : '';
}

// API calls with proper cookie-based token handling
async function fetchDashboard(token) {
    try {
        const res = await fetch(`${baseUrl}/users/dashboard?page=1&page_size=10`, {
            headers: { 'Session-Token': token }
        });
        if (!res.ok) throw new Error(res.statusText);
        const { data } = await res.json();
        return data.user;
    } catch (e) {
        console.error('Failed to fetch dashboard:', e);
        return null;
    }
}

async function fetchPartnerDashboard(token) {
    try {
        const res = await fetch(`${baseUrl}/partner/dashboard`, {
            headers: { 'Session-Token': token }
        });
        if (!res.ok) return null;
        const { data } = await res.json();
        return data;
    } catch (e) {
        console.error('Failed to fetch partner dashboard:', e);
        return null;
    }
}

// Populate dashboard with user data
function populateDashboard(user) {
    const email = user.email;
    document.getElementById('userEmail').textContent = email;
    document.getElementById('userAvatar').textContent = email[0].toUpperCase();
    document.getElementById('welcomeMessage').textContent = `Welcome, ${email.split('@')[0]}!`;

    // Animate stats
    animateStat('statTotalViews', user.task_statistics?.total_views || 0);
    animateStat('statTotalKeywords', user.task_statistics?.total_keywords || 0);
    animateStat('statTotalCharge', user.task_statistics?.total_charge || 0);
    animateStat('statAvailableCharge', user.task_statistics?.available_charge || 0);

    // Populate hosting info
    if (user.hosting) {
        document.getElementById('hostArticles').textContent = user.hosting.article_uploads || 0;
        document.getElementById('hostImages').textContent = user.hosting.images_uploads || 0;
        document.getElementById('hostPlan').textContent = user.hosting.type || 'Free';
        if (user.hosting.expiry_date) {
            document.getElementById('hostExpiry').textContent = new Date(user.hosting.expiry_date).toLocaleDateString();
        }
    }

    // Populate tasks list
    populateTasksList(user.tasks || []);
}

function populatePartnerData(partner) {
    if (partner.user) {
        animateStat('statPartnerBalance', partner.user.credit || 0);
        document.getElementById('partnerCurrentBalance').textContent = `$${partner.user.credit || 0}`;
        document.getElementById('partnerEarnings').textContent = `$${partner.user.credit || 0}`;
    }

    // Load partner balance details
    loadPartnerBalance();
}

function populateTasksList(tasks) {
    const list = document.getElementById('tasksList');
    list.innerHTML = '';

    if (tasks.length) {
        tasks.forEach(task => {
            const div = document.createElement('div');
            div.className = 'task-item';
            div.innerHTML = `
                <div class="task-url">${task.url}</div>
                <div class="task-stat"><strong>${task.views_count || 0}</strong> views</div>
                <div class="task-stat"><strong>${task.keywords_count || 0}</strong> kw</div>
                <div class="task-stat">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width:${task.remaining_percentage || 0}%"></div>
                    </div>
                </div>
            `;
            list.appendChild(div);
        });
    } else {
        list.innerHTML = `
            <p style="text-align:center; color:var(--text-light); padding:2rem;">
                No active tasks. Click "Add New Task" to get started!
            </p>
        `;
    }
}

// Load partner balance details
async function loadPartnerBalance() {
    const token = getCookie('session_token');
    try {
        const res = await fetch(`${baseUrl}/partner/balance-management`, {
            headers: { 'Session-Token': token }
        });
        if (!res.ok) return;
        const { data } = await res.json();

        document.getElementById('partnerTotalEarned').textContent = `$${data.total_earn || 0}`;
        document.getElementById('partnerTasksDone').textContent = data.number_of_done_tasks || 0;
        document.getElementById('partnerTasks').textContent = data.number_of_done_tasks || 0;
    } catch (e) {
        console.error('Failed to load partner balance:', e);
    }
}

// Load partner tasks
async function loadPartnerTasks() {
    const token = getCookie('session_token');
    try {
        const res = await fetch(`${baseUrl}/partner/dashboard`, {
            headers: { 'Session-Token': token }
        });
        if (!res.ok) return;
        const { data } = await res.json();

        renderPartnerTasks(data.tasks || []);
    } catch (e) {
        console.error('Failed to load partner tasks:', e);
    }
}

function renderPartnerTasks(tasks) {
    const container = document.getElementById('partnerTasks');
    if (!Array.isArray(tasks) || !tasks.length) {
        container.innerHTML = '<p>No partner tasks available right now. Check back later!</p>';
        return;
    }

    container.innerHTML = tasks.map(task => `
        <div class="card" style="margin-bottom:1rem">
            <div class="card-body">
                <h4>${task.url}</h4>
                <p><strong>Keywords:</strong> ${task.keywords?.join(', ') || 'N/A'}</p>
                <p><strong>Priority:</strong> $${task.task_priority || 0.12} per click</p>
                <div style="display:flex;gap:1rem;margin-top:1rem">
                    ${task.active ?
                        `<button class="btn-primary" onclick="startPartnerTask('${task._id}')">Start Task</button>` :
                        `<span class="badge badge-warning">Cooldown: ${task.remaining_time || 0}min</span>`
                   }
               </div>
           </div>
       </div>
   `).join('');
}

// Start partner task
async function startPartnerTask(taskId) {
   const token = getCookie('session_token');
   const uniqueId = Date.now().toString();

   try {
       const res = await fetch(`${baseUrl}/allocate-partner-task`, {
           method: 'POST',
           headers: {
               'Content-Type': 'application/json',
               'Session-Token': token
           },
           body: JSON.stringify({
               user_task_id: taskId,
               unique_id: uniqueId
           })
       });

       const result = await res.json();
       if (result.status === 'success') {
           alert(`Task started! Please complete the task and return within the time limit.`);
           loadPartnerTasks(); // Refresh tasks
       } else {
           alert(result.error?.message || 'Failed to start task');
       }
   } catch (e) {
       console.error('Failed to start partner task:', e);
       alert('Network error occurred');
   }
}

// Load tasks for tasks section
async function loadTasks() {
   const token = getCookie('session_token');
   try {
       const res = await fetch(`${baseUrl}/users/dashboard`, {
           headers: { 'Session-Token': token }
       });
       if (!res.ok) return;
       const { data } = await res.json();

       renderTasksTable(data.user.tasks || []);
   } catch (e) {
       console.error('Failed to load tasks:', e);
   }
}

function renderTasksTable(tasks) {
   const tbody = document.getElementById('tasksTable');
   if (!tasks.length) {
       tbody.innerHTML = '<tr><td colspan="6">No tasks found</td></tr>';
       return;
   }

   tbody.innerHTML = tasks.map(task => `
       <tr>
           <td>${task.url}</td>
           <td>${task.keywords_count || 0} keywords</td>
           <td>${task.views_count || 0}</td>
           <td>$${task.total_charge || 0}</td>
           <td><span class="badge badge-${task.remaining_percentage > 0 ? 'success' : 'warning'}">${task.remaining_percentage > 0 ? 'Active' : 'Completed'}</span></td>
           <td>
               <button class="btn" onclick="viewTask('${task._id}')">View</button>
               <button class="btn-primary" onclick="rechargeTask('${task._id}')">Recharge</button>
           </td>
       </tr>
   `).join('');
}

// Task form submission
document.addEventListener('DOMContentLoaded', () => {
   const taskForm = document.getElementById('taskForm');
   if (taskForm) {
       taskForm.addEventListener('submit', async (e) => {
           e.preventDefault();
           const token = getCookie('session_token');

           const formData = {
               task_details: {
                   url: document.getElementById('taskUrl').value,
                   keywords: document.getElementById('taskKeywords').value.split(',').map(k => k.trim()),
                   html_locations: ['/html/body//a'] // Default location
               },
               task_priority: document.getElementById('taskPriority').value,
               total_charge: parseInt(document.getElementById('taskCharge').value),
               provider: 'stripe',
               is_subscription: false,
               cancel_previous: false
           };

           try {
               const res = await fetch(`${baseUrl}/add-task`, {
                   method: 'POST',
                   headers: {
                       'Content-Type': 'application/json',
                       'Session-Token': token
                   },
                   body: JSON.stringify(formData)
               });

               const result = await res.json();
               if (result.status === 'success') {
                   alert('Task created! Redirecting to payment...');
                   window.open(result.data.payment_url, '_blank');
                   hideTaskForm();
                   taskForm.reset();
                   loadTasks();
               } else {
                   alert(result.error?.message || 'Failed to create task');
               }
           } catch (e) {
               console.error('Failed to create task:', e);
               alert('Network error occurred');
           }
       });
   }

   // Withdrawal form
   const withdrawForm = document.getElementById('withdrawForm');
   if (withdrawForm) {
       withdrawForm.addEventListener('submit', async (e) => {
           e.preventDefault();
           const token = getCookie('session_token');

           try {
               const res = await fetch(`${baseUrl}/partner/withdraw`, {
                   method: 'POST',
                   headers: {
                       'Content-Type': 'application/json',
                       'Session-Token': token
                   },
                   body: JSON.stringify({
                       amount: parseFloat(document.getElementById('withdrawAmount').value),
                       address: document.getElementById('withdrawAddress').value
                   })
               });

               const result = await res.json();
               if (result.status === 'success') {
                   alert('Withdrawal request submitted successfully!');
                   withdrawForm.reset();
                   loadPartnerBalance();
               } else {
                   alert(result.error?.message || 'Failed to process withdrawal');
               }
           } catch (e) {
               console.error('Failed to process withdrawal:', e);
               alert('Network error occurred');
           }
       });
   }
});

// Navigation functions
function showSection(sectionId) {
   // Remove active class from all sections and nav links
   document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
   document.querySelectorAll('.nav-links a').forEach(n => n.classList.remove('active'));

   // Show selected section and mark nav as active
   document.getElementById(sectionId).classList.add('active');
   document.querySelector(`[onclick="showSection('${sectionId}')"]`).classList.add('active');

   // Load section-specific data
   if (sectionId === 'tasks') loadTasks();
   if (sectionId === 'partner') loadPartnerTasks();
}

// Task form helpers
function showTaskForm() {
   document.getElementById('taskFormCard').style.display = 'block';
}

function hideTaskForm() {
   document.getElementById('taskFormCard').style.display = 'none';
}

// View task details
async function viewTask(taskId) {
   const token = getCookie('session_token');
   try {
       const res = await fetch(`${baseUrl}/get-task-details`, {
           method: 'POST',
           headers: {
               'Content-Type': 'application/json',
               'Session-Token': token
           },
           body: JSON.stringify({ task_id: taskId })
       });

       const result = await res.json();
       if (result.status === 'success') {
           const task = result.data;
           alert(`Task Details:
URL: ${task.url}
Keywords: ${task.keywords?.join(', ') || 'N/A'}
Total Charge: $${task.total_charge}
Available Charge: $${task.available_charge}
Created: ${task.date_created}`);
       } else {
           alert('Failed to load task details');
       }
   } catch (e) {
       console.error('Failed to view task:', e);
       alert('Network error occurred');
   }
}

// Recharge task
async function rechargeTask(taskId) {
   const amount = prompt('Enter recharge amount ($):');
   if (!amount || isNaN(amount)) return;

   const token = getCookie('session_token');
   try {
       const res = await fetch(`${baseUrl}/recharge`, {
           method: 'POST',
           headers: {
               'Content-Type': 'application/json',
               'Session-Token': token
           },
           body: JSON.stringify({
               task_ids: [taskId],
               payment_method: 'stripe',
               cancel_previous: false
           })
       });

       const result = await res.json();
       if (result.status === 'success') {
           alert('Redirecting to payment...');
           window.open(result.data.payment_url, '_blank');
       } else {
           alert(result.error?.message || 'Failed to create recharge');
       }
   } catch (e) {
       console.error('Failed to recharge task:', e);
       alert('Network error occurred');
   }
}

// Animation helper
function animateStat(id, value) {
   const element = document.getElementById(id);
   if (!element) return;

   // Format value appropriately
   let formattedValue = value;
   if (id.includes('Charge') || id.includes('Balance') || id.includes('Earned')) {
       formattedValue = `$${value}`;
   }

   gsap.to(element, {
       duration: 1.5,
       textContent: formattedValue,
       ease: 'power2.inOut'
   });
}

// Setup event listeners
function setupListeners() {
   document.getElementById('themeToggle').onclick = toggleTheme;
   document.getElementById('logoutBtn').onclick = logout;
}

// Theme management
function toggleTheme() {
   document.body.classList.toggle('dark');
   localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
}

function loadTheme() {
   if (localStorage.getItem('theme') === 'dark') {
       document.body.classList.add('dark');
   }
}

// Logout function (matching your working version)
function logout() {
   const token = getCookie('session_token');
   if (token) {
       fetch(`${baseUrl}/logout`, {
           headers: { 'Session-Token': token }
       }).catch(e => console.error('Logout error:', e));
   }

   // Clear cookie
   document.cookie = 'session_token=;path=/;expires=Thu, 01 Jan 1970 00:00:00 GMT';
   window.location.href = 'login.html';
}

// Animation runner
function runAnimations() {
   const overlay = document.getElementById('loadingOverlay');
   gsap.timeline({ defaults: { ease: 'power3.out' } })
       .to('.sidebar', { x: '0%', duration: 0.8, delay: 0.2 })
       .from(
           '.main-header, .stat-card, .tasks-header',
           { opacity: 0, y: 30, duration: 0.6, stagger: 0.1 },
           '-=0.5'
       )
       .to(overlay, {
           opacity: 0,
           duration: 0.5,
           onComplete: () => (overlay.style.display = 'none')
       });
}

// Auto-refresh partner data if user is a partner
setInterval(() => {
   if (isPartner && document.getElementById('partner').classList.contains('active')) {
       loadPartnerTasks();
   }
}, 30000); // Refresh every 30 seconds

// Load initial tasks when tasks section is shown
document.addEventListener('DOMContentLoaded', () => {
   // Load tasks initially
   setTimeout(() => {
       if (currentUser && currentUser.tasks) {
           renderTasksTable(currentUser.tasks);
       }
   }, 1000);
});
</script>
</body>
</html>
