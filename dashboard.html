<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEOTIZE Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
    --bg:#0f172a;--sidebar:#1e293b;--card:#1e293b;--text:#e2e8f0;--text-light:#94a3b8;
    --border:#334155;--primary:#3b82f6;--primary-hover:#2563eb;--secondary:#10b981;
    --error:#ef4444;--warning:#f59e0b;--success:#10b981;--radius:12px;
    --shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06)
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);display:flex;height:100vh;overflow:hidden}

/* Layout */
.sidebar{width:260px;background:var(--sidebar);padding:1.5rem;display:flex;flex-direction:column;border-right:1px solid var(--border)}
.main{flex:1;overflow-y:auto;padding:2rem}

/* Components */
.logo{font-size:1.5rem;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:2rem}
.nav-item{display:flex;align-items:center;gap:.75rem;padding:.875rem 1rem;border-radius:var(--radius);color:var(--text-light);font-weight:500;transition:all .2s;margin-bottom:.5rem;cursor:pointer}
.nav-item:hover{background:rgba(59,130,246,0.1);color:var(--primary)}
.nav-item.active{background:var(--primary);color:white}

.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:1.5rem}
.card-header{padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.card-body{padding:1.5rem}

.btn{padding:.5rem 1rem;border-radius:var(--radius);font-weight:500;cursor:pointer;transition:all .2s;border:1px solid var(--border);background:transparent;color:var(--text)}
.btn:hover{border-color:var(--primary);color:var(--primary)}
.btn-primary{background:var(--primary);color:white;border:none}
.btn-primary:hover{background:var(--primary-hover)}
.btn-sm{padding:.375rem .75rem;font-size:.875rem}

.stat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1rem;margin-bottom:1.5rem}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem}
.stat-value{font-size:1.75rem;font-weight:700;margin:.5rem 0}
.stat-label{font-size:.875rem;color:var(--text-light)}

.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:.875rem;text-align:left;border-bottom:1px solid var(--border)}
.table th{font-weight:600;color:var(--text-light);font-size:.875rem}

.badge{padding:.25rem .75rem;border-radius:20px;font-size:.75rem;font-weight:600;display:inline-flex;align-items:center;gap:.25rem}
.badge-primary{background:rgba(59,130,246,0.2);color:var(--primary)}
.badge-success{background:rgba(16,185,129,0.2);color:var(--success)}
.badge-warning{background:rgba(245,158,11,0.2);color:var(--warning)}
.badge-error{background:rgba(239,68,68,0.2);color:var(--error)}

.progress-bar{height:6px;background:var(--border);border-radius:3px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--secondary),var(--primary));transition:width .3s}

.modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1000}
.modal.show{display:flex}
.modal-content{background:var(--card);border-radius:var(--radius);max-width:600px;width:90%;max-height:90vh;overflow-y:auto}
.modal-header{padding:1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.modal-body{padding:1.5rem}

.form-group{margin-bottom:1.25rem}
.form-label{display:block;margin-bottom:.5rem;font-weight:500;font-size:.875rem}
.form-input,.form-select{width:100%;padding:.75rem;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg);color:var(--text)}
.form-input:focus,.form-select:focus{outline:none;border-color:var(--primary)}

.toast{position:fixed;bottom:2rem;right:2rem;padding:1rem 1.5rem;border-radius:var(--radius);color:white;font-weight:500;transform:translateX(400px);transition:transform .3s;z-index:1000}
.toast.show{transform:translateX(0)}
.toast.success{background:var(--success)}
.toast.error{background:var(--error)}
.toast.warning{background:var(--warning)}

.pagination{display:flex;align-items:center;gap:1rem;margin-top:1.5rem}
.pagination button{padding:.5rem 1rem;border-radius:var(--radius);border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer}
.pagination button:hover:not(:disabled){border-color:var(--primary);color:var(--primary)}
.pagination button:disabled{opacity:0.5;cursor:not-allowed}

.section{display:none}
.section.active{display:block}

.loader{display:inline-block;width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

.empty-state{text-align:center;padding:3rem;color:var(--text-light)}
.empty-state svg{width:64px;height:64px;margin:0 auto 1rem;opacity:0.3}

/* Specific Styles */
.task-item{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem;margin-bottom:1rem;cursor:pointer;transition:all .2s}
.task-item:hover{border-color:var(--primary);transform:translateY(-2px)}

.image-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1rem}
.image-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;transition:all .2s}
.image-card:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
.image-preview{height:150px;background:#000;display:flex;align-items:center;justify-content:center;overflow:hidden}
.image-preview img{width:100%;height:100%;object-fit:cover}
.image-info{padding:1rem}

.article-item{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem;margin-bottom:1rem;transition:all .2s}
.article-item:hover{border-color:var(--primary);transform:translateY(-2px)}

.domain-item{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid var(--border)}
.domain-item:last-child{border-bottom:none}

.chart-container{height:300px;position:relative}

@media(max-width:768px){
    .sidebar{transform:translateX(-100%);position:fixed;z-index:100}
    .main{padding:1rem}
    .stat-grid{grid-template-columns:1fr 1fr}
    .image-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}
}
</style>
</head>
<body>
    <aside class="sidebar">
        <div class="logo">SEOTIZE</div>
        <nav>
            <div class="nav-item active" data-section="dashboard">
                <span>üìä</span> Dashboard
            </div>
            <div class="nav-item" data-section="tasks">
                <span>üéØ</span> SEO Tasks
            </div>
            <div class="nav-item" data-section="hosting">
                <span>üåê</span> Hosting
            </div>
            <div class="nav-item" data-section="images">
                <span>üñºÔ∏è</span> Images
            </div>
            <div class="nav-item" data-section="articles">
                <span>üìù</span> Articles
            </div>
            <div class="nav-item" data-section="domains">
                <span>üîó</span> Domains
            </div>
            <div class="nav-item" data-section="billing">
                <span>üí≥</span> Billing
            </div>
        </nav>
        <div style="margin-top:auto;padding-top:1.5rem;border-top:1px solid var(--border)">
            <div style="display:flex;align-items:center;gap:.75rem;margin-bottom:1rem">
                <div style="width:40px;height:40px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;font-weight:600" id="userAvatar">U</div>
                <div id="userEmail" style="font-size:.875rem;color:var(--text-light)">Loading...</div>
            </div>
            <button class="btn" style="width:100%" onclick="logout()">Logout</button>
        </div>
    </aside>

    <main class="main">
        <!-- Dashboard Section -->
        <section class="section active" id="dashboard">
            <h1 style="margin-bottom:1.5rem">Dashboard Overview</h1>

            <div class="stat-grid" id="dashboardStats">
                <div class="stat-card">
                    <div class="stat-label">Active Tasks</div>
                    <div class="stat-value">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Views</div>
                    <div class="stat-value">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Keywords</div>
                    <div class="stat-value">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Spent</div>
                    <div class="stat-value">$0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Available Budget</div>
                    <div class="stat-value">$0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Hosting Plan</div>
                    <div class="stat-value">Free</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Recent Tasks</h3>
                    <button class="btn btn-sm" onclick="showSection('tasks')">View All</button>
                </div>
                <div class="card-body" id="recentTasks">
                    <div class="loader"></div>
                </div>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem">
                <div class="card">
                    <div class="card-header">
                        <h3>Views by Country</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="countryChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Daily Views Trend</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tasks Section -->
        <section class="section" id="tasks">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
                <h1>SEO Tasks</h1>
                <button class="btn btn-primary" onclick="showTaskModal()">Create New Task</button>
            </div>

            <div class="stat-grid" id="taskStats"></div>

            <div class="card">
                <div class="card-header">
                    <h3>Active Tasks</h3>
                    <div style="display:flex;gap:.5rem">
                        <button class="btn btn-sm" onclick="loadTasks(1)">Refresh</button>
                    </div>
                </div>
                <div class="card-body" id="tasksList">
                    <div class="loader"></div>
                </div>
            </div>

            <div class="card" style="display:none" id="taskAnalytics">
                <div class="card-header">
                    <h3>Task Analytics</h3>
                </div>
                <div class="card-body" id="taskAnalyticsContent"></div>
            </div>
        </section>

        <!-- Hosting Section -->
        <section class="section" id="hosting">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
                <h1>Hosting Management</h1>
                <button class="btn btn-primary" onclick="showHostingModal()">Upgrade Plan</button>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Current Plan Status</h3>
                </div>
                <div class="card-body" id="hostingStatus">
                    <div class="loader"></div>
                </div>
            </div>
        </section>

        <!-- Images Section -->
        <section class="section" id="images">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
                <h1>Image Management</h1>
                <button class="btn btn-primary" onclick="showImageUploadModal()">Upload Images</button>
            </div>

            <div class="stat-grid" id="imageStats"></div>

            <div class="card">
                <div class="card-body">
                    <div class="image-grid" id="imageGrid">
                        <div class="loader"></div>
                    </div>
                    <div class="pagination" id="imagePagination"></div>
                </div>
            </div>
        </section>

        <!-- Articles Section -->
        <section class="section" id="articles">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
                <h1>Article Management</h1>
                <button class="btn btn-primary" onclick="showArticleModal()">Create Article</button>
            </div>

            <div class="stat-grid" id="articleStats"></div>

            <div class="card">
                <div class="card-body" id="articlesList">
                    <div class="loader"></div>
                </div>
            </div>
        </section>

        <!-- Domains Section -->
        <section class="section" id="domains">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
                <h1>Domain Management</h1>
                <button class="btn btn-primary" onclick="showDomainModal()">Add Domain</button>
            </div>

            <div class="card">
                <div class="card-body" id="domainsList">
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                        </svg>
                        <p>No domains added yet</p>
                        <p style="font-size:.875rem;margin-top:.5rem">Add your first domain to start publishing articles</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Billing Section -->
        <section class="section" id="billing">
            <h1 style="margin-bottom:1.5rem">Billing & Payments</h1>

            <div class="stat-grid" id="billingStats"></div>

            <div class="card">
                <div class="card-header">
                    <h3>Payment History</h3>
                </div>
                <div class="card-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="billingTable">
                            <tr><td colspan="6" style="text-align:center"><div class="loader"></div></td></tr>
                        </tbody>
                    </table>
                    <div class="pagination" id="billingPagination"></div>
                </div>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem">
                <div class="card">
                    <div class="card-header">
                        <h3>Spending Trend</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="spendingChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Payment Methods</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="methodChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modals -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Modal</h3>
                <button onclick="closeModal()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-light)">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast" id="toast"></div>

<script>
const API_BASE = 'https://api.seotize.net';
let sessionToken = getCookie('session_token');
let currentSection = 'dashboard';
let charts = {};
let currentData = {};

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    if (!sessionToken) {
        window.location.href = '/login.html';
        return;
    }

    setupNavigation();
    loadDashboard();
});

// Navigation
function setupNavigation() {
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
            const section = item.dataset.section;
            showSection(section);
        });
    });
}

function showSection(section) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

    document.getElementById(section).classList.add('active');
    document.querySelector(`[data-section="${section}"]`).classList.add('active');

    currentSection = section;

    // Load section data
    switch(section) {
        case 'dashboard': loadDashboard(); break;
        case 'tasks': loadTasks(); break;
        case 'hosting': loadHosting(); break;
        case 'images': loadImages(); break;
        case 'articles': loadArticles(); break;
        case 'domains': loadDomains(); break;
        case 'billing': loadBilling(); break;
    }
}

// API Helper
async function api(endpoint, options = {}) {
    try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
            ...options,
            headers: {
                'Session-Token': sessionToken,
                ...(options.headers || {})
            }
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error?.message || 'API Error');
        }

        return data;
    } catch (error) {
        showToast(error.message, 'error');
        throw error;
    }
}

// Dashboard
async function loadDashboard() {
    try {
        const { data } = await api('/users/dashboard?page=1&page_size=5');
        const user = data.user;

        // Update user info
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('userAvatar').textContent = user.email[0].toUpperCase();

        // Update stats
        const stats = [
            { label: 'Active Tasks', value: user.usage_summary?.active_tasks || 0 },
            { label: 'Total Views', value: user.task_statistics?.total_views || 0 },
            { label: 'Total Keywords', value: user.task_statistics?.total_keywords || 0 },
            { label: 'Total Spent', value: `$${user.task_statistics?.total_charge || 0}` },
            { label: 'Available Budget', value: `$${user.task_statistics?.available_charge || 0}` },
            { label: 'Hosting Plan', value: (user.hosting?.type || 'free').toUpperCase() }
        ];

        document.getElementById('dashboardStats').innerHTML = stats.map(stat => `
            <div class="stat-card">
                <div class="stat-label">${stat.label}</div>
                <div class="stat-value">${stat.value}</div>
            </div>
        `).join('');

        // Recent tasks
        const tasks = user.tasks || [];
        document.getElementById('recentTasks').innerHTML = tasks.length ? tasks.slice(0, 5).map(task => `
            <div class="task-item" onclick="viewTask('${task._id}')">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div>
                        <div style="font-weight:600">${task.url}</div>
                        <div style="font-size:.875rem;color:var(--text-light);margin-top:.25rem">
                            ${task.keywords_count} keywords ‚Ä¢ ${task.views_count} views
                        </div>
                    </div>
                    <div style="text-align:right">
                        <div class="progress-bar" style="width:100px;margin-bottom:.5rem">
                            <div class="progress-fill" style="width:${task.remaining_percentage}%"></div>
                        </div>
                        <div style="font-size:.75rem;color:var(--text-light)">${task.remaining_percentage}% remaining</div>
                    </div>
                </div>
            </div>
        `).join('') : '<div class="empty-state"><p>No active tasks</p></div>';

        // Create charts
        createDashboardCharts(user);

    } catch (error) {
        console.error('Dashboard error:', error);
    }
}

function createDashboardCharts(user) {
    // Country chart
    const countryData = {};
    user.tasks?.forEach(task => {
        if (task.country_visits) {
            Object.entries(task.country_visits).forEach(([country, visits]) => {
                countryData[country] = (countryData[country] || 0) + visits;
            });
        }
    });

    if (charts.country) charts.country.destroy();
    const ctx1 = document.getElementById('countryChart').getContext('2d');
    charts.country = new Chart(ctx1, {
        type: 'doughnut',
        data: {
            labels: Object.keys(countryData),
            datasets: [{
                data: Object.values(countryData),
                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Trend chart
    const trendData = {};
    user.tasks?.forEach(task => {
        if (task.views_by_date) {
            Object.entries(task.views_by_date).forEach(([date, views]) => {
                trendData[date] = (trendData[date] || 0) + views;
            });
        }
    });

    if (charts.trend) charts.trend.destroy();
    const ctx2 = document.getElementById('trendChart').getContext('2d');
    charts.trend = new Chart(ctx2, {
        type: 'line',
        data: {
            labels: Object.keys(trendData).sort(),
            datasets: [{
                label: 'Views',
                data: Object.keys(trendData).sort().map(date => trendData[date]),
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// Tasks
async function loadTasks(page = 1) {
    try {
        const { data } = await api(`/users/dashboard?page=${page}&page_size=10`);
        const user = data.user;
        currentData.tasks = user.tasks || [];

        // Task stats
        document.getElementById('taskStats').innerHTML = `
            <div class="stat-card">
                <div class="stat-label">Total Tasks</div>
                <div class="stat-value">${user.usage_summary?.total_tasks || 0}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Active Tasks</div>
                <div class="stat-value">${user.usage_summary?.active_tasks || 0}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Completed Tasks</div>
                <div class="stat-value">${user.usage_summary?.completed_tasks || 0}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Views</div>
                <div class="stat-value">${user.task_statistics?.total_views || 0}</div>
            </div>
        `;

        // Task list
        const tasksList = document.getElementById('tasksList');
        if (currentData.tasks.length) {
            tasksList.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>URL</th>
                            <th>Keywords</th>
                            <th>Views</th>
                            <th>Budget</th>
                            <th>Progress</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${currentData.tasks.map(task => `
                            <tr onclick="viewTask('${task._id}')" style="cursor:pointer">
                                <td>${task.url}</td>
                                <td>${task.keywords_count}</td>
                                <td>${task.views_count}</td>
                                <td>$${task.total_charge}</td>
                                <td>
                                    <div class="progress-bar" style="width:100px">
                                        <div class="progress-fill" style="width:${task.remaining_percentage}%"></div>
                                    </div>
                                </td>
                                <td onclick="event.stopPropagation()">
                                    <button class="btn btn-sm" onclick="rechargeTask('${task._id}')">Recharge</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            // Show analytics for first task
            if (currentData.tasks[0]) {
                showTaskAnalytics(currentData.tasks[0]);
            }
        } else {
            tasksList.innerHTML = '<div class="empty-state"><p>No tasks found</p></div>';
        }

    } catch (error) {
        console.error('Tasks error:', error);
    }
}

async function viewTask(taskId) {
   try {
       const { data } = await api('/get-task-details', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({ task_id: taskId })
       });

       showModal('Task Details', `
           <div class="stat-grid" style="margin-bottom:1.5rem">
               <div class="stat-card">
                   <div class="stat-label">Total Budget</div>
                   <div class="stat-value">$${data.total_charge}</div>
               </div>
               <div class="stat-card">
                   <div class="stat-label">Remaining</div>
                   <div class="stat-value">$${data.available_charge}</div>
               </div>
               <div class="stat-card">
                   <div class="stat-label">Views</div>
                   <div class="stat-value">${data.views_count || 0}</div>
               </div>
               <div class="stat-card">
                   <div class="stat-label">Priority</div>
                   <div class="stat-value">${data.task_priority}</div>
               </div>
           </div>

           <div style="margin-bottom:1.5rem">
               <strong>URL:</strong> <a href="${data.url}" target="_blank" style="color:var(--primary)">${data.url}</a><br>
               <strong>Created:</strong> ${data.date_created}<br>
               <strong>Keywords:</strong> ${data.keywords?.map(k => `<span class="badge badge-primary">${k}</span>`).join(' ') || 'None'}
           </div>

           ${data.country_visits ? `
               <div style="margin-bottom:1.5rem">
                   <strong>Views by Country:</strong>
                   <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:.5rem;margin-top:.5rem">
                       ${Object.entries(data.country_visits).map(([country, visits]) => `
                           <div style="text-align:center;padding:.5rem;background:var(--bg);border-radius:var(--radius)">
                               <div style="font-weight:600">${country}</div>
                               <div style="color:var(--text-light)">${visits} views</div>
                           </div>
                       `).join('')}
                   </div>
               </div>
           ` : ''}

           <div style="display:flex;gap:1rem">
               <button class="btn btn-primary" onclick="rechargeTask('${taskId}')">Recharge Task</button>
               <button class="btn" onclick="closeModal()">Close</button>
           </div>
       `);

       showTaskAnalytics(data);
   } catch (error) {
       console.error('View task error:', error);
   }
}

function showTaskAnalytics(task) {
   const analytics = document.getElementById('taskAnalytics');
   analytics.style.display = 'block';

   const content = document.getElementById('taskAnalyticsContent');
   content.innerHTML = `
       <h4 style="margin-bottom:1rem">Analytics for ${task.url}</h4>
       <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem">
           <div>
               <canvas id="taskCountryChart"></canvas>
           </div>
           <div>
               <canvas id="taskTrendChart"></canvas>
           </div>
       </div>
   `;

   // Country chart
   if (task.country_visits) {
       const ctx1 = document.getElementById('taskCountryChart').getContext('2d');
       new Chart(ctx1, {
           type: 'pie',
           data: {
               labels: Object.keys(task.country_visits),
               datasets: [{
                   data: Object.values(task.country_visits),
                   backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
               }]
           },
           options: {
               responsive: true,
               maintainAspectRatio: true,
               plugins: {
                   title: {
                       display: true,
                       text: 'Views by Country'
                   }
               }
           }
       });
   }

   // Trend chart
   if (task.views_by_date) {
       const ctx2 = document.getElementById('taskTrendChart').getContext('2d');
       const dates = Object.keys(task.views_by_date).sort();
       new Chart(ctx2, {
           type: 'line',
           data: {
               labels: dates,
               datasets: [{
                   label: 'Daily Views',
                   data: dates.map(d => task.views_by_date[d]),
                   borderColor: '#3b82f6',
                   backgroundColor: 'rgba(59, 130, 246, 0.1)',
                   tension: 0.4
               }]
           },
           options: {
               responsive: true,
               maintainAspectRatio: true,
               plugins: {
                   title: {
                       display: true,
                       text: 'Daily Views Trend'
                   }
               },
               scales: {
                   y: { beginAtZero: true }
               }
           }
       });
   }
}

async function showTaskModal() {
   showModal('Create New Task', `
       <form id="taskForm">
           <div class="form-group">
               <label class="form-label">Website URL</label>
               <input type="url" class="form-input" name="url" required placeholder="https://example.com">
           </div>
           <div class="form-group">
               <label class="form-label">Keywords (comma separated)</label>
               <input type="text" class="form-input" name="keywords" required placeholder="SEO, marketing, optimization">
           </div>
           <div class="form-group">
               <label class="form-label">HTML Locations (optional, comma separated)</label>
               <input type="text" class="form-input" name="locations" placeholder="/html/body/div/a">
           </div>
           <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
               <div class="form-group">
                   <label class="form-label">Task Priority</label>
                   <select class="form-select" name="priority">
                       <option value="basic">Basic ($0.10/click, 1 location)</option>
                       <option value="standard" selected>Standard ($0.12/click, 3 locations)</option>
                       <option value="premium">Premium ($0.15/click, 5 locations)</option>
                   </select>
               </div>
               <div class="form-group">
                   <label class="form-label">Total Budget ($)</label>
                   <input type="number" class="form-input" name="budget" min="10" value="150" required>
               </div>
           </div>
           <button type="submit" class="btn btn-primary">Create Task</button>
       </form>
   `);

   document.getElementById('taskForm').addEventListener('submit', createTask);
}

async function createTask(e) {
   e.preventDefault();
   const formData = new FormData(e.target);

   try {
       const { data } = await api('/add-task', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({
               task_details: {
                   url: formData.get('url'),
                   keywords: formData.get('keywords').split(',').map(k => k.trim()),
                   html_locations: formData.get('locations') ? formData.get('locations').split(',').map(l => l.trim()) : []
               },
               task_priority: formData.get('priority'),
               total_charge: parseInt(formData.get('budget')),
               provider: 'stripe',
               is_subscription: false,
               cancel_previous: false
           })
       });

       window.open(data.payment_url, '_blank');
       closeModal();
       showToast('Redirecting to payment...', 'success');
       setTimeout(() => loadTasks(), 2000);

   } catch (error) {
       console.error('Create task error:', error);
   }
}

async function rechargeTask(taskId) {
   const amount = prompt('Enter recharge amount ($):');
   if (!amount || isNaN(amount)) return;

   try {
       const { data } = await api('/recharge', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({
               task_ids: [taskId],
               payment_method: 'stripe',
               cancel_previous: false
           })
       });

       window.open(data.payment_url, '_blank');
       showToast('Redirecting to payment...', 'success');

   } catch (error) {
       console.error('Recharge error:', error);
   }
}

// Hosting
async function loadHosting() {
   try {
       const { data } = await api('/hosting/subscription-status');

       const statusHtml = `
           <div class="stat-grid">
               <div class="stat-card">
                   <div class="stat-label">Current Plan</div>
                   <div class="stat-value">${(data.current_plan || 'free').toUpperCase()}</div>
               </div>
               <div class="stat-card">
                   <div class="stat-label">Images</div>
                   <div class="stat-value">${data.images_uploads || 0}/${data.images_limit || 0}</div>
               </div>
               <div class="stat-card">
                   <div class="stat-label">Articles</div>
                   <div class="stat-value">${data.article_uploads || 0}/${data.articles_limit || 0}</div>
               </div>
               <div class="stat-card">
                   <div class="stat-label">Expires</div>
                   <div class="stat-value">${data.expiry_date ? new Date(data.expiry_date).toLocaleDateString() : 'Never'}</div>
               </div>
           </div>

           ${data.is_subscription ? `
               <div style="margin-top:1.5rem;padding:1rem;background:var(--bg);border-radius:var(--radius)">
                   <strong>Subscription Status:</strong> ${data.subscription_status}<br>
                   <strong>Period:</strong> ${data.subscription_period_start} to ${data.subscription_period_end}<br>
                   <strong>Last Payment:</strong> $${data.billing?.last_payment_amount} on ${data.billing?.last_payment_date}
                   <button class="btn btn-error btn-sm" style="margin-top:.5rem" onclick="cancelSubscription()">Cancel Subscription</button>
               </div>
           ` : ''}
       `;

       document.getElementById('hostingStatus').innerHTML = statusHtml;

   } catch (error) {
       console.error('Hosting error:', error);
   }
}

async function showHostingModal() {
   showModal('Upgrade Hosting Plan', `
       <div style="display:grid;gap:1rem">
           <div class="stat-card" style="cursor:pointer" onclick="selectPlan('basic')">
               <h4>Basic Plan</h4>
               <div class="stat-value">$9.99/mo</div>
               <p style="color:var(--text-light);margin-top:.5rem">100 images, 50 articles</p>
           </div>
           <div class="stat-card" style="cursor:pointer" onclick="selectPlan('pro')">
               <h4>Pro Plan</h4>
               <div class="stat-value">$19.99/mo</div>
               <p style="color:var(--text-light);margin-top:.5rem">500 images, 200 articles</p>
           </div>
           <div class="stat-card" style="cursor:pointer" onclick="selectPlan('enterprise')">
               <h4>Enterprise Plan</h4>
               <div class="stat-value">$49.99/mo</div>
               <p style="color:var(--text-light);margin-top:.5rem">Unlimited everything</p>
           </div>
       </div>

       <form id="planForm" style="display:none;margin-top:1.5rem">
           <div class="form-group">
               <label class="form-label">Duration</label>
               <select class="form-select" name="duration">
                   <option value="3month">3 Months</option>
                   <option value="6month">6 Months</option>
                   <option value="12month">12 Months</option>
               </select>
           </div>
           <div class="form-group">
               <label>
                   <input type="checkbox" name="subscription" checked> Subscribe for automatic renewal
               </label>
           </div>
           <button type="submit" class="btn btn-primary">Proceed to Payment</button>
       </form>
   `);
}

function selectPlan(plan) {
   currentData.selectedPlan = plan;
   document.getElementById('planForm').style.display = 'block';
   document.getElementById('planForm').addEventListener('submit', buyPlan);
}

async function buyPlan(e) {
   e.preventDefault();
   const formData = new FormData(e.target);

   try {
       const { data } = await api('/hosting/buy-package', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({
               package: currentData.selectedPlan,
               provider: 'stripe',
               duration: formData.get('duration'),
               subscription: formData.get('subscription') === 'on',
               cancel_previous: false,
               cancel_current_plan: false
           })
       });

       window.open(data.payment_url, '_blank');
       closeModal();
       showToast('Redirecting to payment...', 'success');

   } catch (error) {
       console.error('Buy plan error:', error);
   }
}

async function cancelSubscription() {
   if (!confirm('Are you sure you want to cancel your subscription?')) return;

   try {
       await api('/hosting/cancel-subscription');
       showToast('Subscription cancelled successfully', 'success');
       loadHosting();
   } catch (error) {
       console.error('Cancel subscription error:', error);
   }
}

// Images
async function loadImages(page = 1) {
   try {
       const { data, pagination } = await api(`/images/dashboard?page=${page}&page_size=20`);

       // Image stats
       document.getElementById('imageStats').innerHTML = `
           <div class="stat-card">
               <div class="stat-label">Total Images</div>
               <div class="stat-value">${pagination?.total || 0}</div>
           </div>
           <div class="stat-card">
               <div class="stat-label">Uploaded</div>
               <div class="stat-value">${data.user?.uploaded || 0}</div>
           </div>
           <div class="stat-card">
               <div class="stat-label">Remaining</div>
               <div class="stat-value">${data.user?.remaining || 0}</div>
           </div>
           <div class="stat-card">
               <div class="stat-label">Plan</div>
               <div class="stat-value">${(data.user?.plan || 'free').toUpperCase()}</div>
           </div>
       `;

       // Image grid
       const images = data.images || [];
       const imageGrid = document.getElementById('imageGrid');

       if (images.length) {
           imageGrid.innerHTML = images.map(img => `
               <div class="image-card">
                   <div class="image-preview">
                       <img src="${img.cdn_url}" alt="${img.original_filename}" loading="lazy">
                   </div>
                   <div class="image-info">
                       <div style="font-weight:600;font-size:.875rem;margin-bottom:.5rem">${img.original_filename}</div>
                       <div style="font-size:.75rem;color:var(--text-light);margin-bottom:.5rem">
                           ${img.total_views || 0} views ‚Ä¢ ${img.upload_date}
                       </div>
                       <div style="display:flex;gap:.5rem">
                           <button class="btn btn-sm" onclick="copyToClipboard('${img.cdn_url}')">Copy URL</button>
                           <button class="btn btn-sm" onclick="deleteImage('${img.image_id}')">Delete</button>
                       </div>
                   </div>
               </div>
           `).join('');

           // Show analytics for first image
           if (images[0] && images[0].monthly_stats) {
               showImageAnalytics(images);
           }
       } else {
           imageGrid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><p>No images uploaded yet</p></div>';
       }

       // Pagination
       if (pagination && pagination.pages > 1) {
           document.getElementById('imagePagination').innerHTML = `
               <button onclick="loadImages(${page - 1})" ${page === 1 ? 'disabled' : ''}>Previous</button>
               <span>Page ${page} of ${pagination.pages}</span>
               <button onclick="loadImages(${page + 1})" ${!pagination.has_next ? 'disabled' : ''}>Next</button>
           `;
       }

   } catch (error) {
       console.error('Images error:', error);
   }
}

function showImageAnalytics(images) {
   // Aggregate stats
   const monthlyViews = {};
   const formatViews = {};

   images.forEach(img => {
       if (img.monthly_stats) {
           Object.entries(img.monthly_stats).forEach(([month, stats]) => {
               monthlyViews[month] = (monthlyViews[month] || 0) + (stats.views || 0);
           });
       }
       if (img.formats) {
           Object.entries(img.formats).forEach(([format, views]) => {
               formatViews[format] = (formatViews[format] || 0) + views;
           });
       }
   });

   // Add analytics card if there's data
   if (Object.keys(monthlyViews).length || Object.keys(formatViews).length) {
       const analyticsCard = document.createElement('div');
       analyticsCard.className = 'card';
       analyticsCard.style.marginTop = '1.5rem';
       analyticsCard.innerHTML = `
           <div class="card-header">
               <h3>Image Analytics</h3>
           </div>
           <div class="card-body">
               <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem">
                   <div>
                       <h4 style="margin-bottom:1rem">Monthly Views</h4>
                       <canvas id="imageViewsChart"></canvas>
                   </div>
                   <div>
                       <h4 style="margin-bottom:1rem">Format Distribution</h4>
                       <canvas id="imageFormatsChart"></canvas>
                   </div>
               </div>
           </div>
       `;
       document.getElementById('images').appendChild(analyticsCard);

       // Create charts
       setTimeout(() => {
           const ctx1 = document.getElementById('imageViewsChart').getContext('2d');
           new Chart(ctx1, {
               type: 'bar',
               data: {
                   labels: Object.keys(monthlyViews),
                   datasets: [{
                       label: 'Views',
                       data: Object.values(monthlyViews),
                       backgroundColor: '#3b82f6'
                   }]
               },
               options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   scales: { y: { beginAtZero: true } }
               }
           });

           const ctx2 = document.getElementById('imageFormatsChart').getContext('2d');
           new Chart(ctx2, {
               type: 'pie',
               data: {
                   labels: Object.keys(formatViews).map(f => f.toUpperCase()),
                   datasets: [{
                       data: Object.values(formatViews),
                       backgroundColor: ['#3b82f6', '#10b981', '#f59e0b']
                   }]
               },
               options: {
                   responsive: true,
                   maintainAspectRatio: false
               }
           });
       }, 100);
   }
}

async function showImageUploadModal() {
   showModal('Upload Images', `
       <form id="imageForm">
           <div style="border:2px dashed var(--border);border-radius:var(--radius);padding:2rem;text-align:center;cursor:pointer" onclick="document.getElementById('imageFiles').click()">
               <p>Click to select images or drag & drop</p>
               <p style="font-size:.875rem;color:var(--text-light);margin-top:.5rem">Max 10 files, 5MB each</p>
           </div>
           <input type="file" id="imageFiles" name="files" multiple accept="image/*" style="display:none" onchange="previewImages(this)">
           <div id="imagePreview" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:.5rem;margin-top:1rem"></div>
           <button type="submit" class="btn btn-primary" style="margin-top:1rem">Upload</button>
       </form>
   `);

   document.getElementById('imageForm').addEventListener('submit', uploadImages);
}

function previewImages(input) {
   const preview = document.getElementById('imagePreview');
   preview.innerHTML = '';

   Array.from(input.files).forEach(file => {
       const reader = new FileReader();
       reader.onload = e => {
           preview.innerHTML += `
               <div style="position:relative">
                   <img src="${e.target.result}" style="width:100%;height:100px;object-fit:cover;border-radius:var(--radius)">
                   <div style="position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.7);color:white;font-size:.7rem;padding:.25rem;text-align:center">
                       ${(file.size / 1024 / 1024).toFixed(1)}MB
                   </div>
               </div>
           `;
       };
       reader.readAsDataURL(file);
   });
}

async function uploadImages(e) {
   e.preventDefault();
   const formData = new FormData();
   const files = document.getElementById('imageFiles').files;

   for (let file of files) {
       formData.append('file', file);
   }

   try {
       const response = await fetch(`${API_BASE}/images/upload`, {
           method: 'POST',
           headers: { 'Session-Token': sessionToken },
           body: formData
       });

       const result = await response.json();
       if (result.status === 'success') {
           closeModal();
           showToast(`${result.data.uploaded_images.length} images uploaded successfully`, 'success');
           loadImages();
       } else {
           throw new Error(result.error?.message || 'Upload failed');
       }
   } catch (error) {
       showToast(error.message, 'error');
   }
}

async function deleteImage(imageId) {
   if (!confirm('Delete this image?')) return;

   try {
       await api('/images', {
           method: 'DELETE',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({ image_ids: [imageId] })
       });

       showToast('Image deleted successfully', 'success');
       loadImages();
   } catch (error) {
       console.error('Delete image error:', error);
   }
}

// Articles
async function loadArticles(page = 1) {
   try {
       const { data, pagination } = await api(`/dashboard/articles?page=${page}&page_size=10`);

       // Article stats
       document.getElementById('articleStats').innerHTML = `
           <div class="stat-card">
               <div class="stat-label">Total Articles</div>
               <div class="stat-value">${pagination?.total || 0}</div>
           </div>
           <div class="stat-card">
               <div class="stat-label">Uploaded</div>
               <div class="stat-value">${data.user?.uploaded || 0}</div>
           </div>
           <div class="stat-card">
               <div class="stat-label">Remaining</div>
               <div class="stat-value">${data.user?.remaining || 0}</div>
           </div>
           <div class="stat-card">
               <div class="stat-label">Total Domains</div>
               <div class="stat-value">${data.user?.total_domains || 0}</div>
           </div>
       `;

       // Articles list
       const articles = data.articles || [];
       const articlesList = document.getElementById('articlesList');

       if (articles.length) {
           articlesList.innerHTML = articles.map(article => `
               <div class="article-item">
                   <div style="display:flex;justify-content:space-between;align-items:start">
                       <div style="flex:1">
                           <h4>${article.subject}</h4>
                           <div style="font-size:.875rem;color:var(--text-light);margin:.5rem 0">
                               üìç ${article.url} ‚Ä¢ üìÖ ${article.creation_date} ‚Ä¢ üëÅÔ∏è ${article.total_views || 0} views
                           </div>
                           ${article.images?.length ? `
                               <div style="display:flex;gap:.5rem;margin-top:.5rem">
                                   ${article.images.slice(0, 3).map(img => `
                                       <img src="${img}" style="width:60px;height:60px;object-fit:cover;border-radius:var(--radius)">
                                   `).join('')}
                                   ${article.images.length > 3 ? `<div style="width:60px;height:60px;background:var(--bg);border-radius:var(--radius);display:flex;align-items:center;justify-content:center;font-size:.875rem">+${article.images.length - 3}</div>` : ''}
                               </div>
                           ` : ''}
                       </div>
                       <div style="display:flex;gap:.5rem">
                           <button class="btn btn-sm" onclick="viewArticle('${article.article_id}')">View</button>
                           <button class="btn btn-sm" onclick="editArticle('${article.article_id}')">Edit</button>
                           <button class="btn btn-sm" onclick="deleteArticle('${article.article_id}')">Delete</button>
                       </div>
                   </div>
               </div>
           `).join('');

           // Analytics
           showArticleAnalytics(articles);

           // Pagination
           if (pagination && pagination.pages > 1) {
               articlesList.innerHTML += `
                   <div class="pagination">
                       <button onclick="loadArticles(${page - 1})" ${page === 1 ? 'disabled' : ''}>Previous</button>
                       <span>Page ${page} of ${pagination.pages}</span>
                       <button onclick="loadArticles(${page + 1})" ${!pagination.has_next ? 'disabled' : ''}>Next</button>
                   </div>
               `;
           }
       } else {
           articlesList.innerHTML = '<div class="empty-state"><p>No articles published yet</p></div>';
       }

   } catch (error) {
       console.error('Articles error:', error);
   }
}

function showArticleAnalytics(articles) {
   // Aggregate stats
   const deviceStats = {};
   const countryStats = {};
   const browserStats = {};
   const monthlyViews = {};

   articles.forEach(article => {
       if (article.stats) {
           Object.entries(article.stats).forEach(([month, stats]) => {
               monthlyViews[month] = (monthlyViews[month] || 0) + Object.values(stats.daily || {}).reduce((a, b) => a + b, 0);

               if (stats.devices) {
                   Object.entries(stats.devices).forEach(([device, count]) => {
                       deviceStats[device] = (deviceStats[device] || 0) + count;
                   });
               }
               if (stats.country) {
                   Object.entries(stats.country).forEach(([country, count]) => {
                       countryStats[country] = (countryStats[country] || 0) + count;
                   });
               }
               if (stats.browser) {
                   Object.entries(stats.browser).forEach(([browser, count]) => {
                       browserStats[browser] = (browserStats[browser] || 0) + count;
                   });
               }
           });
       }
   });

   if (Object.keys(deviceStats).length || Object.keys(countryStats).length) {
       const analyticsCard = document.createElement('div');
       analyticsCard.className = 'card';
       analyticsCard.style.marginTop = '1.5rem';
       analyticsCard.innerHTML = `
           <div class="card-header">
               <h3>Article Analytics</h3>
           </div>
           <div class="card-body">
               <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1.5rem">
                   ${Object.keys(deviceStats).length ? `
                       <div>
                           <h4 style="margin-bottom:1rem">Views by Device</h4>
                           <canvas id="articleDeviceChart"></canvas>
                       </div>
                   ` : ''}
                   ${Object.keys(countryStats).length ? `
                       <div>
                           <h4 style="margin-bottom:1rem">Views by Country</h4>
                           <canvas id="articleCountryChart"></canvas>
                       </div>
                   ` : ''}
                   ${Object.keys(browserStats).length ? `
                       <div>
                           <h4 style="margin-bottom:1rem">Views by Browser</h4>
                           <canvas id="articleBrowserChart"></canvas>
                       </div>
                   ` : ''}
                   ${Object.keys(monthlyViews).length ? `
                       <div>
                           <h4 style="margin-bottom:1rem">Monthly Views</h4>
                           <canvas id="articleMonthlyChart"></canvas>
                       </div>
                   ` : ''}
               </div>
           </div>
       `;
       document.getElementById('articles').appendChild(analyticsCard);

       // Create charts
       setTimeout(() => {
           if (Object.keys(deviceStats).length) {
const ctx = document.getElementById('articleDeviceChart').getContext('2d');
               new Chart(ctx, {
                   type: 'doughnut',
                   data: {
                       labels: Object.keys(deviceStats).map(d => d.charAt(0).toUpperCase() + d.slice(1)),
                       datasets: [{
                           data: Object.values(deviceStats),
                           backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                       }]
                   },
                   options: { responsive: true, maintainAspectRatio: false }
               });
           }

           if (Object.keys(countryStats).length) {
               const ctx = document.getElementById('articleCountryChart').getContext('2d');
               new Chart(ctx, {
                   type: 'bar',
                   data: {
                       labels: Object.keys(countryStats),
                       datasets: [{
                           label: 'Views',
                           data: Object.values(countryStats),
                           backgroundColor: '#10b981'
                       }]
                   },
                   options: {
                       responsive: true,
                       maintainAspectRatio: false,
                       scales: { y: { beginAtZero: true } }
                   }
               });
           }

           if (Object.keys(browserStats).length) {
               const ctx = document.getElementById('articleBrowserChart').getContext('2d');
               new Chart(ctx, {
                   type: 'pie',
                   data: {
                       labels: Object.keys(browserStats).map(b => b.charAt(0).toUpperCase() + b.slice(1)),
                       datasets: [{
                           data: Object.values(browserStats),
                           backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444']
                       }]
                   },
                   options: { responsive: true, maintainAspectRatio: false }
               });
           }

           if (Object.keys(monthlyViews).length) {
               const ctx = document.getElementById('articleMonthlyChart').getContext('2d');
               new Chart(ctx, {
                   type: 'line',
                   data: {
                       labels: Object.keys(monthlyViews),
                       datasets: [{
                           label: 'Total Views',
                           data: Object.values(monthlyViews),
                           borderColor: '#3b82f6',
                           backgroundColor: 'rgba(59, 130, 246, 0.1)',
                           tension: 0.4
                       }]
                   },
                   options: {
                       responsive: true,
                       maintainAspectRatio: false,
                       scales: { y: { beginAtZero: true } }
                   }
               });
           }
       }, 100);
   }
}

async function viewArticle(articleId) {
   try {
       const { data } = await api(`/dashboard/articles?article_id=${articleId}`);
       const article = data.article;

       showModal(article.subject, `
           <div style="margin-bottom:1rem">
               <strong>URL:</strong> <a href="https://${article.url}" target="_blank" style="color:var(--primary)">${article.url}</a><br>
               <strong>Created:</strong> ${article.creation_date}<br>
               <strong>Total Views:</strong> ${article.total_views || 0}
           </div>

           ${article.images?.length ? `
               <div style="margin-bottom:1rem">
                   <strong>Images:</strong>
                   <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:.5rem;margin-top:.5rem">
                       ${article.images.map(img => `
                           <img src="${img}" style="width:100%;height:100px;object-fit:cover;border-radius:var(--radius);cursor:pointer" onclick="window.open('${img}', '_blank')">
                       `).join('')}
                   </div>
               </div>
           ` : ''}

           <div style="margin-bottom:1rem">
               <strong>Content:</strong>
               <div style="max-height:300px;overflow-y:auto;padding:1rem;background:var(--bg);border-radius:var(--radius);margin-top:.5rem">
                   ${article.body}
               </div>
           </div>

           <div style="display:flex;gap:1rem">
               <button class="btn btn-primary" onclick="editArticle('${articleId}')">Edit Article</button>
               <button class="btn" onclick="closeModal()">Close</button>
           </div>
       `);
   } catch (error) {
       console.error('View article error:', error);
   }
}

async function showArticleModal(articleId = null) {
   const isEdit = !!articleId;
   let article = {};

   if (isEdit) {
       try {
           const { data } = await api(`/dashboard/articles?article_id=${articleId}`);
           article = data.article;
       } catch (error) {
           console.error('Load article error:', error);
           return;
       }
   }

   showModal(isEdit ? 'Edit Article' : 'Create New Article', `
       <form id="articleForm">
           <div class="form-group">
               <label class="form-label">Domain URL</label>
               <input type="text" class="form-input" name="url" value="${article.url || ''}" ${isEdit ? 'readonly' : 'required'} placeholder="example.com/blog">
           </div>
           <div class="form-group">
               <label class="form-label">Article Title</label>
               <input type="text" class="form-input" name="subject" value="${article.subject || ''}" required>
           </div>
           <div class="form-group">
               <label class="form-label">Article Content (HTML)</label>
               <textarea class="form-input" name="body" rows="10" required>${article.body || ''}</textarea>
           </div>
           <div class="form-group">
               <label class="form-label">${isEdit ? 'Add New Images' : 'Images'}</label>
               <input type="file" class="form-input" name="images" multiple accept="image/*">
           </div>
           ${isEdit && article.images?.length ? `
               <div class="form-group">
                   <label class="form-label">Current Images (click to remove)</label>
                   <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:.5rem" id="currentImages">
                       ${article.images.map((img, idx) => `
                           <div style="position:relative;cursor:pointer" onclick="toggleImageDelete(this, '${img}')">
                               <img src="${img}" style="width:100%;height:80px;object-fit:cover;border-radius:var(--radius)">
                               <div style="position:absolute;inset:0;background:rgba(239,68,68,0.8);color:white;display:none;align-items:center;justify-content:center;border-radius:var(--radius)">√ó</div>
                           </div>
                       `).join('')}
                   </div>
                   <input type="hidden" name="deleteImages" value="">
               </div>
           ` : ''}
           <button type="submit" class="btn btn-primary">${isEdit ? 'Update Article' : 'Publish Article'}</button>
       </form>
   `);

   document.getElementById('articleForm').addEventListener('submit', e => {
       e.preventDefault();
       if (isEdit) {
           updateArticle(articleId, e.target);
       } else {
           createArticle(e.target);
       }
   });
}

function editArticle(articleId) {
   showArticleModal(articleId);
}

function toggleImageDelete(elem, imageId) {
   const overlay = elem.querySelector('div');
   const input = document.querySelector('input[name="deleteImages"]');
   const deleteList = input.value ? input.value.split(',') : [];

   if (overlay.style.display === 'flex') {
       overlay.style.display = 'none';
       const index = deleteList.indexOf(imageId);
       if (index > -1) deleteList.splice(index, 1);
   } else {
       overlay.style.display = 'flex';
       deleteList.push(imageId);
   }

   input.value = deleteList.join(',');
}

async function createArticle(form) {
   const formData = new FormData(form);

   try {
       const response = await fetch(`${API_BASE}/add-article`, {
           method: 'POST',
           headers: { 'Session-Token': sessionToken },
           body: formData
       });

       const result = await response.json();
       if (result.status === 'success') {
           closeModal();
           showToast('Article published successfully', 'success');
           loadArticles();
       } else {
           throw new Error(result.error?.message || 'Failed to publish article');
       }
   } catch (error) {
       showToast(error.message, 'error');
   }
}

async function updateArticle(articleId, form) {
   const formData = new FormData(form);

   // Add delete image IDs if any
   const deleteImages = formData.get('deleteImages');
   if (deleteImages) {
       formData.append('delete_image_ids', deleteImages);
   }

   try {
       const response = await fetch(`${API_BASE}/edit-article/${articleId}`, {
           method: 'PUT',
           headers: { 'Session-Token': sessionToken },
           body: formData
       });

       const result = await response.json();
       if (result.status === 'success') {
           closeModal();
           showToast('Article updated successfully', 'success');
           loadArticles();
       } else {
           throw new Error(result.error?.message || 'Failed to update article');
       }
   } catch (error) {
       showToast(error.message, 'error');
   }
}

async function deleteArticle(articleId) {
   if (!confirm('Delete this article permanently?')) return;

   try {
       await api(`/delete-article/${articleId}`, { method: 'DELETE' });
       showToast('Article deleted successfully', 'success');
       loadArticles();
   } catch (error) {
       console.error('Delete article error:', error);
   }
}

// Domains
async function loadDomains() {
   // Since there's no list endpoint, show the add form and instructions
   document.getElementById('domainsList').innerHTML = `
       <div class="empty-state">
           <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
           </svg>
           <p>Domain Management</p>
           <p style="font-size:.875rem;margin-top:.5rem">Add and verify your domains to publish articles</p>
           <button class="btn btn-primary" style="margin-top:1rem" onclick="showDomainModal()">Add Your First Domain</button>
       </div>
   `;
}

async function showDomainModal() {
   showModal('Add Domain', `
       <form id="domainForm">
           <div class="form-group">
               <label class="form-label">Domain URL</label>
               <input type="text" class="form-input" name="url" required placeholder="example.com/blog">
           </div>
           <div style="padding:1rem;background:var(--bg);border-radius:var(--radius);margin-bottom:1rem">
               <p style="font-size:.875rem;color:var(--text-light)">
                   After adding your domain, you'll need to verify ownership by adding a TXT record to your DNS settings.
               </p>
           </div>
           <button type="submit" class="btn btn-primary">Add Domain</button>
       </form>
   `);

   document.getElementById('domainForm').addEventListener('submit', addDomain);
}

async function addDomain(e) {
   e.preventDefault();
   const formData = new FormData(e.target);

   try {
       const { data } = await api('/add-domain', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({ url: formData.get('url') })
       });

       if (data.txt_record) {
           showModal('Domain Added - Verification Required', `
               <div style="padding:1rem;background:var(--bg);border-radius:var(--radius);margin-bottom:1rem">
                   <p><strong>Domain added successfully!</strong></p>
                   <p style="margin-top:.5rem">To verify ownership, add this TXT record to your DNS:</p>
                   <code style="display:block;margin-top:.5rem;padding:1rem;background:var(--card);border-radius:var(--radius);word-break:break-all">
                       ${data.txt_record}
                   </code>
               </div>
               <button class="btn btn-primary" onclick="copyToClipboard('${data.txt_record}')">Copy TXT Record</button>
               <button class="btn" onclick="verifyDomain('${formData.get('url')}')">Verify Now</button>
           `);
       } else {
           showToast('Domain added and verified successfully', 'success');
           closeModal();
       }
   } catch (error) {
       console.error('Add domain error:', error);
   }
}

async function verifyDomain(url) {
   try {
       const { data } = await api('/verify-domain', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({ url })
       });

       showToast('Domain verified successfully', 'success');
       closeModal();
   } catch (error) {
       if (error.message.includes('DNS')) {
           showToast('Verification failed. Please ensure the TXT record is added and try again later.', 'warning');
       }
   }
}

// Billing
async function loadBilling(page = 1) {
   try {
       const { data, pagination } = await api(`/dashboard/billings?page=${page}&limit=10&type=all`);

       // Billing stats
       const allPayments = [...(data.tasks || []), ...(data.hosting || [])];
       const totalSpent = allPayments.reduce((sum, p) => sum + (p.total_payment || 0), 0);
       const paidCount = allPayments.filter(p => p.status === 'Paid').length;
       const pendingCount = allPayments.filter(p => p.status !== 'Paid').length;

       document.getElementById('billingStats').innerHTML = `
           <div class="stat-card">
               <div class="stat-label">Total Spent</div>
               <div class="stat-value">$${totalSpent.toFixed(2)}</div>
           </div>
           <div class="stat-card">
               <div class="stat-label">Total Payments</div>
               <div class="stat-value">${allPayments.length}</div>
           </div>
           <div class="stat-card">
               <div class="stat-label">Paid</div>
               <div class="stat-value">${paidCount}</div>
           </div>
           <div class="stat-card">
               <div class="stat-label">Pending</div>
               <div class="stat-value">${pendingCount}</div>
           </div>
       `;

       // Billing table
       const tbody = document.getElementById('billingTable');
       if (allPayments.length) {
           tbody.innerHTML = allPayments.map(payment => `
               <tr>
                   <td>${payment.dates?.paid || payment.dates?.created || 'N/A'}</td>
                   <td>
                       <span class="badge badge-${payment.method === 'create_task' ? 'primary' : payment.method === 'recharge' ? 'warning' : 'success'}">
                           ${payment.method === 'create_task' ? 'Task' : payment.method === 'recharge' ? 'Recharge' : 'Hosting'}
                       </span>
                   </td>
                   <td>${payment.details?.url || payment.details?.package || payment.method}</td>
                   <td>$${payment.total_payment || 0}</td>
                   <td>
                       <span class="badge badge-${payment.status === 'Paid' ? 'success' : 'warning'}">
                           ${payment.status}
                       </span>
                   </td>
                   <td>
                       <button class="btn btn-sm" onclick="viewPayment('${payment.billing_id}')">View</button>
                   </td>
               </tr>
           `).join('');
       } else {
           tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">No billing history found</td></tr>';
       }

       // Pagination
       if (pagination && pagination.pages > 1) {
           document.getElementById('billingPagination').innerHTML = `
               <button onclick="loadBilling(${page - 1})" ${page === 1 ? 'disabled' : ''}>Previous</button>
               <span>Page ${page} of ${pagination.pages}</span>
               <button onclick="loadBilling(${page + 1})" ${page >= pagination.pages ? 'disabled' : ''}>Next</button>
           `;
       }

       // Create billing charts
       createBillingCharts(allPayments);

   } catch (error) {
       console.error('Billing error:', error);
   }
}

function createBillingCharts(payments) {
   // Spending trend
   const monthlySpending = {};
   payments.forEach(p => {
       if (p.dates?.paid) {
           const month = p.dates.paid.substring(0, 7);
           monthlySpending[month] = (monthlySpending[month] || 0) + (p.total_payment || 0);
       }
   });

   if (charts.spending) charts.spending.destroy();
   const ctx1 = document.getElementById('spendingChart').getContext('2d');
   charts.spending = new Chart(ctx1, {
       type: 'line',
       data: {
           labels: Object.keys(monthlySpending).sort(),
           datasets: [{
               label: 'Monthly Spending',
               data: Object.keys(monthlySpending).sort().map(m => monthlySpending[m]),
               borderColor: '#ef4444',
               backgroundColor: 'rgba(239, 68, 68, 0.1)',
               tension: 0.4
           }]
       },
       options: {
           responsive: true,
           maintainAspectRatio: false,
           scales: { y: { beginAtZero: true } }
       }
   });

   // Payment methods
   const methods = {};
   payments.forEach(p => {
       const provider = p.provider || 'stripe';
       methods[provider] = (methods[provider] || 0) + 1;
   });

   if (charts.methods) charts.methods.destroy();
   const ctx2 = document.getElementById('methodChart').getContext('2d');
   charts.methods = new Chart(ctx2, {
       type: 'doughnut',
       data: {
           labels: Object.keys(methods).map(m => m.charAt(0).toUpperCase() + m.slice(1)),
           datasets: [{
               data: Object.values(methods),
               backgroundColor: ['#3b82f6', '#10b981', '#f59e0b']
           }]
       },
       options: {
           responsive: true,
           maintainAspectRatio: false
       }
   });
}

async function viewPayment(paymentId) {
   try {
       const { data } = await api(`/get-payment-status?payment_id=${paymentId}`);

       showModal('Payment Details', `
           <div class="stat-grid" style="margin-bottom:1rem">
               <div class="stat-card">
                   <div class="stat-label">Amount</div>
                   <div class="stat-value">$${data.amount}</div>
               </div>
               <div class="stat-card">
                   <div class="stat-label">Status</div>
                   <div class="stat-value">
                       <span class="badge badge-${data.status === 'Paid' ? 'success' : 'warning'}">${data.status}</span>
                   </div>
               </div>
           </div>

           <div style="display:grid;gap:.5rem">
               <div><strong>Type:</strong> ${data.type}</div>
               <div><strong>Date:</strong> ${data.date_of_payment}</div>
               <div><strong>Method:</strong> ${data.payment_method}</div>
               <div><strong>Transaction ID:</strong> <code>${data.transaction_id || 'N/A'}</code></div>
               ${data.task_id ? `<div><strong>Task ID:</strong> ${data.task_id}</div>` : ''}
               ${data.task_ids ? `<div><strong>Task IDs:</strong> ${data.task_ids.join(', ')}</div>` : ''}
               ${data.package ? `<div><strong>Package:</strong> ${data.package} (${data.duration})</div>` : ''}
           </div>

           <button class="btn" style="margin-top:1rem" onclick="closeModal()">Close</button>
       `);
   } catch (error) {
       console.error('View payment error:', error);
   }
}

// Utilities
function showModal(title, content) {
   document.getElementById('modalTitle').textContent = title;
   document.getElementById('modalBody').innerHTML = content;
   document.getElementById('modal').classList.add('show');
}

function closeModal() {
   document.getElementById('modal').classList.remove('show');
}

function showToast(message, type = 'success') {
   const toast = document.getElementById('toast');
   toast.textContent = message;
   toast.className = `toast ${type} show`;
   setTimeout(() => toast.classList.remove('show'), 3000);
}

function copyToClipboard(text) {
   navigator.clipboard.writeText(text).then(() => {
       showToast('Copied to clipboard', 'success');
   }).catch(() => {
       showToast('Failed to copy', 'error');
   });
}

function getCookie(name) {
   const value = `; ${document.cookie}`;
   const parts = value.split(`; ${name}=`);
   return parts.length === 2 ? parts.pop().split(';').shift() : '';
}

function logout() {
   api('/logout').finally(() => {
       document.cookie = 'session_token=;path=/;expires=Thu, 01 Jan 1970 00:00:00 GMT';
       window.location.href = '/login.html';
   });
}

// Click outside modal to close
document.getElementById('modal').addEventListener('click', e => {
   if (e.target === e.currentTarget) closeModal();
});
</script>
</body>
</html>
