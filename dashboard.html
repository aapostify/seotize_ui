<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEOTIZE Dashboard - Manage Your SEO Tasks & Hosting</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
:root{
    --bg:#f5f7fa;--sidebar-bg:#ffffff;--card-bg:#ffffff;--text:#1f2937;--text-light:#4b5563;
    --border:#e5e7eb;--primary:#3b82f6;--primary-light:rgba(59,130,246,0.1);--secondary:#10b981;
    --shadow:0 4px 6px rgba(0,0,0,0.05);--radius:0.5rem;--error:#ef4444;--warning:#f59e0b;--success:#10b981
}
body.dark{
    --bg:#0f172a;--sidebar-bg:#1f2937;--card-bg:#1f2937;--text:#f9fafb;--text-light:#9ca3af;
    --border:#334155;--primary-light:rgba(59,130,246,0.15)
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);display:flex;height:100vh;overflow:hidden;transition:all .3s}

/* Layout */
.sidebar{width:280px;background:var(--sidebar-bg);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:1.5rem;transform:translateX(-100%);transition:transform .8s ease}
.main{flex:1;display:flex;flex-direction:column;padding:2rem;overflow-y:auto}

/* Sidebar */
.logo{font-size:1.75rem;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:2rem;text-decoration:none;display:block}
.nav-links{list-style:none;flex:1}
.nav-links a{display:flex;align-items:center;gap:.75rem;padding:.75rem 1rem;border-radius:var(--radius);text-decoration:none;color:var(--text-light);font-weight:500;transition:all .2s;margin-bottom:.5rem;cursor:pointer}
.nav-links a:hover{background:var(--primary-light);color:var(--primary);transform:translateX(4px)}
.nav-links a.active{background:var(--primary);color:white;box-shadow:0 5px 15px rgba(59,130,246,0.3)}
.sidebar-footer{margin-top:auto;border-top:1px solid var(--border);padding-top:1.5rem}
.user-profile{display:flex;align-items:center;gap:.75rem;margin-bottom:1rem}
.user-avatar{width:40px;height:40px;border-radius:50%;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-weight:600;text-transform:uppercase}
.user-email{font-size:.875rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.btn{width:100%;padding:.75rem;border:1px solid var(--border);border-radius:var(--radius);background:transparent;font-weight:500;color:var(--text-light);display:flex;align-items:center;justify-content:center;gap:.5rem;cursor:pointer;transition:all .2s;margin-bottom:.5rem}
.btn:hover{border-color:var(--primary);color:var(--primary)}
.btn-primary{background:var(--primary);color:white;border:none;border-radius:var(--radius);padding:.75rem 1.5rem;font-weight:600;display:flex;align-items:center;gap:.5rem;cursor:pointer;transition:all .2s}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(59,130,246,0.3)}
.btn-success{background:var(--success);color:white}
.btn-error{background:var(--error);color:white}
.btn-sm{padding:.5rem .75rem;font-size:.875rem}

/* Header */
.main-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem}
.main-header h1{font-size:2rem;font-weight:800}

/* Stats Grid */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1.5rem;margin-bottom:2rem}
.stat-card{background:var(--card-bg);padding:1.5rem;border-radius:var(--radius);border:1px solid var(--border);box-shadow:var(--shadow);transition:all .3s;cursor:pointer}
.stat-card:hover{transform:translateY(-5px) scale(1.03);box-shadow:0 10px 15px rgba(0,0,0,0.1)}
.stat-header{display:flex;align-items:center;gap:.5rem;color:var(--text-light);font-weight:500;margin-bottom:.5rem}
.stat-value{font-size:2rem;font-weight:800}
.stat-desc{font-size:.875rem;color:var(--text-light)}

/* Content Sections */
.section{display:none}
.section.active{display:block}
.card{background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:1.5rem}
.card-header{padding:1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.card-title{font-size:1.125rem;font-weight:600}
.card-body{padding:1.5rem}

/* Forms */
.form-group{margin-bottom:1.5rem}
.form-label{display:block;margin-bottom:.5rem;font-weight:500;color:var(--text)}
.form-input,.form-select{width:100%;padding:.75rem;border:1px solid var(--border);border-radius:var(--radius);background:var(--card-bg);color:var(--text);transition:border-color .2s}
.form-input:focus,.form-select:focus{outline:none;border-color:var(--primary)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}

/* Tables */
.table-container{overflow-x:auto;border-radius:var(--radius);border:1px solid var(--border)}
.table{width:100%;border-collapse:collapse;background:var(--card-bg)}
.table th,.table td{padding:.875rem 1rem;text-align:left;border-bottom:1px solid var(--border)}
.table th{background:var(--primary-light);font-weight:600;font-size:.875rem;color:var(--text-light)}
.table tbody tr:hover{background:var(--primary-light)}

/* Badges */
.badge{display:inline-flex;align-items:center;gap:.25rem;padding:.25rem .75rem;border-radius:20px;font-size:.75rem;font-weight:600}
.badge-success{background:rgba(16,185,129,.1);color:var(--success)}
.badge-warning{background:rgba(245,158,11,.1);color:var(--warning)}
.badge-error{background:rgba(239,68,68,.1);color:var(--error)}
.badge-primary{background:var(--primary-light);color:var(--primary)}

/* Tasks */
.tasks{flex:1;background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);display:flex;flex-direction:column;overflow:hidden;margin-bottom:2rem}
.tasks-header{padding:1rem 1.5rem;border-bottom:1px solid var(--border);font-size:1.125rem;font-weight:600}
.tasks-list{flex:1;overflow-y:auto;padding:.5rem}
.task-item{display:grid;grid-template-columns:3fr 1fr 1fr 1fr;align-items:center;padding:1rem 1.5rem;border-radius:var(--radius);margin-bottom:.5rem;transition:background .2s;cursor:pointer}
.task-item:hover{background:var(--primary-light)}
.task-url{font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.task-stat{text-align:center;color:var(--text-light)}
.progress-bar{width:100%;height:6px;background:var(--border);border-radius:var(--radius);overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--secondary),var(--primary));width:0%;transition:width 1s ease-in-out}

/* Analytics */
.analytics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:1.5rem;margin-bottom:2rem}
.chart-container{height:300px;position:relative}
.map-container{height:400px;border-radius:var(--radius);overflow:hidden}

/* Image Grid */
.image-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1rem}
.image-item{background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;transition:all .2s}
.image-item:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
.image-item img{width:100%;height:150px;object-fit:cover}
.image-info{padding:1rem}
.image-name{font-size:.875rem;font-weight:500;margin-bottom:.5rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.image-stats{font-size:.75rem;color:var(--text-light);margin-bottom:.5rem}
.image-url{font-size:.7rem;color:var(--primary);background:var(--primary-light);padding:.25rem .5rem;border-radius:.25rem;word-break:break-all}

/* Article Grid */
.article-grid{display:grid;gap:1rem}
.article-item{background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;transition:all .2s}
.article-item:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
.article-title{font-size:1.125rem;font-weight:600;margin-bottom:.5rem}
.article-meta{display:flex;justify-content:space-between;align-items:center;color:var(--text-light);font-size:.875rem;margin-bottom:1rem}
.article-stats{display:flex;gap:1rem;font-size:.875rem}
.article-actions{display:flex;gap:.5rem;margin-top:1rem}

/* Domain List */
.domain-list{display:grid;gap:1rem}
.domain-item{background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;display:flex;justify-content:space-between;align-items:center}
.domain-info h4{margin-bottom:.5rem}
.domain-status{display:flex;align-items:center;gap:.5rem}
.domain-actions{display:flex;gap:.5rem}

/* Modal */
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000}
.modal.active{display:flex}
.modal-content{background:var(--card-bg);border-radius:var(--radius);max-width:600px;width:90%;max-height:90vh;overflow-y:auto}
.modal-header{padding:1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.modal-title{font-size:1.25rem;font-weight:700}
.modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-light)}
.modal-body{padding:1.5rem}

/* File Upload */
.file-upload{border:2px dashed var(--border);border-radius:var(--radius);padding:2rem;text-align:center;cursor:pointer;transition:all .2s}
.file-upload:hover{border-color:var(--primary);background:var(--primary-light)}
.file-upload.dragover{border-color:var(--primary);background:var(--primary-light)}

/* Loading */
.loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:1000}
.spinner{width:60px;height:60px;border:4px solid var(--border);border-top:4px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

/* Progress Indicators */
.upload-progress{margin-top:1rem}
.progress-bar-full{width:100%;height:8px;background:var(--border);border-radius:var(--radius);overflow:hidden}
.progress-fill-full{height:100%;background:var(--primary);width:0%;transition:width .3s ease}

/* Responsive */
@media(max-width:768px){
    .sidebar{transform:translateY(-100%);width:100%;flex-direction:row;justify-content:space-between;padding:1rem}
    .nav-links,.sidebar-footer{display:none}
    .main{padding:1rem}
    .stats-grid{grid-template-columns:1fr 1fr}
    .analytics-grid{grid-template-columns:1fr}
    .task-item{grid-template-columns:1fr;text-align:center;gap:.5rem}
    .image-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}
    .form-row{grid-template-columns:1fr}
}
</style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <a href="#" class="logo">SEOTIZE</a>
        <nav class="nav-links">
            <a href="#" class="active" onclick="showSection('dashboard')"><span>🏠</span> Dashboard</a>
            <a href="#" onclick="showSection('tasks')"><span>🎯</span> SEO Tasks</a>
            <a href="#" onclick="showSection('analytics')"><span>📊</span> Analytics</a>
            <a href="#" onclick="showSection('hosting')"><span>🌐</span> Hosting</a>
            <a href="#" onclick="showSection('billing')"><span>💳</span> Billing</a>
        </nav>
        <div class="sidebar-footer">
            <div class="user-profile">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-email" id="userEmail">Loading...</div>
            </div>
            <button class="btn" id="themeToggle"><span>🌙</span> Switch Theme</button>
            <button class="btn" id="logoutBtn"><span>🚪</span> Log Out</button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main">
        <!-- Dashboard Section -->
        <div class="section active" id="dashboard">
            <div class="main-header">
                <h1 id="welcomeMessage">Welcome!</h1>
                <button class="btn-primary" onclick="showSection('tasks')"><span>➕</span> Add New Task</button>
            </div>

            <!-- Stats Cards -->
            <section class="stats-grid">
                <div class="stat-card" onclick="showSection('tasks')">
                    <div class="stat-header"><span>🎯</span>Active Tasks</div>
                    <div class="stat-value" id="statActiveTasks">0</div>
                    <div class="stat-desc">Running campaigns</div>
                </div>
                <div class="stat-card" onclick="showSection('analytics')">
                    <div class="stat-header"><span>👀</span>Total Views</div>
                    <div class="stat-value" id="statTotalViews">0</div>
                    <div class="stat-desc">Across all tasks</div>
                </div>
                <div class="stat-card" onclick="showSection('analytics')">
                    <div class="stat-header"><span>🔑</span>Total Keywords</div>
                    <div class="stat-value" id="statTotalKeywords">0</div>
                    <div class="stat-desc">Driving your traffic</div>
                </div>
                <div class="stat-card" onclick="showSection('billing')">
                    <div class="stat-header"><span>⚡️</span>Total Spent</div>
                    <div class="stat-value" id="statTotalCharge">$0</div>
                    <div class="stat-desc">Campaign investment</div>
                </div>
                <div class="stat-card" onclick="showSection('billing')">
                    <div class="stat-header"><span>🔋</span>Available Budget</div>
                    <div class="stat-value" id="statAvailableCharge">$0</div>
                    <div class="stat-desc">Remaining credits</div>
                </div>
            </section>

            <!-- Active Tasks Preview -->
            <section class="tasks">
                <div class="tasks-header">Your Active Tasks</div>
                <div class="tasks-list" id="tasksList">
                    <p style="text-align:center; color:var(--text-light); padding:2rem;">Loading tasks...</p>
                </div>
            </section>

            <!-- Quick Stats -->
            <div class="analytics-grid">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Hosting Usage</h3>
                    </div>
                    <div class="card-body">
                        <div class="stats-grid" style="grid-template-columns:repeat(3,1fr);gap:1rem">
                            <div style="text-align:center">
                                <div style="font-size:1.5rem;font-weight:800" id="hostImages">0</div>
                                <div style="font-size:.875rem;color:var(--text-light)">Images</div>
                            </div>
                            <div style="text-align:center">
                                <div style="font-size:1.5rem;font-weight:800" id="hostArticles">0</div>
                                <div style="font-size:.875rem;color:var(--text-light)">Articles</div>
                            </div>
                            <div style="text-align:center">
                                <div style="font-size:1.5rem;font-weight:800" id="hostDomains">0</div>
                                <div style="font-size:.875rem;color:var(--text-light)">Domains</div>
                            </div>
                        </div>
                        <div style="margin-top:1rem;padding:1rem;background:var(--primary-light);border-radius:var(--radius)">
                            <div style="display:flex;justify-content:space-between;align-items:center">
                                <span>Plan: <strong id="hostPlan">Free</strong></span>
                                <span>Expires: <span id="hostExpiry">Never</span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Views by Country (Last 30 Days)</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="countriesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tasks Section -->
        <div class="section" id="tasks">
            <div class="main-header">
                <h1>SEO Tasks</h1>
                <button class="btn-primary" onclick="showTaskForm()"><span>➕</span> Create Task</button>
            </div>

            <div class="card" id="taskFormCard" style="display:none">
                <div class="card-header">
                    <h3 class="card-title">Create New Task</h3>
                    <button onclick="hideTaskForm()" style="background:none;border:none;font-size:1.2rem;cursor:pointer">×</button>
                </div>
                <div class="card-body">
                    <form id="taskForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Website URL</label>
                                <input type="url" class="form-input" id="taskUrl" placeholder="https://example.com" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Task Priority</label>
                                <select class="form-select" id="taskPriority">
                                    <option value="basic">Basic ($0.10/click)</option>
                                    <option value="standard" selected>Standard ($0.12/click)</option>
                                    <option value="premium">Premium ($0.15/click)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Keywords (comma separated)</label>
                            <input type="text" class="form-input" id="taskKeywords" placeholder="SEO, marketing, optimization" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">HTML Locations (optional)</label>
                            <input type="text" class="form-input" id="taskLocations" placeholder="/html/body/div/a, /html/body/header/nav/a">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Total Budget ($)</label>
                            <input type="number" class="form-input" id="taskCharge" min="10" value="150" required>
                        </div>
                        <button type="submit" class="btn-primary">Create Task & Pay</button>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Your Tasks</h3>
                    <button class="btn" onclick="loadTasks()">Refresh</button>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>URL</th>
                                    <th>Keywords</th>
                                    <th>Views</th>
                                    <th>Budget</th>
                                    <th>Progress</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tasksTable">
                                <tr><td colspan="6">Loading tasks...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Section -->
        <div class="section" id="analytics">
            <div class="main-header">
                <h1>Analytics Dashboard</h1>
                <button class="btn-primary" onclick="loadAnalytics()"><span>🔄</span> Refresh Data</button>
            </div>

            <!-- Analytics Grid -->
            <div class="analytics-grid">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Views by Country</h3>
                    </div>
                    <div class="card-body">
                        <div class="map-container" id="worldMap"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Daily Views Trend</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="viewsTrendChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Top Performing Tasks</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="tasksPerformanceChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Article Views by Device</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="deviceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hosting Section -->
        <div class="section" id="hosting">
            <div class="main-header">
                <h1>Hosting Management</h1>
                <div>
                    <button class="btn-primary" onclick="showUploadModal('image')"><span>🖼️</span> Upload Images</button>
                    <button class="btn-primary" onclick="showUploadModal('article')"><span>📝</span> New Article</button>
                    <button class="btn-primary" onclick="showUploadModal('domain')"><span>🔗</span> Add Domain</button>
                </div>
            </div>

            <!-- Hosting Plan Status -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Current Hosting Plan</h3>
                    <button class="btn-primary" onclick="showPlanModal()">Upgrade Plan</button>
                </div>
                <div class="card-body">
                    <div class="stats-grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr))">
                        <div class="stat-card">
                            <div class="stat-header"><span>📦</span>Plan</div>
                            <div class="stat-value" id="currentPlan">Free</div>
                            <div class="stat-desc" id="planExpiry">Never expires</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header"><span>🖼️</span>Images</div>
                            <div class="stat-value"><span id="imagesUsed">0</span>/<span id="imagesLimit">0</span></div>
                            <div class="stat-desc"><span id="imagesRemaining">0</span> remaining</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header"><span>📝</span>Articles</div>
                            <div class="stat-value"><span id="articlesUsed">0</span>/<span id="articlesLimit">0</span></div>
                            <div class="stat-desc"><span id="articlesRemaining">0</span> remaining</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs for different content types -->
            <div class="card">
                <div class="card-header">
                    <div style="display:flex;gap:1rem">
                        <button class="btn hosting-tab active" onclick="showHostingTab('images')">Images</button>
                        <button class="btn hosting-tab" onclick="showHostingTab('articles')">Articles</button>
                        <button class="btn hosting-tab" onclick="showHostingTab('domains')">Domains</button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Images Tab -->
                    <div class="hosting-content active" id="imagesTab">
                        <div class="image-grid" id="imagesList">
                            <p style="text-align:center;color:var(--text-light);padding:2rem">Loading images...</p>
                        </div>
                    </div>

                    <!-- Articles Tab -->
                    <div class="hosting-content" id="articlesTab" style="display:none">
                        <div class="article-grid" id="articlesList">
                            <p style="text-align:center;color:var(--text-light);padding:2rem">Loading articles...</p>
                        </div>
                    </div>

                    <!-- Domains Tab -->
                    <div class="hosting-content" id="domainsTab" style="display:none">
                        <div class="domain-list" id="domainsList">
                            <p style="text-align:center;color:var(--text-light);padding:2rem">Loading domains...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Billing Section -->
        <div class="section" id="billing">
            <div class="main-header">
                <h1>Billing & Payments</h1>
                <button class="btn-primary" onclick="loadBilling()"><span>🔄</span> Refresh</button>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Payment History</h3>
                </div>
                <div class="card-body">
                    <div class="table-container">
<table class="table">
                           <thead>
                               <tr>
                                   <th>Date</th>
                                   <th>Type</th>
                                   <th>Description</th>
                                   <th>Amount</th>
                                   <th>Status</th>
                                   <th>Actions</th>
                               </tr>
                           </thead>
                           <tbody id="billingTable">
                               <tr><td colspan="6">Loading billing history...</td></tr>
                           </tbody>
                       </table>
                   </div>
               </div>
           </div>

           <!-- Billing Summary -->
           <div class="analytics-grid">
               <div class="card">
                   <div class="card-header">
                       <h3 class="card-title">Monthly Spending</h3>
                   </div>
                   <div class="card-body">
                       <div class="chart-container">
                           <canvas id="spendingChart"></canvas>
                       </div>
                   </div>
               </div>

               <div class="card">
                   <div class="card-header">
                       <h3 class="card-title">Payment Methods</h3>
                   </div>
                   <div class="card-body">
                       <div class="chart-container">
                           <canvas id="paymentMethodsChart"></canvas>
                       </div>
                   </div>
               </div>
           </div>
       </div>
   </main>

   <!-- Modals -->
   <!-- Task Details Modal -->
   <div class="modal" id="taskModal">
       <div class="modal-content">
           <div class="modal-header">
               <h3 class="modal-title">Task Details</h3>
               <button class="modal-close" onclick="closeModal('taskModal')">&times;</button>
           </div>
           <div class="modal-body" id="taskModalBody">
               Loading task details...
           </div>
       </div>
   </div>

   <!-- Upload Modals -->
   <div class="modal" id="uploadModal">
       <div class="modal-content">
           <div class="modal-header">
               <h3 class="modal-title" id="uploadModalTitle">Upload</h3>
               <button class="modal-close" onclick="closeModal('uploadModal')">&times;</button>
           </div>
           <div class="modal-body" id="uploadModalBody">
               <!-- Dynamic content based on upload type -->
           </div>
       </div>
   </div>

   <!-- Plan Upgrade Modal -->
   <div class="modal" id="planModal">
       <div class="modal-content">
           <div class="modal-header">
               <h3 class="modal-title">Upgrade Hosting Plan</h3>
               <button class="modal-close" onclick="closeModal('planModal')">&times;</button>
           </div>
           <div class="modal-body">
               <div class="stats-grid" style="grid-template-columns:repeat(auto-fit,minmax(250px,1fr))">
                   <div class="stat-card" onclick="upgradePlan('basic')">
                       <div class="stat-header"><span>📦</span>Basic Plan</div>
                       <div class="stat-value">$9.99/mo</div>
                       <div class="stat-desc">100 images, 50 articles</div>
                       <button class="btn-primary" style="margin-top:1rem">Choose Basic</button>
                   </div>
                   <div class="stat-card" onclick="upgradePlan('pro')">
                       <div class="stat-header"><span>🚀</span>Pro Plan</div>
                       <div class="stat-value">$19.99/mo</div>
                       <div class="stat-desc">500 images, 200 articles</div>
                       <button class="btn-primary" style="margin-top:1rem">Choose Pro</button>
                   </div>
                   <div class="stat-card" onclick="upgradePlan('enterprise')">
                       <div class="stat-header"><span>🏢</span>Enterprise</div>
                       <div class="stat-value">$49.99/mo</div>
                       <div class="stat-desc">Unlimited everything</div>
                       <button class="btn-primary" style="margin-top:1rem">Choose Enterprise</button>
                   </div>
               </div>
           </div>
       </div>
   </div>

<script>
const baseUrl = 'https://api.seotize.net';
let currentUser = null;
let worldMap = null;
let charts = {};

document.addEventListener('DOMContentLoaded', () => {
   const token = getCookie('session_token');
   if (!token) {
       window.location.href = 'login.html';
       return;
   }

   loadTheme();
   setupListeners();

   // Load all dashboard data
   Promise.all([
       fetchDashboard(token),
       fetchHostingStatus(token),
       fetchImages(token),
       fetchArticles(token)
   ]).then(([userDash, hosting, images, articles]) => {
       if (userDash) {
           currentUser = userDash;
           populateDashboard(userDash);
       }
       if (hosting) populateHostingStatus(hosting);
       if (images) populateImages(images.images || []);
       if (articles) populateArticles(articles.articles || []);

       // Initialize analytics
       initializeAnalytics();
       loadAnalytics();

   }).catch(e => {
       console.error('Dashboard error:', e);
   }).finally(() => {
       runAnimations();
   });
});

// Cookie helper function
function getCookie(name) {
   const value = `; ${document.cookie}`;
   const parts = value.split(`; ${name}=`);
   return parts.length === 2 ? parts.pop().split(';').shift() : '';
}

// API calls
async function fetchDashboard(token) {
   try {
       const res = await fetch(`${baseUrl}/users/dashboard?page=1&page_size=10`, {
           headers: { 'Session-Token': token }
       });
       if (!res.ok) throw new Error(res.statusText);
       const { data } = await res.json();
       return data.user;
   } catch (e) {
       console.error('Failed to fetch dashboard:', e);
       return null;
   }
}

async function fetchHostingStatus(token) {
   try {
       const res = await fetch(`${baseUrl}/hosting/subscription-status`, {
           headers: { 'Session-Token': token }
       });
       if (!res.ok) return null;
       const { data } = await res.json();
       return data;
   } catch (e) {
       console.error('Failed to fetch hosting status:', e);
       return null;
   }
}

async function fetchImages(token) {
   try {
       const res = await fetch(`${baseUrl}/images/dashboard`, {
           headers: { 'Session-Token': token }
       });
       if (!res.ok) return null;
       const { data } = await res.json();
       return data;
   } catch (e) {
       console.error('Failed to fetch images:', e);
       return null;
   }
}

async function fetchArticles(token) {
   try {
       const res = await fetch(`${baseUrl}/dashboard/articles`, {
           headers: { 'Session-Token': token }
       });
       if (!res.ok) return null;
       const { data } = await res.json();
       return data;
   } catch (e) {
       console.error('Failed to fetch articles:', e);
       return null;
   }
}

async function fetchBilling(token) {
   try {
       const res = await fetch(`${baseUrl}/dashboard/billings`, {
           headers: { 'Session-Token': token }
       });
       if (!res.ok) return null;
       const { data } = await res.json();
       return data;
   } catch (e) {
       console.error('Failed to fetch billing:', e);
       return null;
   }
}

// Populate dashboard
function populateDashboard(user) {
   const email = user.email;
   document.getElementById('userEmail').textContent = email;
   document.getElementById('userAvatar').textContent = email[0].toUpperCase();
   document.getElementById('welcomeMessage').textContent = `Welcome, ${email.split('@')[0]}!`;

   // Animate stats
   animateStat('statActiveTasks', user.usage_summary?.active_tasks || 0);
   animateStat('statTotalViews', user.task_statistics?.total_views || 0);
   animateStat('statTotalKeywords', user.task_statistics?.total_keywords || 0);
   animateStat('statTotalCharge', user.task_statistics?.total_charge || 0, true);
   animateStat('statAvailableCharge', user.task_statistics?.available_charge || 0, true);

   // Populate hosting summary
   if (user.hosting) {
       document.getElementById('hostImages').textContent = user.hosting.images_uploads || 0;
       document.getElementById('hostArticles').textContent = user.hosting.article_uploads || 0;
       document.getElementById('hostPlan').textContent = (user.hosting.type || 'free').toUpperCase();
       if (user.hosting.expiry_date) {
           document.getElementById('hostExpiry').textContent = new Date(user.hosting.expiry_date).toLocaleDateString();
       }
   }

   // Count domains (we'll update this when we load domains)
   document.getElementById('hostDomains').textContent = '0';

   // Populate tasks list
   populateTasksList(user.tasks || []);

   // Create country chart from task data
   createCountryChart(user.tasks || []);
}

function populateHostingStatus(hosting) {
   document.getElementById('currentPlan').textContent = (hosting.current_plan || 'free').toUpperCase();
   document.getElementById('imagesUsed').textContent = hosting.images_uploads || 0;
   document.getElementById('imagesLimit').textContent = hosting.images_limit || 0;
   document.getElementById('imagesRemaining').textContent = hosting.images_remaining || 0;
   document.getElementById('articlesUsed').textContent = hosting.article_uploads || 0;
   document.getElementById('articlesLimit').textContent = hosting.articles_limit || 0;
   document.getElementById('articlesRemaining').textContent = hosting.articles_remaining || 0;

   if (hosting.expiry_date) {
       document.getElementById('planExpiry').textContent = `Expires ${new Date(hosting.expiry_date).toLocaleDateString()}`;
   }
}

function populateImages(images) {
   const container = document.getElementById('imagesList');
   if (!images.length) {
       container.innerHTML = '<p style="text-align:center;color:var(--text-light);padding:2rem">No images uploaded yet. Click "Upload Images" to get started!</p>';
       return;
   }

   container.innerHTML = images.map(img => `
       <div class="image-item">
           <img src="${img.cdn_url}" alt="${img.original_filename}" loading="lazy">
           <div class="image-info">
               <div class="image-name">${img.original_filename}</div>
               <div class="image-stats">${img.total_views || 0} views • ${img.upload_date}</div>
               <div class="image-url">${img.cdn_url}</div>
               <div style="display:flex;gap:.5rem;margin-top:.5rem">
                   <button class="btn btn-sm" onclick="copyToClipboard('${img.cdn_url}')">Copy URL</button>
                   <button class="btn btn-error btn-sm" onclick="deleteImage('${img.image_id}')">Delete</button>
               </div>
           </div>
       </div>
   `).join('');
}

function populateArticles(articles) {
   const container = document.getElementById('articlesList');
   if (!articles.length) {
       container.innerHTML = '<p style="text-align:center;color:var(--text-light);padding:2rem">No articles published yet. Click "New Article" to create your first article!</p>';
       return;
   }

   container.innerHTML = articles.map(article => `
       <div class="article-item">
           <div class="article-title">${article.subject}</div>
           <div class="article-meta">
               <span>📍 ${article.url}</span>
               <span>📅 ${article.creation_date}</span>
           </div>
           <div class="article-stats">
               <span>👁️ ${article.total_views || 0} views</span>
               <span>🖼️ ${article.images?.length || 0} images</span>
           </div>
           <div class="article-actions">
               <button class="btn btn-sm" onclick="viewArticle('${article.article_id}')">View</button>
               <button class="btn btn-sm" onclick="editArticle('${article.article_id}')">Edit</button>
               <button class="btn btn-error btn-sm" onclick="deleteArticle('${article.article_id}')">Delete</button>
           </div>
       </div>
   `).join('');
}

function populateTasksList(tasks) {
   const list = document.getElementById('tasksList');
   list.innerHTML = '';

   if (tasks.length) {
       tasks.forEach(task => {
           const div = document.createElement('div');
           div.className = 'task-item';
           div.onclick = () => viewTask(task._id);
           div.innerHTML = `
               <div class="task-url">${task.url}</div>
               <div class="task-stat"><strong>${task.views_count || 0}</strong> views</div>
               <div class="task-stat"><strong>${task.keywords_count || 0}</strong> kw</div>
               <div class="task-stat">
                   <div class="progress-bar">
                       <div class="progress-fill" style="width:${task.remaining_percentage || 0}%"></div>
                   </div>
               </div>
           `;
           list.appendChild(div);
       });
   } else {
       list.innerHTML = `
           <p style="text-align:center; color:var(--text-light); padding:2rem;">
               No active tasks. Click "Add New Task" to get started!
           </p>
       `;
   }
}

// Load tasks for tasks section
async function loadTasks() {
   const token = getCookie('session_token');
   try {
       const res = await fetch(`${baseUrl}/users/dashboard`, {
           headers: { 'Session-Token': token }
       });
       if (!res.ok) return;
       const { data } = await res.json();

       renderTasksTable(data.user.tasks || []);
   } catch (e) {
       console.error('Failed to load tasks:', e);
   }
}

function renderTasksTable(tasks) {
   const tbody = document.getElementById('tasksTable');
   if (!tasks.length) {
       tbody.innerHTML = '<tr><td colspan="6">No tasks found</td></tr>';
       return;
   }

   tbody.innerHTML = tasks.map(task => `
       <tr onclick="viewTask('${task._id}')" style="cursor:pointer">
           <td>${task.url}</td>
           <td>${task.keywords_count || 0} keywords</td>
           <td>${task.views_count || 0}</td>
           <td>$${task.total_charge || 0}</td>
           <td>
               <div class="progress-bar">
                   <div class="progress-fill" style="width:${task.remaining_percentage || 0}%"></div>
               </div>
               <small>${task.remaining_percentage || 0}% remaining</small>
           </td>
           <td>
               <button class="btn btn-sm" onclick="event.stopPropagation(); rechargeTask('${task._id}')">Recharge</button>
           </td>
       </tr>
   `).join('');
}

// Analytics functions
function initializeAnalytics() {
   // Initialize world map
   worldMap = L.map('worldMap').setView([20, 0], 2);
   L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
       attribution: '© OpenStreetMap contributors'
   }).addTo(worldMap);
}

async function loadAnalytics() {
   const token = getCookie('session_token');

   // Load fresh data for analytics
   try {
       const [dashData, articlesData] = await Promise.all([
           fetchDashboard(token),
           fetchArticles(token)
       ]);

       if (dashData) {
           createAnalyticsCharts(dashData, articlesData);
       }
   } catch (e) {
       console.error('Failed to load analytics:', e);
   }
}

function createAnalyticsCharts(userData, articlesData) {
   const tasks = userData.tasks || [];
   const articles = articlesData?.articles || [];

   // Update world map with country data
   updateWorldMap(tasks);

   // Create views trend chart
   createViewsTrendChart(tasks);

   // Create tasks performance chart
   createTasksPerformanceChart(tasks);

   // Create device chart from articles data
   createDeviceChart(articles);
}

function createCountryChart(tasks) {
   const countryData = {};
   tasks.forEach(task => {
       if (task.country_visits) {
           Object.entries(task.country_visits).forEach(([country, visits]) => {
               countryData[country] = (countryData[country] || 0) + visits;
           });
       }
   });

   const ctx = document.getElementById('countriesChart').getContext('2d');
   if (charts.countries) charts.countries.destroy();

   charts.countries = new Chart(ctx, {
       type: 'doughnut',
       data: {
           labels: Object.keys(countryData),
           datasets: [{
               data: Object.values(countryData),
               backgroundColor: [
                   '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                   '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#14b8a6'
               ]
           }]
       },
       options: {
           responsive: true,
           maintainAspectRatio: false,
           plugins: {
               legend: { position: 'bottom' }
           }
       }
   });
}

function updateWorldMap(tasks) {
   if (!worldMap) return;

   // Clear existing markers
   worldMap.eachLayer(layer => {
       if (layer instanceof L.Marker) {
           worldMap.removeLayer(layer);
       }
   });

   const countryData = {};
   tasks.forEach(task => {
       if (task.country_visits) {
           Object.entries(task.country_visits).forEach(([country, visits]) => {
               countryData[country] = (countryData[country] || 0) + visits;
           });
       }
   });

   // Country coordinates (simplified)
   const countryCoords = {
       'US': [39.8283, -98.5795],
       'UK': [55.3781, -3.4360],
       'CA': [56.1304, -106.3468],
       'DE': [51.1657, 10.4515],
       'FR': [46.6034, 1.8883],
       'IN': [20.5937, 78.9629],
       'AU': [-25.2744, 133.7751],
       'JP': [36.2048, 138.2529],
       'BR': [-14.2350, -51.9253],
       'CN': [35.8617, 104.1954]
   };

   Object.entries(countryData).forEach(([country, visits]) => {
       if (countryCoords[country]) {
           const [lat, lng] = countryCoords[country];
           const radius = Math.min(Math.max(visits * 2, 5), 50);

           L.circleMarker([lat, lng], {
               radius: radius,
               fillColor: '#3b82f6',
               color: '#1d4ed8',
               weight: 2,
               opacity: 0.8,
               fillOpacity: 0.6
           }).addTo(worldMap)
             .bindPopup(`${country}: ${visits} visits`);
       }
   });
}

function createViewsTrendChart(tasks) {
   const viewsData = {};
   tasks.forEach(task => {
       if (task.views_by_date) {
           Object.entries(task.views_by_date).forEach(([date, views]) => {
               viewsData[date] = (viewsData[date] || 0) + views;
           });
       }
   });

   const sortedDates = Object.keys(viewsData).sort();
   const ctx = document.getElementById('viewsTrendChart').getContext('2d');
   if (charts.viewsTrend) charts.viewsTrend.destroy();

   charts.viewsTrend = new Chart(ctx, {
       type: 'line',
       data: {
           labels: sortedDates,
           datasets: [{
               label: 'Daily Views',
               data: sortedDates.map(date => viewsData[date]),
               borderColor: '#3b82f6',
               backgroundColor: 'rgba(59, 130, 246, 0.1)',
               tension: 0.4,
               fill: true
           }]
       },
       options: {
           responsive: true,
           maintainAspectRatio: false,
           scales: {
               y: { beginAtZero: true }
           }
       }
   });
}

function createTasksPerformanceChart(tasks) {
   const taskNames = tasks.map(task => task.url.replace('https://', '').split('/')[0]);
   const taskViews = tasks.map(task => task.views_count || 0);

   const ctx = document.getElementById('tasksPerformanceChart').getContext('2d');
   if (charts.tasksPerformance) charts.tasksPerformance.destroy();

   charts.tasksPerformance = new Chart(ctx, {
       type: 'bar',
       data: {
           labels: taskNames,
           datasets: [{
               label: 'Views',
               data: taskViews,
               backgroundColor: '#10b981',
               borderColor: '#059669',
               borderWidth: 1
           }]
       },
       options: {
           responsive: true,
           maintainAspectRatio: false,
           scales: {
               y: { beginAtZero: true }
           }
       }
   });
}

function createDeviceChart(articles) {
   const deviceData = { windows: 0, android: 0, ios: 0, mac: 0, linux: 0 };

   articles.forEach(article => {
       if (article.stats) {
           Object.values(article.stats).forEach(monthStats => {
               if (monthStats.devices) {
                   Object.entries(monthStats.devices).forEach(([device, count]) => {
                       const deviceKey = device.toLowerCase();
                       if (deviceData.hasOwnProperty(deviceKey)) {
                           deviceData[deviceKey] += count;
                       }
                   });
               }
           });
       }
   });

   const ctx = document.getElementById('deviceChart').getContext('2d');
   if (charts.device) charts.device.destroy();

   charts.device = new Chart(ctx, {
       type: 'pie',
       data: {
           labels: Object.keys(deviceData).map(d => d.charAt(0).toUpperCase() + d.slice(1)),
           datasets: [{
               data: Object.values(deviceData),
               backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
           }]
       },
       options: {
           responsive: true,
           maintainAspectRatio: false,
           plugins: {
               legend: { position: 'right' }
           }
       }
   });
}

// Load billing data
async function loadBilling() {
   const token = getCookie('session_token');
   const billing = await fetchBilling(token);
   if (billing) {
       populateBillingData(billing);
       createBillingCharts(billing);
   }
}

function populateBillingData(billing) {
   const tbody = document.getElementById('billingTable');
   const allPayments = [...(billing.tasks || []), ...(billing.hosting || [])];

   if (!allPayments.length) {
       tbody.innerHTML = '<tr><td colspan="6">No billing history found</td></tr>';
       return;
   }

   tbody.innerHTML = allPayments.map(payment => `
       <tr>
           <td>${payment.dates?.paid || payment.dates?.created || 'N/A'}</td>
           <td><span class="badge badge-${payment.method === 'create_task' ? 'primary' : 'success'}">${payment.method === 'create_task' ? 'Task' : 'Hosting'}</span></td>
           <td>${payment.method === 'create_task' ? payment.details?.url || 'Task Payment' : `${payment.details?.package || 'hosting'} Plan`}</td>
           <td>$${payment.total_payment || 0}</td>
           <td><span class="badge badge-${payment.status === 'Paid' ? 'success' : 'warning'}">${payment.status}</span></td>
           <td>
               <button class="btn btn-sm" onclick="viewPayment('${payment.billing_id}')">View</button>
           </td>
       </tr>
   `).join('');
}

function createBillingCharts(billing) {
   // Monthly spending chart
   const spendingData = {};
   const allPayments = [...(billing.tasks || []), ...(billing.hosting || [])];

   allPayments.forEach(payment => {
       if (payment.dates?.paid) {
           const month = payment.dates.paid.substring(0, 7); // YYYY-MM
           spendingData[month] = (spendingData[month] || 0) + (payment.total_payment || 0);
       }
   });

   const ctx1 = document.getElementById('spendingChart').getContext('2d');
   if (charts.spending) charts.spending.destroy();

   charts.spending = new Chart(ctx1, {
       type: 'line',
       data: {
           labels: Object.keys(spendingData).sort(),
           datasets: [{
               label: 'Monthly Spending ($)',
               data: Object.keys(spendingData).sort().map(month => spendingData[month]),
               borderColor: '#ef4444',
               backgroundColor: 'rgba(239, 68, 68, 0.1)',
               tension: 0.4,
               fill: true
           }]
       },
       options: {
           responsive: true,
           maintainAspectRatio: false,
           scales: {
               y: { beginAtZero: true }
           }
       }
   });

   // Payment methods chart
   const methodData = { stripe: 0, paypal: 0, crypto: 0 };
   allPayments.forEach(payment => {
       const provider = payment.provider || 'stripe';
       methodData[provider] = (methodData[provider] || 0) + 1;
   });

   const ctx2 = document.getElementById('paymentMethodsChart').getContext('2d');
   if (charts.paymentMethods) charts.paymentMethods.destroy();

   charts.paymentMethods = new Chart(ctx2, {
       type: 'doughnut',
       data: {
           labels: Object.keys(methodData).map(m => m.charAt(0).toUpperCase() + m.slice(1)),
           datasets: [{
               data: Object.values(methodData),
               backgroundColor: ['#3b82f6', '#10b981', '#f59e0b']
           }]
       },
       options: {
           responsive: true,
           maintainAspectRatio: false,
           plugins: {
               legend: { position: 'bottom' }
           }
       }
   });
}

// Navigation functions
function showSection(sectionId) {
   document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
   document.querySelectorAll('.nav-links a').forEach(n => n.classList.remove('active'));

   document.getElementById(sectionId).classList.add('active');
   document.querySelector(`[onclick="showSection('${sectionId}')"]`).classList.add('active');

   // Load section-specific data
   if (sectionId === 'tasks') loadTasks();
   if (sectionId === 'analytics') loadAnalytics();
   if (sectionId === 'billing') loadBilling();
}

// Hosting tab management
function showHostingTab(tabName) {
   document.querySelectorAll('.hosting-tab').forEach(t => t.classList.remove('active'));
   document.querySelectorAll('.hosting-content').forEach(c => c.style.display = 'none');

   document.querySelector(`[onclick="showHostingTab('${tabName}')"]`).classList.add('active');
   document.getElementById(`${tabName}Tab`).style.display = 'block';

   // Load tab-specific data
   if (tabName === 'domains') loadDomains();
}

// Modal functions
function showModal(modalId) {
   document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId) {
   document.getElementById(modalId).classList.remove('active');
}

function showUploadModal(type) {
   const modal = document.getElementById('uploadModal');
   const title = document.getElementById('uploadModalTitle');
   const body = document.getElementById('uploadModalBody');

   switch(type) {
       case 'image':
           title.textContent = 'Upload Images';
           body.innerHTML = `
               <form id="imageUploadForm" enctype="multipart/form-data">
                   <div class="file-upload" onclick="document.getElementById('imageFiles').click()">
                       <div>📁 Click to select images or drag & drop</div>
                       <small>Max 10 files, 5MB each</small>
                   </div>
                   <input type="file" id="imageFiles" multiple accept="image/*" style="display:none" onchange="handleFileSelect(this)">
                   <div id="selectedFiles"></div>
                   <div class="upload-progress" id="uploadProgress" style="display:none">
                       <div class="progress-bar-full">
                           <div class="progress-fill-full" id="progressFill"></div>
                       </div>
                       <div id="progressText">Uploading...</div>
                   </div>
                   <button type="submit" class="btn-primary" style="margin-top:1rem">Upload Images</button>
               </form>
           `;
           break;

       case 'article':
           title.textContent = 'Create New Article';
           body.innerHTML = `
               <form id="articleUploadForm" enctype="multipart/form-data">
                   <div class="form-group">
                       <label class="form-label">Domain URL</label>
<input type="text" class="form-input" id="articleUrl" placeholder="example.com/blog" required>
                   </div>
                   <div class="form-group">
                       <label class="form-label">Article Title</label>
                       <input type="text" class="form-input" id="articleSubject" placeholder="Your article title" required>
                   </div>
                   <div class="form-group">
                       <label class="form-label">Article Content (HTML)</label>
                       <textarea class="form-input" id="articleBody" rows="10" placeholder="<p>Your article content...</p>" required></textarea>
                   </div>
                   <div class="form-group">
                       <label class="form-label">Images</label>
                       <input type="file" class="form-input" id="articleImages" multiple accept="image/*">
                   </div>
                   <button type="submit" class="btn-primary">Publish Article</button>
               </form>
           `;
           break;

       case 'domain':
           title.textContent = 'Add New Domain';
           body.innerHTML = `
               <form id="domainForm">
                   <div class="form-group">
                       <label class="form-label">Domain URL</label>
                       <input type="text" class="form-input" id="domainUrl" placeholder="example.com/blog" required>
                   </div>
                   <div class="form-group">
                       <small style="color:var(--text-light)">
                           After adding, you'll need to verify ownership by adding a TXT record to your DNS.
                       </small>
                   </div>
                   <button type="submit" class="btn-primary">Add Domain</button>
               </form>
           `;
           break;
   }

   showModal('uploadModal');
   setupUploadForms();
}

function showPlanModal() {
   showModal('planModal');
}

// Form handling
function setupUploadForms() {
   // Image upload form
   const imageForm = document.getElementById('imageUploadForm');
   if (imageForm) {
       imageForm.addEventListener('submit', async (e) => {
           e.preventDefault();
           await uploadImages();
       });
   }

   // Article upload form
   const articleForm = document.getElementById('articleUploadForm');
   if (articleForm) {
       articleForm.addEventListener('submit', async (e) => {
           e.preventDefault();
           await uploadArticle();
       });
   }

   // Domain form
   const domainForm = document.getElementById('domainForm');
   if (domainForm) {
       domainForm.addEventListener('submit', async (e) => {
           e.preventDefault();
           await addDomain();
       });
   }
}

function handleFileSelect(input) {
   const files = Array.from(input.files);
   const container = document.getElementById('selectedFiles');

   container.innerHTML = files.map(file => `
       <div style="display:flex;justify-content:space-between;align-items:center;padding:.5rem;background:var(--bg-light);margin:.5rem 0;border-radius:var(--radius)">
           <span>${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)</span>
           <button type="button" onclick="removeFile(this, '${file.name}')" style="background:none;border:none;color:var(--error);cursor:pointer">×</button>
       </div>
   `).join('');
}

// Upload functions
async function uploadImages() {
   const token = getCookie('session_token');
   const files = document.getElementById('imageFiles').files;

   if (!files.length) {
       alert('Please select images to upload');
       return;
   }

   const formData = new FormData();
   for (let file of files) {
       formData.append('file', file);
   }

   const progress = document.getElementById('uploadProgress');
   const progressFill = document.getElementById('progressFill');
   const progressText = document.getElementById('progressText');

   progress.style.display = 'block';

   try {
       const xhr = new XMLHttpRequest();

       xhr.upload.onprogress = (e) => {
           if (e.lengthComputable) {
               const percentComplete = (e.loaded / e.total) * 100;
               progressFill.style.width = percentComplete + '%';
               progressText.textContent = `Uploading... ${Math.round(percentComplete)}%`;
           }
       };

       xhr.onload = () => {
           if (xhr.status === 200) {
               const result = JSON.parse(xhr.responseText);
               if (result.status === 'success') {
                   alert(`${result.data.uploaded_images.length} images uploaded successfully!`);
                   closeModal('uploadModal');
                   populateImages(result.data.uploaded_images);
                   // Refresh images
                   fetchImages(token).then(data => {
                       if (data) populateImages(data.images || []);
                   });
               } else {
                   alert(result.error?.message || 'Upload failed');
               }
           } else {
               alert('Upload failed');
           }
           progress.style.display = 'none';
       };

       xhr.onerror = () => {
           alert('Upload failed');
           progress.style.display = 'none';
       };

       xhr.open('POST', `${baseUrl}/images/upload`);
       xhr.setRequestHeader('Session-Token', token);
       xhr.send(formData);

   } catch (e) {
       console.error('Upload error:', e);
       alert('Upload failed');
       progress.style.display = 'none';
   }
}

async function uploadArticle() {
   const token = getCookie('session_token');
   const formData = new FormData();

   formData.append('url', document.getElementById('articleUrl').value);
   formData.append('subject', document.getElementById('articleSubject').value);
   formData.append('body', document.getElementById('articleBody').value);

   const files = document.getElementById('articleImages').files;
   for (let file of files) {
       formData.append('image_data', file);
   }

   try {
       const res = await fetch(`${baseUrl}/add-article`, {
           method: 'POST',
           headers: { 'Session-Token': token },
           body: formData
       });

       const result = await res.json();
       if (result.status === 'success') {
           alert('Article published successfully!');
           closeModal('uploadModal');
           // Refresh articles
           fetchArticles(token).then(data => {
               if (data) populateArticles(data.articles || []);
           });
       } else {
           alert(result.error?.message || 'Failed to publish article');
       }
   } catch (e) {
       console.error('Article upload error:', e);
       alert('Failed to publish article');
   }
}

async function addDomain() {
   const token = getCookie('session_token');
   const url = document.getElementById('domainUrl').value;

   try {
       const res = await fetch(`${baseUrl}/add-domain`, {
           method: 'POST',
           headers: {
               'Content-Type': 'application/json',
               'Session-Token': token
           },
           body: JSON.stringify({ url })
       });

       const result = await res.json();
       if (result.status === 'success') {
           alert(result.data.message);
           if (result.data.txt_record) {
               alert(`Please add this TXT record to your DNS:\n${result.data.txt_record}`);
           }
           closeModal('uploadModal');
           loadDomains();
       } else {
           alert(result.error?.message || 'Failed to add domain');
       }
   } catch (e) {
       console.error('Domain add error:', e);
       alert('Failed to add domain');
   }
}

// Load domains (placeholder - API doesn't have list endpoint)
async function loadDomains() {
   const container = document.getElementById('domainsList');
   container.innerHTML = '<p style="text-align:center;color:var(--text-light);padding:2rem">Domains will appear here after you add and verify them.</p>';
}

// Task form submission
document.addEventListener('DOMContentLoaded', () => {
   const taskForm = document.getElementById('taskForm');
   if (taskForm) {
       taskForm.addEventListener('submit', async (e) => {
           e.preventDefault();
           const token = getCookie('session_token');

           const locations = document.getElementById('taskLocations').value.trim();
           const htmlLocations = locations ? locations.split(',').map(l => l.trim()) : ['/html/body//a'];

           const formData = {
               task_details: {
                   url: document.getElementById('taskUrl').value,
                   keywords: document.getElementById('taskKeywords').value.split(',').map(k => k.trim()),
                   html_locations: htmlLocations
               },
               task_priority: document.getElementById('taskPriority').value,
               total_charge: parseInt(document.getElementById('taskCharge').value),
               provider: 'stripe',
               is_subscription: false,
               cancel_previous: false
           };

           try {
               const res = await fetch(`${baseUrl}/add-task`, {
                   method: 'POST',
                   headers: {
                       'Content-Type': 'application/json',
                       'Session-Token': token
                   },
                   body: JSON.stringify(formData)
               });

               const result = await res.json();
               if (result.status === 'success') {
                   alert('Task created! Redirecting to payment...');
                   window.open(result.data.payment_url, '_blank');
                   hideTaskForm();
                   taskForm.reset();
                   loadTasks();
               } else {
                   alert(result.error?.message || 'Failed to create task');
               }
           } catch (e) {
               console.error('Failed to create task:', e);
               alert('Network error occurred');
           }
       });
   }
});

// Task management functions
function showTaskForm() {
   document.getElementById('taskFormCard').style.display = 'block';
}

function hideTaskForm() {
   document.getElementById('taskFormCard').style.display = 'none';
}

async function viewTask(taskId) {
   const token = getCookie('session_token');
   try {
       const res = await fetch(`${baseUrl}/get-task-details`, {
           method: 'POST',
           headers: {
               'Content-Type': 'application/json',
               'Session-Token': token
           },
           body: JSON.stringify({ task_id: taskId })
       });

       const result = await res.json();
       if (result.status === 'success') {
           const task = result.data;
           document.getElementById('taskModalBody').innerHTML = `
               <div class="stats-grid" style="grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.5rem">
                   <div>
                       <strong>URL:</strong><br>
                       <a href="${task.url}" target="_blank" style="color:var(--primary)">${task.url}</a>
                   </div>
                   <div>
                       <strong>Created:</strong><br>
                       ${task.date_created}
                   </div>
                   <div>
                       <strong>Total Budget:</strong><br>
                       $${task.total_charge}
                   </div>
                   <div>
                       <strong>Remaining:</strong><br>
                       $${task.available_charge}
                   </div>
               </div>

               <div style="margin-bottom:1.5rem">
                   <strong>Keywords:</strong><br>
                   ${task.keywords?.map(kw => `<span class="badge badge-primary">${kw}</span>`).join(' ') || 'N/A'}
               </div>

               <div style="margin-bottom:1.5rem">
                   <strong>HTML Locations:</strong><br>
                   ${task.html_locations?.map(loc => `<code style="background:var(--bg-light);padding:.25rem .5rem;border-radius:.25rem;font-size:.875rem">${loc}</code>`).join('<br>') || 'Default'}
               </div>

               ${task.country_visits ? `
                   <div style="margin-bottom:1.5rem">
                       <strong>Views by Country:</strong><br>
                       <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:.5rem;margin-top:.5rem">
                           ${Object.entries(task.country_visits).map(([country, visits]) =>
                               `<div style="text-align:center;padding:.5rem;background:var(--bg-light);border-radius:.25rem">
                                   <div style="font-weight:600">${country}</div>
                                   <div style="color:var(--text-light)">${visits} views</div>
                               </div>`
                           ).join('')}
                       </div>
                   </div>
               ` : ''}

               ${task.views_by_date ? `
                   <div>
                       <strong>Daily Views:</strong><br>
                       <div style="max-height:150px;overflow-y:auto;margin-top:.5rem">
                           ${Object.entries(task.views_by_date).map(([date, views]) =>
                               `<div style="display:flex;justify-content:space-between;padding:.25rem 0;border-bottom:1px solid var(--border)">
                                   <span>${date}</span>
                                   <span>${views} views</span>
                               </div>`
                           ).join('')}
                       </div>
                   </div>
               ` : ''}

               <div style="display:flex;gap:1rem;margin-top:2rem">
                   <button class="btn-primary" onclick="rechargeTask('${taskId}')">Recharge Task</button>
                   <button class="btn" onclick="closeModal('taskModal')">Close</button>
               </div>
           `;
           showModal('taskModal');
       } else {
           alert('Failed to load task details');
       }
   } catch (e) {
       console.error('Failed to view task:', e);
       alert('Network error occurred');
   }
}

async function rechargeTask(taskId) {
   const amount = prompt('Enter recharge amount ($):');
   if (!amount || isNaN(amount)) return;

   const token = getCookie('session_token');
   try {
       const res = await fetch(`${baseUrl}/recharge`, {
           method: 'POST',
           headers: {
               'Content-Type': 'application/json',
               'Session-Token': token
           },
           body: JSON.stringify({
               task_ids: [taskId],
               payment_method: 'stripe',
               cancel_previous: false
           })
       });

       const result = await res.json();
       if (result.status === 'success') {
           alert('Redirecting to payment...');
           window.open(result.data.payment_url, '_blank');
           closeModal('taskModal');
       } else {
           alert(result.error?.message || 'Failed to create recharge');
       }
   } catch (e) {
       console.error('Failed to recharge task:', e);
       alert('Network error occurred');
   }
}

// Hosting management functions
async function upgradePlan(planName) {
   const token = getCookie('session_token');
   try {
       const res = await fetch(`${baseUrl}/hosting/buy-package`, {
           method: 'POST',
           headers: {
               'Content-Type': 'application/json',
               'Session-Token': token
           },
           body: JSON.stringify({
               package: planName,
               provider: 'stripe',
               duration: '3month',
               subscription: true,
               cancel_previous: false,
               cancel_current_plan: false
           })
       });

       const result = await res.json();
       if (result.status === 'success') {
           alert('Redirecting to payment...');
           window.open(result.data.payment_url, '_blank');
           closeModal('planModal');
       } else {
           alert(result.error?.message || 'Failed to create payment session');
       }
   } catch (e) {
       console.error('Plan upgrade error:', e);
       alert('Failed to upgrade plan');
   }
}

async function deleteImage(imageId) {
   if (!confirm('Are you sure you want to delete this image?')) return;

   const token = getCookie('session_token');
   try {
       const res = await fetch(`${baseUrl}/images`, {
           method: 'DELETE',
           headers: {
               'Content-Type': 'application/json',
               'Session-Token': token
           },
           body: JSON.stringify({ image_ids: [imageId] })
       });

       const result = await res.json();
       if (result.status === 'success') {
           alert('Image deleted successfully');
           // Refresh images
           fetchImages(token).then(data => {
               if (data) populateImages(data.images || []);
           });
       } else {
           alert(result.error?.message || 'Failed to delete image');
       }
   } catch (e) {
       console.error('Delete image error:', e);
       alert('Failed to delete image');
   }
}

async function deleteArticle(articleId) {
   if (!confirm('Are you sure you want to delete this article?')) return;

   const token = getCookie('session_token');
   try {
       const res = await fetch(`${baseUrl}/delete-article/${articleId}`, {
           method: 'DELETE',
           headers: { 'Session-Token': token }
       });

       const result = await res.json();
       if (result.status === 'success') {
           alert('Article deleted successfully');
           // Refresh articles
           fetchArticles(token).then(data => {
               if (data) populateArticles(data.articles || []);
           });
       } else {
           alert(result.error?.message || 'Failed to delete article');
       }
   } catch (e) {
       console.error('Delete article error:', e);
       alert('Failed to delete article');
   }
}

async function viewPayment(paymentId) {
   const token = getCookie('session_token');
   try {
       const res = await fetch(`${baseUrl}/get-payment-status?payment_id=${paymentId}`, {
           headers: { 'Session-Token': token }
       });

       const result = await res.json();
       if (result.status === 'success') {
           const payment = result.data;
           alert(`Payment Details:
Type: ${payment.type}
Amount: $${payment.amount}
Status: ${payment.status}
Date: ${payment.date_of_payment}
Transaction: ${payment.transaction_id}`);
       } else {
           alert('Failed to load payment details');
       }
   } catch (e) {
       console.error('View payment error:', e);
       alert('Failed to load payment details');
   }
}

// Utility functions
function copyToClipboard(text) {
   navigator.clipboard.writeText(text).then(() => {
       alert('URL copied to clipboard!');
   }).catch(() => {
       alert('Failed to copy URL');
   });
}

function animateStat(id, value, isCurrency = false) {
   const element = document.getElementById(id);
   if (!element) return;

   const formattedValue = isCurrency ? `$${value}` : value;

   gsap.to(element, {
       duration: 1.5,
       textContent: formattedValue,
       ease: 'power2.inOut'
   });
}

// Setup event listeners
function setupListeners() {
   document.getElementById('themeToggle').onclick = toggleTheme;
   document.getElementById('logoutBtn').onclick = logout;

   // Close modals when clicking outside
   document.querySelectorAll('.modal').forEach(modal => {
       modal.addEventListener('click', (e) => {
           if (e.target === modal) {
               modal.classList.remove('active');
           }
       });
   });
}

// Theme management
function toggleTheme() {
   document.body.classList.toggle('dark');
   localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
}

function loadTheme() {
   if (localStorage.getItem('theme') === 'dark') {
       document.body.classList.add('dark');
   }
}

// Logout function
function logout() {
   const token = getCookie('session_token');
   if (token) {
       fetch(`${baseUrl}/logout`, {
           headers: { 'Session-Token': token }
       }).catch(e => console.error('Logout error:', e));
   }

   document.cookie = 'session_token=;path=/;expires=Thu, 01 Jan 1970 00:00:00 GMT';
   window.location.href = 'login.html';
}

// Animation runner
function runAnimations() {
   const overlay = document.getElementById('loadingOverlay');
   gsap.timeline({ defaults: { ease: 'power3.out' } })
       .to('.sidebar', { x: '0%', duration: 0.8, delay: 0.2 })
       .from(
           '.main-header, .stat-card, .tasks-header',
           { opacity: 0, y: 30, duration: 0.6, stagger: 0.1 },
           '-=0.5'
       )
       .to(overlay, {
           opacity: 0,
           duration: 0.5,
           onComplete: () => (overlay.style.display = 'none')
       });
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', () => {
   setTimeout(loadTasks, 1000);
});
</script>
</body>
</html>
