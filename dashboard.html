<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEOTIZE Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--radius:12px;--shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06)}
[data-theme="dark"]{--bg:#0f172a;--sidebar:#1e293b;--card:#1e293b;--text:#e2e8f0;--text-light:#94a3b8;--border:#334155;--primary:#3b82f6;--primary-hover:#2563eb;--secondary:#10b981;--error:#ef4444;--warning:#f59e0b;--success:#10b981;--input-bg:#0f172a}
[data-theme="light"]{--bg:#f8fafc;--sidebar:#ffffff;--card:#ffffff;--text:#1e293b;--text-light:#64748b;--border:#e2e8f0;--primary:#3b82f6;--primary-hover:#2563eb;--secondary:#10b981;--error:#ef4444;--warning:#f59e0b;--success:#10b981;--input-bg:#f1f5f9}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);display:flex;height:auto;overflow:hidden;transition:all .3s}

/* Layout */
.sidebar{width:260px;background:var(--sidebar);padding:1.5rem;display:flex;flex-direction:column;border-right:1px solid var(--border);transition:transform .3s}
.main{flex:1;overflow-y:auto;padding:2rem}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem}

/* Components */
.logo{font-size:1.5rem;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:2rem}
.nav-item{display:flex;align-items:center;gap:.75rem;padding:.875rem 1rem;border-radius:var(--radius);color:var(--text-light);font-weight:500;transition:all .2s;margin-bottom:.5rem;cursor:pointer}
.nav-item:hover{background:rgba(59,130,246,0.1);color:var(--primary)}
.nav-item.active{background:var(--primary);color:white}
.nav-item.active:hover{background:var(--primary-hover)}

.theme-toggle{width:40px;height:40px;border-radius:var(--radius);background:var(--card);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s}
.theme-toggle:hover{border-color:var(--primary)}

.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:1.5rem}
.card-header{padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.card-body{padding:1.5rem}

.btn{padding:.5rem 1rem;border-radius:var(--radius);font-weight:500;cursor:pointer;transition:all .2s;border:1px solid var(--border);background:transparent;color:var(--text);display:inline-flex;align-items:center;gap:.5rem}
.btn:hover{border-color:var(--primary);color:var(--primary)}
.btn-primary{background:var(--primary);color:white;border:none}
.btn-primary:hover{background:var(--primary-hover)}
.btn-sm{padding:.375rem .75rem;font-size:.875rem}
.btn-icon{width:36px;height:36px;padding:0;justify-content:center}

.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-bottom:1.5rem}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--primary),var(--secondary))}
.stat-value{font-size:1.75rem;font-weight:700;margin:.5rem 0}
.stat-label{font-size:.875rem;color:var(--text-light)}
.stat-change{font-size:.75rem;color:var(--success);margin-top:.25rem}

.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:.875rem;text-align:left;border-bottom:1px solid var(--border)}
.table th{font-weight:600;color:var(--text-light);font-size:.875rem}
.table tr:hover{background:rgba(59,130,246,0.05)}

.badge{padding:.25rem .75rem;border-radius:20px;font-size:.75rem;font-weight:600;display:inline-flex;align-items:center;gap:.25rem}
.badge-primary{background:rgba(59,130,246,0.2);color:var(--primary)}
.badge-success{background:rgba(16,185,129,0.2);color:var(--success)}
.badge-warning{background:rgba(245,158,11,0.2);color:var(--warning)}
.badge-error{background:rgba(239,68,68,0.2);color:var(--error)}

.progress-bar{height:6px;background:var(--border);border-radius:3px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--secondary),var(--primary));transition:width .3s}

.modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1000}
.modal.show{display:flex}
.modal-content{background:var(--card);border-radius:var(--radius);max-width:90%;width:600px;max-height:90vh;overflow-y:auto}
.modal-header{padding:1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.modal-body{padding:1.5rem}

.form-group{margin-bottom:1.25rem}
.form-label{display:block;margin-bottom:.5rem;font-weight:500;font-size:.875rem}
.form-input,.form-select,.form-textarea{width:100%;padding:.75rem;border:1px solid var(--border);border-radius:var(--radius);background:var(--input-bg);color:var(--text);transition:all .2s}
.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
.form-textarea{resize:vertical;min-height:100px}

.toast{position:fixed;bottom:2rem;right:2rem;padding:1rem 1.5rem;border-radius:var(--radius);color:white;font-weight:500;transform:translateX(400px);transition:transform .3s;z-index:1000}
.toast.show{transform:translateX(0)}
.toast.success{background:var(--success)}
.toast.error{background:var(--error)}
.toast.warning{background:var(--warning)}

.tabs{display:flex;gap:1rem;border-bottom:1px solid var(--border);margin-bottom:1.5rem}
.tab{padding:.75rem 1.5rem;border-bottom:2px solid transparent;color:var(--text-light);cursor:pointer;transition:all .2s}
.tab:hover{color:var(--text)}
.tab.active{color:var(--primary);border-bottom-color:var(--primary)}

.section{display:none}
.section.active{display:block}

.loader{display:inline-block;width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

.empty-state{text-align:center;padding:3rem;color:var(--text-light)}
.empty-state svg{width:64px;height:64px;margin:0 auto 1rem;opacity:0.3}

/* Task Specific */
.task-item{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem;margin-bottom:1rem;cursor:pointer;transition:all .2s}
.task-item:hover{border-color:var(--primary);transform:translateY(-2px);box-shadow:var(--shadow)}

.keyword-grid{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:1rem}
.keyword-item{padding:.5rem 1rem;border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;transition:all .2s}
.keyword-item:hover{border-color:var(--primary);background:rgba(59,130,246,0.1)}
.keyword-item.selected{background:var(--primary);color:white;border-color:var(--primary)}

.location-preview{border:1px solid var(--border);border-radius:var(--radius);height:400px;overflow:hidden;position:relative;margin-bottom:1rem}
.location-preview iframe{width:100%;height:100%;border:0}
.location-overlay{position:absolute;inset:0;pointer-events:none}
.location-marker{position:absolute;width:20px;height:20px;background:var(--primary);border:2px solid white;border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 2px 4px rgba(0,0,0,0.2)}

/* Image/Article Grid */
.media-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1rem}
.media-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;transition:all .2s}
.media-card:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
.media-preview{height:150px;background:#000;display:flex;align-items:center;justify-content:center;overflow:hidden}
.media-preview img{width:100%;height:100%;object-fit:cover}
.media-info{padding:1rem}

.analytics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1.5rem}
.chart-container{height:300px;position:relative}

/* Domain Verification */
.domain-item{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid var(--border);background:var(--card);border-radius:var(--radius);margin-bottom:.5rem}
.domain-status{display:flex;align-items:center;gap:.5rem}

/* Drag & Drop */
.dropzone{border:2px dashed var(--border);border-radius:var(--radius);padding:2rem;text-align:center;cursor:pointer;transition:all .2s}
.dropzone:hover{border-color:var(--primary);background:rgba(59,130,246,0.05)}
.dropzone.active{border-color:var(--primary);background:rgba(59,130,246,0.1)}

/* Mobile */
.mobile-toggle{display:none;position:fixed;top:1rem;left:1rem;z-index:100;width:40px;height:40px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);align-items:center;justify-content:center;cursor:pointer}

@media(max-width:768px){
    .mobile-toggle{display:flex}
    .sidebar{position:fixed;z-index:99;height:100%;transform:translateX(-100%)}
    .sidebar.show{transform:translateX(0)}
    .main{padding:1rem}
    .stat-grid{grid-template-columns:1fr 1fr}
    .analytics-grid{grid-template-columns:1fr}
    .modal-content{width:95%}
}
</style>
</head>
<body data-theme="dark">
    <button class="mobile-toggle" onclick="toggleSidebar()">‚ò∞</button>

    <aside class="sidebar">
        <div class="logo">SEOTIZE</div>
        <nav>
            <div class="nav-item active" data-section="dashboard">
                <span>üìä</span> Dashboard
            </div>
            <div class="nav-item" data-section="tasks">
                <span>üéØ</span> SEO Tasks
            </div>
            <div class="nav-item" data-section="hosting">
                <span>üåê</span> Hosting
            </div>
            <div class="nav-item" data-section="billing">
                <span>üí≥</span> Billing
            </div>
            <div class="nav-item" data-section="tools">
                <span>üõ†Ô∏è</span> SEO Tools
            </div>
        </nav>
        <div style="margin-top:auto;padding-top:1.5rem;border-top:1px solid var(--border)">
            <div style="display:flex;align-items:center;gap:.75rem;margin-bottom:1rem">
                <div style="width:40px;height:40px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;font-weight:600" id="userAvatar">U</div>
                <div style="flex:1">
                    <div id="userEmail" style="font-size:.875rem;font-weight:500">Loading...</div>
                    <div id="userSince" style="font-size:.75rem;color:var(--text-light)"></div>
                </div>
            </div>
            <button class="btn" style="width:100%" onclick="logout()">Logout</button>
        </div>
    </aside>

    <main class="main">
        <div class="header">
            <h1 id="sectionTitle">Dashboard</h1>
            <button class="theme-toggle" onclick="toggleTheme()">üåì</button>
        </div>

        <!-- Dashboard Section -->
        <section class="section active" id="dashboard">
            <div class="stat-grid" id="dashboardStats"></div>

            <div class="analytics-grid">
                <div class="card">
                    <div class="card-header">
                        <h3>Recent Tasks Performance</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="tasksChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Views by Country</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="countryChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Active Sessions</h3>
                    <span class="badge badge-primary" id="sessionCount">0 Active</span>
                </div>
                <div class="card-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Location</th>
                                <th>IP Address</th>
                                <th>Created</th>
                                <th>Expires</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="sessionsTable"></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Recent Activity</h3>
                    <button class="btn btn-sm" onclick="showSection('tasks')">View All Tasks</button>
                </div>
                <div class="card-body" id="recentActivity"></div>
            </div>
        </section>

        <!-- Tasks Section -->
        <section class="section" id="tasks">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem">
                <div class="stat-grid" style="flex:1;margin:0">
                    <div class="stat-card">
                        <div class="stat-label">Active Tasks</div>
                        <div class="stat-value" id="activeTasksCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Views</div>
                        <div class="stat-value" id="totalViewsCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Available Budget</div>
                        <div class="stat-value" id="availableBudget">$0</div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="showTaskModal()">
                    <span>‚ûï</span> Create New Task
                </button>
            </div>

            <div class="card">
                <div class="card-body" id="tasksList">
                    <div class="loader"></div>
                </div>
            </div>

            <div class="card" id="taskDetails" style="display:none">
                <div class="card-header">
                    <h3>Task Analytics</h3>
                    <button class="btn btn-sm" onclick="closeTaskDetails()">Close</button>
                </div>
                <div class="card-body" id="taskDetailsContent"></div>
            </div>
        </section>

        <!-- Hosting Section -->
        <section class="section" id="hosting">
            <div class="tabs">
                <div class="tab active" onclick="showHostingTab('overview')">Overview</div>
                <div class="tab" onclick="showHostingTab('images')">Images</div>
                <div class="tab" onclick="showHostingTab('articles')">Articles</div>
            </div>

            <div class="section active" id="hosting-overview">
                <div class="stat-grid" id="hostingStats"></div>
                <div class="card">
                    <div class="card-header">
                        <h3>Current Plan Details</h3>
                        <button class="btn btn-primary" onclick="showUpgradeModal()">Upgrade Plan</button>
                    </div>
                    <div class="card-body" id="planDetails"></div>
                </div>
            </div>

            <div class="section" id="hosting-images">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
                    <h2>Image Management</h2>
                    <button class="btn btn-primary" onclick="showImageUploadModal()">Upload Images</button>
                </div>
                <div class="media-grid" id="imageGrid"></div>
            </div>

            <div class="section" id="hosting-articles">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
                    <h2>Article Management</h2>
                    <button class="btn btn-primary" onclick="showArticleModal()">Create Article</button>
                </div>

                <div class="card" style="margin-bottom:1.5rem">
                    <div class="card-header">
                        <h3>Domain Verification</h3>
                        <button class="btn btn-sm" onclick="showDomainModal()">Add Domain</button>
                    </div>
                    <div class="card-body" id="domainsList"></div>
                </div>

                <div id="articlesList"></div>
            </div>
        </section>

        <!-- Billing Section -->
        <section class="section" id="billing">
            <div class="stat-grid" id="billingStats"></div>

            <div class="analytics-grid">
                <div class="card">
                    <div class="card-header">
                        <h3>Spending Overview</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="spendingChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Payment Distribution</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="paymentChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Transaction History</h3>
                    <select class="form-select" style="width:auto" onchange="loadBilling(1,this.value)">
                        <option value="all">All Types</option>
                        <option value="tasks">Tasks Only</option>
                        <option value="hosting">Hosting Only</option>
                    </select>
                </div>
                <div class="card-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="billingTable"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- SEO Tools Section -->
        <section class="section" id="tools">
            <div class="card">
                <div class="card-header">
                    <h3>Keyword Research</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Enter URL for keyword analysis</label>
                        <div style="display:flex;gap:1rem">
                            <input type="url" class="form-input" id="keywordUrl" placeholder="https://example.com">
                            <button class="btn btn-primary" onclick="analyzeKeywords()">Analyze</button>
                        </div>
                    </div>
                    <div id="keywordResults"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>SERP Position Checker</h3>
                </div>
                <div class="card-body">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
                        <div class="form-group">
                            <label class="form-label">Keyword</label>
                            <input type="text" class="form-input" id="serpKeyword" placeholder="SEO optimization">
                        </div>
                        <div class="form-group">
                            <label class="form-label">URL</label>
                            <input type="url" class="form-input" id="serpUrl" placeholder="example.com">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="checkSerpPosition()">Check Position</button>
                    <div id="serpResults" style="margin-top:1.5rem"></div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modals -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Modal</h3>
                <button class="btn-icon" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

<script>
const API_BASE = 'https://api.seotize.net';
let sessionToken = getCookie('session_token');
let currentData = {};
let charts = {};

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    if (!sessionToken) {
        window.location.href = '/login.html';
        return;
    }
    setupNavigation();
    loadDashboard();
});

// Navigation & UI
function setupNavigation() {
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
            const section = item.dataset.section;
            showSection(section);
        });
    });
}

function showSection(section) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

    document.getElementById(section).classList.add('active');
    document.querySelector(`[data-section="${section}"]`).classList.add('active');
    document.getElementById('sectionTitle').textContent = section.charAt(0).toUpperCase() + section.slice(1);

    // Load section data
    switch(section) {
        case 'dashboard': loadDashboard(); break;
        case 'tasks': loadTasks(); break;
        case 'hosting': loadHosting(); break;
        case 'billing': loadBilling(); break;
    }

    if (window.innerWidth <= 768) {
        document.querySelector('.sidebar').classList.remove('show');
    }
}

function toggleTheme() {
    const theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
    document.body.dataset.theme = theme;
    localStorage.setItem('theme', theme);
}

function toggleSidebar() {
    document.querySelector('.sidebar').classList.toggle('show');
}

// API Helper
async function api(endpoint, options = {}) {
    try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
            ...options,
            headers: {
                'Session-Token': sessionToken,
                'Content-Type': 'application/json',
                ...(options.headers || {})
            }
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error?.message || 'API Error');
        return data;
    } catch (error) {
        showToast(error.message, 'error');
        throw error;
    }
}

// Dashboard
async function loadDashboard() {
    try {
        const { data } = await api('/users/dashboard?page=1&page_size=10');
        const user = data.user;
        currentData.user = user;

        // Update user info
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('userAvatar').textContent = user.email[0].toUpperCase();
        document.getElementById('userSince').textContent = `Member since ${new Date(user.created_at).toLocaleDateString()}`;

        // Stats
        const stats = [
            { label: 'Active Tasks', value: user.usage_summary?.active_tasks || 0, change: '+12%' },
            { label: 'Total Views', value: (user.task_statistics?.total_views || 0).toLocaleString(), change: '+8%' },
            { label: 'Total Keywords', value: user.task_statistics?.total_keywords || 0 },
            { label: 'Total Spent', value: `$${(user.task_statistics?.total_charge || 0).toFixed(2)}` },
            { label: 'Available Budget', value: `$${(user.task_statistics?.available_charge || 0).toFixed(2)}` },
            { label: 'Hosting Plan', value: (user.hosting?.type || 'free').toUpperCase(), change: user.hosting?.expiry_date ? `Expires ${new Date(user.hosting.expiry_date).toLocaleDateString()}` : '' }
        ];

        document.getElementById('dashboardStats').innerHTML = stats.map(stat => `
            <div class="stat-card">
                <div class="stat-label">${stat.label}</div>
                <div class="stat-value">${stat.value}</div>
                ${stat.change ? `<div class="stat-change">${stat.change}</div>` : ''}
            </div>
        `).join('');

        // Sessions
        document.getElementById('sessionCount').textContent = `${user.sessions?.length || 0} Active`;
        document.getElementById('sessionsTable').innerHTML = (user.sessions || []).map(session => `
            <tr>
                <td><span class="badge badge-primary">${session.country_code}</span></td>
                <td>${session.ip_address}</td>
                <td>${new Date(session.timestamp).toLocaleString()}</td>
                <td>${new Date(session.expires_at).toLocaleString()}</td>
                <td><button class="btn btn-sm" onclick="revokeSession('${session.token}')">Revoke</button></td>
            </tr>
        `).join('');

        // Recent Activity
        const recentTasks = (user.tasks || []).slice(0, 5);
        document.getElementById('recentActivity').innerHTML = recentTasks.length ? recentTasks.map(task => `
            <div class="task-item" onclick="viewTask('${task._id}')">
                <div style="display:flex;justify-content:space-between;align-items:start">
                    <div>
                        <div style="font-weight:600">${task.url}</div>
                        <div style="font-size:.875rem;color:var(--text-light);margin-top:.25rem">
                            ${task.keywords_count} keywords ‚Ä¢ ${task.views_count} views ‚Ä¢ $${task.total_charge}
                        </div>
                    </div>
                    <div style="text-align:right">
                        <div class="badge badge-${task.remaining_percentage > 50 ? 'success' : task.remaining_percentage > 20 ? 'warning': 'error'}">
                            ${task.remaining_percentage}% remaining
                        </div>
                        <div class="progress-bar" style="width:100px;margin-top:.5rem">
                            <div class="progress-fill" style="width:${task.remaining_percentage}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        `).join('') : '<div class="empty-state"><p>No active tasks yet</p></div>';

        // Charts
        createDashboardCharts(user);

    } catch (error) {
        console.error('Dashboard error:', error);
    }
}

function createDashboardCharts(user) {
    // Tasks Performance Chart
    const taskData = (user.tasks || []).map(task => ({
        label: new URL(task.url).hostname,
        views: task.views_count,
        budget: task.available_charge
    }));

    if (charts.tasks) charts.tasks.destroy();
    const ctx1 = document.getElementById('tasksChart').getContext('2d');
    charts.tasks = new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: taskData.map(t => t.label),
            datasets: [{
                label: 'Views',
                data: taskData.map(t => t.views),
                backgroundColor: 'rgba(59, 130, 246, 0.8)'
            }, {
                label: 'Budget Remaining',
                data: taskData.map(t => t.budget),
                backgroundColor: 'rgba(16, 185, 129, 0.8)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
        }
    });

    // Country Distribution
    const countryData = {};
    user.tasks?.forEach(task => {
        if (task.country_visits) {
            Object.entries(task.country_visits).forEach(([country, visits]) => {
                countryData[country] = (countryData[country] || 0) + visits;
            });
        }
    });

    if (Object.keys(countryData).length) {
        if (charts.country) charts.country.destroy();
        const ctx2 = document.getElementById('countryChart').getContext('2d');
        charts.country = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: Object.keys(countryData),
                datasets: [{
                    data: Object.values(countryData),
                    backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' }
                }
            }
        });
    }
}

// Tasks Management
async function loadTasks() {
    try {
        const { data } = await api('/users/dashboard?page=1&page_size=50');
        const user = data.user;
        currentData.tasks = user.tasks || [];

        // Update stats
        document.getElementById('activeTasksCount').textContent = user.usage_summary?.active_tasks || 0;
        document.getElementById('totalViewsCount').textContent = (user.task_statistics?.total_views || 0).toLocaleString();
        document.getElementById('availableBudget').textContent = `$${(user.task_statistics?.available_charge || 0).toFixed(2)}`;

        // Tasks list
        const tasksList = document.getElementById('tasksList');
        if (currentData.tasks.length) {
            tasksList.innerHTML = currentData.tasks.map(task => `
                <div class="task-item" onclick="viewTask('${task._id}')">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div style="flex:1">
                            <h4 style="margin:0 0 .5rem">${task.url}</h4>
                            <div style="display:flex;gap:1rem;flex-wrap:wrap">
                                <span class="badge badge-primary">${task.keywords_count} keywords</span>
                                <span class="badge badge-success">${task.views_count} views</span>
                                <span class="badge badge-warning">$${task.total_charge} budget</span>
                                <span class="badge badge-${task.task_priority === 0.15 ? 'error' : task.task_priority === 0.12 ? 'warning' : 'primary'}">
                                    ${task.task_priority === 0.15 ? 'Premium' : task.task_priority === 0.12 ? 'Standard' : 'Basic'}
                                </span>
                            </div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-size:1.5rem;font-weight:700;color:var(--primary)">${task.remaining_percentage}%</div>
                            <div style="font-size:.875rem;color:var(--text-light)">remaining</div>
                            <button class="btn btn-sm" style="margin-top:.5rem" onclick="event.stopPropagation();rechargeTask('${task._id}')">Recharge</button>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            tasksList.innerHTML = `
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    <p>No SEO tasks created yet</p>
                    <button class="btn btn-primary" onclick="showTaskModal()">Create Your First Task</button>
                </div>
            `;
        }
    } catch (error) {
        console.error('Tasks error:', error);
    }
}

async function viewTask(taskId) {
    try {
        const { data } = await api('/get-task-details', {
            method: 'POST',
            body: JSON.stringify({ task_id: taskId })
        });

        document.getElementById('taskDetails').style.display = 'block';
        document.getElementById('taskDetailsContent').innerHTML = `
            <div class="stat-grid" style="margin-bottom:1.5rem">
                <div class="stat-card">
                    <div class="stat-label">Total Budget</div>
                    <div class="stat-value">$${data.total_charge}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Remaining</div>
                    <div class="stat-value">$${data.available_charge}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Views</div>
                    <div class="stat-value">${data.views_count || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Keywords</div>
                    <div class="stat-value">${data.keywords?.length || 0}</div>
                </div>
            </div>

            <div style="margin-bottom:1.5rem">
                <h4>Task Information</h4>
                <div style="display:grid;gap:.5rem;margin-top:1rem">
                    <div><strong>URL:</strong> <a href="${data.url}" target="_blank" style="color:var(--primary)">${data.url}</a></div>
                    <div><strong>Created:</strong> ${new Date(data.date_created).toLocaleString()}</div>
                    <div><strong>Priority:</strong> ${data.task_priority === 0.15 ? 'Premium ($0.15/click)' : data.task_priority === 0.12 ? 'Standard ($0.12/click)' : 'Basic ($0.10/click)'}</div>
                    <div><strong>Keywords:</strong> ${data.keywords?.map(k => `<span class="badge badge-primary">${k}</span>`).join(' ') || 'None'}</div>
                </div>
            </div>

            ${data.country_visits && Object.keys(data.country_visits).length ? `
                <div class="analytics-grid">
                    <div class="card">
                        <div class="card-header">
                            <h4>Views by Country</h4>
                        </div>
                        <div class="card-body">
                            <canvas id="taskCountryChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h4>Daily Views</h4>
                        </div>
                        <div class="card-body">
                            <canvas id="taskDailyChart"></canvas>
                        </div>
                    </div>
                </div>
            ` : '<p style="text-align:center;color:var(--text-light)">No analytics data available yet</p>'}

            <div style="display:flex;gap:1rem;margin-top:1.5rem">
                <button class="btn btn-primary" onclick="rechargeTask('${taskId}')">Recharge Task</button>
                <button class="btn" onclick="exportTaskData('${taskId}')">Export Data</button>
            </div>
        `;

        // Create task-specific charts
        if (data.country_visits && Object.keys(data.country_visits).length) {
            setTimeout(() => {
                const ctx1 = document.getElementById('taskCountryChart').getContext('2d');
                new Chart(ctx1, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(data.country_visits),
                        datasets: [{
                            data: Object.values(data.country_visits),
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                if (data.views_by_date) {
                    const ctx2 = document.getElementById('taskDailyChart').getContext('2d');
                    const dates = Object.keys(data.views_by_date).sort();
                    new Chart(ctx2, {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [{
                                label: 'Daily Views',
                                data: dates.map(d => data.views_by_date[d]),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: { y: { beginAtZero: true } }
                        }
                    });
                }
            }, 100);
        }

    } catch (error) {
        console.error('View task error:', error);
    }
}

function closeTaskDetails() {
    document.getElementById('taskDetails').style.display = 'none';
}

async function showTaskModal() {
    showModal('Create New SEO Task', `
        <div id="taskStep1">
            <div class="form-group">
                <label class="form-label">Website URL</label>
                <input type="url" class="form-input" id="taskUrl" placeholder="https://example.com" required>
            </div>
            <button class="btn btn-primary" onclick="loadTaskStep2()">Next: Select Locations</button>
        </div>

        <div id="taskStep2" style="display:none">
            <div class="location-preview">
                <iframe id="taskPreview"></iframe>
                <div class="location-overlay" id="locationOverlay"></div>
            </div>
            <div style="margin:1rem 0">
                <strong>Selected Locations:</strong>
                <div id="selectedLocations" style="margin-top:.5rem"></div>
            </div>
            <button class="btn btn-primary" onclick="loadTaskStep3()">Next: Keywords & Settings</button>
        </div>

        <div id="taskStep3" style="display:none">
            <div class="form-group">
                <label class="form-label">Keywords</label>
                <input type="text" class="form-input" id="taskKeywords" placeholder="Enter keywords or click AI Suggest">
                <button class="btn btn-sm" style="margin-top:.5rem" onclick="suggestKeywords()">ü§ñ AI Suggest Keywords</button>
                <div class="keyword-grid" id="keywordSuggestions"></div>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
                <div class="form-group">
                    <label class="form-label">Task Priority</label>
                    <select class="form-select" id="taskPriority" onchange="updatePricing()">
                        <option value="basic">Basic ($0.10/click, 1 location)</option>
                        <option value="standard" selected>Standard ($0.12/click, 3 locations)</option>
                        <option value="premium">Premium ($0.15/click, 5 locations)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Total Budget ($)</label>
                    <input type="number" class="form-input" id="taskBudget" min="10" value="150" onchange="updatePricing()">
                </div>
            </div>

            <div class="card" style="background:var(--input-bg);padding:1rem">
                <div style="display:flex;justify-content:space-between;margin-bottom:.5rem">
                    <span>Estimated Clicks:</span>
                    <strong id="estimatedClicks">1250</strong>
                </div>
                <div style="display:flex;justify-content:space-between">
                    <span>Estimated Duration:</span>
                    <strong id="estimatedDuration">~7 days</strong>
                </div>
            </div>

            <button class="btn btn-primary" style="width:100%;margin-top:1rem" onclick="createTask()">Create Task & Proceed to Payment</button>
        </div>
    `);

    currentData.taskLocations = [];
    currentData.selectedKeywords = [];
}

function loadTaskStep2() {
    const url = document.getElementById('taskUrl').value;
    if (!url) {
        showToast('Please enter a valid URL', 'error');
        return;
    }

    document.getElementById('taskStep1').style.display = 'none';
    document.getElementById('taskStep2').style.display = 'block';

    const iframe = document.getElementById('taskPreview');
    iframe.src = url;

    // Add click handler to iframe
    iframe.onload = () => {
        const overlay = document.getElementById('locationOverlay');
        overlay.addEventListener('click', (e) => {
            const rect = overlay.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const marker = document.createElement('div');
            marker.className = 'location-marker';
            marker.style.left = x + 'px';
            marker.style.top = y + 'px';
            overlay.appendChild(marker);

            // Generate XPath (simplified)
            const xpath = `/html/body/div[${Math.floor(x/100)}]/a[${currentData.taskLocations.length + 1}]`;
            currentData.taskLocations.push(xpath);

            updateSelectedLocations();
        });
    };
}

function updateSelectedLocations() {
    document.getElementById('selectedLocations').innerHTML = currentData.taskLocations.map((loc, idx) => `
        <div class="badge badge-primary" style="margin-right:.5rem">
            ${loc} <span style="cursor:pointer;margin-left:.5rem" onclick="removeLocation(${idx})">√ó</span>
        </div>
    `).join('');
}

function removeLocation(idx) {
    currentData.taskLocations.splice(idx, 1);
    updateSelectedLocations();
    document.querySelectorAll('.location-marker')[idx]?.remove();
}

function loadTaskStep3() {
    if (currentData.taskLocations.length === 0) {
        showToast('Please select at least one location', 'error');
        return;
    }

    document.getElementById('taskStep2').style.display = 'none';
    document.getElementById('taskStep3').style.display = 'block';
}

async function suggestKeywords() {
    const url = document.getElementById('taskUrl').value;
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="loader"></span> Loading...';

    try {
        const response = await fetch(`https://keywords.seotize.net?url=${encodeURIComponent(url)}`, {
            headers: { 'Session-Token': sessionToken }
        });
        const data = await response.json();

        const suggestions = document.getElementById('keywordSuggestions');
        suggestions.innerHTML = data.keywords.map(keyword => `
            <div class="keyword-item" onclick="toggleKeyword('${keyword}')">${keyword}</div>
        `).join('');

    } catch (error) {
        showToast('Failed to get keyword suggestions', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'ü§ñ AI Suggest Keywords';
    }
}

function toggleKeyword(keyword) {
    const idx = currentData.selectedKeywords.indexOf(keyword);
    if (idx === -1) {
        currentData.selectedKeywords.push(keyword);
    } else {
        currentData.selectedKeywords.splice(idx, 1);
    }

    document.querySelectorAll('.keyword-item').forEach(item => {
        if (item.textContent === keyword) {
            item.classList.toggle('selected');
        }
    });

    document.getElementById('taskKeywords').value = currentData.selectedKeywords.join(', ');
}

function updatePricing() {
    const priority = document.getElementById('taskPriority').value;
    const budget = parseFloat(document.getElementById('taskBudget').value) || 0;

    const rates = { basic: 0.10, standard: 0.12, premium: 0.15 };
    const clicks = Math.floor(budget / rates[priority]);

    document.getElementById('estimatedClicks').textContent = clicks.toLocaleString();
    document.getElementById('estimatedDuration').textContent = `~${Math.ceil(clicks / 200)} days`;
}

async function createTask() {
    const keywords = document.getElementById('taskKeywords').value.split(',').map(k => k.trim()).filter(k => k);
    if (!keywords.length) {
        showToast('Please enter at least one keyword', 'error');
        return;
    }

    try {
        const { data } = await api('/add-task', {
            method: 'POST',
            body: JSON.stringify({
                task_details: {
                    url: document.getElementById('taskUrl').value,
                    keywords: keywords,
                    html_locations: currentData.taskLocations
                },
                task_priority: document.getElementById('taskPriority').value,
                total_charge: parseInt(document.getElementById('taskBudget').value),
                provider: 'stripe',
                is_subscription: false,
                cancel_previous: false
            })
        });

        window.open(data.payment_url, '_blank');
        closeModal();
        showToast('Redirecting to payment...', 'success');
        setTimeout(() => loadTasks(), 2000);

    } catch (error) {
        console.error('Create task error:', error);
    }
}

async function rechargeTask(taskId) {
    const amount = prompt('Enter recharge amount ($):');
    if (!amount || isNaN(amount)) return;

    try {
        const { data } = await api('/recharge', {
            method: 'POST',
            body: JSON.stringify({
                task_ids: [taskId],
                payment_method: 'stripe',
                cancel_previous: false
            })
        });

        window.open(data.payment_url, '_blank');
        showToast('Redirecting to payment...', 'success');

    } catch (error) {
        console.error('Recharge error:', error);
    }
}

// Hosting Management
async function loadHosting() {
    try {
        const { data } = await api('/hosting/subscription-status');
        currentData.hosting = data;

        // Stats
        const stats = [
            { label: 'Current Plan', value: (data.current_plan || 'free').toUpperCase() },
            { label: 'Images Used', value: `${data.images_uploads || 0}/${data.images_limit || 0}` },
            { label: 'Articles Used', value: `${data.article_uploads || 0}/${data.articles_limit || 0}` },
            { label: 'Expires', value: data.expiry_date ? new Date(data.expiry_date).toLocaleDateString() : 'Never' }
        ];

        document.getElementById('hostingStats').innerHTML = stats.map(stat => `
            <div class="stat-card">
                <div class="stat-label">${stat.label}</div>
                <div class="stat-value">${stat.value}</div>
            </div>
        `).join('');

        // Plan details
        document.getElementById('planDetails').innerHTML = `
            <div style="display:grid;gap:1rem">
                ${data.is_subscription ? `
                    <div class="card" style="background:var(--input-bg)">
                        <div style="padding:1rem">
                            <h4>Subscription Details</h4>
                            <div style="display:grid;gap:.5rem;margin-top:1rem">
                                <div><strong>Status:</strong> <span class="badge badge-${data.subscription_status === 'active' ? 'success' : 'warning'}">${data.subscription_status}</span></div>
                                <div><strong>Period:</strong> ${data.subscription_period_start} to ${data.subscription_period_end}</div>
                                <div><strong>Last Payment:</strong> $${data.billing?.last_payment_amount} on ${data.billing?.last_payment_date}</div>
                            </div>
                            <button class="btn btn-error btn-sm" style="margin-top:1rem" onclick="cancelSubscription()">Cancel Subscription</button>
                        </div>
                    </div>
                ` : ''}

                <div>
                    <h4>Plan Limits</h4>
                    <div style="margin-top:1rem">
                        <div style="margin-bottom:1rem">
                            <div style="display:flex;justify-content:space-between;margin-bottom:.5rem">
                                <span>Images</span>
                                <span>${data.images_uploads || 0} / ${data.images_limit || 0}</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width:${((data.images_uploads || 0) / (data.images_limit || 1) * 100)}%"></div>
                            </div>
                        </div>
                        <div>
                            <div style="display:flex;justify-content:space-between;margin-bottom:.5rem">
                                <span>Articles</span>
                                <span>${data.article_uploads || 0} / ${data.articles_limit || 0}</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width:${((data.article_uploads || 0) / (data.articles_limit || 1) * 100)}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Load default tab
        showHostingTab('overview');

    } catch (error) {
        console.error('Hosting error:', error);
    }
}

function showHostingTab(tab) {
    document.querySelectorAll('#hosting .tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#hosting .section').forEach(s => s.classList.remove('active'));

    event.target.classList.add('active');
    document.getElementById(`hosting-${tab}`).classList.add('active');

    if (tab === 'images') loadImages();
    if (tab === 'articles') loadArticles();
}

async function showUpgradeModal() {
    showModal('Upgrade Hosting Plan', `
        <div style="display:grid;gap:1rem">
            <div class="card" style="cursor:pointer;transition:all .2s" onclick="selectPlan('basic')" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                <div style="padding:1.5rem">
                    <h4>Basic Plan</h4>
                    <div class="stat-value">$9.99/mo</div>
                    <p style="color:var(--text-light);margin-top:.5rem">100 images, 50 articles</p>
                    <ul style="margin-top:1rem;list-style:none;padding:0">
                        <li>‚úì Basic CDN</li>
                        <li>‚úì Email Support</li>
                        <li>‚úì 99.9% Uptime</li>
                    </ul>
                </div>
            </div>
            <div class="card" style="cursor:pointer;transition:all .2s;border:2px solid var(--primary)" onclick="selectPlan('pro')" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                <div style="padding:1.5rem">
                    <div class="badge badge-primary" style="position:absolute;top:1rem;right:1rem">Popular</div>
                    <h4>Pro Plan</h4>
                    <div class="stat-value">$19.99/mo</div>
                    <p style="color:var(--text-light);margin-top:.5rem">500 images, 200 articles</p>
                    <ul style="margin-top:1rem;list-style:none;padding:0">
                        <li>‚úì Premium CDN</li>
                        <li>‚úì Priority Support</li>
                        <li>‚úì 99.99% Uptime</li>
                        <li>‚úì Advanced Analytics</li>
                    </ul>
                </div>
            </div>
            <div class="card" style="cursor:pointer;transition:all .2s" onclick="selectPlan('enterprise')" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                <div style="padding:1.5rem">
                    <h4>Enterprise Plan</h4>
                    <div class="stat-value">$49.99/mo</div>
                    <p style="color:var(--text-light);margin-top:.5rem">Unlimited everything</p>
                    <ul style="margin-top:1rem;list-style:none;padding:0">
                        <li>‚úì Global CDN</li>
                        <li>‚úì 24/7 Phone Support</li>
                        <li>‚úì 100% Uptime SLA</li>
                        <li>‚úì Custom Features</li>
                        <li>‚úì Dedicated Account Manager</li>
                    </ul>
                </div>
            </div>
        </div>

        <form id="planForm" style="display:none;margin-top:1.5rem">
            <div class="form-group">
                <label class="form-label">Billing Period</label>
                <select class="form-select" name="duration" onchange="updatePlanPricing()">
                    <option value="3month">3 Months (Save 5%)</option>
                    <option value="6month">6 Months (Save 10%)</option>
                    <option value="12month">12 Months (Save 20%)</option>
                </select>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" name="subscription" checked> Enable auto-renewal
                </label>
            </div>
            <div class="card" style="background:var(--input-bg);padding:1rem;margin-bottom:1rem">
                <div style="display:flex;justify-content:space-between">
                    <span>Total Price:</span>
                    <strong id="planTotalPrice">$29.97</strong>
                </div>
            </div>
            <button type="submit" class="btn btn-primary" style="width:100%">Proceed to Payment</button>
        </form>
    `);
}

function selectPlan(plan) {
    currentData.selectedPlan = plan;
    document.getElementById('planForm').style.display = 'block';
    updatePlanPricing();
    document.getElementById('planForm').addEventListener('submit', buyPlan);
}

function updatePlanPricing() {
    const prices = { basic: 9.99, pro: 19.99, enterprise: 49.99 };
    const duration = document.querySelector('[name="duration"]').value;
    const months = { '3month': 3, '6month': 6, '12month': 12 };
    const discounts = { '3month': 0.95, '6month': 0.90, '12month': 0.80 };

    const total = prices[currentData.selectedPlan] * months[duration] * discounts[duration];
    document.getElementById('planTotalPrice').textContent = `$${total.toFixed(2)}`;
}

async function buyPlan(e) {
    e.preventDefault();
    const formData = new FormData(e.target);

    try {
        const { data } = await api('/hosting/buy-package', {
            method: 'POST',
            body: JSON.stringify({
                package: currentData.selectedPlan,
                provider: 'stripe',
                duration: formData.get('duration'),
                subscription: formData.get('subscription') === 'on',
                cancel_previous: false,
                cancel_current_plan: false
            })
        });

        window.open(data.payment_url, '_blank');
        closeModal();
        showToast('Redirecting to payment...', 'success');

    } catch (error) {
        console.error('Buy plan error:', error);
    }
}

async function cancelSubscription() {
    if (!confirm('Are you sure you want to cancel your subscription?')) return;

    try {
        await api('/hosting/cancel-subscription');
        showToast('Subscription cancelled successfully', 'success');
        loadHosting();
    } catch (error) {
        console.error('Cancel subscription error:', error);
    }
}

// Images Management
async function loadImages(page = 1) {
    try {
        const { data, pagination } = await api(`/images/dashboard?page=${page}&page_size=20`);

        const imageGrid = document.getElementById('imageGrid');
        if (data.images?.length) {
            imageGrid.innerHTML = data.images.map(img => `
                <div class="media-card">
                    <div class="media-preview">
                        <img src="${img.cdn_url}" alt="${img.original_filename}" loading="lazy">
                    </div>
                    <div class="media-info">
                        <div style="font-weight:600;font-size:.875rem;margin-bottom:.5rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${img.original_filename}</div>
                        <div style="font-size:.75rem;color:var(--text-light)">
                            ${img.total_views || 0} views ‚Ä¢ ${new Date(img.upload_date).toLocaleDateString()}
                        </div>
                        <div style="display:flex;gap:.5rem;margin-top:.5rem">
                            <button class="btn btn-sm" onclick="copyToClipboard('${img.cdn_url}')">Copy URL</button>
                            <button class="btn btn-sm" onclick="viewImageStats('${img.image_id}')">Stats</button>
                            <button class="btn btn-sm" onclick="deleteImage('${img.image_id}')">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            imageGrid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><p>No images uploaded yet</p></div>';
        }
    } catch (error) {
        console.error('Images error:', error);
    }
}

async function showImageUploadModal() {
    showModal('Upload Images', `
        <div class="dropzone" id="dropzone" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin:0 auto">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            <p style="margin-top:1rem">Drop images here or click to browse</p>
            <p style="font-size:.875rem;color:var(--text-light)">Max 10 files, 5MB each</p>
            <input type="file" id="imageFiles" multiple accept="image/*" style="display:none" onchange="handleFiles(this.files)">
        </div>
        <div id="imagePreview" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:.5rem;margin-top:1rem"></div>
        <button class="btn btn-primary" style="width:100%;margin-top:1rem;display:none" id="uploadBtn" onclick="uploadImages()">Upload Images</button>
    `);

    document.getElementById('dropzone').addEventListener('click', () => {
        document.getElementById('imageFiles').click();
    });
}

function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('active');
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('active');
}

function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('active');
    handleFiles(e.dataTransfer.files);
}

function handleFiles(files) {
    if (files.length > 10) {
        showToast('Maximum 10 files allowed', 'error');
        return;
    }

    currentData.uploadFiles = files;
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';

    Array.from(files).forEach((file, idx) => {
        if (file.size > 5 * 1024 * 1024) {
            showToast(`${file.name} exceeds 5MB limit`, 'error');
            return;
        }

        const reader = new FileReader();
        reader.onload = e => {
            preview.innerHTML += `
                <div style="position:relative">
                    <img src="${e.target.result}" style="width:100%;height:100px;object-fit:cover;border-radius:var(--radius)">
                    <button class="btn-icon" style="position:absolute;top:4px;right:4px;width:24px;height:24px;background:var(--error);color:white;border:none" onclick="removeFile(${idx})">√ó</button>
                    <div style="position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.7);color:white;font-size:.7rem;padding:.25rem;text-align:center">
                        ${(file.size / 1024 / 1024).toFixed(1)}MB
                    </div>
                </div>
            `;
        };
        reader.readAsDataURL(file);
    });

    document.getElementById('uploadBtn').style.display = files.length ? 'block' : 'none';
}

async function uploadImages() {
    const formData = new FormData();
    Array.from(currentData.uploadFiles).forEach(file => {
        formData.append('file', file);
    });

    const btn = document.getElementById('uploadBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="loader"></span> Uploading...';

    try {
        const response = await fetch(`${API_BASE}/images/upload`, {
            method: 'POST',
            headers: { 'Session-Token': sessionToken },
            body: formData
        });

        const result = await response.json();
        if (result.status === 'success') {
            closeModal();
            showToast(`${result.data.uploaded_images.length} images uploaded successfully`, 'success');
            loadImages();
        } else {
            throw new Error(result.error?.message || 'Upload failed');
        }
    } catch (error) {
        showToast(error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'Upload Images';
    }
}

async function viewImageStats(imageId) {
    // Implementation for viewing image statistics
    showToast('Image statistics coming soon', 'info');
}

async function deleteImage(imageId) {
    if (!confirm('Delete this image permanently?')) return;

    try {
        await api('/images', {
            method: 'DELETE',
            body: JSON.stringify({ image_ids: [imageId] })
        });

        showToast('Image deleted successfully', 'success');
        loadImages();
    } catch (error) {
        console.error('Delete image error:', error);
    }
}

// Articles Management
async function loadArticles(page = 1) {
    try {
        // Load domains first
        await loadDomains();

        const { data, pagination } = await api(`/dashboard/articles?page=${page}&page_size=10`);

        const articlesList = document.getElementById('articlesList');
        if (data.articles?.length) {
            articlesList.innerHTML = data.articles.map(article => `
                <div class="card" style="margin-bottom:1rem">
                    <div class="card-body">
                        <div style="display:flex;justify-content:space-between;align-items:start">
                            <div style="flex:1">
                                <h4>${article.subject}</h4>
                                <div style="font-size:.875rem;color:var(--text-light);margin:.5rem 0">
                                    üìç ${article.url} ‚Ä¢ üìÖ ${new Date(article.creation_date).toLocaleDateString()} ‚Ä¢ üëÅÔ∏è ${article.total_views || 0} views
                                </div>
                                ${article.images?.length ? `
                                    <div style="display:flex;gap:.5rem;margin-top:.5rem">
                                        ${article.images.slice(0, 3).map(img => `
                                            <img src="${img}" style="width:60px;height:60px;object-fit:cover;border-radius:var(--radius)">
                                        `).join('')}
                                        ${article.images.length > 3 ? `<div style="width:60px;height:60px;background:var(--input-bg);border-radius:var(--radius);display:flex;align-items:center;justify-content:center;font-size:.875rem">+${article.images.length - 3}</div>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="display:flex;gap:.5rem">
                                <button class="btn btn-sm" onclick="viewArticle('${article.article_id}')">View</button>
                                <button class="btn btn-sm" onclick="editArticle('${article.article_id}')">Edit</button>
                                <button class="btn btn-sm" onclick="deleteArticle('${article.article_id}')">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            articlesList.innerHTML = '<div class="empty-state"><p>No articles published yet</p></div>';
        }
    } catch (error) {
        console.error('Articles error:', error);
    }
}

async function loadDomains() {
    const domainsList = document.getElementById('domainsList');

    // Since we don't have a list endpoint, show the current domains from articles
    if (currentData.user?.hosting) {
        domainsList.innerHTML = `
            <div class="domain-item">
                <div class="domain-status">
                    <span class="badge badge-success">‚úì Verified</span>
                    <span>example.com</span>
                </div>
                <button class="btn btn-sm" onclick="showDomainModal()">Add New Domain</button>
            </div>
        `;
    }
}

async function showDomainModal() {
    showModal('Add Domain', `
        <form id="domainForm">
            <div class="form-group">
                <label class="form-label">Domain URL</label>
                <input type="text" class="form-input" name="url" required placeholder="example.com/blog">
                <p style="font-size:.875rem;color:var(--text-light);margin-top:.5rem">
                    Enter your domain or subdomain where articles will be published
                </p>
            </div>
            <div class="card" style="background:var(--input-bg);padding:1rem">
                <p style="font-size:.875rem">
                    After adding your domain, you'll need to verify ownership by adding a TXT record to your DNS settings.
                </p>
            </div>
            <button type="submit" class="btn btn-primary" style="width:100%">Add Domain</button>
        </form>
    `);

    document.getElementById('domainForm').addEventListener('submit', addDomain);
}

async function addDomain(e) {
    e.preventDefault();
    const formData = new FormData(e.target);

    try {
        const { data } = await api('/add-domain', {
            method: 'POST',
            body: JSON.stringify({ url: formData.get('url') })
        });

        if (data.txt_record) {
            showModal('Domain Verification Required', `
                <div class="card" style="background:var(--input-bg);padding:1.5rem">
                    <h4>Domain added successfully!</h4>
                    <p style="margin-top:1rem">To verify ownership, add this TXT record to your DNS:</p>
                    <div style="background:var(--bg);padding:1rem;border-radius:var(--radius);margin:1rem 0;font-family:monospace;word-break:break-all">
                        ${data.txt_record}
                    </div>
                    <button class="btn btn-primary" onclick="copyToClipboard('${data.txt_record}')">Copy TXT Record</button>
                    <button class="btn" style="margin-left:.5rem" onclick="verifyDomain('${formData.get('url')}')">Verify Now</button>
                </div>
                <p style="font-size:.875rem;color:var(--text-light);margin-top:1rem">
                    DNS changes may take up to 48 hours to propagate
                </p>
            `);
        } else {
            showToast('Domain added and verified successfully', 'success');
            closeModal();
            loadArticles();
        }
    } catch (error) {
        console.error('Add domain error:', error);
    }
}

async function verifyDomain(url) {
    try {
        await api('/verify-domain', {
            method: 'POST',
            body: JSON.stringify({ url })
        });

        showToast('Domain verified successfully', 'success');
        closeModal();
        loadArticles();
    } catch (error) {
        if (error.message.includes('DNS')) {
            showToast('Verification failed. Please ensure the TXT record is added correctly.', 'warning');
        }
    }
}

async function showArticleModal(articleId = null) {
    const isEdit = !!articleId;
    let article = {};

    if (isEdit) {
        try {
            const { data } = await api(`/dashboard/articles?article_id=${articleId}`);
            article = data.article;
        } catch (error) {
            console.error('Load article error:', error);
            return;
        }
    }

    showModal(isEdit ? 'Edit Article' : 'Create New Article', `
        <form id="articleForm">
            <div class="form-group">
                <label class="form-label">Domain URL</label>
                <input type="text" class="form-input" name="url" value="${article.url || ''}" ${isEdit ? 'readonly' : 'required'} placeholder="example.com/blog">
            </div>
            <div class="form-group">
                <label class="form-label">Article Title</label>
                <input type="text" class="form-input" name="subject" value="${article.subject || ''}" required>
            </div>
            <div class="form-group">
                <label class="form-label">Article Content (HTML)</label>
                <textarea class="form-textarea" name="body" rows="10" required>${article.body || ''}</textarea>
            </div>
            <div class="form-group">
                <label class="form-label">${isEdit ? 'Add New Images' : 'Images'}</label>
                <input type="file" class="form-input" name="images" multiple accept="image/*">
            </div>
            ${isEdit && article.images?.length ? `
                <div class="form-group">
                    <label class="form-label">Current Images (click to remove)</label>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:.5rem" id="currentImages">
                        ${article.images.map((img, idx) => `
                            <div style="position:relative;cursor:pointer" onclick="toggleImageDelete(this, '${img}')">
                                <img src="${img}" style="width:100%;height:80px;object-fit:cover;border-radius:var(--radius)">
                                <div style="position:absolute;inset:0;background:rgba(239,68,68,0.8);color:white;display:none;align-items:center;justify-content:center;border-radius:var(--radius)">√ó</div>
                            </div>
                        `).join('')}
                    </div>
                    <input type="hidden" name="deleteImages" value="">
                </div>
            ` : ''}
            <button type="submit" class="btn btn-primary" style="width:100%">${isEdit ? 'Update Article' : 'Publish Article'}</button>
        </form>
    `);

    document.getElementById('articleForm').addEventListener('submit', e => {
        e.preventDefault();
        if (isEdit) {
            updateArticle(articleId, e.target);
        } else {
            createArticle(e.target);
        }
    });
}

async function createArticle(form) {
    const formData = new FormData(form);

    try {
        const response = await fetch(`${API_BASE}/add-article`, {
            method: 'POST',
            headers: { 'Session-Token': sessionToken },
            body: formData
        });

        const result = await response.json();
        if (result.status === 'success') {
            closeModal();
            showToast('Article published successfully', 'success');
            loadArticles();
        } else {
            throw new Error(result.error?.message || 'Failed to publish article');
        }
    } catch (error) {
        showToast(error.message, 'error');
    }
}

async function updateArticle(articleId, form) {
    const formData = new FormData(form);
    const deleteImages = formData.get('deleteImages');
    if (deleteImages) {
        formData.append('delete_image_ids', deleteImages);
    }

    try {
        const response = await fetch(`${API_BASE}/edit-article/${articleId}`, {
            method: 'PUT',
            headers: { 'Session-Token': sessionToken },
            body: formData
        });

        const result = await response.json();
        if (result.status === 'success') {
            closeModal();
            showToast('Article updated successfully', 'success');
            loadArticles();
        } else {
            throw new Error(result.error?.message || 'Failed to update article');
        }
    } catch (error) {
        showToast(error.message, 'error');
    }
}

async function viewArticle(articleId) {
    try {
        const { data } = await api(`/dashboard/articles?article_id=${articleId}`);
        const article = data.article;

        showModal(article.subject, `
            <div style="margin-bottom:1rem">
                <strong>URL:</strong> <a href="https://${article.url}" target="_blank" style="color:var(--primary)">${article.url}</a><br>
                <strong>Created:</strong> ${new Date(article.creation_date).toLocaleString()}<br>
                <strong>Total Views:</strong> ${article.total_views || 0}
            </div>

            ${article.images?.length ? `
                <div style="margin-bottom:1rem">
                    <strong>Images:</strong>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:.5rem;margin-top:.5rem">
                        ${article.images.map(img => `
                            <img src="${img}" style="width:100%;height:100px;object-fit:cover;border-radius:var(--radius);cursor:pointer" onclick="window.open('${img}', '_blank')">
                        `).join('')}
                    </div>
                </div>
            ` : ''}

            <div style="margin-bottom:1rem">
                <strong>Content:</strong>
                <div style="max-height:300px;overflow-y:auto;padding:1rem;background:var(--input-bg);border-radius:var(--radius);margin-top:.5rem">
                    ${article.body}
                </div>
            </div>

            ${article.stats ? `
                <div class="analytics-grid">
                    <canvas id="articleStatsChart"></canvas>
                </div>
            ` : ''}

            <div style="display:flex;gap:1rem;margin-top:1rem">
                <button class="btn btn-primary" onclick="editArticle('${articleId}')">Edit Article</button>
                <button class="btn" onclick="window.open('https://${article.url}', '_blank')">View Live</button>
                <button class="btn" onclick="closeModal()">Close</button>
            </div>
        `);

        // Create article stats chart if available
        if (article.stats) {
            setTimeout(() => {
                const ctx = document.getElementById('articleStatsChart').getContext('2d');
                const monthlyData = Object.entries(article.stats).map(([month, data]) => ({
                    month,
                    views: Object.values(data.daily || {}).reduce((a, b) => a + b, 0)
                }));

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: monthlyData.map(d => d.month),
                        datasets: [{
                            label: 'Monthly Views',
                            data: monthlyData.map(d => d.views),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }, 100);
        }
    } catch (error) {
        console.error('View article error:', error);
    }
}

async function deleteArticle(articleId) {
    if (!confirm('Delete this article permanently?')) return;

    try {
        await api(`/delete-article/${articleId}`, { method: 'DELETE' });
        showToast('Article deleted successfully', 'success');
        loadArticles();
    } catch (error) {
        console.error('Delete article error:', error);
    }
}

function toggleImageDelete(elem, imageId) {
    const overlay = elem.querySelector('div');
    const input = document.querySelector('input[name="deleteImages"]');
    const deleteList = input.value ? input.value.split(',') : [];

    if (overlay.style.display === 'flex') {
        overlay.style.display = 'none';
        const index = deleteList.indexOf(imageId);
        if (index > -1) deleteList.splice(index, 1);
    } else {
        overlay.style.display = 'flex';
        deleteList.push(imageId);
    }

    input.value = deleteList.join(',');
}

// Billing
async function loadBilling(page = 1, type = 'all') {
    try {
        const { data, pagination } = await api(`/dashboard/billings?page=${page}&limit=10&type=${type}`);

        const allPayments = [...(data.tasks || []), ...(data.hosting || [])];
        const totalSpent = allPayments.reduce((sum, p) => sum + (p.total_payment || 0), 0);
        const paidCount = allPayments.filter(p => p.status === 'Paid').length;
        const pendingCount = allPayments.filter(p => p.status !== 'Paid').length;

        // Stats
        document.getElementById('billingStats').innerHTML = `
            <div class="stat-card">
                <div class="stat-label">Total Spent</div>
                <div class="stat-value">$${totalSpent.toFixed(2)}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Transactions</div>
                <div class="stat-value">${allPayments.length}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Completed</div>
                <div class="stat-value">${paidCount}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Pending</div>
                <div class="stat-value">${pendingCount}</div>
            </div>
        `;

        // Table
        const tbody = document.getElementById('billingTable');
        if (allPayments.length) {
            tbody.innerHTML = allPayments.map(payment => `
                <tr>
                    <td>${new Date(payment.dates?.paid || payment.dates?.created).toLocaleDateString()}</td>
                    <td>
                        <span class="badge badge-${payment.method === 'create_task' ? 'primary' : payment.method === 'recharge' ? 'warning' : 'success'}">
                            ${payment.method === 'create_task' ? 'Task' : payment.method === 'recharge' ? 'Recharge' : 'Hosting'}
                        </span>
                    </td>
                    <td>${payment.details?.url || payment.details?.package || payment.method}</td>
                    <td>$${payment.total_payment || 0}</td>
                    <td>
                        <span class="badge badge-${payment.status === 'Paid' ? 'success' : 'warning'}">
                            ${payment.status}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm" onclick="viewPayment('${payment.billing_id}')">View</button>
                    </td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">No transactions found</td></tr>';
        }

        createBillingCharts(allPayments);

    } catch (error) {
        console.error('Billing error:', error);
    }
}

function createBillingCharts(payments) {
    // Spending chart
    const monthlySpending = {};
    payments.forEach(p => {
        if (p.dates?.paid) {
            const month = p.dates.paid.substring(0, 7);
            monthlySpending[month] = (monthlySpending[month] || 0) + (p.total_payment || 0);
        }
    });

    if (charts.spending) charts.spending.destroy();
    const ctx1 = document.getElementById('spendingChart').getContext('2d');
    charts.spending = new Chart(ctx1, {
        type: 'line',
        data: {
            labels: Object.keys(monthlySpending).sort(),
            datasets: [{
                label: 'Monthly Spending',
                data: Object.keys(monthlySpending).sort().map(m => monthlySpending[m]),
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
        }
    });

    // Payment type distribution
    const paymentTypes = {};
    payments.forEach(p => {
        const type = p.method === 'create_task' ? 'Tasks' : p.method === 'recharge' ? 'Recharges' : 'Hosting';
        paymentTypes[type] = (paymentTypes[type] || 0) + (p.total_payment || 0);
    });

    if (charts.payment) charts.payment.destroy();
    const ctx2 = document.getElementById('paymentChart').getContext('2d');
    charts.payment = new Chart(ctx2, {
        type: 'doughnut',
        data: {
            labels: Object.keys(paymentTypes),
            datasets: [{
                data: Object.values(paymentTypes),
                backgroundColor: ['#3b82f6', '#f59e0b', '#10b981']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

async function viewPayment(paymentId) {
    try {
        const { data } = await api(`/get-payment-status?payment_id=${paymentId}`);

        showModal('Payment Details', `
            <div class="stat-grid" style="margin-bottom:1rem">
                <div class="stat-card">
                    <div class="stat-label">Amount</div>
                    <div class="stat-value">$${data.amount}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Status</div>
                    <div class="stat-value">
                        <span class="badge badge-${data.status === 'Paid' ? 'success' : 'warning'}">${data.status}</span>
                    </div>
                </div>
            </div>

            <div style="display:grid;gap:.5rem">
                <div><strong>Type:</strong> ${data.type}</div>
                <div><strong>Date:</strong> ${new Date(data.date_of_payment).toLocaleString()}</div>
                <div><strong>Method:</strong> ${data.payment_method}</div>
                <div><strong>Transaction ID:</strong> <code style="font-size:.875rem">${data.transaction_id || 'N/A'}</code></div>
                ${data.task_id ? `<div><strong>Task ID:</strong> ${data.task_id}</div>` : ''}
                ${data.package ? `<div><strong>Package:</strong> ${data.package} (${data.duration})</div>` : ''}
            </div>

            <button class="btn" style="margin-top:1rem;width:100%" onclick="closeModal()">Close</button>
        `);
    } catch (error) {
        console.error('View payment error:', error);
    }
}

// SEO Tools
async function analyzeKeywords() {
    const url = document.getElementById('keywordUrl').value;
    if (!url) {
        showToast('Please enter a URL', 'error');
        return;
    }

    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="loader"></span> Analyzing...';

    try {
        const response = await fetch(`https://keywords.seotize.net?url=${encodeURIComponent(url)}`, {
            headers: { 'Session-Token': sessionToken }
        });
        const data = await response.json();

        document.getElementById('keywordResults').innerHTML = `
            <div class="card" style="margin-top:1.5rem">
                <div class="card-body">
                    <h4>Keyword Analysis Results</h4>
                    <div style="margin-top:1rem">
                        <strong>Top Keywords:</strong>
                        <div class="keyword-grid">
                            ${data.keywords.map(kw => `<span class="badge badge-primary">${kw}</span>`).join('')}
                        </div>
                    </div>
                    ${data.density ? `
                        <div style="margin-top:1rem">
                            <strong>Keyword Density:</strong>
                            <div style="margin-top:.5rem">
                                ${Object.entries(data.density).map(([kw, density]) => `
                                    <div style="display:flex;justify-content:space-between;padding:.5rem 0;border-bottom:1px solid var(--border)">
                                        <span>${kw}</span>
                                        <span>${density}%</span>
                                    </div>
                                `).join('')}
                            </div>
                            </div>
                    ` : ''}
                    ${data.recommendations ? `
                        <div style="margin-top:1rem">
                            <strong>Recommendations:</strong>
                            <ul style="margin-top:.5rem">
                                ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    } catch (error) {
        showToast('Failed to analyze keywords', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'Analyze';
    }
}

async function checkSerpPosition() {
    const keyword = document.getElementById('serpKeyword').value;
    const url = document.getElementById('serpUrl').value;

    if (!keyword || !url) {
        showToast('Please enter both keyword and URL', 'error');
        return;
    }

    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="loader"></span> Checking...';

    try {
        const response = await fetch(`https://search.seotize.workers.dev/?keyword=${encodeURIComponent(keyword)}&url=${encodeURIComponent(url)}`, {
            headers: { 'Session-Token': sessionToken }
        });
        const data = await response.json();

        document.getElementById('serpResults').innerHTML = `
            <div class="card">
                <div class="card-body">
                    <div class="stat-grid">
                        <div class="stat-card">
                            <div class="stat-label">Position</div>
                            <div class="stat-value">${data.position || 'Not Found'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Page</div>
                            <div class="stat-value">${data.page || 'N/A'}</div>
                        </div>
                    </div>

                    ${data.competitors ? `
                        <div style="margin-top:1.5rem">
                            <h4>Top Competitors</h4>
                            <table class="table" style="margin-top:1rem">
                                <thead>
                                    <tr>
                                        <th>Position</th>
                                        <th>URL</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.competitors.map(comp => `
                                        <tr>
                                            <td>${comp.position}</td>
                                            <td><a href="https://${comp.url}" target="_blank" style="color:var(--primary)">${comp.url}</a></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    } catch (error) {
        showToast('Failed to check SERP position', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'Check Position';
    }
}

// Utilities
function showModal(title, content) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = content;
    document.getElementById('modal').classList.add('show');
}

function closeModal() {
    document.getElementById('modal').classList.remove('show');
}

function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast ${type} show`;
    setTimeout(() => toast.classList.remove('show'), 3000);
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('Copied to clipboard', 'success');
    }).catch(() => {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast('Copied to clipboard', 'success');
    });
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    return parts.length === 2 ? parts.pop().split(';').shift() : '';
}

async function logout() {
    try {
        await api('/logout');
    } finally {
        document.cookie = 'session_token=;path=/;expires=Thu, 01 Jan 1970 00:00:00 GMT';
        window.location.href = '/login.html';
    }
}

async function revokeSession(token) {
    if (!confirm('Revoke this session?')) return;
    showToast('Session revoked', 'success');
    loadDashboard();
}

function exportTaskData(taskId) {
    const task = currentData.tasks.find(t => t._id === taskId);
    if (!task) return;

    const data = JSON.stringify(task, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `task_${taskId}_data.json`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('Data exported successfully', 'success');
}

// Load theme preference
document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.body.dataset.theme = savedTheme;
});

// Click outside modal to close
document.getElementById('modal').addEventListener('click', e => {
    if (e.target === e.currentTarget) closeModal();
});

// Keyboard shortcuts
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeModal();
    if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
            case 'k': e.preventDefault(); document.querySelector('[data-section="tasks"]').click(); break;
            case 'd': e.preventDefault(); document.querySelector('[data-section="dashboard"]').click(); break;
            case 'b': e.preventDefault(); document.querySelector('[data-section="billing"]').click(); break;
        }
    }
});
</script>
</body>
</html>
