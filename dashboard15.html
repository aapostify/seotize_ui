<!DOCTYPE html>
<!--
Dashboard v13 Changes:
1. Added detailed pagination to SEO Tasks section (matching Articles section style)
2. Fixed mobile stats-grid to show 2 columns per row for better space utilization
3. Adjusted stat card padding and font sizes for mobile view
4. Articles section already had proper pagination (maintained)
5. Enhanced pagination UI for Tasks and Articles pages to match dashboard style with vertical layout
-->
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SEOTIZE Dashboard - Mobile Optimized v13</title>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet">

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/turnstile@0/turnstile.min.js" async defer></script>

<style>
/* CSS Variables */
:root {
    --primary: #6366f1;
    --primary-dark: #4f46e5;
    --primary-light: #818cf8;
    --secondary: #10b981;
    --secondary-dark: #059669;
    --accent: #f59e0b;
    --error: #ef4444;
    --warning: #f59e0b;
    --success: #10b981;
    --info: #3b82f6;

    --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --gradient-accent: linear-gradient(135deg, #fa709a 0%, #fee140 100%);

    --radius-sm: 8px;
    --radius: 12px;
    --radius-lg: 16px;
    --radius-xl: 24px;

    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);

    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Light Theme */
[data-theme="light"] {
    --bg: #f8f9fa;
    --bg-secondary: #ffffff;
    --bg-tertiary: #e9ecef;
    --sidebar: #ffffff;
    --card: #ffffff;
    --card-hover: #f8f9fa;
    --text: #212529;
    --text-secondary: #6c757d;
    --text-tertiary: #adb5bd;
    --border: #dee2e6;
    --input-bg: #ffffff;
    --overlay: rgba(255, 255, 255, 0.95);
    --glass: rgba(255, 255, 255, 0.7);
    --glass-border: rgba(0, 0, 0, 0.1);
}

/* Dark Theme */
[data-theme="dark"] {
    --bg: #0a0a0a;
    --bg-secondary: #1a1a1a;
    --bg-tertiary: #2a2a2a;
    --sidebar: #141414;
    --card: #1f1f1f;
    --card-hover: #2a2a2a;
    --text: #ffffff;
    --text-secondary: #a0a0a0;
    --text-tertiary: #6b6b6b;
    --border: rgba(255, 255, 255, 0.1);
    --input-bg: #1a1a1a;
    --overlay: rgba(0, 0, 0, 0.95);
    --glass: rgba(255, 255, 255, 0.05);
    --glass-border: rgba(255, 255, 255, 0.1);
}

/* Base Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    transition: var(--transition);
    line-height: 1.6;
    overflow-x: hidden;
}

/* Layout */
.dashboard-layout {
    display: flex;
    min-height: 100vh;
}

/* Sidebar */
.sidebar {
    width: 280px;
    background: var(--sidebar);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    transition: var(--transition);
}

.sidebar-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
}

.logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--primary);
    text-decoration: none;
}

.sidebar-nav {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
}

.nav-section {
    margin-bottom: 1.5rem;
}

.nav-section-title {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
    padding: 0 0.75rem;
}

.nav-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    border-radius: var(--radius);
    color: var(--text-secondary);
    text-decoration: none;
    transition: var(--transition);
    cursor: pointer;
    margin-bottom: 0.25rem;
}

.nav-item:hover {
    background: var(--card);
    color: var(--text);
}

.nav-item.active {
    background: var(--primary);
    color: white;
}

.nav-item i {
    font-size: 1.25rem;
    width: 1.5rem;
    text-align: center;
}

/* Main Content */
.main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* Header */
.header {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.search-bar {
    position: relative;
    width: 300px;
}

.search-bar input {
    width: 100%;
    padding: 0.625rem 1rem 0.625rem 2.5rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--input-bg);
    color: var(--text);
    font-size: 0.875rem;
    transition: var(--transition);
}

.search-bar input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.search-bar i {
    position: absolute;
    left: 0.875rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-tertiary);
}

.header-right {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.theme-toggle {
    padding: 0.5rem;
    border-radius: var(--radius);
    background: transparent;
    border: none;
    color: var(--text);
    cursor: pointer;
    font-size: 1.25rem;
    transition: var(--transition);
}

.theme-toggle:hover {
    background: var(--card);
}

.user-menu {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 1rem;
    border-radius: var(--radius);
    background: var(--card);
    cursor: pointer;
    transition: var(--transition);
}

.user-menu:hover {
    background: var(--card-hover);
}

.user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--gradient-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
}

/* Content Area */
.content {
    flex: 1;
    padding: 1.5rem;
    overflow-y: auto;
}

/* Cards */
.card {
    background: var(--card);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    transition: var(--transition);
}

.card-header {
    padding: 1.25rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text);
}

.card-body {
    padding: 1.25rem;
}

/* Improved Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 1.25rem;
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--gradient-primary);
}

.stat-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--radius);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    flex-shrink: 0;
}

.stat-icon.primary {
    background: rgba(99, 102, 241, 0.1);
    color: var(--primary);
}

.stat-icon.success {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
}

.stat-icon.warning {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
}

.stat-icon.error {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error);
}

.stat-content {
    flex: 1;
    min-width: 0;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 0.25rem;
}

.stat-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

/* Buttons */
.btn {
    padding: 0.625rem 1.25rem;
    border-radius: var(--radius);
    font-weight: 500;
    font-size: 0.875rem;
    border: none;
    cursor: pointer;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-1px);
    box-shadow: var(--shadow);
}

.btn-secondary {
    background: var(--bg-tertiary);
    color: var(--text);
}

.btn-secondary:hover {
    background: var(--card);
}

.btn-danger {
    background: var(--error);
    color: white;
}

.btn-danger:hover {
    background: #dc2626;
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.8125rem;
}

/* Forms */
.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--text);
}

.form-input,
.form-select,
.form-textarea {
    width: 100%;
    padding: 0.625rem 1rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--input-bg);
    color: var(--text);
    font-size: 0.875rem;
    transition: var(--transition);
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.form-textarea {
    resize: vertical;
    min-height: 100px;
}

/* Tables */
.table-container {
    overflow-x: auto;
    border-radius: var(--radius);
    border: 1px solid var(--border);
}

table {
    width: 100%;
    border-collapse: collapse;
}

th {
    background: var(--bg-tertiary);
    padding: 0.75rem 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--text);
    border-bottom: 1px solid var(--border);
}

td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border);
    color: var(--text-secondary);
}

tr:hover {
    background: var(--card-hover);
}

/* Pagination */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    margin-top: 2rem;
    padding: 1rem;
    background: var(--card);
    border-radius: var(--radius);
    border: 1px solid var(--border);
}

.pagination-btn {
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--bg-secondary);
    color: var(--text);
    cursor: pointer;
    transition: var(--transition);
    font-size: 0.875rem;
}

.pagination-btn:hover:not(:disabled) {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.pagination-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.pagination-info {
    margin: 0 1rem;
    color: var(--text-secondary);
    font-size: 0.875rem;
}

/* Modal */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 1000;
    animation: fadeIn 0.3s;
}

.modal-overlay.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal {
    background: var(--card);
    border-radius: var(--radius-xl);
    max-width: 90vw;
    width: 900px;
    max-height: 90vh;
    overflow: hidden;
    animation: slideUp 0.3s;
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text);
}

.modal-close {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.25rem;
    transition: var(--transition);
}

.modal-close:hover {
    color: var(--text);
}

.modal-body {
    padding: 1.5rem;
    max-height: calc(90vh - 140px);
    overflow-y: auto;
}

/* Toast */
.toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    padding: 1rem 1.5rem;
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow-xl);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    animation: slideInRight 0.3s;
    z-index: 2000;
}

.toast.success {
    border-left: 4px solid var(--success);
}

.toast.error {
    border-left: 4px solid var(--error);
}

.toast.warning {
    border-left: 4px solid var(--warning);
}

.toast.info {
    border-left: 4px solid var(--info);
}

/* Charts */
/* Enhanced Chart Container */
.chart-container {
    position: relative;
    height: 280px !important;
    width: 100%;
    overflow: hidden;
}

.chart-container canvas {
    width: 100% !important;
    height: 100% !important;
    max-width: 100%;
    max-height: 100%;
}

/* Map Container Fixed Size */
.map-container {
    height: 280px !important;
    width: 100%;
    border-radius: var(--radius);f
    overflow: hidden;
    border: 1px solid var(--border);
}

/* Custom Leaflet Styles */
.leaflet-container {
    background: var(--bg-tertiary) !important;
}

.leaflet-tile-pane {
    filter: var(--map-filter, none);
}

[data-theme="dark"] .leaflet-tile-pane {
    --map-filter: hue-rotate(180deg) invert(100%) brightness(70%) contrast(120%);
}

/* Task Cards */
.task-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
}

.task-card {
    background: var(--card);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    padding: 1.25rem;
    transition: var(--transition);
    cursor: pointer;
}

.task-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.task-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 1rem;
}

.task-url {
    font-weight: 600;
    color: var(--primary);
    text-decoration: none;
    word-break: break-all;
}

.task-status {
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
}

.task-status.active {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
}

.task-status.paused {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
}

.task-status.completed {
    background: rgba(99, 102, 241, 0.1);
    color: var(--primary);
}

.task-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin: 1rem 0;
}

.task-stat {
    display: flex;
    flex-direction: column;
}

.task-stat-label {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    margin-bottom: 0.25rem;
}

.task-stat-value {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text);
}

.task-progress {
    margin: 1rem 0;
}

.progress-bar {
    height: 6px;
    background: var(--bg-tertiary);
    border-radius: 3px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: var(--gradient-primary);
    transition: width 0.3s ease;
}

.task-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}

/* Enhanced Website Preview */
.website-preview {
    width: 100%;
    height: 450px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    background: #fff;
    position: relative;
    overflow: hidden;
    margin-bottom: 1rem;
}

.website-preview iframe {
    width: 100%;
    height: 100%;
    border: none;
    background: #fff;
}

.preview-controls {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 5px;
    background: rgba(0, 0, 0, 0.8);
    padding: 8px;
    border-radius: var(--radius);
    z-index: 10;
}

.preview-btn {
    padding: 4px 8px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: var(--transition);
}

.preview-btn:hover {
    background: var(--primary-dark);
}

/* XPath Marker */
.xpath-marker {
    width: 28px;
    height: 28px;
    background: var(--primary);
    color: white;
    border: 3px solid white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.875rem;
    cursor: pointer;
    box-shadow: var(--shadow-lg);
    animation: pulse 2s infinite;
    z-index: 20;
    pointer-events: auto;
}


/* Media Grid */
.media-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 1rem;
}

.media-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    transition: var(--transition);
}

.media-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.media-preview {
    height: 140px;
    background: var(--bg-tertiary);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.media-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.media-info {
    padding: 1rem;
}

.media-filename {
    font-weight: 600;
    margin-bottom: 0.5rem;
    word-break: break-all;
    font-size: 0.875rem;
}

.media-stats {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-bottom: 0.75rem;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 3rem;
}

.empty-state-icon {
    font-size: 4rem;
    color: var(--text-tertiary);
    margin-bottom: 1rem;
}

.empty-state-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 0.5rem;
}

.empty-state-description {
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
}

/* Badge */
.badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
}

.badge-primary {
    background: rgba(99, 102, 241, 0.1);
    color: var(--primary);
}

.badge-success {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
}

.badge-warning {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
}

.badge-danger {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error);
}

/* Loading Spinner */
.spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

/* Keyword suggestions */
.keyword-suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.keyword-suggestion {
    padding: 0.375rem 0.75rem;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    cursor: pointer;
    transition: var(--transition);
}

.keyword-suggestion:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.keyword-suggestion.selected {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

/* Task creation steps */
.step-content {
    display: none;
}

.step-content.active {
    display: block;
}

.step-navigation {
    display: flex;
    justify-content: space-between;
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border);
}

/* Priority selector */
.priority-options {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-top: 0.5rem;
}

.priority-option {
    padding: 1rem;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    cursor: pointer;
    transition: var(--transition);
    text-align: center;
}

.priority-option:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
}

.priority-option.selected {
    border-color: var(--primary);
    background: rgba(99, 102, 241, 0.1);
}

.priority-title {
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.priority-price {
    color: var(--primary);
    font-weight: 700;
    font-size: 1.125rem;
}

.priority-locations {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
}

/* Mobile Bottom Navigation */
.mobile-nav {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--card);
    border-top: 1px solid var(--border);
    z-index: 50;
    padding: 0.5rem;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
}

.mobile-nav-items {
    display: flex;
    justify-content: space-around;
    align-items: center;
}

.mobile-nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    padding: 0.5rem;
    color: var(--text-secondary);
    text-decoration: none;
    font-size: 0.75rem;
    transition: var(--transition);
    border-radius: var(--radius);
    flex: 1;
}

.mobile-nav-item:active {
    transform: scale(0.95);
}

.mobile-nav-item.active {
    color: var(--primary);
    background: rgba(99, 102, 241, 0.1);
}

.mobile-nav-item i {
    font-size: 1.25rem;
}

/* Mobile Menu Overlay */
.mobile-menu-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 998;
}

.mobile-menu-overlay.active {
    display: block;
}

.mobile-menu {
    position: fixed;
    top: 0;
    left: -100%;
    bottom: 0;
    width: 85%;
    max-width: 320px;
    background: var(--card);
    transition: left 0.3s ease;
    z-index: 999;
    overflow-y: auto;
}

.mobile-menu.active {
    left: 0;
}

.mobile-menu-header {
    padding: 1.5rem;
    background: var(--primary);
    color: white;
}

.mobile-menu-content {
    padding: 1rem;
}

/* Enhanced User Menu with Dropdown */
.user-menu-container {
    position: relative;
}

.user-dropdown {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    min-width: 220px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-xl);
    display: none;
    z-index: 1000;
}

.user-dropdown.active {
    display: block;
}

.user-dropdown-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    color: var(--text);
    text-decoration: none;
    transition: var(--transition);
    cursor: pointer;
}

.user-dropdown-item:hover {
    background: var(--bg-tertiary);
}

.user-dropdown-item i {
    width: 1.25rem;
}

.user-dropdown-item.danger {
    color: var(--error);
}

/* Session Management Section */
.sessions-section {
    max-height: 300px;
    overflow-y: auto;
}

.session-item {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border);
    font-size: 0.875rem;
}

.session-item:last-child {
    border-bottom: none;
}

.session-info {
    display: flex;
    justify-content: space-between;
    align-items: start;
    gap: 0.5rem;
}

.session-details {
    flex: 1;
}

.session-location {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    color: var(--text-secondary);
    font-size: 0.8rem;
    margin-top: 0.25rem;
}

.session-delete {
    padding: 0.25rem 0.5rem;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--error);
    cursor: pointer;
    font-size: 0.75rem;
    transition: var(--transition);
}

.session-delete:hover {
    background: var(--error);
    color: white;
    border-color: var(--error);
}

/* Mobile Search Overlay */
.mobile-search-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: var(--card);
    padding: 1rem;
    border-bottom: 1px solid var(--border);
    z-index: 1001;
}

.mobile-search-overlay.active {
    display: block;
}

.mobile-search-input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--input-bg);
    color: var(--text);
    font-size: 1rem;
}

.mobile-search-toggle {
    display: none;
}

/* Responsive Improvements */
@media (max-width: 768px) {
    /* Hide desktop sidebar */
    .sidebar {
        display: none;
    }

    /* Show mobile navigation */
    .mobile-nav {
        display: block;
    }

    /* Adjust main content for mobile nav */
    .main-content {
        padding-bottom: 60px;
    }

    /* Mobile header adjustments */
    .header {
        padding: 0.75rem;
        position: sticky;
        top: 0;
        z-index: 100;
        background: var(--bg-secondary);
    }

    .search-bar {
        display: none;
    }

    .mobile-search-toggle {
        display: block;
        padding: 0.5rem;
        background: transparent;
        border: none;
        color: var(--text);
        font-size: 1.25rem;
        cursor: pointer;
    }

    /* User dropdown mobile full width */
    .user-dropdown {
        position: fixed;
        top: auto;
        bottom: 0;
        left: 0;
        right: 0;
        min-width: 100%;
        border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        max-height: 50vh;
        overflow-y: auto;
    }

    /* Hide user dropdown header on mobile */
    .user-dropdown-header {
        display: none;
    }

    /* Simplify user menu on mobile */
    .user-menu {
        padding: 0.5rem;
        gap: 0.5rem;
    }

    .user-menu > div {
        display: none;
    }

    .header-left {
        flex: 1;
    }

    .header-right {
        gap: 0.5rem;
    }

    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }

    .stat-card {
        padding: 0.875rem;
    }

    .stat-card .stat-value {
        font-size: 1.5rem;
    }

    .stat-card .stat-label {
        font-size: 0.75rem;
    }

    .task-grid {
        grid-template-columns: 1fr;
    }

    .media-grid {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    }

    .search-bar {
        width: 200px;
    }

    .header {
        padding: 1rem;
    }

    .content {
        padding: 1rem;
    }

    .modal {
        width: 95%;
        max-height: 85vh;
    }

    .priority-options {
        grid-template-columns: 1fr;
    }

    .chart-container {
        height: 200px !important;
    }

    .map-container {
        height: 250px !important;
    }

    /* Stack analytics cards vertically on mobile */
    .analytics-grid,
    div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
        gap: 1rem !important;
    }

    /* Ensure cards don't get too small */
    .card {
        min-width: 100%;
    }

    /* Improve table responsiveness */
    .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    table {
        min-width: 600px;
    }

    /* Adjust modal for mobile */
    .modal {
        width: 100%;
        max-width: 100%;
        margin: 0;
        height: 100vh;
        max-height: 100vh;
        border-radius: 0;
    }

    .modal-body {
        max-height: calc(100vh - 60px);
    }
}

/* Extra small screens (phones in portrait) */
@media (max-width: 480px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
    }

    .stat-card {
        padding: 0.75rem;
    }

    .stat-card .stat-value {
        font-size: 1.25rem;
    }

    .stat-card .stat-label {
        font-size: 0.7rem;
    }

    .card-header {
        padding: 1rem;
    }

    .card-body {
        padding: 1rem;
    }

    .btn {
        padding: 0.5rem 1rem;
        font-size: 0.8125rem;
    }

    .table-container {
        font-size: 0.8125rem;
    }

    th, td {
        padding: 0.5rem;
    }

    .media-grid {
        grid-template-columns: 1fr;
    }

    /* Ensure header stays visible */
    .header {
        position: sticky;
        top: 0;
        background: var(--bg-secondary);
        z-index: 100;
        border-bottom: 1px solid var(--border);
    }

    /* Mobile nav adjustments */
    .mobile-nav-item span {
        font-size: 0.625rem;
    }

    .mobile-nav-item i {
        font-size: 1.125rem;
    }

    /* Hide less important elements on very small screens */
    .pagination-info {
        display: none;
    }

    /* Simplify user menu even more */
    .user-menu {
        background: transparent;
        padding: 0.375rem;
    }

    .user-avatar {
        width: 28px;
        height: 28px;
        font-size: 0.875rem;
    }
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@keyframes pulse {
    0%, 100% { transform: translate(-50%, -50%) scale(1); }
    50% { transform: translate(-50%, -50%) scale(1.1); }
}

@media (max-width: 580px) {
    .mobilearticle1 {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 14px!important;
    }
    .mobilearticle2{
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 14px!important;
    }
    .logo {
        color: white !important;
    }
    .mobileol{
        height: 200px;
    overflow-y: scroll;
    }
    .user-menu-container {
        display: none!important;
    }
}
    /* Desktop/Mobile visibility classes */
.desktop-only {
    display: block !important;
}

.mobile-only {
    display: none !important;
}

@media (max-width: 768px) {
    .desktop-only {
        display: none !important;
    }

    .mobile-only {
        display: block !important;
    }
}
</style>
</head>
<body data-theme="light">
<div class="dashboard-layout">
<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
<div class="sidebar-header">
<a href="#" class="logo">
<i class="ri-seo-line"></i>
<span>SEOTIZE</span>
</a>
</div>

<nav class="sidebar-nav">
<div class="nav-section">
<div class="nav-section-title">Main</div>
<a href="#" class="nav-item active" data-page="dashboard">
<i class="ri-dashboard-line"></i>
<span>Dashboard</span>
</a>
<a href="#" class="nav-item" data-page="tasks">
<i class="ri-task-line"></i>
<span>SEO Tasks</span>
</a>
</div>

<div class="nav-section">
<div class="nav-section-title">Hosting</div>
<a href="#" class="nav-item" data-page="images">
<i class="ri-image-line"></i>
<span>Images</span>
</a>
<a href="#" class="nav-item" data-page="articles">
<i class="ri-article-line"></i>
<span>Articles</span>
</a>
</div>

<div class="nav-section">
<div class="nav-section-title">Account</div>
<a href="#" class="nav-item" data-page="billing">
<i class="ri-bank-card-line"></i>
<span>Billing</span>
</a>
<!-- Logout moved to user dropdown menu -->
</div>
</nav>
</aside>

<!-- Mobile Menu Overlay -->
<div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
<div class="mobile-menu" id="mobileMenu">
<div class="mobile-menu-header">
<div class="logo">
<i class="ri-seo-line"></i>
<span>SEOTIZE</span>
</div>
</div>
<div class="mobile-menu-content">
    <div class="nav-section">
        <div class="nav-section-title">Account</div>
        <a href="#" class="nav-item" onclick="showSessionsModal(); closeMobileMenu();">
            <i class="ri-device-line"></i>
            <span>Active Sessions</span>
            <span class="badge badge-primary" id="sessionCountMobile"></span>
        </a>
        <a href="#" class="nav-item" data-page="billing" onclick="closeMobileMenu()">
            <i class="ri-bank-card-line"></i>
            <span>Billing</span>
        </a>
    </div>
    <div style="border-top: 1px solid var(--border); margin: 0.5rem 0;"></div>
    <div class="nav-section">
        <a href="#" class="nav-item danger" style="color: var(--error);" onclick="logout()">
            <i class="ri-logout-box-line"></i>
            <span>Logout</span>
        </a>
    </div>
</div>
</div>

<!-- Mobile Bottom Navigation -->
<nav class="mobile-nav" id="mobileNav">
<div class="mobile-nav-items">
<a href="#" class="mobile-nav-item active" data-page="dashboard">
<i class="ri-dashboard-line"></i>
<span>Dashboard</span>
</a>
<a href="#" class="mobile-nav-item" data-page="tasks">
<i class="ri-task-line"></i>
<span>Tasks</span>
</a>
<a href="#" class="mobile-nav-item" data-page="images">
<i class="ri-image-line"></i>
<span>Images</span>
</a>
<a href="#" class="mobile-nav-item" data-page="articles">
<i class="ri-article-line"></i>
<span>Articles</span>
</a>
<a href="#" class="mobile-nav-item" onclick="openMobileMenu()">
<i class="ri-menu-line"></i>
<span>More</span>
</a>
</div>
</nav>

<!-- Main Content -->
<main class="main-content">
<!-- Header -->
<header class="header">
<div class="header-left">
<button class="mobile-search-toggle" onclick="toggleMobileSearch()">
<i class="ri-search-line"></i>
</button>
<div class="search-bar">
<i class="ri-search-line"></i>
<input type="text" placeholder="Search tasks, images, articles...">
</div>
</div>

<div class="header-right">
<button class="theme-toggle" onclick="toggleTheme()">
<i class="ri-moon-line" id="themeIcon"></i>
</button>

<div class="user-menu-container">
<div class="user-menu" onclick="toggleUserDropdown()">
<div class="user-avatar">
<span id="userInitial">U</span>
</div>
<div>
<div style="font-weight: 500;" id="userName">User</div>
<div style="font-size: 0.75rem; color: var(--text-secondary);" id="userEmail">user@example.com</div>
</div>
</div>

<div class="user-dropdown" id="userDropdown">


<a href="#" class="user-dropdown-item" onclick="showSessionsModal()">
<i class="ri-device-line"></i>
<span>Active Sessions</span>
<span class="badge badge-primary" id="sessionCount"></span>
</a>

<div style="border-top: 1px solid var(--border); margin: 0.5rem 0;"></div>

<a href="#" class="user-dropdown-item danger" onclick="logout()">
<i class="ri-logout-box-line"></i>
<span>Logout</span>
</a>
</div>
</div>
</div>
</header>

<!-- Mobile Search Overlay -->
<div class="mobile-search-overlay" id="mobileSearchOverlay">
<div style="display: flex; gap: 0.5rem; align-items: center;">
<button onclick="toggleMobileSearch()" style="background: transparent; border: none; color: var(--text); font-size: 1.5rem; padding: 0.5rem;">
<i class="ri-arrow-left-line"></i>
</button>
<input type="text" class="mobile-search-input" placeholder="Search..." autofocus>
</div>
</div>

<!-- Content Area -->
<div class="content" id="content">
<!-- Dynamic content will be loaded here -->
</div>
</main>
</div>

<!-- Modal Container -->
<div class="modal-overlay" id="modalOverlay">
<div class="modal">
<div class="modal-header">
<h3 class="modal-title" id="modalTitle">Modal Title</h3>
<button class="modal-close" onclick="closeModal()">
<i class="ri-close-line"></i>
</button>
</div>
<div class="modal-body" id="modalBody">
<!-- Modal content -->
</div>
</div>
</div>

<!-- JavaScript -->
<script>
// API Configuration
const API_BASE = 'https://api.seotize.net';
let sessionToken = getCookie('session_token') || localStorage.getItem('authToken');

// Global State
let currentData = {
    user: null,
    tasks: [],
    images: [],
    articles: [],
    domains: [],
    billing: [],
    selectedLocations: [],
    currentStep: 1,
    taskPriority: 'standard',
    selectedKeywords: []
};

let charts = {};
let globalMap = null;
let paginationState = {
    tasks: { page: 1, pageSize: 10, total: 0, hasNext: false },
    images: { page: 1, pageSize: 20, total: 0, hasNext: false },
    articles: { page: 1, pageSize: 10, total: 0, hasNext: false },
    billing: { page: 1, pageSize: 10, total: 0, hasNext: false }
};

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    if (!sessionToken) {
        window.location.href = '/login.html';
        return;
    }

    initializeEventListeners();
    loadDashboard();
    initializeTheme();

    // Initialize user info after dashboard loads
    setTimeout(() => {
        updateUserInfo();
    }, 100);
});

// Event Listeners
function initializeEventListeners() {
    // Desktop navigation
    document.querySelectorAll('.sidebar .nav-item[data-page]').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            navigateTo(item.dataset.page);
        });
    });

    // Mobile navigation
    document.querySelectorAll('.mobile-nav-item[data-page]').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            navigateTo(item.dataset.page);
        });
    });

    // Mobile menu navigation
    document.querySelectorAll('.mobile-menu .nav-item[data-page]').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            closeMobileMenu();
            navigateTo(item.dataset.page);
        });
    });

    // Modal click outside to close
    document.getElementById('modalOverlay').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
            closeModal();
        }
    });

    // Close user dropdown when clicking outside
    document.addEventListener('click', (e) => {
        const userMenuContainer = document.querySelector('.user-menu-container');
        const userDropdown = document.getElementById('userDropdown');

        if (!userMenuContainer.contains(e.target)) {
            userDropdown.classList.remove('active');
        }
    });

    // Mobile menu overlay close
    document.getElementById('mobileMenuOverlay')?.addEventListener('click', closeMobileMenu);
}

// Mobile Menu Functions
function openMobileMenu() {
    document.getElementById('mobileMenu').classList.add('active');
    document.getElementById('mobileMenuOverlay').classList.add('active');
}

function closeMobileMenu() {
    document.getElementById('mobileMenu').classList.remove('active');
    document.getElementById('mobileMenuOverlay').classList.remove('active');
}

// Mobile Search Functions
function toggleMobileSearch() {
    const overlay = document.getElementById('mobileSearchOverlay');
    overlay.classList.toggle('active');
    if (overlay.classList.contains('active')) {
        overlay.querySelector('input').focus();
    }
}

// User Dropdown Toggle
function toggleUserDropdown() {
    const dropdown = document.getElementById('userDropdown');
    dropdown.classList.toggle('active');
}

// Get Other Sessions (excluding current)
function getOtherSessions() {
    const sessions = currentData.user?.sessions || [];
    // Filter out current session token
    return sessions.filter(session => session.token !== sessionToken);
}

// Get Current Session
function getCurrentSession() {
    const sessions = currentData.user?.sessions || [];
    // Find current session token
    return sessions.find(session => session.token === sessionToken);
}

// Show Sessions Modal
function showSessionsModal() {
    const otherSessions = getOtherSessions();
    const currentSession = getCurrentSession();

    showModal('Active Sessions', `
        <div style="max-height: 75vh; display: flex; flex-direction: column;">
            <!-- Header -->
            <div style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border);">
                <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0;">
                    Manage your active login sessions. You can revoke access for sessions you don't recognize.
                </p>
            </div>

            <!-- Other Sessions Section -->
            <div style="flex: 1; min-height: 0; margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 1rem 0; color: var(--text); display: flex; align-items: center; gap: 0.5rem;">
                    <i class="ri-device-line"></i> Other Sessions
                    ${otherSessions.length > 0 ? `<span style="background: var(--warning); color: white; padding: 0.2rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.7rem; font-weight: 600;">${otherSessions.length}</span>` : ''}
                </h4>

                <div style="border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-secondary); max-height: 200px; overflow-y: auto;">
                    ${otherSessions.length > 0 ? otherSessions.map((session, index) => {
                        const createdDate = new Date(session.timestamp);
                        const expiresDate = new Date(session.expires_at);
                        const isExpired = expiresDate < new Date();

                        return `
                        <div style="padding: 1rem; border-bottom: ${index === otherSessions.length - 1 ? 'none' : '1px solid var(--border)'};">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="ri-map-pin-line" style="color: var(--primary);"></i>
                                        ${session.country_code} - ${session.ip_address}
                                        ${isExpired ? `<span style="background: var(--error); color: white; padding: 0.1rem 0.4rem; border-radius: var(--radius-sm); font-size: 0.65rem;">EXPIRED</span>` : ''}
                                    </div>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                                        <div><i class="ri-time-line"></i> ${createdDate.toLocaleDateString()} ${createdDate.toLocaleTimeString()}</div>
                                        <div><i class="ri-calendar-line"></i> ${isExpired ? '<span style="color: var(--error);">Expired</span>' : `Expires ${expiresDate.toLocaleDateString()}`}</div>
                                    </div>
                                    <code style="font-size: 0.65rem; color: var(--text-tertiary); word-break: break-all;">
                                        ${session.token.substring(0, 20)}...
                                    </code>
                                </div>
                                <button onclick="revokeSession('${session.token}')" style="margin-left: 1rem; padding: 0.4rem 0.8rem; background: var(--error); color: white; border: none; border-radius: var(--radius-sm); font-size: 0.75rem; cursor: pointer;">
                                    Revoke
                                </button>
                            </div>
                        </div>
                        `;
                    }).join('') : `
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="ri-shield-check-line" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                            <p style="margin: 0; font-weight: 500;">No other sessions</p>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem;">You're only logged in here</p>
                        </div>
                    `}
                </div>
            </div>
        </div>

        <!-- Current Session Section (Outside main container) -->
        ${currentSession ? `
            <div style="margin-top: 1rem; padding: 1rem; background: var(--card); border: 1px solid var(--success); border-radius: var(--radius);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600; color: var(--success); margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="ri-computer-line"></i> Current Session
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">
                            ${currentSession.country_code} - ${currentSession.ip_address}
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 0.25rem;">
                            Created: ${new Date(currentSession.timestamp).toLocaleDateString()}
                        </div>
                    </div>
                    <span style="background: var(--success); color: white; padding: 0.3rem 0.6rem; border-radius: var(--radius-sm); font-size: 0.75rem; font-weight: 600;">
                        Active
                    </span>
                </div>
            </div>
        ` : ''}

        <!-- Revoke All Button -->
        ${otherSessions.length > 0 ? `
            <div style="margin-top: 1.5rem; text-align: center; padding-top: 1rem; border-top: 1px solid var(--border);">
                <button class="btn btn-danger" onclick="revokeAllSessions()" style="padding: 0.6rem 1.5rem; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 0.5rem;">
                    <i class="ri-logout-box-line"></i> Revoke All Other Sessions (${otherSessions.length})
                </button>
                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">
                    Logs you out from all other devices
                </div>
            </div>
        ` : ''}
    `, '85vw');

    // Close dropdown
    document.getElementById('userDropdown').classList.remove('active');
}

// Revoke Session
async function revokeSession(token) {
    if (!confirm('Are you sure you want to revoke this session?')) {
        return;
    }

    try {
        // Use the logout endpoint with GET request (as per the user's correction)
        const response = await fetch(`${API_BASE}/logout`, {
            method: 'GET',
            headers: {
                'Session-Token': token,  // Use the token to be revoked instead of current session
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error('Failed to revoke session');
        }

        // Remove from local data
        if (currentData.user && currentData.user.sessions) {
            currentData.user.sessions = currentData.user.sessions.filter(s => s.token !== token);
        }

        showToast('Session revoked successfully', 'success');
        showSessionsModal(); // Refresh modal
        updateUserInfo(); // Update session count

    } catch (error) {
        console.error('Revoke session error:', error);
        showToast('Failed to revoke session', 'error');
    }
}

// Revoke All Sessions
async function revokeAllSessions() {
    if (!confirm('Are you sure you want to revoke all other sessions? This will log you out from all other devices.')) {
        return;
    }

    try {
        await api('/sessions/revoke-all', { method: 'POST' });

        // Keep only current session
        if (currentData.user && currentData.user.sessions) {
            currentData.user.sessions = currentData.user.sessions.filter(s => s.token === sessionToken);
        }

        showToast('All other sessions revoked successfully', 'success');
        closeModal();
        updateUserInfo(); // Update session count

    } catch (error) {
        console.error('Revoke all sessions error:', error);
        showToast('Failed to revoke sessions', 'error');
    }
}

// Theme Management
function initializeTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.body.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);
}

function toggleTheme() {
    const currentTheme = document.body.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    document.body.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeIcon(newTheme);

    // Refresh charts and map with new theme
    if (charts.traffic) {
        setTimeout(updateCharts, 100);
    }
}

function updateThemeIcon(theme) {
    document.getElementById('themeIcon').className = theme === 'light' ? 'ri-moon-line' : 'ri-sun-line';
}

// Navigation
function navigateTo(page) {
    // Update desktop nav
    document.querySelectorAll('.sidebar .nav-item').forEach(item => item.classList.remove('active'));
    document.querySelector(`.sidebar .nav-item[data-page="${page}"]`)?.classList.add('active');

    // Update mobile nav
    document.querySelectorAll('.mobile-nav-item').forEach(item => item.classList.remove('active'));
    document.querySelector(`.mobile-nav-item[data-page="${page}"]`)?.classList.add('active');

    switch(page) {
        case 'dashboard': loadDashboard(); break;
        case 'tasks': loadTasks(); break;
        case 'images': loadImages(); break;
        case 'articles': loadArticles(); break;
        case 'billing': loadBilling(); break;
        case 'profile': loadProfile(); break;
    }
}

// Update User Info
function updateUserInfo() {
    const user = currentData.user;
    if (!user) return;

    const email = user.email;
    const name = email.split('@')[0];
    const initial = email[0].toUpperCase();

    // Update all user display elements
    document.getElementById('userInitial').textContent = initial;
    document.getElementById('userName').textContent = name;
    document.getElementById('userEmail').textContent = email;

    // Update session count (excluding current session)
    const otherSessions = getOtherSessions();
    const totalSessions = otherSessions.length + 1;

    // Update both desktop and mobile session counts
    const desktopCountEl = document.getElementById('sessionCount');
    if (desktopCountEl) desktopCountEl.textContent = totalSessions;

    const mobileCountEl = document.getElementById('sessionCountMobile');
    if (mobileCountEl) mobileCountEl.textContent = totalSessions;
}

// API Helper
async function api(endpoint, options = {}) {
    try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
            ...options,
            headers: {
                'Session-Token': sessionToken,
                'Content-Type': 'application/json',
                ...(options.headers || {})
            }
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error?.message || data.message || 'API Error');
        }

        return data;
    } catch (error) {
        console.error('API Error:', error);
        showToast(error.message, 'error');
        throw error;
    }
}

// Helper function to format numbers with K/M abbreviations
function formatNumber(num) {
    if (num < 1000) {
        return num.toString();
    } else if (num < 1000000) {
        return (num / 1000).toFixed(1).replace('.0', '') + 'k';
    } else if (num < 1000000000) {
        return (num / 1000000).toFixed(1).replace('.0', '') + 'M';
    } else {
        return (num / 1000000000).toFixed(1).replace('.0', '') + 'B';
    }
}

// Dashboard
async function loadDashboard(page = 1) {
    try {
        showSpinner();
        const response = await api(`/users/dashboard?page=${page}&page_size=10`);
        const { data, pagination } = response;
        const user = data.user;
        currentData.user = user;

        // Update pagination state for dashboard tasks
        paginationState.tasks = {
            page: pagination.current,
            pageSize: pagination.size,
            total: pagination.total,
            hasNext: pagination.has_next
        };

        // Sort tasks by date (newest first)
        const sortedTasks = (user.tasks || []).sort((a, b) =>
            new Date(b.date_created) - new Date(a.date_created)
        );

        // Update user info
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('userName').textContent = user.email.split('@')[0];
        document.getElementById('userInitial').textContent = user.email[0].toUpperCase();

        updateUserInfo();
        const content = document.getElementById('content');
        content.innerHTML = `
        <div class="stats-grid">
        <div class="stat-card">
        <div class="stat-icon primary">
        <i class="ri-task-line"></i>
        </div>
        <div class="stat-content">
        <div class="stat-value">${user.usage_summary?.total_tasks || 0}</div>
        <div class="stat-label">Total Tasks</div>
        </div>
        </div>
        <div class="stat-card">
        <div class="stat-icon success">
        <i class="ri-eye-line"></i>
        </div>
        <div class="stat-content">
        <div class="stat-value">${formatNumber(user.usage_summary?.total_views || 0)}</div>
        <div class="stat-label">Total Views</div>
        </div>
        </div>
        <div class="stat-card">
        <div class="stat-icon warning">
        <i class="ri-key-line"></i>
        </div>
        <div class="stat-content">
        <div class="stat-value">${user.usage_summary?.total_keywords || 0}</div>
        <div class="stat-label">Keywords</div>
        </div>
        </div>
        <div class="stat-card">
        <div class="stat-icon error">
        <i class="ri-wallet-line"></i>
        </div>
        <div class="stat-content">
        <div class="stat-value">$${(user.task_statistics?.available_charge || 0).toFixed(2)}</div>
        <div class="stat-label">Available Budget</div>
        </div>
        </div>
        </div>

        <div class="analytics-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
        <div class="card">
        <div class="card-header">
        <h3 class="card-title">Task Performance</h3>
        </div>
        <div class="card-body">
        <div class="chart-container" style="height: 280px; position: relative;">
        <canvas id="taskChart"></canvas>
        </div>
        </div>
        </div>

        <div class="card">
        <div class="card-header">
        <h3 class="card-title">Views by Country</h3>
        </div>
        <div class="card-body">
        <div class="map-container" id="countryMap" style="height: 280px;"></div>
        </div>
        </div>
        </div>

        <div class="card">
        <div class="card-header">
        <h3 class="card-title">Recent Tasks</h3>
        <button class="btn btn-primary btn-sm" onclick="navigateTo('tasks')">View All</button>
        </div>
        <div class="card-body">

        <!-- Desktop Table Version -->
        <div class="table-container desktop-only">
        <table>
        <thead>
        <tr>
        <th>URL</th>
        <th>Created</th>
        <th>Keywords</th>
        <th>Views</th>
        <th>Budget Status</th>
        <th>Available</th>
        <th>Status</th>
        <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        ${sortedTasks.map(task => {
            const createdDate = new Date(task.date_created).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            // Budget calculation with used and remaining display
            const totalCharge = task.total_charge;
            const availableCharge = task.available_charge;
            const remainingPercent = Math.max(0, task.remaining_percentage || 0);

            // Calculate used amount and display values
            let usedAmount = 0;
            let usedPercent = 0;
            let progressBarWidth = remainingPercent;
            let progressColor = '#8b5cf6'; // Purple for 100%

            if (remainingPercent <= 100) {
                // Normal case: calculate used from remaining percentage
                usedPercent = Math.max(0, 100 - remainingPercent);
                usedAmount = (totalCharge * usedPercent) / 100;

                // Color coding based on remaining percentage
                if (remainingPercent >= 100) {
                    progressColor = '#8b5cf6'; // Purple for 100%
                } else if (remainingPercent >= 10) {
                    progressColor = '#10b981'; // Green for 10% to 99%
                } else {
                    progressColor = '#ef4444'; // Red for below 10%
                }

                progressBarWidth = remainingPercent;
            } else {
                // Recharged case: remaining > 100%
                const rechargeAmount = availableCharge - totalCharge;
                usedAmount = 0;
                usedPercent = 0;
                progressColor = '#8b5cf6'; // Purple for recharged
                progressBarWidth = 100;
            }

            return `
            <tr>
            <td>
            <a href="${task.url}" target="_blank" style="color: var(--primary); text-decoration: none;">
            ${task.url.length > 30 ? task.url.substring(0, 30) + '...' : task.url}
            </a>
            </td>
            <td style="font-size: 0.875rem; color: var(--text-secondary);">${createdDate}</td>
            <td>
            <span class="badge badge-primary">${task.keywords_count}</span>
            </td>
            <td>
            <span class="badge badge-success">${formatNumber(task.views_count)}</span>
            </td>
            <td>
            <div style="display: flex; flex-direction: column; gap: 0.25rem; min-width: 120px;">
            <div style="font-size: 0.75rem; text-align: center;">
            Used: $${usedAmount.toFixed(2)} ${remainingPercent.toFixed(0)}%
            </div>
            <div class="progress-bar" style="height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden;">
            <div class="progress-fill" style="width: ${progressBarWidth}%; height: 100%; background: ${progressColor}; transition: width 0.3s ease, background-color 0.3s ease;"></div>
            </div>
            </div>
            </td>
            <td style="font-weight: 600;">$${availableCharge.toFixed(2)}</td>
            <td>
            <span class="badge badge-${availableCharge > 0 ? 'success' : 'warning'}">
            ${availableCharge > 0 ? 'Active' : 'Depleted'}
            </span>
            </td>
            <td>
            <button class="btn btn-sm" onclick="viewTaskDetails('${task._id}')" title="View Details">
            <i class="ri-eye-line"></i>
            </button>
            </td>
            </tr>
            `;
        }).join('')}
        </tbody>
        </table>
        </div>

        <!-- Mobile Card Version -->
        <div class="mobile-only">
        ${sortedTasks.length > 0 ? sortedTasks.map(task => {
            const createdDate = new Date(task.date_created).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            // Same calculation logic as desktop version
            const totalCharge = task.total_charge;
            const availableCharge = task.available_charge;
            const remainingPercent = Math.max(0, task.remaining_percentage || 0);

            // Calculate used amount and display values - SAME AS DESKTOP
            let usedAmount = 0;
            let usedPercent = 0;
            let progressBarWidth = remainingPercent;
            let progressColor = '#8b5cf6'; // Purple for 100%

            if (remainingPercent <= 100) {
                // Normal case: calculate used from remaining percentage
                usedPercent = Math.max(0, 100 - remainingPercent);
                usedAmount = (totalCharge * usedPercent) / 100;

                // Color coding based on remaining percentage
                if (remainingPercent >= 100) {
                    progressColor = '#8b5cf6'; // Purple for 100%
                } else if (remainingPercent >= 10) {
                    progressColor = '#10b981'; // Green for 10% to 99%
                } else {
                    progressColor = '#ef4444'; // Red for below 10%
                }

                progressBarWidth = remainingPercent;
            } else {
                // Recharged case: remaining > 100%
                const rechargeAmount = availableCharge - totalCharge;
                usedAmount = 0;
                usedPercent = 0;
                progressColor = '#8b5cf6'; // Purple for recharged
                progressBarWidth = 100;
            }

            return `
            <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem; cursor: pointer; transition: var(--transition);" onclick="viewTaskDetails('${task._id}')" ontouchstart="this.style.background='var(--card-hover)'" ontouchend="this.style.background='var(--bg-secondary)'">

                <!-- Header: URL and Status -->
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                    <div style="flex: 1; min-width: 0;">
                        <a href="${task.url}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 500; font-size: 0.9rem; display: block; word-break: break-all; line-height: 1.3;" onclick="event.stopPropagation()">
                            ${task.url.length > 45 ? task.url.substring(0, 45) + '...' : task.url}
                        </a>
                        <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 0.25rem;">
                            ${createdDate}
                        </div>
                    </div>
                    <span class="badge badge-${availableCharge > 0 ? 'success' : 'warning'}" style="margin-left: 0.5rem; flex-shrink: 0; font-size: 0.7rem;">
                        ${availableCharge > 0 ? 'Active' : 'Depleted'}
                    </span>
                </div>

                <!-- Stats Row -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0.75rem; background: var(--bg-tertiary); border-radius: var(--radius-sm);">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 0.75rem; color: var(--text-secondary);">Keywords:</span>
                        <span class="badge badge-primary" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">${task.keywords_count}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 0.75rem; color: var(--text-secondary);">Views:</span>
                        <span class="badge badge-success" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">${formatNumber(task.views_count)}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 0.75rem; color: var(--text-secondary);">Available:</span>
                        <span style="font-weight: 600; font-size: 0.8rem; color: var(--text);">$${availableCharge.toFixed(2)}</span>
                    </div>
                </div>

                <!-- Budget Progress -->
                <div style="margin-bottom: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.75rem; color: var(--text-secondary);">Budget Remaining</span>
                        <span style="font-size: 0.75rem; color: var(--text-secondary);">${remainingPercent.toFixed(0)}% (Used: $${usedAmount.toFixed(2)})</span>
                    </div>
                    <div class="progress-bar" style="height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden;">
                        <div class="progress-fill" style="width: ${progressBarWidth}%; height: 100%; background: ${progressColor}; transition: width 0.3s ease, background-color 0.3s ease;"></div>
                    </div>
                </div>

                <!-- Actions -->
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-sm" onclick="event.stopPropagation(); viewTaskDetails('${task._id}')" style="flex: 1; font-size: 0.75rem; padding: 0.4rem 0.8rem;">
                        <i class="ri-eye-line"></i> Details
                    </button>
                    <button class="btn btn-sm" onclick="event.stopPropagation(); rechargeTask('${task._id}')" style="flex: 1; font-size: 0.75rem; padding: 0.4rem 0.8rem;">
                        <i class="ri-wallet-line"></i> Recharge
                    </button>
                </div>
            </div>
            `;
        }).join('') : `
            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                <i class="ri-task-line" style="font-size: 2.5rem; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                <p style="margin: 0; font-weight: 500;">No tasks yet</p>
                <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem;">Create your first SEO task</p>
            </div>
        `}
        </div>

        <!-- Fixed pagination with proper structure -->
        <div class="pagination" style="flex-direction: column;">
        <div style="display: flex; justify-content: center; align-items: center; gap: 0.5rem;">
        <button class="pagination-btn" ${pagination.current <= 1 ? 'disabled' : ''} onclick="loadDashboard(${pagination.current - 1})">
        <i class="ri-arrow-left-s-line"></i> Previous
        </button>

        ${(() => {
            let paginationButtons = '';
            const totalPages = Math.max(1, pagination.pages);
            const currentPage = pagination.current;

            if (totalPages <= 5) {
                // Show all pages if 5 or fewer
                for (let i = 1; i <= totalPages; i++) {
                    paginationButtons += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="loadDashboard(${i})">${i}</button>`;
                }
            } else {
                // Show condensed pagination for more than 5 pages
                if (currentPage > 2) {
                    paginationButtons += `<button class="pagination-btn" onclick="loadDashboard(1)">1</button>`;
                    if (currentPage > 3) {
                        paginationButtons += '<span class="pagination-info">...</span>';
                    }
                }

                const startPage = Math.max(1, currentPage - 1);
                const endPage = Math.min(totalPages, currentPage + 1);

                for (let i = startPage; i <= endPage; i++) {
                    paginationButtons += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="loadDashboard(${i})">${i}</button>`;
                }

                if (currentPage < totalPages - 1) {
                    if (currentPage < totalPages - 2) {
                        paginationButtons += '<span class="pagination-info">...</span>';
                    }
                    paginationButtons += `<button class="pagination-btn" onclick="loadDashboard(${totalPages})">${totalPages}</button>`;
                }
            }

            return paginationButtons;
        })()}

        <button class="pagination-btn" ${!pagination.has_next ? 'disabled' : ''} onclick="loadDashboard(${pagination.current + 1})">
        Next <i class="ri-arrow-right-s-line"></i>
        </button>
        </div>

        <div class="pagination-info">
        Page ${pagination.current} of ${Math.max(1, pagination.pages)} | Showing ${sortedTasks.length} of ${pagination.total} tasks
        </div>
        </div>
        </div>
        </div>
        `;

        // Initialize charts and map
        setTimeout(() => {
            initializeCharts(user);
            initializeCountryMap(user);
        }, 100);

    } catch (error) {
        console.error('Dashboard error:', error);
        showErrorState('Failed to load dashboard');
    }
}

// Tasks
async function loadTasks(page = 1) {
    try {
        showSpinner();
        const response = await api(`/users/dashboard?page=${page}&page_size=10`);
        const { data, pagination } = response;
        const user = data.user;
        currentData.tasks = user.tasks || [];

        // Ensure pagination state is properly set
        paginationState.tasks = {
            page: pagination.current || 1,
            pageSize: pagination.size || 10,
            total: pagination.total || 0,
            hasNext: pagination.has_next || false
        };

        const content = document.getElementById('content');
        content.innerHTML = `
        <div class="mobilearticle2" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="font-size: 1.5rem; font-weight: 700;">SEO Tasks</h2>
        <button class="btn btn-primary" onclick="showTaskModal()">
        <i class="ri-add-line"></i> Create New Task
        </button>
        </div>

        <div class="task-grid">
        ${currentData.tasks.map(task => `
            <div class="task-card" onclick="viewTaskDetails('${task._id}')">
            <div class="task-header">
            <a href="${task.url}" target="_blank" class="task-url" onclick="event.stopPropagation()">${task.url}</a>
            <span class="task-status active">Active</span>
            </div>

            <div class="task-stats">
            <div class="task-stat">
            <div class="task-stat-label">Keywords</div>
            <div class="task-stat-value">${task.keywords_count}</div>
            </div>
            <div class="task-stat">
            <div class="task-stat-label">Views</div>
            <div class="task-stat-value">${task.views_count}</div>
            </div>
            <div class="task-stat">
            <div class="task-stat-label">Budget Used</div>
            <div class="task-stat-value">$${(task.total_charge - task.available_charge).toFixed(2)}</div>
            </div>
            <div class="task-stat">
            <div class="task-stat-label">Available</div>
            <div class="task-stat-value">$${task.available_charge.toFixed(2)}</div>
            </div>
            </div>

            <div class="task-progress">
            <div class="progress-bar">
            <div class="progress-fill" style="width: ${task.remaining_percentage}%; background: ${task.remaining_percentage >= 100 ? '#8b5cf6' : task.remaining_percentage >= 10 ? '#10b981' : '#ef4444'}; transition: width 0.3s ease, background-color 0.3s ease;"></div>
            </div>
            </div>

            <div class="task-actions">
            <button class="btn btn-sm" onclick="event.stopPropagation(); viewTaskDetails('${task._id}')">
            <i class="ri-eye-line"></i> Details
            </button>
            <button class="btn btn-sm" onclick="event.stopPropagation(); rechargeTask('${task._id}')">
            <i class="ri-wallet-line"></i> Recharge
            </button>
            </div>
            </div>
            `).join('')}
            </div>

            ${currentData.tasks.length === 0 ? `
                <div class="empty-state">
                <div class="empty-state-icon">
                <i class="ri-task-line"></i>
                </div>
                <div class="empty-state-title">No Tasks Yet</div>
                <div class="empty-state-description">Create your first SEO task to start optimizing your website</div>
                <button class="btn btn-primary" onclick="showTaskModal()">Create First Task</button>
                </div>
                ` : generatePagination('tasks', loadTasks)}
                `;

    } catch (error) {
        console.error('Tasks error:', error);
        showErrorState('Failed to load tasks');
    }
}

// Images
async function loadImages(page = 1) {
    try {
        showSpinner();
        const response = await api(`/images/dashboard?page=${page}&page_size=20`);
        const { data, pagination } = response;

        currentData.images = data.images || [];
        paginationState.images = {
            page: pagination.current,
            pageSize: pagination.size,
            total: pagination.total,
            hasNext: pagination.has_next
        };

        const content = document.getElementById('content');
        content.innerHTML = `
        <div class="mobilearticle2" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="font-size: 1.5rem; font-weight: 700;">Image Hosting</h2>
        <div style="display: flex; gap: 1rem; align-items: center;">
        <div style="font-size: 0.875rem; color: var(--text-secondary);">
        ${data.user?.uploaded || 0}/${(data.user?.uploaded || 0) + (data.user?.remaining || 0)} images used
        </div>
        <button class="btn btn-primary" onclick="showImageUploadModal()">
        <i class="ri-upload-line"></i> Upload Images
        </button>
        </div>
        </div>

        <div class="media-grid">
        ${currentData.images.map(image => `
    <div class="media-card">
        <div class="media-preview" onclick="window.open('${image.cdn_url}', '_blank')" style="cursor: pointer;" title="Click to open full image">
            <img src="${image.cdn_url}" alt="${image.original_filename}" loading="lazy">
        </div>
        <div class="media-info">
            <div class="media-filename">${image.original_filename}</div>
            <div class="media-stats">
                <span>${image.total_views} views</span>
                <span>${new Date(image.upload_date).toLocaleDateString()}</span>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                <button class="btn btn-sm" onclick="showImageDetails('${image.image_id}')">
                    <i class="ri-eye-line"></i> Details
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteImage('${image.image_id}')">
                    <i class="ri-delete-bin-line"></i> Delete
                </button>
            </div>
        </div>
    </div>
        `).join('')}
        </div>

            ${currentData.images.length === 0 ? `
                <div class="empty-state">
                <div class="empty-state-icon">
                <i class="ri-image-line"></i>
                </div>
                <div class="empty-state-title">No Images Uploaded</div>
                <div class="empty-state-description">Upload images to host them on our CDN with analytics</div>
                <button class="btn btn-primary" onclick="showImageUploadModal()">Upload First Image</button>
                </div>
                ` : ''}

                ${paginationState.images.total > paginationState.images.pageSize ? generatePagination('images', loadImages) : ''}
                `;

    } catch (error) {
        console.error('Images error:', error);
        showErrorState('Failed to load images');
    }
}

// Articles with Domains
async function loadArticles(page = 1) {
    try {
        showSpinner();

        // Single API call gets both articles and domains
        const response = await api(`/dashboard/articles?page=${page}&page_size=10`);
        const { data, pagination } = response;

        // Extract articles and domains from the response
        currentData.articles = data.articles || [];
        currentData.domains = data.user?.domains || [];

        // Update pagination state
        paginationState.articles = {
            page: pagination.current || page,
            pageSize: pagination.size || 10,
            total: pagination.total || 0,
            hasNext: pagination.has_next || false
        };

        const content = document.getElementById('content');
        content.innerHTML = `
        <div class="mobilearticle2" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="font-size: 1.5rem; font-weight: 700;">Articles & Domains</h2>
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-secondary" onclick="showDomainModal()">
                    <i class="ri-global-line"></i> Add Domain
                </button>
                <button class="btn btn-primary" onclick="showArticleModal()">
                    <i class="ri-add-line"></i> Create Article
                </button>
            </div>
        </div>

        <!-- Domains Section -->
        <div class="card" style="margin-bottom: 1.5rem">
            <div class="card-header">
                <h3 class="card-title">Domain Verification</h3>
                <span class="badge badge-primary">${currentData.domains.length} domains</span>
            </div>
            <div class="card-body" id="domainsList">
                ${currentData.domains.length > 0 ? currentData.domains.map(domain => `
                    <div class="mobilearticle1" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span class="badge badge-${domain.verified ? 'success' : 'warning'}">
                                ${domain.verified ? '✓ Verified' : '⏳ Pending'}
                            </span>
                            <span>${domain.domain}</span>
                        </div>
                        ${!domain.verified ? `
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-sm" onclick="showVerificationInstructions('${domain.domain}', '${domain.txt_record || ''}')">Instructions</button>
                                <button class="btn btn-sm btn-primary" onclick="verifyDomain('${domain.domain}')">Verify Now</button>
                            </div>
                        ` : ''}
                    </div>
                `).join('') : `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        No domains added yet. Add a domain to start publishing articles.
                    </div>
                `}
            </div>
        </div>

        <!-- Articles Section -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Published Articles</h3>
                <span class="badge badge-primary">${paginationState.articles.total} articles</span>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Domain</th>
                                <th>Published</th>
                                <th>Views</th>
                                <th>Images</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentData.articles.map(article => `
                                <tr>
                                    <td>
                                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${article.subject}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">ID: ${article.article_id}</div>
                                    </td>
                                    <td>
                                        <a href="https://${article.url}" target="_blank" class="badge badge-primary" style="text-decoration: none;">
                                            ${article.url}
                                        </a>
                                    </td>
                                    <td style="font-size: 0.875rem; color: var(--text-secondary);">
                                        ${new Date(article.creation_date).toLocaleDateString('en-US', {
                                            year: 'numeric',
                                            month: 'short',
                                            day: 'numeric'
                                        })}
                                    </td>
                                    <td>
                                        <span class="badge badge-success">${article.total_views || 0}</span>
                                    </td>
                                    <td>
                                        <span class="badge badge-warning">${(article.images || []).length}</span>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 0.25rem;">
                                            <button class="btn btn-sm" onclick="viewArticle('${article.article_id}')" title="View Details">
                                                <i class="ri-eye-line"></i>
                                            </button>
                                            <button class="btn btn-sm" onclick="editArticle('${article.article_id}')" title="Edit">
                                                <i class="ri-edit-line"></i>
                                            </button>
                                            <button class="btn btn-sm" onclick="window.open('https://${article.url}', '_blank')" title="View Live">
                                                <i class="ri-external-link-line"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteArticle('${article.article_id}')" title="Delete">
                                                <i class="ri-delete-bin-line"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                ${currentData.articles.length === 0 ? `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="ri-article-line"></i>
                        </div>
                        <div class="empty-state-title">No Articles Published</div>
                        <div class="empty-state-description">Create your first article to start publishing content</div>
                        <button class="btn btn-primary" onclick="showArticleModal()">Create First Article</button>
                    </div>
                ` : generatePagination('articles', loadArticles)}
            </div>
        </div>
        `;

    } catch (error) {
        console.error('Articles error:', error);
        showErrorState('Failed to load articles and domains');
    }
}

// Upgraded Billing Function
async function loadBilling(page = 1, type = 'all') {
    try {
        showSpinner();
        // We now need two API calls: one for subscription status and one for billing history.
        const [planResponse, historyResponse] = await Promise.all([
            api('/hosting/subscription-status'),
            api(`/dashboard/billings?page=${page}&limit=10&type=${type}`)
        ]);

        const planData = planResponse.data;
        const historyData = historyResponse.data;

        // --- 1. Current Plan Data ---
        const planName = planData.current_plan || 'free';
        const isSubscribed = planData.is_subscription;
        let expiryHTML = '';
        if (planData.expiry_date) {
            const expiry = new Date(planData.expiry_date);
            const now = new Date();
            const daysLeft = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
            expiryHTML = `<div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">
                ${isSubscribed ? 'Renews' : 'Expires'} in <strong>${daysLeft > 0 ? daysLeft : 0} days</strong> (${expiry.toLocaleDateString()})
            </div>`;
        }
        const imagesUsedPercent = (planData.images_uploads / (planData.images_limit || 1)) * 100;
        const articlesUsedPercent = (planData.article_uploads / (planData.articles_limit || 1)) * 100;


        // --- 2. Transaction History Data ---
        const taskPayments = historyData.tasks || [];
        const hostingPayments = historyData.hosting || [];
        const allPayments = [...taskPayments, ...hostingPayments];
        paginationState.billing = {
            page: historyData.pagination.page,
            pageSize: historyData.pagination.limit,
            total: historyData.pagination.total,
            hasNext: historyData.pagination.page < historyData.pagination.pages
        };

        // --- 3. Render everything together ---
        const content = document.getElementById('content');
        content.innerHTML = `
        <style>
            /* Add some new styles for the plan cards, harmonized with your app */
            .plan-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
            .plan-card { padding: 1.25rem; border: 2px solid var(--border); border-radius: var(--radius-lg); cursor: pointer; transition: var(--transition); }
            .plan-card:hover { border-color: var(--primary-light); transform: translateY(-3px); box-shadow: var(--shadow); }
            .plan-card.selected { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); }
            .plan-card h4 { margin-bottom: 1rem; }
            .plan-card ul { list-style: none; padding: 0; margin: 0; font-size: 0.875rem; color: var(--text-secondary); }
            .plan-card ul li { margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
            .plan-card ul li::before { content: '✓'; color: var(--success); font-weight: 600; }
            .duration-selector { display: flex; gap: 0.5rem; background: var(--bg-tertiary); padding: 0.5rem; border-radius: var(--radius); margin-bottom: 1.5rem; justify-content: center; }
            .duration-selector label { flex: 1; text-align: center; }
            .duration-selector input { display: none; }
            .duration-selector span { padding: 0.5rem 1rem; border-radius: var(--radius-sm); display: block; cursor: pointer; transition: var(--transition); font-weight: 500; font-size: 0.875rem; }
            .duration-selector input:checked + span { background: var(--primary); color: white; }
        </style>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="font-size: 1.5rem; font-weight: 700;">Billing & Plans</h2>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; align-items: start; margin-bottom: 1.5rem;">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Current Hosting Plan</h3>
                    <span class="badge badge-primary" style="text-transform: capitalize;">${planName}</span>
                </div>
                <div class="card-body">
                    ${expiryHTML}
                    <div style="margin-top: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.875rem; margin-bottom: 0.25rem;">
                            <span>Images Used</span>
                            <span style="color: var(--text-secondary);">${planData.images_uploads} / ${planData.images_limit || 0}</span>
                        </div>
                        <div class="progress-bar"><div class="progress-fill" style="width:${imagesUsedPercent}%"></div></div>
                    </div>
                     <div style="margin-top: 1rem;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.875rem; margin-bottom: 0.25rem;">
                            <span>Articles Published</span>
                            <span style="color: var(--text-secondary);">${planData.article_uploads} / ${planData.articles_limit || 0}</span>
                        </div>
                        <div class="progress-bar"><div class="progress-fill" style="width:${articlesUsedPercent}%"></div></div>
                    </div>
                    ${isSubscribed ? '<button class="btn btn-secondary" style="width:100%; margin-top:1.5rem;" onclick="cancelSubscription()">Manage Subscription</button>' : ''}
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h3 class="card-title">Upgrade Hosting Plan</h3></div>
                <div class="card-body">
                    <div class="plan-grid">
                        ${Object.keys(hostingConfig.packages).map(planKey => `
                            <div class="plan-card" id="plan-${planKey}" onclick="selectPlan('${planKey}')">
                                <h4>${hostingConfig.packages[planKey].name}</h4>
                                <ul>${hostingConfig.packages[planKey].features.map(f => `<li>${f}</li>`).join('')}</ul>
                            </div>
                        `).join('')}
                    </div>
                    <div class="duration-selector">
                        <label><input type="radio" name="duration" value="3month" onchange="selectDuration('3month')" checked><span>3 Months</span></label>
                        <label><input type="radio" name="duration" value="6month" onchange="selectDuration('6month')"><span>6 Months</span></label>
                        <label><input type="radio" name="duration" value="12month" onchange="selectDuration('12month')"><span>12 Months</span></label>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top: 1.5rem; background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-lg);">
                         <div>
                            <label for="payment-provider" style="font-size: 0.8125rem; color: var(--text-secondary); display:block; margin-bottom: 0.25rem;">Payment Method</label>
                            <select id="payment-provider" class="form-select" style="padding: 0.5rem;">
                                <option value="stripe">Card (Stripe)</option>
                                <option value="oxapay">Crypto (OxaPay)</option>
                            </select>
                        </div>
                        <div style="text-align:right">
                            <span style="font-size: 0.875rem; color: var(--text-secondary);">Total Price</span>
                            <div id="price-display" style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">$0.00</div>
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width:100%; margin-top: 1rem; padding: 0.75rem;    justify-content: center;" onclick="purchasePlan()">Purchase Plan</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Transaction History</h3>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <span style="font-size: 0.875rem; color: var(--text-secondary);">Filter:</span>
                    <select class="form-select" style="width: auto; padding: 0.5rem;" onchange="loadBilling(1, this.value)">
                        <option value="all" ${type === 'all' ? 'selected' : ''}>All Types</option>
                        <option value="tasks" ${type === 'tasks' ? 'selected' : ''}>Tasks Only</option>
                        <option value="hosting" ${type === 'hosting' ? 'selected' : ''}>Hosting Only</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>Date</th><th>Type</th><th>Description</th><th>Amount</th><th>Status</th><th>Actions</th></tr>
                        </thead>
                        <tbody>
                            ${allPayments.map(payment => {
                                let paymentType = '', description = '', badgeClass = '';
                                if (payment.method === 'create_task') {
                                    paymentType = 'SEO Task'; badgeClass = 'primary'; description = payment.details?.url || 'Task Creation';
                                } else if (payment.method === 'recharge') {
                                    paymentType = 'Recharge'; badgeClass = 'success'; description = `Task Recharge`;
                                } else if (payment.method === 'buy_package') {
                                    paymentType = 'Hosting'; badgeClass = 'warning'; description = `${payment.details?.package || ''} Package`;
                                } else {
                                    paymentType = payment.method || 'Payment'; badgeClass = 'primary'; description = 'Payment';
                                }
                                let statusClass = 'warning'; let statusText = payment.status || 'Unknown';
                                switch (payment.status?.toLowerCase()) {
                                    case 'paid': statusClass = 'success'; statusText = 'Paid'; break;
                                    case 'pending': statusClass = 'warning'; statusText = 'Pending'; break;
                                    case 'cancelled': statusClass = 'danger'; statusText = 'Cancelled'; break;
                                    case 'expired': statusClass = 'error'; statusText = 'Expired'; break;
                                }
                                return `
                                <tr>
                                    <td>${new Date(payment.dates?.created || Date.now()).toLocaleDateString()}</td>
                                    <td><span class="badge badge-${badgeClass}">${paymentType}</span></td>
                                    <td style="max-width: 250px; word-break: break-all;">${description}</td>
                                    <td style="font-weight: 600;">$${(payment.total_payment || 0).toFixed(2)}</td>
                                    <td><span class="badge badge-${statusClass}">${statusText}</span></td>
                                    <td>
                                        <button class="btn btn-sm" onclick="viewPaymentDetails('${payment.billing_id}')"><i class="ri-eye-line"></i> Details</button>
                                        ${payment.payment_url ? `<button class="btn btn-sm btn-primary" onclick="window.open('${payment.payment_url}', '_blank')" style="margin-left: 0.25rem;"><i class="ri-external-link-line"></i> Pay</button>` : ''}
                                    </td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                ${allPayments.length === 0 ? `<div class="empty-state" style="padding: 2rem 0;"><div class="empty-state-icon"><i class="ri-file-list-line"></i></div><div class="empty-state-title">No Transactions Found</div></div>` : ''}
            </div>
        </div>

        ${paginationState.billing.total > paginationState.billing.pageSize ? generatePagination('billing', (page) => loadBilling(page, type)) : ''}
        `;

        // Initialize the interactive plan selection
        selectPlan('professional');

    } catch (error) {
        console.error('Billing error:', error);
        showErrorState('Failed to load billing data. Please check your connection and try again.');
    }
}

// Profile Page
function loadProfile() {
    const user = currentData.user;
    const content = document.getElementById('content');
    content.innerHTML = `
        <div style="max-width: 600px; margin: 0 auto;">
            <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem;">Profile Settings</h2>

            <div class="card">
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-input" value="${user.email}" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Account Created</label>
                        <input type="text" class="form-input" value="${new Date(user.created_at).toLocaleDateString()}" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Hosting Plan</label>
                        <input type="text" class="form-input" value="${user.hosting.type.toUpperCase()}" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Plan Expiry</label>
                        <input type="text" class="form-input" value="${new Date(user.hosting.expiry_date).toLocaleDateString()}" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Images Uploaded</label>
                        <input type="text" class="form-input" value="${user.hosting.images_uploads}" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Articles Published</label>
                        <input type="text" class="form-input" value="${user.hosting.article_uploads}" readonly>
                    </div>

                    <button class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    `;

    // Close dropdown
    document.getElementById('userDropdown').classList.remove('active');
}

// Modal Functions
// function showModal(title, content) {
//     document.getElementById('modalTitle').textContent = title;
//     document.getElementById('modalBody').innerHTML = content;
//     document.getElementById('modalOverlay').classList.add('active');
// }
function showModal(title, content, width = '900px') {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = content;
    const modal = document.querySelector('.modal');
    modal.style.width = width;
    modal.style.maxWidth = '95vw';
    document.getElementById('modalOverlay').classList.add('active');
}

function closeModal() {
    document.getElementById('modalOverlay').classList.remove('active');
    // Reset task creation state
    currentData.selectedLocations = [];
    currentData.selectedKeywords = [];
    currentData.currentStep = 1;
}

// Enhanced Task Modal with Priority First
async function showTaskModal() {
    showModal('Create New SEO Task', `
    <div class="step-content active" id="step1">
    <div class="form-group">
    <label class="form-label">Website URL</label>
    <input type="url" class="form-input" id="taskUrl" required placeholder="https://example.com">
    <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
    Enter the full URL of your website to analyze and preview
    </small>
    </div>

    <div class="form-group">
    <label class="form-label">Task Priority</label>
    <div class="priority-options">
    <div class="priority-option" data-priority="basic" onclick="selectPriority('basic')">
    <div class="priority-title">Basic</div>
    <div class="priority-price">$0.10/click</div>
    <div class="priority-locations">Up to 2 locations</div>
    </div>
    <div class="priority-option selected" data-priority="standard" onclick="selectPriority('standard')">
    <div class="priority-title">Standard</div>
    <div class="priority-price">$0.12/click</div>
    <div class="priority-locations">Up to 3 locations</div>
    </div>
    <div class="priority-option" data-priority="premium" onclick="selectPriority('premium')">
    <div class="priority-title">Premium</div>
    <div class="priority-price">$0.15/click</div>
    <div class="priority-locations">Up to 5 locations</div>
    </div>
    </div>
    </div>

    <div class="step-navigation">
    <div></div>
    <button class="btn btn-primary" onclick="goToStep(2)">Next: Preview & Select Locations</button>
    </div>
    </div>

    <div class="step-content" id="step2">
    <div class="website-preview" id="websitePreview">
    <div id="websiteLoader" style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f5f5f5;">
    <div class="spinner"></div>
    </div>
    <iframe id="taskPreviewFrame" style="display: none;"></iframe>
    <div id="xpathOverlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; cursor: crosshair; pointer-events: auto; z-index: 15; touch-action: pan-y;"></div>
    </div>

    <div style="margin-top: 1rem;">
    <h4>Selected Click Locations (${currentData.selectedLocations.length}/${getPriorityMaxLocations(currentData.taskPriority)})</h4>
    <div id="selectedLocations">
    <p style="color: var(--text-secondary); font-size: 0.875rem;">Click on the website preview above to select clickable areas. You can select up to <span id="maxLocations">${getPriorityMaxLocations(currentData.taskPriority)}</span> locations.</p>
    </div>
    </div>

    <div class="step-navigation">
    <button class="btn btn-secondary" onclick="goToStep(1)">Back</button>
    <button class="btn btn-primary" onclick="goToStep(3)">Next: Keywords & Payment</button>
    </div>
    </div>

    <div class="step-content" id="step3">
    <div class="form-group">
    <label class="form-label">Keywords</label>
    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
    <input type="text" class="form-input" id="keywordsInput" placeholder="Enter keywords separated by commas">
    <button class="btn btn-secondary" id="aiKeywordsBtn" onclick="generateAIKeywords()">
    <i class="ri-magic-line"></i> AI Suggest
    </button>
    </div>
    <div id="keywordSuggestions" class="keyword-suggestions"></div>
    <div id="selectedKeywordsDisplay" style="margin-top: 1rem;"></div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
    <div class="form-group">
    <label class="form-label">Total Budget ($)</label>
    <input type="number" class="form-input" id="taskBudget" min="10" value="150" onchange="updateEstimates()">
    </div>
    <div class="form-group">
    <label class="form-label">Estimated Clicks</label>
    <input type="text" class="form-input" id="estimatedClicks" readonly>
    </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
    <div class="form-group">
    <label class="form-label">Payment Method</label>
    <select class="form-select" id="paymentMethod">
    <option value="stripe">Stripe (Credit/Debit Cards)</option>
    <option value="oxapay">OxaPay (Cryptocurrency)</option>
    </select>
    </div>
    <div class="form-group">
    <label class="form-label">Payment Type</label>
    <select class="form-select" id="paymentType" onchange="toggleSubscriptionOptions()">
    <option value="one-time">One-time Payment</option>
    <option value="subscription">Recurring Subscription</option>
    </select>
    </div>
    </div>

    <div id="subscriptionOptions" style="display: none; margin-bottom: 1.5rem;">
    <div class="form-group">
    <label class="form-label">Billing Cycle</label>
    <select class="form-select" id="billingCycle">
    <option value="monthly">Monthly</option>
    <option value="quarterly">Quarterly (3 months)</option>
    <option value="yearly">Yearly</option>
    </select>
    </div>
    </div>

    <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius); margin-bottom: 1.5rem;">
    <div style="display: flex; align-items: start; gap: 0.5rem; margin-bottom: 1rem;">
    <input type="checkbox" id="cancelPrevious" style="margin-top: 0.25rem;">
    <label for="cancelPrevious" style="font-size: 0.875rem; cursor: pointer;">
    <strong>Cancel Previous Tasks</strong><br>
    <span style="color: var(--text-secondary);">Automatically cancel any pending or active payments for previous tasks. This will stop any ongoing SEO campaigns and refund unused credits.</span>
    </label>
    </div>

    <div id="previousTasksWarning" style="display: none; background: var(--warning); color: white; padding: 0.75rem; border-radius: var(--radius-sm); font-size: 0.875rem;">
    <i class="ri-alert-line"></i> This will cancel <span id="previousTaskCount">0</span> active task(s) and any pending payments.
    </div>
    </div>

    <div style="background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem;">
    <h4 style="margin-bottom: 1rem;">Order Summary</h4>
    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
    <span>Task Budget:</span>
    <span id="orderBudget">$150.00</span>
    </div>
    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">
    <span>Priority:</span>
    <span id="orderPriority">Standard</span>
    </div>
    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">
    <span>Keywords:</span>
    <span id="orderKeywords">0</span>
    </div>
    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">
    <span>Click Locations:</span>
    <span id="orderLocations">0</span>
    </div>
    <div style="border-top: 1px solid var(--border); padding-top: 0.5rem; margin-top: 0.5rem;">
    <div style="display: flex; justify-content: space-between; font-weight: 600; font-size: 1.125rem;">
    <span>Total:</span>
    <span id="orderTotal">$150.00</span>
    </div>
    </div>
    </div>

    <div class="step-navigation">
    <button class="btn btn-secondary" onclick="goToStep(2)">Back</button>
    <button class="btn btn-primary" onclick="createTask()" id="createTaskBtn">
    <i class="ri-wallet-line"></i> Create Task & Pay
    </button>
    </div>
    </div>
    `);

    currentData.currentStep = 1;
    currentData.selectedLocations = [];
    currentData.selectedKeywords = [];
    currentData.taskPriority = 'standard';

    // Check for existing active tasks
    checkForActiveTasks();
}

function toggleSubscriptionOptions() {
    const paymentType = document.getElementById('paymentType').value;
    const subscriptionOptions = document.getElementById('subscriptionOptions');

    if (paymentType === 'subscription') {
        subscriptionOptions.style.display = 'block';
    } else {
        subscriptionOptions.style.display = 'none';
    }

    updateOrderSummary();
}

async function checkForActiveTasks() {
    try {
        // This would be replaced with actual API call to get active tasks
        const activeTasks = currentData.user?.tasks?.filter(task =>
        task.status === 'active' || task.remaining_percentage > 0
        ) || [];

        const cancelCheckbox = document.getElementById('cancelPrevious');
        const warningDiv = document.getElementById('previousTasksWarning');
        const countSpan = document.getElementById('previousTaskCount');

        if (activeTasks.length > 0) {
            countSpan.textContent = activeTasks.length;
            cancelCheckbox.addEventListener('change', () => {
                warningDiv.style.display = cancelCheckbox.checked ? 'block' : 'none';
            });
        }
    } catch (error) {
        console.error('Error checking active tasks:', error);
    }
}

function updateOrderSummary() {
    const budget = parseFloat(document.getElementById('taskBudget')?.value || 150);
    const priority = currentData.taskPriority;
    const keywordCount = currentData.selectedKeywords.length;
    const locationCount = currentData.selectedLocations.length;
    const paymentType = document.getElementById('paymentType')?.value || 'one-time';

    document.getElementById('orderBudget').textContent = `$${budget.toFixed(2)}`;
    document.getElementById('orderPriority').textContent = priority.charAt(0).toUpperCase() + priority.slice(1);
    document.getElementById('orderKeywords').textContent = keywordCount;
    document.getElementById('orderLocations').textContent = locationCount;
    document.getElementById('orderTotal').textContent = `$${budget.toFixed(2)}${paymentType === 'subscription' ? '/mo' : ''}`;

    updateEstimates();
}
// Complete Fixed Step Navigation System
function goToStep(step) {
    console.log(`Attempting to go to step ${step}`); // Debug log
    console.log(`Current selected locations:`, currentData.selectedLocations); // Debug log

    if (step === 2) {
        const url = document.getElementById('taskUrl').value.trim();
        if (!url) {
            showToast('Please enter a valid URL', 'error');
            return;
        }
        loadWebsitePreview(url);
    } else if (step === 3) {
        if (currentData.selectedLocations.length === 0) {
            showToast('Please select at least one click location', 'error');
            return;
        }
        // Initialize step 3 elements
        setTimeout(() => {
            updateEstimates();
            updateOrderSummary();
        }, 100);
    }

    // Hide all steps
    document.querySelectorAll('.step-content').forEach(content => {
        content.classList.remove('active');
    });

    // Show current step
    const targetStep = document.getElementById(`step${step}`);
    if (targetStep) {
        targetStep.classList.add('active');
        currentData.currentStep = step;
        console.log(`Successfully moved to step ${step}`); // Debug log
    } else {
        console.error(`Step ${step} element not found`); // Debug log
    }
}

// Fixed Website Preview with Complete XPath Selection
function loadWebsitePreview(url) {
    const iframe = document.getElementById('taskPreviewFrame');
    const loader = document.getElementById('websiteLoader');
    const overlay = document.getElementById('xpathOverlay');

    // Validate URL
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
        url = 'https://' + url;
    }

    // Use our Cloudflare Worker CORS proxy
    const proxyUrl = `https://cors.seotize.workers.dev/?url=${encodeURIComponent(url)}`;

    loader.style.display = 'flex';
    iframe.style.display = 'none';

    // Clear existing markers and locations
    overlay.innerHTML = '';
    currentData.selectedLocations = [];
    updateSelectedLocationsDisplay();

    iframe.src = proxyUrl;

    iframe.onload = () => {
    loader.style.display = 'none';
    iframe.style.display = 'block';
    
    // Set fixed 50% zoom
    iframe.style.transform = 'scale(0.5)';
    iframe.style.transformOrigin = '0 0';
    iframe.style.width = '200%';
    iframe.style.height = '200%';

    // Remove any existing click listeners
    const newOverlay = overlay.cloneNode(true);
    overlay.parentNode.replaceChild(newOverlay, overlay);

    // Get the new overlay reference
    const currentOverlay = document.getElementById('xpathOverlay');
    currentOverlay.style.cursor = 'crosshair';
    currentOverlay.style.background = 'rgba(99, 102, 241, 0.02)';

    // Setup events to allow scrolling but capture clicks
    currentOverlay.addEventListener('click', handleOverlayClick);
    
    // Allow scroll events to pass through
    currentOverlay.addEventListener('wheel', (e) => {
        // Let scroll events pass through to iframe
        e.stopPropagation();
        const iframe = document.getElementById('taskPreviewFrame');
        if (iframe.contentWindow) {
            iframe.contentWindow.scrollBy(0, e.deltaY);
        }
    }, { passive: false });
    
    // Allow touch scroll on mobile
    currentOverlay.addEventListener('touchmove', (e) => {
        // Allow touch scrolling to pass through
    }, { passive: true });

    console.log('Website loaded at 50% zoom with scrolling enabled');
    };

    iframe.onerror = () => {
        loader.innerHTML = `
        <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">⚠️</div>
        <div style="font-size: 1.1rem; margin-bottom: 1rem;">Unable to load website preview</div>
        <div style="font-size: 0.875rem; color: var(--text-tertiary);">
        The website may block iframe embedding or have CORS restrictions.<br>
        You can still continue by manually specifying XPath locations.
        </div>
        <button class="btn btn-primary" onclick="showManualXPathInput()" style="margin-top: 1rem;">
        <i class="ri-code-line"></i> Add XPath Manually
        </button>
        </div>
        `;
    };
}

// Handle overlay clicks for XPath selection
function handleOverlayClick(e) {
    // Only handle actual clicks, not scroll events
    if (e.type !== 'click') return;
    
    console.log('Overlay clicked - selecting location');

    const overlay = document.getElementById('xpathOverlay');
    const rect = overlay.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * 100;
    const y = ((e.clientY - rect.top) / rect.height) * 100;

    const maxLocations = getPriorityMaxLocations(currentData.taskPriority);
    if (currentData.selectedLocations.length >= maxLocations) {
        showToast(`Maximum ${maxLocations} locations allowed for ${currentData.taskPriority} priority`, 'warning');
        return;
    }

    const xpath = generateXPath(x, y, currentData.selectedLocations.length + 1);
    const locationId = Date.now() + Math.random();

    // Add visual marker
    const marker = document.createElement('div');
    marker.className = 'xpath-marker';
    marker.style.left = x + '%';
    marker.style.top = y + '%';
    marker.innerHTML = currentData.selectedLocations.length + 1;
    marker.dataset.locationId = locationId;
    marker.title = `Click to remove - ${xpath}`;

    marker.addEventListener('click', (e) => {
        e.stopPropagation();
        removeLocation(locationId);
    });

    overlay.appendChild(marker);

    currentData.selectedLocations.push({
        id: locationId,
        xpath: xpath,
        x: x,
        y: y
    });

    updateSelectedLocationsDisplay();
    showToast(`Added location ${currentData.selectedLocations.length}`, 'success');
}

// Manual XPath input for when preview fails
function showManualXPathInput() {
    const container = document.getElementById('selectedLocations');
    const maxLocations = getPriorityMaxLocations(currentData.taskPriority);

    container.innerHTML = `
    <div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border);">
    <h4 style="margin-bottom: 1rem;">Add XPath Locations Manually</h4>
    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
    <input type="text" class="form-input" id="manualXPath" placeholder="/html/body/header//a[1]" style="flex: 1;">
    <button class="btn btn-primary" onclick="addManualXPath()">
    <i class="ri-add-line"></i> Add
    </button>
    </div>
    <small style="color: var(--text-secondary);">
    Enter XPath expressions like: /html/body/header//a[1], /html/body/nav//a[2], etc.<br>
    You can add up to ${maxLocations} locations for ${currentData.taskPriority} priority.
    </small>
    <div id="manualLocations" style="margin-top: 1rem;">
    ${updateSelectedLocationsHTML()}
    </div>
    </div>
    `;

    // Add enter key listener
    const input = document.getElementById('manualXPath');
    if (input) {
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addManualXPath();
            }
        });
        input.focus();
    }
}

// Add manual XPath
function addManualXPath() {
    const input = document.getElementById('manualXPath');
    if (!input) return;

    const xpath = input.value.trim();

    if (!xpath) {
        showToast('Please enter a valid XPath', 'error');
        return;
    }

    // Basic XPath validation
    if (!xpath.startsWith('/') || !xpath.includes('html')) {
        showToast('XPath should start with / and contain html (e.g., /html/body/header//a[1])', 'error');
        return;
    }

    const maxLocations = getPriorityMaxLocations(currentData.taskPriority);
    if (currentData.selectedLocations.length >= maxLocations) {
        showToast(`Maximum ${maxLocations} locations allowed`, 'warning');
        return;
    }

    const locationId = Date.now() + Math.random();

    currentData.selectedLocations.push({
        id: locationId,
        xpath: xpath,
        x: 0,
        y: 0,
        manual: true
    });

    input.value = '';

    // Update the manual locations display
    const manualContainer = document.getElementById('manualLocations');
    if (manualContainer) {
        manualContainer.innerHTML = updateSelectedLocationsHTML();
    } else {
        updateSelectedLocationsDisplay();
    }

    showToast('XPath location added successfully', 'success');
}

// Generate HTML for selected locations
function updateSelectedLocationsHTML() {
    if (currentData.selectedLocations.length === 0) {
        return '<p style="color: var(--text-secondary); font-size: 0.875rem;">No locations selected yet.</p>';
    }

    return currentData.selectedLocations.map((location, index) => `
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-tertiary); border-radius: var(--radius); margin-bottom: 0.5rem;">
    <div>
    <span style="font-weight: 500;">Location ${index + 1}:</span>
    <code style="background: var(--bg); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; margin-left: 0.5rem;">${location.xpath}</code>
    ${location.manual ? '<span class="badge badge-warning" style="margin-left: 0.5rem; font-size: 0.7rem;">Manual</span>' : ''}
    </div>
    <button class="btn btn-sm btn-danger" onclick="removeLocation('${location.id}')">
    <i class="ri-delete-bin-line"></i>
    </button>
    </div>
    `).join('');
}

// Update selected locations display
function updateSelectedLocationsDisplay() {
    const container = document.getElementById('selectedLocations');
    if (!container) return;

    const maxLocations = getPriorityMaxLocations(currentData.taskPriority);

    if (currentData.selectedLocations.length === 0) {
        container.innerHTML = `
        <div style="text-align: center; padding: 1rem; color: var(--text-secondary);">
        <p style="font-size: 0.875rem; margin-bottom: 1rem;">
        Click on the website preview above to select clickable areas, or add XPath locations manually.
        </p>
        <p style="font-size: 0.875rem; margin-bottom: 1rem;">
        You can select up to <span id="maxLocations" style="font-weight: 600; color: var(--primary);">${maxLocations}</span> locations for ${currentData.taskPriority} priority.
        </p>
        <button class="btn btn-secondary btn-sm" onclick="showManualXPathInput()">
        <i class="ri-code-line"></i> Add XPath Manually
        </button>
        </div>
        `;
        return;
    }

    container.innerHTML = `
    <div style="margin-bottom: 1rem;">
    ${updateSelectedLocationsHTML()}
    </div>
    <div style="text-align: center;">
    <button class="btn btn-secondary btn-sm" onclick="showManualXPathInput()">
    <i class="ri-add-line"></i> Add More XPaths
    </button>
    </div>
    `;
}

// Remove location
function removeLocation(locationId) {
    console.log('Removing location:', locationId); // Debug log

    // Remove from array
    currentData.selectedLocations = currentData.selectedLocations.filter(loc => loc.id != locationId);

    // Remove marker from overlay
    const marker = document.querySelector(`[data-location-id="${locationId}"]`);
    if (marker) {
        marker.remove();
    }

    // Update display
    const manualContainer = document.getElementById('manualLocations');
    if (manualContainer) {
        manualContainer.innerHTML = updateSelectedLocationsHTML();
    } else {
        updateSelectedLocationsDisplay();
    }

    showToast('Location removed', 'info');
    console.log('Location removed, remaining:', currentData.selectedLocations.length); // Debug log
}

// Select priority
function selectPriority(priority) {
    console.log('Selecting priority:', priority); // Debug log

    document.querySelectorAll('.priority-option').forEach(option => {
        option.classList.remove('selected');
    });

    const selectedOption = document.querySelector(`[data-priority="${priority}"]`);
    if (selectedOption) {
        selectedOption.classList.add('selected');
        currentData.taskPriority = priority;

        // Update max locations display
        const maxLocations = getPriorityMaxLocations(priority);
        const maxLocationsSpan = document.getElementById('maxLocations');
        if (maxLocationsSpan) {
            maxLocationsSpan.textContent = maxLocations;
        }

        // Trim locations if they exceed the new limit
        if (currentData.selectedLocations.length > maxLocations) {
            const removedCount = currentData.selectedLocations.length - maxLocations;
            currentData.selectedLocations = currentData.selectedLocations.slice(0, maxLocations);

            // Remove excess markers from overlay
            const overlay = document.getElementById('xpathOverlay');
            if (overlay) {
                const markers = overlay.querySelectorAll('.xpath-marker');
                for (let i = maxLocations; i < markers.length; i++) {
                    markers[i].remove();
                }
            }

            updateSelectedLocationsDisplay();
            showToast(`Reduced to ${maxLocations} locations for ${priority} priority (removed ${removedCount})`, 'warning');
        }

        updateEstimates();
        console.log('Priority updated to:', priority, 'Max locations:', maxLocations); // Debug log
    }
}

// Get priority max locations
function getPriorityMaxLocations(priority) {
    const limits = { basic: 2, standard: 3, premium: 5 };
    return limits[priority] || 3;
}

// Generate XPath based on click position
function generateXPath(x, y, index) {
    // Enhanced XPath generation based on click position
    const sections = [
        '/html/body/header//a',
        '/html/body/nav//a',
        '/html/body/main//a',
        '/html/body/section//a',
        '/html/body/aside//a',
        '/html/body/footer//a'
    ];

    let sectionIndex = Math.floor((y / 100) * sections.length);
    if (sectionIndex >= sections.length) sectionIndex = sections.length - 1;

    const elementIndex = Math.max(1, Math.floor((x / 100) * 10) + 1);
    return `${sections[sectionIndex]}[${elementIndex}]`;
}

// Update estimates
function updateEstimates() {
    const budget = parseFloat(document.getElementById('taskBudget')?.value || 150);
    const rates = { basic: 0.10, standard: 0.12, premium: 0.15 };
    const rate = rates[currentData.taskPriority] || 0.12;
    const estimatedClicks = Math.floor(budget / rate);

    const estimatedClicksInput = document.getElementById('estimatedClicks');
    if (estimatedClicksInput) {
        estimatedClicksInput.value = estimatedClicks.toLocaleString() + ' clicks';
    }

    updateOrderSummary();
}

// Update order summary
function updateOrderSummary() {
    const budget = parseFloat(document.getElementById('taskBudget')?.value || 150);
    const priority = currentData.taskPriority;
    const keywordCount = currentData.selectedKeywords.length;
    const locationCount = currentData.selectedLocations.length;
    const paymentType = document.getElementById('paymentType')?.value || 'one-time';

    // Update all order summary elements if they exist
    const orderBudget = document.getElementById('orderBudget');
    const orderPriority = document.getElementById('orderPriority');
    const orderKeywords = document.getElementById('orderKeywords');
    const orderLocations = document.getElementById('orderLocations');
    const orderTotal = document.getElementById('orderTotal');

    if (orderBudget) orderBudget.textContent = `$${budget.toFixed(2)}`;
    if (orderPriority) orderPriority.textContent = priority.charAt(0).toUpperCase() + priority.slice(1);
    if (orderKeywords) orderKeywords.textContent = keywordCount;
    if (orderLocations) orderLocations.textContent = locationCount;
    if (orderTotal) orderTotal.textContent = `$${budget.toFixed(2)}${paymentType === 'subscription' ? '/mo' : ''}`;

    console.log('Order summary updated:', { budget, priority, keywordCount, locationCount }); // Debug log
}

// Toggle subscription options
function toggleSubscriptionOptions() {
    const paymentType = document.getElementById('paymentType')?.value;
    const subscriptionOptions = document.getElementById('subscriptionOptions');

    if (subscriptionOptions) {
        if (paymentType === 'subscription') {
            subscriptionOptions.style.display = 'block';
        } else {
            subscriptionOptions.style.display = 'none';
        }
    }

    updateOrderSummary();
}

async function generateAIKeywords() {
    const url = document.getElementById('taskUrl').value;
    const btn = document.getElementById('aiKeywordsBtn');

    if (!url) {
        showToast('Please enter a URL first', 'error');
        return;
    }

    btn.innerHTML = '<i class="ri-loader-line"></i> Generating...';
    btn.disabled = true;

    try {
        const response = await fetch(`https://keywords.seotize.net?url=${encodeURIComponent(url)}`, {
            headers: { 'Session-Token': sessionToken }
        });

        if (!response.ok) throw new Error('Failed to generate keywords');

        const data = await response.json();
        displayKeywordSuggestions(data.keywords || []);

    } catch (error) {
        console.error('AI Keywords error:', error);
        showToast('Failed to generate AI keywords', 'error');
    } finally {
        btn.innerHTML = '<i class="ri-magic-line"></i> AI Suggest';
        btn.disabled = false;
    }
}

function displayKeywordSuggestions(keywords) {
    const container = document.getElementById('keywordSuggestions');
    container.innerHTML = keywords.slice(0, 15).map(keyword => `
    <span class="keyword-suggestion" onclick="toggleKeyword('${keyword}')">${keyword}</span>
    `).join('');
}

function toggleKeyword(keyword) {
    const index = currentData.selectedKeywords.indexOf(keyword);
    const element = event.target;

    if (index === -1) {
        currentData.selectedKeywords.push(keyword);
        element.classList.add('selected');
    } else {
        currentData.selectedKeywords.splice(index, 1);
        element.classList.remove('selected');
    }

    // Update input and display
    document.getElementById('keywordsInput').value = currentData.selectedKeywords.join(', ');
    updateSelectedKeywordsDisplay();
}

function updateSelectedKeywordsDisplay() {
    const container = document.getElementById('selectedKeywordsDisplay');
    if (currentData.selectedKeywords.length === 0) {
        container.innerHTML = '';
        return;
    }

    container.innerHTML = `
    <div style="margin-top: 1rem;">
    <strong>Selected Keywords (${currentData.selectedKeywords.length}):</strong>
    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
    ${currentData.selectedKeywords.map(keyword => `
        <span class="badge badge-primary">${keyword} <span onclick="removeKeyword('${keyword}')" style="cursor: pointer; margin-left: 0.25rem;">×</span></span>
        `).join('')}
        </div>
        </div>
        `;
}

function removeKeyword(keyword) {
    currentData.selectedKeywords = currentData.selectedKeywords.filter(kw => kw !== keyword);
    document.getElementById('keywordsInput').value = currentData.selectedKeywords.join(', ');
    updateSelectedKeywordsDisplay();

    // Update suggestion display
    const suggestions = document.querySelectorAll('.keyword-suggestion');
    suggestions.forEach(suggestion => {
        if (suggestion.textContent === keyword) {
            suggestion.classList.remove('selected');
        }
    });
}

async function createTask() {
    const url = document.getElementById('taskUrl').value.trim();
    const budget = parseFloat(document.getElementById('taskBudget').value);
    const keywordsInput = document.getElementById('keywordsInput').value.trim();
    const keywords = keywordsInput ? keywordsInput.split(',').map(k => k.trim()).filter(k => k) : currentData.selectedKeywords;
    const paymentMethod = document.getElementById('paymentMethod').value;
    const paymentType = document.getElementById('paymentType').value;
    const cancelPrevious = document.getElementById('cancelPrevious').checked;
    const billingCycle = document.getElementById('billingCycle')?.value;

    // Validation
    if (!url) {
        showToast('Please enter a valid URL', 'error');
        return;
    }

    if (!keywords.length) {
        showToast('Please add at least one keyword', 'error');
        return;
    }

    if (!currentData.selectedLocations.length) {
        showToast('Please select at least one click location', 'error');
        return;
    }

    if (!budget || budget < 10) {
        showToast('Minimum budget is $10', 'error');
        return;
    }

    // Validate URL format
    const urlRegex = /^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/;
    if (!urlRegex.test(url)) {
        showToast('Please enter a valid URL format', 'error');
        return;
    }

    // Validate keywords
    if (keywords.some(kw => kw.length < 2 || kw.length > 50)) {
        showToast('Keywords must be between 2 and 50 characters', 'error');
        return;
    }

    // Validate locations count based on priority
    const maxLocations = getPriorityMaxLocations(currentData.taskPriority);
    if (currentData.selectedLocations.length > maxLocations) {
        showToast(`Maximum ${maxLocations} locations allowed for ${currentData.taskPriority} priority`, 'error');
        return;
    }

    const createButton = document.getElementById('createTaskBtn');
    createButton.innerHTML = '<i class="ri-loader-line"></i> Creating Task...';
    createButton.disabled = true;

    try {
        // Prepare task data with all API parameters
        const taskData = {
            task_details: {
                url: url.startsWith('http') ? url : `https://${url}`,
                keywords: keywords,
                html_locations: currentData.selectedLocations.map(loc => loc.xpath)
            },
            task_priority: currentData.taskPriority, // priority name as string
            total_charge: budget,
            payment_method: paymentMethod,
            is_subscription: paymentType === 'subscription',
            cancel_previous: cancelPrevious
        };

        // Add billing cycle for subscriptions
        if (paymentType === 'subscription' && billingCycle) {
            taskData.billing_cycle = billingCycle;
        }

        console.log('Creating task with data:', taskData); // Debug log

        const response = await api('/add-task', {
            method: 'POST',
            body: JSON.stringify(taskData)
        });

        console.log('Task creation response:', response); // Debug log

        if (response.data?.payment_url) {
            // Open payment URL in new window
            window.open(response.data.payment_url, '_blank');
            showToast('Task created! Complete payment to activate your SEO campaign.', 'success');

            // Show additional info based on payment type
            if (paymentType === 'subscription') {
                showToast(`Subscription created with ${billingCycle} billing cycle`, 'info');
            }

            if (cancelPrevious) {
                showToast('Previous tasks have been cancelled', 'info');
            }
        } else {
            showToast('Task created successfully!', 'success');
        }

        closeModal();

        // Refresh tasks list
        if (document.querySelector('.nav-item[data-page="tasks"]').classList.contains('active')) {
            loadTasks();
        } else {
            loadDashboard();
        }

    } catch (error) {
        console.error('Create task error:', error);

        // Handle specific API errors
        let errorMessage = 'Failed to create task';

        if (error.message.includes('Payload too large')) {
            errorMessage = 'Request data is too large. Please reduce the number of keywords or locations.';
        } else if (error.message.includes('Invalid URL')) {
            errorMessage = 'Please enter a valid URL format.';
        } else if (error.message.includes('Invalid keywords')) {
            errorMessage = 'Please check your keywords format.';
        } else if (error.message.includes('Invalid HTML locations')) {
            errorMessage = 'Please select valid click locations.';
        } else if (error.message.includes('Invalid total charge')) {
            errorMessage = 'Please enter a valid budget amount.';
        } else if (error.message.includes('Missing required fields')) {
            errorMessage = 'Please fill in all required fields.';
        } else {
            errorMessage = error.message || 'An unexpected error occurred.';
        }

        showToast(errorMessage, 'error');
    } finally {
        createButton.innerHTML = '<i class="ri-wallet-line"></i> Create Task & Pay';
        createButton.disabled = false;
    }
}

// View Task Details
async function viewTaskDetails(taskId) {
    try {
        const response = await api('/get-task-details', {
            method: 'POST',
            body: JSON.stringify({ task_id: taskId })
        });

        const task = response.data;

        showModal('Task Details', `
        <div style="display: grid; gap: 1.5rem;">
        <div>
        <h4 style="margin-bottom: 1rem;">${task.url}</h4>
        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
        ${(task.keywords || []).map(keyword => `<span class="badge badge-primary">${keyword}</span>`).join('')}
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
        <div class="stat-card">
        <div class="stat-value">${task.views_count || 0}</div>
        <div class="stat-label">Total Views</div>
        </div>
        <div class="stat-card">
        <div class="stat-value">$${task.total_charge.toFixed(2)}</div>
        <div class="stat-label">Total Budget</div>
        </div>
        <div class="stat-card">
        <div class="stat-value">$${task.available_charge.toFixed(2)}</div>
        <div class="stat-label">Available</div>
        </div>
        <div class="stat-card">
        <div class="stat-value">${task.task_priority}</div>
        <div class="stat-label">Priority</div>
        </div>
        </div>
        </div>

        ${task.country_visits ? `
            <div>
            <h4>Country Performance</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem; margin-top: 1rem;">
            ${Object.entries(task.country_visits).map(([country, visits]) => `
                <div class="badge badge-success">${country}: ${visits}</div>
                `).join('')}
                </div>
                </div>
                ` : ''}

                ${task.views_by_date ? `
                    <div>
                    <h4>Daily Performance</h4>
                    <div style="margin-top: 1rem;">
                    ${Object.entries(task.views_by_date).map(([date, views]) => `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                        <span>${new Date(date).toLocaleDateString()}</span>
                        <span class="badge badge-primary">${views} views</span>
                        </div>
                        `).join('')}
                        </div>
                        </div>
                        ` : ''}

                        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <button class="btn btn-primary" onclick="rechargeTask('${taskId}')">
                        <i class="ri-wallet-line"></i> Recharge Task
                        </button>
                        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                        </div>
                        </div>
                        `);

    } catch (error) {
        console.error('Task details error:', error);
        showToast('Failed to load task details', 'error');
    }
}

// Recharge Task
async function rechargeTask(taskId) {
    showModal('Recharge Task', `
    <form id="rechargeForm">
    <div class="form-group">
    <label class="form-label">Recharge Amount ($)</label>
    <input type="number" class="form-input" name="amount" required min="10" value="50" placeholder="50">
    </div>

    <div class="form-group">
    <label class="form-label">Payment Method</label>
    <select class="form-select" name="provider">
    <option value="stripe">Stripe (Credit/Debit Cards)</option>
    <option value="oxapay">OxaPay (Cryptocurrency)</option>
    </select>
    </div>

    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
    <button type="submit" class="btn btn-primary" style="flex: 1;">Recharge Task</button>
    </div>
    </form>
    `);

    document.getElementById('rechargeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);

        try {
            const response = await api('/recharge', {
                method: 'POST',
                body: JSON.stringify({
                    task_ids: [taskId],
                    payment_method: formData.get('provider'),
                                     cancel_previous: false
                })
            });

            if (response.data.payment_url) {
                window.open(response.data.payment_url, '_blank');
                showToast('Recharge initiated! Complete payment to add funds.', 'success');
            } else {
                showToast('Task recharged successfully', 'success');
            }

            closeModal();
            loadTasks();

        } catch (error) {
            console.error('Recharge error:', error);
            showToast('Failed to recharge task: ' + error.message, 'error');
        }
    });
}

// Domain Modal
async function showDomainModal() {
    showModal('Add Domain', `
    <form id="domainForm">
    <div class="form-group">
    <label class="form-label">Domain URL</label>
    <input type="text" class="form-input" name="url" required placeholder="example.com/blog">
    <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
    Enter your domain or subdomain where articles will be published
    </small>
    </div>

    <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius); margin: 1rem 0;">
    <p style="font-size: 0.875rem; margin: 0;">
    <strong>Note:</strong> After adding your domain, you'll need to verify ownership by adding a TXT record to your DNS settings.
    </p>
    </div>

    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
    <button type="submit" class="btn btn-primary" style="flex: 1;">Add Domain</button>
    </div>
    </form>
    `);

    document.getElementById('domainForm').addEventListener('submit', addDomain);
}

async function addDomain(e) {
    e.preventDefault();
    const formData = new FormData(e.target);

    try {
        const response = await api('/add-domain', {
            method: 'POST',
            body: JSON.stringify({ url: formData.get('url') })
        });

        if (response.data.txt_record) {
            showModal('Domain Verification Required', `
            <div style="text-align: center;">
            <div style="margin-bottom: 2rem;">
            <i class="ri-shield-check-line" style="font-size: 3rem; color: var(--warning);"></i>
            <h4 style="margin: 1rem 0;">Domain Added Successfully!</h4>
            <p style="color: var(--text-secondary);">To verify ownership, add this TXT record to your DNS:</p>
            </div>

            <div style="background: var(--bg); padding: 1rem; border-radius: var(--radius); margin: 1rem 0; font-family: monospace; word-break: break-all; border: 1px solid var(--border);">
            ${response.data.txt_record}
            </div>

            <div style="display: flex; gap: 1rem; justify-content: center;">
            <button class="btn btn-secondary" onclick="copyToClipboard('${response.data.txt_record}')">
            <i class="ri-file-copy-line"></i> Copy Record
            </button>
            <button class="btn btn-primary" onclick="verifyDomain('${formData.get('url')}')">
            <i class="ri-check-line"></i> Verify Now
            </button>
            </div>
            </div>
            `);
        } else {
            showToast('Domain added and verified successfully', 'success');
            closeModal();
            loadArticles();
        }

    } catch (error) {
        console.error('Add domain error:', error);
        showToast('Failed to add domain: ' + error.message, 'error');
    }
}

async function verifyDomain(url) {
    try {
        await api('/verify-domain', {
            method: 'POST',
            body: JSON.stringify({ url })
        });

        showToast('Domain verified successfully', 'success');
        closeModal();
        loadArticles();

    } catch (error) {
        console.error('Verify domain error:', error);
        showToast('Verification failed. Please check your DNS settings and try again.', 'error');
    }
}

function showVerificationInstructions(domain, txtRecord = '') {
    showModal('Domain Verification Instructions', `
    <div>
        <h4>How to verify your domain: ${domain}</h4>

        ${txtRecord ? `
            <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius); margin: 1.5rem 0; border: 1px solid var(--border);">
                <h5 style="margin-bottom: 0.5rem;">Your TXT Record:</h5>
                <div style="background: var(--bg); padding: 0.75rem; border-radius: var(--radius-sm); font-family: monospace; word-break: break-all; border: 1px solid var(--border);">
                    ${txtRecord}
                </div>
                <button class="btn btn-sm btn-primary" onclick="copyToClipboard('${txtRecord}')" style="margin-top: 0.5rem;">
                    <i class="ri-file-copy-line"></i> Copy TXT Record
                </button>
            </div>
        ` : ''}

        <ol style="margin: 1.5rem 0; padding-left: 1.5rem;" class="mobileol">
            <li style="margin-bottom: 1rem;">
                <strong>Access your DNS provider:</strong> Log in to your domain registrar or DNS hosting provider (like Cloudflare, GoDaddy, Namecheap, etc.)
            </li>
            <li style="margin-bottom: 1rem;">
                <strong>Find DNS management:</strong> Look for "DNS Management", "DNS Settings", or "Zone Editor" in your control panel
            </li>
            <li style="margin-bottom: 1rem;">
                <strong>Add TXT record:</strong> Create a new TXT record with:
                <ul style="margin-left: 1rem; margin-top: 0.5rem;">
                    <li><strong>Type:</strong> TXT</li>
                    <li><strong>Name:</strong> @ (or leave blank for root domain)</li>
                    <li><strong>Value:</strong> ${txtRecord || 'The verification code shown above'}</li>
                </ul>
            </li>
            <li style="margin-bottom: 1rem;">
                <strong>Wait for propagation:</strong> DNS changes can take up to 24 hours to propagate globally
            </li>
            <li>
                <strong>Click verify:</strong> Come back here and click "Verify Now" once you've added the record
            </li>
        </ol>

        <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius); margin: 1rem 0;">
            <p style="font-size: 0.875rem; margin: 0;">
                <strong>Tip:</strong> You can use online DNS checker tools to verify if your TXT record has been added correctly.
            </p>
        </div>

        <div style="display: flex; justify-content: center; margin-top: 2rem;">
            <button class="btn btn-primary" onclick="verifyDomain('${domain}')">
                <i class="ri-check-line"></i> Try Verification Again
            </button>
        </div>
    </div>
    `);
}

// Article Modal - Fixed
function showArticleModal(articleId = null) {
    const isEdit = !!articleId;

    showModal(isEdit ? 'Edit Article' : 'Create Article', `
    <form id="articleForm" enctype="multipart/form-data">
    <div class="form-group">
    <label class="form-label">Domain URL</label>
    <select class="form-select" name="url" required>
    <option value="">Select a verified domain...</option>
    ${currentData.domains.filter(d => d.verified).map(domain => `
        <option value="${domain.domain}">${domain.domain}</option>
        `).join('')}
        </select>
        ${currentData.domains.filter(d => d.verified).length === 0 ? `
            <small style="color: var(--error); display: block; margin-top: 0.5rem;">
            No verified domains available. Please add and verify a domain first.
            </small>
            ` : ''}
            </div>

            <div class="form-group">
            <label class="form-label">Article Title</label>
            <input type="text" class="form-input" name="subject" required placeholder="My Amazing Article Title">
            </div>

            <div class="form-group">
            <label class="form-label">Article Content (HTML)</label>
            <textarea class="form-textarea" name="body" required rows="12" placeholder="<h1>Article Title</h1><p>Your article content goes here...</p>"></textarea>
            <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
            You can use HTML tags to format your content. Images will be uploaded separately.
            </small>
            </div>

            <div class="form-group">
            <label class="form-label">Upload Images (Optional)</label>
            <input type="file" class="form-input" name="image_data" multiple accept="image/*">
            <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
            Upload up to 10 images. Maximum 5MB per image, 20MB total.
            </small>
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary" style="flex: 1;">
            ${isEdit ? 'Update' : 'Create'} Article
            </button>
            </div>
            </form>
            `);

    document.getElementById('articleForm').addEventListener('submit', (e) => {
        e.preventDefault();
        if (isEdit) {
            updateArticle(articleId, e);
        } else {
            createArticle(e);
        }
    });
}

async function createArticle(e) {
    const formData = new FormData(e.target);

    // Check if domain is verified - Fixed to use domain.domain
    const selectedDomain = formData.get('url');
    const verifiedDomain = currentData.domains.find(d => d.domain === selectedDomain && d.verified);

    if (!verifiedDomain) {
        showToast('Please select a verified domain', 'error');
        return;
    }

    const createButton = e.target.querySelector('button[type="submit"]');
    createButton.innerHTML = '<i class="ri-loader-line"></i> Creating Article...';
    createButton.disabled = true;

    try {
        const response = await fetch(`${API_BASE}/add-article`, {
            method: 'POST',
            headers: {
                'Session-Token': sessionToken
            },
            body: formData
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error?.message || data.message || 'Failed to create article');
        }

        showToast('Article created successfully!', 'success');
        closeModal();
        loadArticles();

    } catch (error) {
        console.error('Create article error:', error);
        showToast('Failed to create article: ' + error.message, 'error');
    } finally {
        createButton.innerHTML = 'Create Article';
        createButton.disabled = false;
    }
}

async function viewArticle(articleId) {
    try {
        const response = await api(`/dashboard/articles?article_id=${articleId}`);
        const article = response.data.article;

        // Process analytics data
        const stats = article.stats || {};
        const countries = {};
        const browsers = {};
        const devices = {};
        const viewsByDate = {};

        Object.entries(stats).forEach(([month, monthStats]) => {
            if (monthStats.country) {
                Object.entries(monthStats.country).forEach(([country, views]) => {
                    const key = String(country || '').toUpperCase();
                    countries[key] = (countries[key] || 0) + views;
                });
            }
            if (monthStats.browser) {
                Object.entries(monthStats.browser).forEach(([browser, views]) => {
                    const key = String(browser || '');
                    browsers[key] = (browsers[key] || 0) + views;
                });
            }
            if (monthStats.devices) {
                Object.entries(monthStats.devices).forEach(([device, views]) => {
                    const key = String(device || '');
                    devices[key] = (devices[key] || 0) + views;
                });
            }
            if (monthStats.daily) {
                Object.entries(monthStats.daily).forEach(([day, views]) => {
                    const [year, monthNum] = month.split('-');
                    const fullDate = `${year}-${monthNum}-${String(day).padStart(2, '0')}`;
                    viewsByDate[fullDate] = (viewsByDate[fullDate] || 0) + views;
                });
            }
        });

        const sortedDates = Object.entries(viewsByDate).sort(([a], [b]) => new Date(a) - new Date(b));
        const haveStats = Object.keys(stats).length > 0;

        showModal('Article Analytics', `
        <div>
            <!-- Desktop Layout -->
            <div class="desktop-only">
                <div style="height: 80vh; display: grid; grid-template-rows: auto 1fr; gap: 1rem;">
                    <!-- Compact Header -->
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 1.5rem; align-items: center; padding: 0.75rem 1rem; background: var(--primary); color: white; border-radius: var(--radius); margin: -1.5rem -1.5rem 0 -1.5rem;">
                        <div>
                            <h4 style="color: white; margin-bottom: 0.5rem; font-size: 1.05rem; line-height: 1.2;">${article.subject}</h4>
                            <div style="display: flex; gap: 1rem; font-size: 0.85rem; opacity: 0.9; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                <span title="${article.url}"><i class="ri-global-line"></i> ${article.url}</span>
                                <span><i class="ri-eye-line"></i> ${formatNumber(article.total_views || 0)} views</span>
                                <span><i class="ri-calendar-line"></i> ${new Date(article.creation_date).toLocaleDateString()}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm" onclick="window.open('https://${article.url}', '_blank')" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.375rem 0.75rem;">
                                <i class="ri-external-link-line"></i>
                            </button>
                            <button class="btn btn-sm" onclick="editArticle('${article.article_id}')" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.375rem 0.75rem;">
                                <i class="ri-edit-line"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="confirmDeleteArticle('${article.article_id}')" style="padding: 0.375rem 0.75rem;">
                                <i class="ri-delete-bin-line"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Main Content Grid -->
                    <div style="display: grid; grid-template-columns: 2fr 300px; gap: 1.5rem; min-height: 0;">
                        <!-- Charts Area -->
                        <div style="display: flex; flex-direction: column; gap: 1rem; overflow: hidden;">
                            ${haveStats ? `
                                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                                    <div style="background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 0.75rem;">
                                        <h6 style="margin-bottom: 0.5rem; color: var(--primary); font-size: 0.9rem;">Views Timeline</h6>
                                        <div style="height: 220px; position: relative;">
                                            <canvas id="articleViewsChart"></canvas>
                                        </div>
                                    </div>
                                    <div style="background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 0.75rem;">
                                        <h6 style="margin-bottom: 0.5rem; color: var(--warning); font-size: 0.85rem; display: flex; align-items: center; gap: 0.25rem;">
                                            <i class="ri-smartphone-line"></i> Devices
                                        </h6>
                                        <div style="height: 200px; position: relative;">
                                            <canvas id="articleDevicesChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div style="background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 0.75rem;">
                                        <h6 style="margin-bottom: 0.5rem; color: var(--success); font-size: 0.85rem; display: flex; align-items: center; gap: 0.25rem;">
                                            <i class="ri-global-line"></i> Countries
                                        </h6>
                                        <div style="height: 200px; position: relative;">
                                            <canvas id="articleCountriesChart"></canvas>
                                        </div>
                                    </div>
                                    <div style="background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 0.75rem;">
                                        <h6 style="margin-bottom: 0.5rem; color: var(--primary); font-size: 0.85rem; display: flex; align-items: center; gap: 0.25rem;">
                                            <i class="ri-computer-line"></i> Browsers
                                        </h6>
                                        <div style="height: 200px; position: relative;">
                                            <canvas id="articleBrowsersChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <div style="display: flex; align-items: center; justify-content: center; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 2rem; text-align: center; color: var(--text-secondary);">
                                    <div>
                                        <i class="ri-bar-chart-line" style="font-size: 2.5rem; opacity: 0.5; margin-bottom: 1rem; display: block;"></i>
                                        <h5 style="margin-bottom: 0.5rem;">No Analytics Data</h5>
                                        <p style="font-size: 0.9rem; margin: 0;">Analytics will appear once your article receives views.</p>
                                    </div>
                                </div>
                            `}
                        </div>

                        <!-- Sidebar -->
                        <div style="display: flex; flex-direction: column; gap: 1rem; overflow-y: auto;">
                            ${article.images && article.images.length > 0 ? `
                                <div style="background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem;">
                                    <h6 style="margin-bottom: 0.75rem; font-size: 0.85rem;">Images (${article.images.length})</h6>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 0.5rem;">
                                        ${article.images.map(img => `
                                            <div onclick="window.open('${img}', '_blank')" style="cursor: pointer; aspect-ratio: 1; border-radius: 4px; overflow: hidden; background: var(--bg-tertiary); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                                <img src="${img}" style="width: 100%; height: 100%; object-fit: cover;" loading="lazy">
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            <div style="background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; flex: 1; min-height: 0;">
                                <h6 style="margin-bottom: 0.75rem; font-size: 0.85rem;">Content Preview</h6>
                                <div style="overflow-y: auto; font-family: Georgia, serif; line-height: 1.5; font-size: 0.8rem; max-height: 300px;">
                                    ${article.body}
                                </div>
                            </div>
                            <div style="background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem;">
                                <h6 style="margin-bottom: 0.75rem; font-size: 0.85rem;">Details</h6>
                                <div style="font-size: 0.8rem; line-height: 1.4; color: var(--text-secondary);">
                                    <div style="margin-bottom: 0.5rem;"><strong>ID: </strong><code style="font-size: 0.7rem;">${article.article_id}</code></div>
                                    <div><strong>Views:</strong> <span style="color: var(--primary); font-weight: 600;">${formatNumber(article.total_views || 0)}</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Perfect Mobile Layout -->
            <div class="mobile-only" style="padding: 0; margin: -1.5rem; background: var(--bg);">

                <!-- Compact Mobile Hero Header -->
                <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 1rem; position: relative;">
                    <div style="display: flex; align-items: flex-start; gap: 1rem;">
                        <!-- Article Info -->
                        <div style="flex: 1; min-width: 0;">
                            <h3 style="color: white; font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; line-height: 1.2; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${article.subject}</h3>
                            <div style="display: flex; flex-direction: column; gap: 0.25rem; opacity: 0.9;">
                                <div style="font-size: 0.75rem; display: flex; align-items: center; gap: 0.25rem;">
                                    <i class="ri-global-line" style="font-size: 0.7rem;"></i>
                                    <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${article.url}</span>
                                </div>
                                <div style="font-size: 0.7rem; opacity: 0.8; display: flex; align-items: center; gap: 0.25rem;">
                                    <i class="ri-calendar-line" style="font-size: 0.65rem;"></i>
                                    <span>${new Date(article.creation_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Compact Views Badge -->
                        <div style="background: rgba(255,255,255,0.2); padding: 0.6rem 0.8rem; border-radius: var(--radius); text-align: center; flex-shrink: 0; backdrop-filter: blur(5px);">
                            <div style="font-size: 1.2rem; font-weight: 700; line-height: 1; margin-bottom: 0.15rem;">${formatNumber(article.total_views || 0)}</div>
                            <div style="font-size: 0.65rem; opacity: 0.9; font-weight: 500; letter-spacing: 0.5px;">VIEWS</div>
                        </div>
                    </div>
                </div>

                <!-- Mobile Actions Bar -->
                <div style="background: var(--card); padding: 0.75rem; border-bottom: 1px solid var(--border); display: flex; gap: 0.5rem;">
                    <button class="btn btn-primary" onclick="window.open('https://${article.url}', '_blank')" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.625rem; font-size: 0.85rem;">
                        <i class="ri-external-link-line"></i> View Live
                    </button>
                    <button class="btn btn-secondary" onclick="editArticle('${article.article_id}')" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.625rem; font-size: 0.85rem;">
                        <i class="ri-edit-line"></i> Edit
                    </button>
                    <button class="btn btn-danger" onclick="confirmDeleteArticle('${article.article_id}')" style="padding: 0.625rem 0.75rem;">
                        <i class="ri-delete-bin-line"></i>
                    </button>
                </div>

                <!-- Mobile Content -->
                <div style="padding: 1rem; background: var(--bg);">

                    <!-- Analytics Overview Cards -->
                    ${haveStats ? `
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text);">Analytics Overview</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                ${Object.keys(countries).length > 0 ? `
                                    <div style="background: linear-gradient(135deg, var(--success) 0%, #059669 100%); color: white; padding: 1.25rem; border-radius: var(--radius-lg); text-align: center; box-shadow: var(--shadow);">
                                        <div style="font-size: 1.75rem; font-weight: 800; margin-bottom: 0.25rem;">${Object.keys(countries).length}</div>
                                        <div style="font-size: 0.8rem; opacity: 0.9; font-weight: 500;">Countries</div>
                                    </div>
                                ` : ''}
                                ${Object.keys(browsers).length > 0 ? `
                                    <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 1.25rem; border-radius: var(--radius-lg); text-align: center; box-shadow: var(--shadow);">
                                        <div style="font-size: 1.75rem; font-weight: 800; margin-bottom: 0.25rem;">${Object.keys(browsers).length}</div>
                                        <div style="font-size: 0.8rem; opacity: 0.9; font-weight: 500;">Browsers</div>
                                    </div>
                                ` : ''}
                                ${Object.keys(devices).length > 0 ? `
                                    <div style="background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%); color: white; padding: 1.25rem; border-radius: var(--radius-lg); text-align: center; box-shadow: var(--shadow);">
                                        <div style="font-size: 1.75rem; font-weight: 800; margin-bottom: 0.25rem;">${Object.keys(devices).length}</div>
                                        <div style="font-size: 0.8rem; opacity: 0.9; font-weight: 500;">Devices</div>
                                    </div>
                                ` : ''}
                                ${sortedDates.length > 0 ? `
                                    <div style="background: linear-gradient(135deg, var(--info) 0%, #2563eb 100%); color: white; padding: 1.25rem; border-radius: var(--radius-lg); text-align: center; box-shadow: var(--shadow);">
                                        <div style="font-size: 1.75rem; font-weight: 800; margin-bottom: 0.25rem;">${sortedDates.length}</div>
                                        <div style="font-size: 0.8rem; opacity: 0.9; font-weight: 500;">Active Days</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Article Information -->
                    <div style="background: var(--card); border-radius: var(--radius-lg); padding: 1.25rem; margin-bottom: 1.5rem; border: 1px solid var(--border); box-shadow: var(--shadow-sm);">
                        <h4 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text); display: flex; align-items: center; gap: 0.5rem;">
                            <i class="ri-information-line" style="color: var(--primary);"></i> Article Information
                        </h4>
                        <div style="space-y: 1rem;">
                            <div style="margin-bottom: 1rem;">
                                <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;">Article ID</div>
                                <code style="background: var(--bg-tertiary); padding: 0.5rem; border-radius: var(--radius-sm); font-size: 0.8rem; color: var(--text); display: block; word-break: break-all;">${article.article_id}</code>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;">Domain</div>
                                <a href="https://${article.url}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                                    ${article.url} <i class="ri-external-link-line"></i>
                                </a>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;">Published Date</div>
                                <div style="color: var(--text-secondary); font-weight: 500;">${new Date(article.creation_date).toLocaleDateString('en-US', {
                                    weekday: 'long',
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric'
                                })}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Images Section -->
                    ${article.images && article.images.length > 0 ? `
                        <div style="background: var(--card); border-radius: var(--radius-lg); padding: 1.25rem; margin-bottom: 1.5rem; border: 1px solid var(--border); box-shadow: var(--shadow-sm);">
                            <h4 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text); display: flex; align-items: center; gap: 0.5rem;">
                                <i class="ri-image-line" style="color: var(--warning);"></i> Images (${article.images.length})
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem;">
                                ${article.images.map(img => `
                                    <div onclick="window.open('${img}', '_blank')" style="cursor: pointer; aspect-ratio: 1; border-radius: var(--radius); overflow: hidden; background: var(--bg-tertiary); transition: all 0.3s ease; box-shadow: var(--shadow-sm);" ontouchstart="this.style.transform='scale(0.95)'; this.style.boxShadow='var(--shadow)'" ontouchend="this.style.transform='scale(1)'; this.style.boxShadow='var(--shadow-sm)'">
                                        <img src="${img}" style="width: 100%; height: 100%; object-fit: cover;" loading="lazy">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Detailed Analytics -->
                    ${haveStats ? `
                        <!-- Top Countries -->
                        ${Object.keys(countries).length > 0 ? `
                            <div style="background: var(--card); border-radius: var(--radius-lg); padding: 1.25rem; margin-bottom: 1.5rem; border: 1px solid var(--border); box-shadow: var(--shadow-sm);">
                                <h4 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--success); display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="ri-global-line"></i> Top Countries
                                </h4>
                                <div style="space-y: 0.75rem;">
                                    ${Object.entries(countries).sort(([,a], [,b]) => b - a).slice(0, 5).map(([country, views], index) => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--bg-tertiary); border-radius: var(--radius); ${index === 0 ? 'border: 2px solid var(--success);' : ''}">
                                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                ${index === 0 ? '<div style="width: 8px; height: 8px; background: var(--success); border-radius: 50%;"></div>' : '<div style="width: 8px; height: 8px; background: var(--text-tertiary); border-radius: 50%;"></div>'}
                                                <span style="font-weight: 600; font-size: 0.95rem;">${country}</span>
                                            </div>
                                            <span style="background: var(--success); color: white; padding: 0.25rem 0.75rem; border-radius: var(--radius); font-size: 0.8rem; font-weight: 600;">${formatNumber(views)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Top Browsers -->
                        ${Object.keys(browsers).length > 0 ? `
                            <div style="background: var(--card); border-radius: var(--radius-lg); padding: 1.25rem; margin-bottom: 1.5rem; border: 1px solid var(--border); box-shadow: var(--shadow-sm);">
                                <h4 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--primary); display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="ri-computer-line"></i> Top Browsers
                                </h4>
                                <div style="space-y: 0.75rem;">
                                    ${Object.entries(browsers).sort(([,a], [,b]) => b - a).slice(0, 5).map(([browser, views], index) => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--bg-tertiary); border-radius: var(--radius); ${index === 0 ? 'border: 2px solid var(--primary);' : ''}">
                                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                ${index === 0 ? '<div style="width: 8px; height: 8px; background: var(--primary); border-radius: 50%;"></div>' : '<div style="width: 8px; height: 8px; background: var(--text-tertiary); border-radius: 50%;"></div>'}
                                                <span style="font-weight: 600; font-size: 0.95rem; text-transform: capitalize;">${browser}</span>
                                            </div>
                                            <span style="background: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: var(--radius); font-size: 0.8rem; font-weight: 600;">${formatNumber(views)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Recent Activity -->
                        ${sortedDates.length > 0 ? `
                            <div style="background: var(--card); border-radius: var(--radius-lg); padding: 1.25rem; margin-bottom: 1.5rem; border: 1px solid var(--border); box-shadow: var(--shadow-sm);">
                                <h4 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--info); display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="ri-calendar-line"></i> Recent Activity
                                </h4>
                                <div style="max-height: 250px; overflow-y: auto;">
                                    ${sortedDates.slice(-7).reverse().map(([date, views], index) => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; ${index < sortedDates.slice(-7).length - 1 ? 'border-bottom: 1px solid var(--border);' : ''}">
                                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                <div style="width: 6px; height: 6px; background: var(--info); border-radius: 50%;"></div>
                                                <span style="font-size: 0.9rem; color: var(--text-secondary);">${new Date(date).toLocaleDateString('en-US', {
                                                    month: 'short',
                                                    day: 'numeric',
                                                    year: new Date(date).getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined
                                                })}</span>
                                            </div>
                                            <span style="background: var(--info); color: white; padding: 0.25rem 0.75rem; border-radius: var(--radius); font-size: 0.8rem; font-weight: 600;">${formatNumber(views)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                <div style="text-align: center; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                                    <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                        <strong style="color: var(--text);">${formatNumber(sortedDates.reduce((sum, [,views]) => sum + views, 0))}</strong> total views across <strong style="color: var(--text);">${sortedDates.length}</strong> days
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    ` : `
                        <div style="background: var(--card); border-radius: var(--radius-lg); padding: 2rem; text-align: center; color: var(--text-secondary); border: 1px solid var(--border); box-shadow: var(--shadow-sm);">
                            <div style="background: var(--bg-tertiary); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                                <i class="ri-bar-chart-line" style="font-size: 2rem; opacity: 0.5;"></i>
                            </div>
                            <h5 style="margin-bottom: 0.5rem; color: var(--text);">No Analytics Yet</h5>
                            <p style="font-size: 0.9rem; margin: 0; max-width: 250px; margin: 0 auto;">Analytics will appear once your article starts receiving views from readers.</p>
                        </div>
                    `}

                    <!-- Content Preview -->
                    <div style="background: var(--card); border-radius: var(--radius-lg); padding: 1.25rem; border: 1px solid var(--border); box-shadow: var(--shadow-sm);">
                        <h4 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text); display: flex; align-items: center; gap: 0.5rem;">
                            <i class="ri-file-text-line" style="color: var(--accent);"></i> Content Preview
                        </h4>
                        <div style="max-height: 300px; overflow-y: auto; font-family: Georgia, serif; line-height: 1.6; font-size: 0.9rem; color: var(--text-secondary); background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border);">
                            ${article.body}
                        </div>
                    </div>

                </div>
            </div>
        </div>
        `, '95vw');

        // Initialize charts after DOM paints
        setTimeout(() => {
            initializeArticleCharts(countries, browsers, devices, sortedDates);
        }, 100);

    } catch (error) {
        console.error('View article error:', error);
        showToast('Failed to load article details', 'error');
    }
}

// Charts
function initializeArticleCharts(countries, browsers, devices, sortedDates) {
    const isDark = document.body.getAttribute('data-theme') === 'dark';
    const textColor = isDark ? '#e2e8f0' : '#1e293b';
    const gridColor = isDark ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)';

    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: 0 },
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    color: textColor,
                    usePointStyle: true,
                    padding: 6,
                    font: { size: 10 }
                }
            },
            tooltip: {
                backgroundColor: isDark ? 'rgba(0, 0, 0, 0.8)' : 'rgba(255, 255, 255, 0.95)',
                titleColor: textColor,
                bodyColor: textColor,
                borderWidth: 1,
                cornerRadius: 6,
                padding: 8,
                titleFont: { size: 11 },
                bodyFont: { size: 10 }
            }
        }
    };

    // Timeline
    if (sortedDates && sortedDates.length > 0) {
        const viewsChart = document.getElementById('articleViewsChart');
        if (viewsChart) {
            new Chart(viewsChart, {
                type: 'line',
                data: {
                    labels: sortedDates.map(([date]) =>
                        new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                    ),
                    datasets: [{
                        label: 'Views',
                        data: sortedDates.map(([, views]) => views),
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.12)',
                        tension: 0.35,
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 2.5,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        x: {
                            grid: { color: gridColor, drawBorder: false },
                            ticks: { color: textColor, font: { size: 10 }, maxRotation: 0, autoSkipPadding: 8 }
                        },
                        y: {
                            grid: { color: gridColor, drawBorder: false },
                            ticks: { color: textColor, font: { size: 10 }, beginAtZero: true }
                        }
                    },
                    plugins: { ...commonOptions.plugins, legend: { display: false } }
                }
            });
        }
    }

    // Doughnuts
    const chartConfigs = [
        { id: 'articleCountriesChart', data: countries, colors: ['#10b981', '#059669', '#047857', '#065f46', '#064e3b'] },
        { id: 'articleBrowsersChart', data: browsers, colors: ['#6366f1', '#4f46e5', '#4338ca', '#3730a3', '#312e81'] },
        { id: 'articleDevicesChart', data: devices, colors: ['#f59e0b', '#d97706', '#b45309', '#92400e', '#78350f'] }
    ];

    chartConfigs.forEach(({ id, data, colors }) => {
        if (data && Object.keys(data).length > 0) {
            const el = document.getElementById(id);
            if (!el) return;
            const sortedData = Object.entries(data).sort(([, a], [, b]) => b - a);
            new Chart(el, {
                type: 'doughnut',
                data: {
                    labels: sortedData.map(([key]) => key.charAt(0).toUpperCase() + key.slice(1)),
                    datasets: [{
                        data: sortedData.map(([, v]) => v),
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    ...commonOptions,
                    cutout: '60%',
                    plugins: {
                        ...commonOptions.plugins,
                        legend: {
                            ...commonOptions.plugins.legend,
                            display: true
                        }
                    }
                }
            });
        }
    });
}


async function editArticle(articleId) {
    closeModal();
    setTimeout(() => showArticleModal(articleId), 100);
}

async function deleteArticle(articleId) {
    if (!confirm('Are you sure you want to delete this article? This action cannot be undone.')) {
        return;
    }

    try {
        await api(`/delete-article/${articleId}`, { method: 'DELETE' });
        showToast('Article deleted successfully', 'success');
        loadArticles();
    } catch (error) {
        console.error('Delete article error:', error);
        showToast('Failed to delete article: ' + error.message, 'error');
    }
}

// Image Upload Modal
function showImageUploadModal() {
    showModal('Upload Images', `
    <form id="imageUploadForm" enctype="multipart/form-data">
    <div class="form-group">
    <label class="form-label">Select Images</label>
    <input type="file" class="form-input" name="file" multiple accept="image/*" required>
    <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
    Maximum 10 files, 5MB per file. Supported formats: JPG, PNG, GIF, WebP
    </small>
    </div>

    <div id="uploadPreview" style="margin-top: 1rem; display: none;">
    <h4>Preview:</h4>
    <div id="previewContainer" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;"></div>
    </div>

    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
    <button type="submit" class="btn btn-primary" style="flex: 1;">Upload Images</button>
    </div>
    </form>
    `);

    // Preview functionality
    document.querySelector('input[name="file"]').addEventListener('change', function(e) {
        const files = e.target.files;
        const previewContainer = document.getElementById('previewContainer');
        const uploadPreview = document.getElementById('uploadPreview');

        if (files.length > 0) {
            uploadPreview.style.display = 'block';
            previewContainer.innerHTML = '';

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.width = '60px';
                    img.style.height = '60px';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '4px';
                    img.style.border = '1px solid var(--border)';
                    previewContainer.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        } else {
            uploadPreview.style.display = 'none';
        }
    });

    document.getElementById('imageUploadForm').addEventListener('submit', uploadImages);
}

async function uploadImages(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const files = formData.getAll('file');

    if (files.length === 0) {
        showToast('Please select at least one image', 'error');
        return;
    }

    if (files.length > 10) {
        showToast('Maximum 10 images allowed', 'error');
        return;
    }

    try {
        const response = await fetch(`${API_BASE}/images/upload`, {
            method: 'POST',
            headers: {
                'Session-Token': sessionToken
            },
            body: formData
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error?.message || data.message || 'Upload failed');
        }

        showToast(`Successfully uploaded ${data.data.uploaded_images.length} images`, 'success');
        closeModal();
        loadImages();

    } catch (error) {
        console.error('Upload error:', error);
        showToast('Upload failed: ' + error.message, 'error');
    }
}

// Enhanced Image Details with Mobile-Optimized Layout
async function showImageDetails(imageId) {
    try {
        // Get the image from current data
        const image = currentData.images.find(img => img.image_id === imageId);

        if (!image) {
            showToast('Image not found', 'error');
            return;
        }

        const monthlyStats = image.monthly_stats || {};

        // Aggregate analytics data properly
        const countries = {};
        const browsers = {};
        const devices = {};
        const viewsByDate = {};

        // Process each month's data
        Object.entries(monthlyStats).forEach(([month, stats]) => {
            // Country data aggregation
            if (stats.country) {
                Object.entries(stats.country).forEach(([country, views]) => {
                    const countryCode = country.toUpperCase();
                    countries[countryCode] = (countries[countryCode] || 0) + views;
                });
            }

            // Browser data aggregation
            if (stats.browser) {
                Object.entries(stats.browser).forEach(([browser, views]) => {
                    browsers[browser] = (browsers[browser] || 0) + views;
                });
            }

            // Device data aggregation
            if (stats.devices) {
                Object.entries(stats.devices).forEach(([device, views]) => {
                    devices[device] = (devices[device] || 0) + views;
                });
            }

            // Daily views data - Create full dates
            if (stats.daily) {
                Object.entries(stats.daily).forEach(([day, views]) => {
                    const [year, monthNum] = month.split('-');
                    const fullDate = `${year}-${monthNum}-${day.padStart(2, '0')}`;
                    viewsByDate[fullDate] = views;
                });
            }
        });

        // Sort dates chronologically for the timeline
        const sortedDates = Object.entries(viewsByDate).sort(([a], [b]) => new Date(a) - new Date(b));

        // Calculate top performers for better insights
        const topCountries = Object.entries(countries).sort(([,a], [,b]) => b - a).slice(0, 5);
        const topBrowsers = Object.entries(browsers).sort(([,a], [,b]) => b - a).slice(0, 5);
        const topDevices = Object.entries(devices).sort(([,a], [,b]) => b - a).slice(0, 5);

        showModal('Image Analytics', `
        <div>
            <!-- Desktop Layout -->
            <div class="desktop-only">
                <div style="display: grid; grid-template-columns: 300px 1fr; gap: 2rem;">
                    <!-- Image Info Panel -->
                    <div>
                        <div onclick="window.open('${image.cdn_url}', '_blank')" style="cursor: pointer; position: relative; margin-bottom: 1rem;" title="Click to open full size">
                            <img src="${image.cdn_url}" style="width: 100%; border-radius: var(--radius); box-shadow: var(--shadow);" alt="${image.original_filename}">
                            <div style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                                <i class="ri-external-link-line"></i> Full Size
                            </div>
                        </div>

                        <div class="stat-card" style="text-align: center; margin-bottom: 1rem;">
                            <div class="stat-value" style="font-size: 2rem; color: var(--primary);">${formatNumber(image.total_views)}</div>
                            <div class="stat-label">Total Views</div>
                        </div>

                        <div style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.6;">
                            <div style="margin-bottom: 0.75rem;">
                                <strong>Filename:</strong><br>
                                <span style="word-break: break-all; font-family: monospace; font-size: 0.8rem;">${image.original_filename}</span>
                            </div>
                            <div style="margin-bottom: 0.75rem;">
                                <strong>Uploaded:</strong><br>
                                ${new Date(image.upload_date).toLocaleDateString('en-US', {
                                    weekday: 'long',
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric'
                                })}
                            </div>
                            <div style="margin-bottom: 0.75rem;">
                                <strong>Available Formats:</strong><br>
                                ${Object.keys(image.formats || {}).length > 0 ?
                                    Object.entries(image.formats).map(([format, count]) =>
                                        `${format.toUpperCase()} (${formatNumber(count)} views)`
                                    ).join(', ') : 'Original only'
                                }
                            </div>
                            <div>
                                <strong>Image ID:</strong><br>
                                <code style="font-size: 0.75rem; word-break: break-all;">${image.image_id}</code>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Panel -->
                    <div>
                        <h4 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="ri-bar-chart-line" style="color: var(--primary);"></i>
                            Detailed Analytics
                        </h4>

                        <!-- Top Level Stats -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;">
                            <div class="stat-card" style="text-align: center;">
                                <div class="stat-value" style="color: var(--success);">${topCountries.length}</div>
                                <div class="stat-label">Countries</div>
                            </div>
                            <div class="stat-card" style="text-align: center;">
                                <div class="stat-value" style="color: var(--primary);">${topBrowsers.length}</div>
                                <div class="stat-label">Browsers</div>
                            </div>
                            <div class="stat-card" style="text-align: center;">
                                <div class="stat-value" style="color: var(--warning);">${topDevices.length}</div>
                                <div class="stat-label">Devices</div>
                            </div>
                        </div>

                        <!-- Analytics Breakdown -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
                            <div>
                                <h5 style="margin-bottom: 1rem; color: var(--success); display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="ri-global-line"></i> Top Countries
                                </h5>
                                <div style="max-height: 180px; overflow-y: auto;">
                                    ${topCountries.length > 0 ? topCountries.map(([country, views]) => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <span style="font-weight: 600;">${country}</span>
                                            </div>
                                            <span class="badge badge-success">${formatNumber(views)} views</span>
                                        </div>
                                    `).join('') : '<div style="color: var(--text-secondary); font-size: 0.875rem; text-align: center; padding: 1rem;">No country data</div>'}
                                </div>
                            </div>

                            <div>
                                <h5 style="margin-bottom: 1rem; color: var(--primary); display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="ri-computer-line"></i> Top Browsers
                                </h5>
                                <div style="max-height: 180px; overflow-y: auto;">
                                    ${topBrowsers.length > 0 ? topBrowsers.map(([browser, views]) => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <i class="ri-${browser.toLowerCase() === 'firefox' ? 'firefox' : browser.toLowerCase() === 'chrome' ? 'chrome' : 'computer'}-line" style="color: var(--primary);"></i>
                                                <span style="text-transform: capitalize; font-weight: 500;">${browser}</span>
                                            </div>
                                            <span class="badge badge-primary">${formatNumber(views)} views</span>
                                        </div>
                                    `).join('') : '<div style="color: var(--text-secondary); font-size: 0.875rem; text-align: center; padding: 1rem;">No browser data</div>'}
                                </div>
                            </div>

                            <div>
                                <h5 style="margin-bottom: 1rem; color: var(--warning); display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="ri-device-line"></i> Top Devices
                                </h5>
                                <div style="max-height: 180px; overflow-y: auto;">
                                    ${topDevices.length > 0 ? topDevices.map(([device, views]) => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <i class="ri-${device.toLowerCase() === 'android' ? 'android' : device.toLowerCase() === 'linux' ? 'ubuntu' : 'device'}-line" style="color: var(--warning);"></i>
                                                <span style="text-transform: capitalize; font-weight: 500;">${device}</span>
                                            </div>
                                            <span class="badge badge-warning">${formatNumber(views)} views</span>
                                        </div>
                                    `).join('') : '<div style="color: var(--text-secondary); font-size: 0.875rem; text-align: center; padding: 1rem;">No device data</div>'}
                                </div>
                            </div>
                        </div>

                        <!-- Views by Date Analytics -->
                        ${sortedDates.length > 0 ? `
                            <div>
                                <h5 style="margin-bottom: 1rem; color: var(--primary); display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="ri-calendar-line"></i> Views by Date Analytics
                                </h5>
                                <div style="max-height: 300px; overflow-y: auto; background: var(--bg-tertiary); border-radius: var(--radius); padding: 1rem;">
                                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; font-weight: 600; padding-bottom: 0.5rem; border-bottom: 2px solid var(--border); margin-bottom: 0.5rem;">
                                        <div>Date</div>
                                        <div>Views</div>
                                    </div>
                                    ${sortedDates.map(([date, views]) => `
                                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                                            <div style="color: var(--text-secondary);">${new Date(date).toLocaleDateString('en-US', {
                                                weekday: 'short',
                                                year: 'numeric',
                                                month: 'short',
                                                day: 'numeric'
                                            })}</div>
                                            <div>
                                                <span class="badge badge-primary">${formatNumber(views)} view${views !== 1 ? 's' : ''}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary); text-align: center;">
                                    Total: ${formatNumber(sortedDates.reduce((sum, [,views]) => sum + views, 0))} views across ${sortedDates.length} days
                                </div>
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                <div style="font-size: 2rem; margin-bottom: 1rem;"><i class="ri-calendar-line"></i></div>
                                <div>No date analytics available yet</div>
                                <div style="font-size: 0.875rem; margin-top: 0.5rem;">Analytics will appear once your image receives views</div>
                            </div>
                        `}
                    </div>
                </div>
            </div>

            <!-- Mobile Layout -->
            <div class="mobile-only">
                <!-- Mobile Image Header -->
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div onclick="window.open('${image.cdn_url}', '_blank')" style="cursor: pointer; position: relative; margin-bottom: 1rem;" title="Tap to open full size">
                        <img src="${image.cdn_url}" style="width: 100%; max-width: 280px; border-radius: var(--radius); box-shadow: var(--shadow);" alt="${image.original_filename}">
                        <div style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.8); color: white; padding: 0.5rem; border-radius: var(--radius); font-size: 0.8rem;">
                            <i class="ri-external-link-line"></i> Full Size
                        </div>
                    </div>

                    <!-- Mobile Stats Cards -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                        <div style="background: var(--primary); color: white; padding: 1rem; border-radius: var(--radius); text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem;">${formatNumber(image.total_views)}</div>
                            <div style="font-size: 0.8rem; opacity: 0.9;">Total Views</div>
                        </div>
                        <div style="background: var(--success); color: white; padding: 1rem; border-radius: var(--radius); text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem;">${topCountries.length}</div>
                            <div style="font-size: 0.8rem; opacity: 0.9;">Countries</div>
                        </div>
                    </div>
                </div>

                <!-- Mobile Image Info -->
                <div style="background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="ri-information-line"></i> Image Details
                    </h4>
                    <div style="font-size: 0.85rem; line-height: 1.6;">
                        <div style="margin-bottom: 0.75rem;">
                            <strong>Filename:</strong><br>
                            <span style="word-break: break-all; font-family: monospace; font-size: 0.75rem; color: var(--text-secondary);">${image.original_filename}</span>
                        </div>
                        <div style="margin-bottom: 0.75rem;">
                            <strong>Uploaded:</strong><br>
                            <span style="color: var(--text-secondary);">${new Date(image.upload_date).toLocaleDateString('en-US', {
                                weekday: 'long',
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            })}</span>
                        </div>
                        <div>
                            <strong>Formats:</strong><br>
                            <span style="color: var(--text-secondary);">
                                ${Object.keys(image.formats || {}).length > 0 ?
                                    Object.entries(image.formats).map(([format, count]) =>
                                        `${format.toUpperCase()} (${formatNumber(count)} views)`
                                    ).join(', ') : 'Original only'
                                }
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Mobile Analytics -->
                ${(topCountries.length > 0 || topBrowsers.length > 0 || topDevices.length > 0) ? `
                    <div style="background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="ri-bar-chart-line"></i> Analytics Overview
                        </h4>

                        ${topCountries.length > 0 ? `
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin-bottom: 0.75rem; color: var(--success); font-size: 0.9rem;">
                                    <i class="ri-global-line"></i> Top Countries
                                </h5>
                                ${topCountries.slice(0, 3).map(([country, views]) => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: var(--bg-tertiary); border-radius: var(--radius-sm); margin-bottom: 0.5rem;">
                                        <span style="font-weight: 500; font-size: 0.85rem;">${country}</span>
                                        <span class="badge badge-success" style="font-size: 0.7rem;">${formatNumber(views)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${topBrowsers.length > 0 ? `
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin-bottom: 0.75rem; color: var(--primary); font-size: 0.9rem;">
                                    <i class="ri-computer-line"></i> Top Browsers
                                </h5>
                                ${topBrowsers.slice(0, 3).map(([browser, views]) => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: var(--bg-tertiary); border-radius: var(--radius-sm); margin-bottom: 0.5rem;">
                                        <span style="font-weight: 500; font-size: 0.85rem; text-transform: capitalize;">${browser}</span>
                                        <span class="badge badge-primary" style="font-size: 0.7rem;">${formatNumber(views)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${topDevices.length > 0 ? `
                            <div>
                                <h5 style="margin-bottom: 0.75rem; color: var(--warning); font-size: 0.9rem;">
                                    <i class="ri-device-line"></i> Top Devices
                                </h5>
                                ${topDevices.slice(0, 3).map(([device, views]) => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: var(--bg-tertiary); border-radius: var(--radius-sm); margin-bottom: 0.5rem;">
                                        <span style="font-weight: 500; font-size: 0.85rem; text-transform: capitalize;">${device}</span>
                                        <span class="badge badge-warning" style="font-size: 0.7rem;">${formatNumber(views)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                ` : ''}

                <!-- Mobile Views Timeline -->
                ${sortedDates.length > 0 ? `
                    <div style="background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="ri-calendar-line"></i> Recent Views
                        </h4>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${sortedDates.slice(-5).map(([date, views]) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--border); font-size: 0.85rem;">
                                    <span style="color: var(--text-secondary);">${new Date(date).toLocaleDateString('en-US', {
                                        month: 'short',
                                        day: 'numeric'
                                    })}</span>
                                    <span class="badge badge-primary" style="font-size: 0.7rem;">${formatNumber(views)}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div style="margin-top: 0.75rem; font-size: 0.8rem; color: var(--text-secondary); text-align: center;">
                            Total: ${formatNumber(sortedDates.reduce((sum, [,views]) => sum + views, 0))} views across ${sortedDates.length} days
                        </div>
                    </div>
                ` : ''}
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 1rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="copyToClipboard('${image.cdn_url}')">
                    <i class="ri-file-copy-line"></i> Copy URL
                </button>
                <button class="btn btn-primary" onclick="window.open('${image.cdn_url}', '_blank')">
                    <i class="ri-external-link-line"></i> View Full Size
                </button>
                <button class="btn btn-danger" onclick="deleteImageFromModal('${image.image_id}')">
                    <i class="ri-delete-bin-line"></i> Delete Image
                </button>
            </div>
        </div>
        `, '95vw');

    } catch (error) {
        console.error('Image details error:', error);
        showToast('Failed to load image details', 'error');
    }
}

async function deleteImage(imageId) {
    if (!confirm('Are you sure you want to delete this image? This action cannot be undone.')) {
        return;
    }

    try {
        await api('/images', {
            method: 'DELETE',
            body: JSON.stringify({ image_ids: [imageId] })
        });

        showToast('Image deleted successfully', 'success');
        loadImages();

    } catch (error) {
        console.error('Delete image error:', error);
        showToast('Failed to delete image: ' + error.message, 'error');
    }
}

function deleteImageFromModal(imageId) {
    closeModal();
    setTimeout(() => deleteImage(imageId), 100);
}

// Payment Details
async function viewPaymentDetails(billingId) {
    try {
        // Find payment in current data first (faster)
        const taskPayments = currentData.billing?.tasks || [];
        const hostingPayments = currentData.billing?.hosting || [];
        const allPayments = [...taskPayments, ...hostingPayments];

        let payment = allPayments.find(p => p.billing_id === billingId);

        // If not found in current data, try API call
        if (!payment) {
            try {
                const response = await api(`/get-payment-status?payment_id=${billingId}`);
                payment = response.data;
            } catch (apiError) {
                console.error('API payment details error:', apiError);
                showToast('Payment details not found', 'error');
                return;
            }
        }

        if (!payment) {
            showToast('Payment details not found', 'error');
            return;
        }

        // Calculate fees and amounts
        const totalAmount = payment.total_payment || 0;
        const finalAmount = payment.final_amount || 0;
        const platformFee = payment.platform_fee || 0;
        const providerFee = payment.provider_fee || 0;

        showModal('Payment Details', `
        <div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
        <div class="stat-card">
        <div class="stat-value">$${totalAmount.toFixed(2)}</div>
        <div class="stat-label">Total Amount</div>
        </div>
        <div class="stat-card">
        <div class="stat-value">$${finalAmount.toFixed(2)}</div>
        <div class="stat-label">Final Amount</div>
        </div>
        <div class="stat-card">
        <div class="stat-value">${payment.provider || 'N/A'}</div>
        <div class="stat-label">Provider</div>
        </div>
        <div class="stat-card">
        <div class="stat-value">${payment.status || 'Unknown'}</div>
        <div class="stat-label">Status</div>
        </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
        <div>
        <h4 style="margin-bottom: 1rem;">Payment Information</h4>
        <table style="width: 100%; font-size: 0.875rem;">
        <tr><td style="padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-weight: 500;">Billing ID:</td><td style="padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-family: monospace;">${payment.billing_id}</td></tr>
        <tr><td style="padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-weight: 500;">Transaction ID:</td><td style="padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-family: monospace;">${payment.txID || payment.trackId || 'N/A'}</td></tr>
        <tr><td style="padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-weight: 500;">Date Created:</td><td style="padding: 0.5rem 0; border-bottom: 1px solid var(--border);">${new Date(payment.dates?.created || Date.now()).toLocaleString()}</td></tr>
        <tr><td style="padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-weight: 500;">Date Updated:</td><td style="padding: 0.5rem 0; border-bottom: 1px solid var(--border);">${payment.dates?.updated ? new Date(payment.dates.updated).toLocaleString() : 'N/A'}</td></tr>
        <tr><td style="padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-weight: 500;">Currency:</td><td style="padding: 0.5rem 0; border-bottom: 1px solid var(--border);">${payment.transaction_data?.currency?.toUpperCase() || 'USD'}</td></tr>
        <tr><td style="padding: 0.5rem 0; font-weight: 500;">Customer:</td><td style="padding: 0.5rem 0;">${payment.transaction_data?.customer_details?.email || 'N/A'}</td></tr>
        </table>
        </div>

        <div>
        <h4 style="margin-bottom: 1rem;">Fee Breakdown</h4>
        <table style="width: 100%; font-size: 0.875rem;">
        <tr><td style="padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-weight: 500;">Platform Fee:</td><td style="padding: 0.5rem 0; border-bottom: 1px solid var(--border);">$${platformFee.toFixed(2)}</td></tr>
        <tr><td style="padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-weight: 500;">Provider Fee:</td><td style="padding: 0.5rem 0; border-bottom: 1px solid var(--border);">$${providerFee.toFixed(2)}</td></tr>
        <tr><td style="padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-weight: 500;">Total Fees:</td><td style="padding: 0.5rem 0; border-bottom: 1px solid var(--border);">$${(platformFee + providerFee).toFixed(2)}</td></tr>
        <tr style="font-weight: 600;"><td style="padding: 0.5rem 0; font-weight: 600;">Net Amount:</td><td style="padding: 0.5rem 0;">$${finalAmount.toFixed(2)}</td></tr>
        </table>
        </div>
        </div>

        ${payment.method === 'create_task' && payment.details ? `
            <div style="margin-top: 2rem;">
            <h4 style="margin-bottom: 1rem;">Task Details</h4>
            <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius);">
            <div style="margin-bottom: 0.5rem;"><strong>URL:</strong> <a href="${payment.details.url}" target="_blank" style="color: var(--primary);">${payment.details.url}</a></div>
            <div style="margin-bottom: 0.5rem;"><strong>Priority:</strong> ${payment.details.priority}</div>
            <div style="margin-bottom: 0.5rem;"><strong>Keywords:</strong> ${payment.details.keywords ? payment.details.keywords.join(', ') : 'N/A'}</div>
            <div><strong>HTML Locations:</strong> ${payment.details.html_locations ? payment.details.html_locations.length : 0} locations</div>
            </div>
            </div>
            ` : ''}

            ${payment.method === 'buy_package' && payment.details ? `
                <div style="margin-top: 2rem;">
                <h4 style="margin-bottom: 1rem;">Hosting Package Details</h4>
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius);">
                <div style="margin-bottom: 0.5rem;"><strong>Package:</strong> ${payment.details.package?.charAt(0).toUpperCase() + payment.details.package?.slice(1) || 'N/A'}</div>
                <div><strong>Duration:</strong> ${payment.details.duration || 'N/A'}</div>
                ${payment.subscription?.details ? `
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                    <strong>Subscription Status:</strong> ${payment.subscription.details.status || 'N/A'}
                    ${payment.subscription.details.current_period_end ? `<br><strong>Next Billing:</strong> ${new Date(payment.subscription.details.current_period_end).toLocaleDateString()}` : ''}
                    </div>
                    ` : ''}
                    </div>
                    </div>
                    ` : ''}

                    ${payment.method === 'recharge' && payment.details?.task_ids ? `
                        <div style="margin-top: 2rem;">
                        <h4 style="margin-bottom: 1rem;">Recharge Details</h4>
                        <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius);">
                        <div><strong>Recharged Tasks:</strong> ${payment.details.task_ids.length} task${payment.details.task_ids.length !== 1 ? 's' : ''}</div>
                        </div>
                        </div>
                        ` : ''}

                        <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: center;">
                        ${payment.payment_url ? `
                            <button class="btn btn-primary" onclick="window.open('${payment.payment_url}', '_blank')">
                            <i class="ri-external-link-line"></i> View Payment
                            </button>
                            ` : ''}
                            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                            </div>
                            </div>
                            `);

    } catch (error) {
        console.error('Payment details error:', error);
        showToast('Failed to load payment details', 'error');
    }
}

// Charts
function initializeCharts(user) {
    const isDark = document.body.getAttribute('data-theme') === 'dark';
    const textColor = isDark ? '#e2e8f0' : '#1e293b';
    const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

    // Task Performance Chart
    const taskCtx = document.getElementById('taskChart');
    if (taskCtx) {
        if (charts.task) {
            charts.task.destroy();
        }

        const taskData = generateTaskChartData(user);
        const hasRealData = taskData.labels[0] !== 'No Data';

        charts.task = new Chart(taskCtx, {
            type: 'line',
            data: {
                labels: taskData.labels,
                datasets: [{
                    label: 'Views',
                    data: taskData.views,
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 2,
                    pointBackgroundColor: '#6366f1',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: hasRealData ? 4 : 0
                }, {
                    label: 'Active Tasks',
                    data: taskData.tasks,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: false,
                    borderWidth: 2,
                    pointBackgroundColor: '#10b981',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: hasRealData ? 4 : 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: textColor,
                            usePointStyle: true,
                            padding: 20
                        }
                    },
                    tooltip: {
                        enabled: hasRealData,
                        backgroundColor: isDark ? 'rgba(30, 30, 30, 0.9)' : 'rgba(255, 255, 255, 0.9)',
                        titleColor: textColor,
                        bodyColor: textColor,
                        borderColor: textColor,
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: gridColor,
                            drawBorder: false
                        },
                        ticks: {
                            color: textColor,
                            font: { size: 12 },
                            maxRotation: 45
                        }
                    },
                    y: {
                        grid: {
                            color: gridColor,
                            drawBorder: false
                        },
                        ticks: {
                            color: textColor,
                            font: { size: 12 }
                        },
                        beginAtZero: true
                    }
                },
                elements: {
                    point: {
                        hoverRadius: hasRealData ? 6 : 0
                    }
                }
            }
        });

        // Add "No data available" message if needed
        if (!hasRealData) {
            const chartContainer = taskCtx.parentElement;
            const noDataMsg = document.createElement('div');
            noDataMsg.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: var(--text-secondary);
                font-size: 0.875rem;
                text-align: center;
                pointer-events: none;
                z-index: 10;
            `;
            noDataMsg.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">📊</div>
                <div>No analytics data available yet</div>
                <div style="font-size: 0.75rem; margin-top: 0.25rem;">Data will appear when tasks receive views</div>
            `;
            chartContainer.style.position = 'relative';
            chartContainer.appendChild(noDataMsg);
        }
    }
}

function generateTaskChartData(user) {
    const analytics = user.analytics || {};
    const monthlyStats = analytics.monthly_stats || {};

    // Collect all date-view pairs from the analytics
    const dateViews = [];

    // Parse analytics data: "2025-02": {"daily": {"04": 1, "09": 3}}
    Object.entries(monthlyStats).forEach(([monthKey, stats]) => {
        if (stats.daily) {
            Object.entries(stats.daily).forEach(([day, views]) => {
                // Convert "2025-02" and "04" to "2025-02-04"
                const fullDate = `${monthKey}-${day.padStart(2, '0')}`;
                const dateObj = new Date(fullDate);

                if (!isNaN(dateObj.getTime())) {
                    dateViews.push({
                        date: dateObj,
                        dateString: fullDate,
                        views: views || 0
                    });
                }
            });
        }
    });

    // Sort by date
    dateViews.sort((a, b) => a.date - b.date);

    // If we have analytics data, use the actual dates and views
    if (dateViews.length > 0) {
        // Take last 10 data points or all if less than 10
        const recentData = dateViews.slice(-10);

        const labels = recentData.map(item =>
            item.date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            })
        );
        const views = recentData.map(item => item.views);
        const tasks = new Array(recentData.length).fill(user.usage_summary?.active_tasks || 0);

        return { labels, views, tasks };
    }

    // Fallback: if no analytics data, show empty chart with message
    return {
        labels: ['No Data'],
        views: [0],
        tasks: [user.usage_summary?.active_tasks || 0]
    };
}

// amCharts v5 World Map — Indigo ramp, hover = green
function initializeCountryMap(user) {
  const container = document.getElementById('countryMap');
  if (!container) return;
  if (!container.style.height) container.style.height = '420px';

  // Dispose previous instance
  if (container.__am5root && !container.__am5root.isDisposed()) {
    try { container.__am5root.dispose(); } catch (_) {}
    container.__am5root = null;
  }

  // ---- Colors ----
  const RAMP_MIN   = '#a5b4fc'; // light indigo
  const RAMP_MAX   = '#4338ca'; // deep indigo
  const HOVER_FILL = '#10b981'; // green on hover
  const HOVER_EDGE = '#065f46'; // darker green stroke
  const BASE_EDGE  = '#374151'; // indigo border

  // ---- Build data ----
  const src = user?.data?.data?.user ?? user?.data?.user ?? user?.user ?? user;
  const counts = {};
  const monthly = src?.analytics?.monthly_stats || {};
  Object.values(monthly).forEach(m => {
    const cc = m?.country || {};
    for (const [iso2, v] of Object.entries(cc)) {
      const k = String(iso2).toUpperCase();
      counts[k] = (counts[k] || 0) + (Number(v) || 0);
    }
  });
  if (Object.keys(counts).length === 0 && Array.isArray(src?.sessions)) {
    src.sessions.forEach(s => {
      const k = (s.country_code || s.country || '').toUpperCase();
      if (k) counts[k] = (counts[k] || 0) + 1;
    });
  }

  const data = Object.entries(counts).map(([id, value]) => ({
    id,
    value: Number(value) || 0
  }));

  container.innerHTML = `<div id="countryMapCanvas" style="width:100%;height:100%;"></div>`;

  // ---- Helpers ----
  const ready = () =>
    typeof window.am5 !== 'undefined' &&
    typeof window.am5map !== 'undefined' &&
    typeof window.am5geodata_worldLow !== 'undefined';

  const add = (id, src) => new Promise((res, rej) => {
    if (document.getElementById(id)) return res();
    const s = document.createElement('script');
    s.id = id; s.src = src; s.async = true; s.setAttribute('data-cfasync','false');
    s.onload = res; s.onerror = rej;
    document.head.appendChild(s);
  });

  function hexToNum(hex) {
    const s = String(hex || '').trim();
    const m = s.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
    if (m) { const r=+m[1], g=+m[2], b=+m[3]; return (r<<16) + (g<<8) + b; }
    let h = s.replace('#', '');
    if (h.length === 3) h = h.split('').map(x=>x+x).join('');
    if (!/^[0-9a-f]{6}$/i.test(h)) return 0x000000;
    return parseInt(h, 16);
  }
  function numToRgb(n){ return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 }; }
  function rgbToNum(r,g,b){ return ((r&255)<<16)|((g&255)<<8)|(b&255); }
  function lerp(a,b,t){ return Math.round(a + (b - a) * t); }
  function gradient(minHex, maxHex, t) {
    t = Math.max(0, Math.min(1, t || 0));
    const a = numToRgb(hexToNum(minHex));
    const b = numToRgb(hexToNum(maxHex));
    return rgbToNum(lerp(a.r,b.r,t), lerp(a.g,b.g,t), lerp(a.b,b.b,t));
  }

  function boot() {
    const root = am5.Root.new("countryMapCanvas");
    container.__am5root = root;
    if (typeof am5themes_Animated !== 'undefined') {
      root.setThemes([ am5themes_Animated.new(root) ]);
    }

    const chart = root.container.children.push(am5map.MapChart.new(root, {}));

    const polygonSeries = chart.series.push(
      am5map.MapPolygonSeries.new(root, {
        geoJSON: am5geodata_worldLow,
        exclude: ["AQ"],
        valueField: "value",
        calculateAggregates: true
      })
    );

    const maxVal = Math.max(...data.map(d => d.value), 1);
    const minVal = Math.min(...data.map(d => d.value), 0);
    const range  = Math.max(1, maxVal - minVal);

    const polyTpl = polygonSeries.mapPolygons.template;
    polyTpl.setAll({
      tooltipText: "{name}: [bold]{value}[/]",
      strokeOpacity: 0.7,
      stroke: am5.color(hexToNum(BASE_EDGE)),
      fillOpacity: 1,
      interactive: true,
      cursorOverStyle: "pointer"
    });

    // Hover turns country fill GREEN
    polyTpl.states.create("hover", {
      fill: am5.color(hexToNum(HOVER_FILL)),
      stroke: am5.color(hexToNum(HOVER_EDGE)),
      strokeWidth: 1.2
    });

    // Adapter: indigo ramp for normal state
    polyTpl.adapters.add("fill", (current, target) => {
      const v = target?.dataItem?.get("value");
      if (v == null || isNaN(v)) return am5.color(hexToNum(RAMP_MIN));
      const t = (v - minVal) / range;
      return am5.color(gradient(RAMP_MIN, RAMP_MAX, t));
    });

    if (data.length > 0) polygonSeries.data.setAll(data);

    polyTpl.events.on("pointerover", ev => ev.target.toFront());
    chart.set("wheelY", "zoom");
    chart.set("wheelX", "zoom");

    const ro = new ResizeObserver(() => root.resize());
    ro.observe(container);
    root.__ro = ro;
  }

  if (ready()) {
    boot();
  } else {
    Promise.resolve()
      .then(() => add('am5-core',     'https://cdn.amcharts.com/lib/5/index.js'))
      .then(() => add('am5-map',      'https://cdn.amcharts.com/lib/5/map.js'))
      .then(() => add('am5-worldlow', 'https://cdn.amcharts.com/lib/5/geodata/worldLow.js'))
      .then(() => add('am5-animated', 'https://cdn.amcharts.com/lib/5/themes/Animated.js'))
      .then(() => {
        let tries = 0;
        const t = setInterval(() => {
          if (ready() || tries++ > 40) {
            clearInterval(t);
            if (ready()) boot();
            else console.error('amCharts libs not ready.');
          }
        }, 100);
      })
      .catch(err => console.error('Map libs failed to load:', err));
  }
}


function updateCharts() {
    if (currentData.user) {
        setTimeout(() => {
            initializeCharts(currentData.user);
            if (globalMap) {
                globalMap.remove();
                initializeCountryMap(currentData.user);
            }
        }, 100);
    }
}

// Pagination
function generatePagination(type, loadFunction) {
    const pagination = paginationState[type];
    if (!pagination) return '';

    const totalPages = Math.max(1, Math.ceil(pagination.total / pagination.pageSize));
    const currentPage = pagination.page || 1;
    const hasMultiplePages = totalPages > 1;

    let paginationHTML = '<div class="pagination">';

    // Always show previous button (disabled if on first page)
    paginationHTML += `<button class="pagination-btn" ${currentPage <= 1 ? 'disabled' : ''} onclick="${loadFunction.name}(${currentPage - 1})">
        <i class="ri-arrow-left-s-line"></i> Previous
    </button>`;

    // Only show page numbers if there are multiple pages
    if (hasMultiplePages) {
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);

        if (startPage > 1) {
            paginationHTML += `<button class="pagination-btn" onclick="${loadFunction.name}(1)">1</button>`;
            if (startPage > 2) {
                paginationHTML += '<span class="pagination-info">...</span>';
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="${loadFunction.name}(${i})">${i}</button>`;
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                paginationHTML += '<span class="pagination-info">...</span>';
            }
            paginationHTML += `<button class="pagination-btn" onclick="${loadFunction.name}(${totalPages})">${totalPages}</button>`;
        }
    } else {
        // Single page - show page 1 as active
        paginationHTML += `<button class="pagination-btn active">1</button>`;
    }

    // Always show next button (disabled if on last page)
    paginationHTML += `<button class="pagination-btn" ${currentPage >= totalPages ? 'disabled' : ''} onclick="${loadFunction.name}(${currentPage + 1})">
        Next <i class="ri-arrow-right-s-line"></i>
    </button>`;

    // Info text
    const startItem = Math.max(1, ((currentPage - 1) * pagination.pageSize) + 1);
    const endItem = Math.min(currentPage * pagination.pageSize, pagination.total);

    paginationHTML += `<div class="pagination-info">
        ${pagination.total > 0 ? `Showing ${startItem} to ${endItem} of ${pagination.total} results` : 'No results'}
    </div>`;

    paginationHTML += '</div>';
    return paginationHTML;
}

// Toast Notifications
function showToast(message, type = 'info') {
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
        existingToast.remove();
    }

    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
    <i class="ri-${type === 'success' ? 'check' : type === 'error' ? 'close' : type === 'warning' ? 'alert' : 'information'}-circle-line"></i>
    <span>${message}</span>
    `;

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 4000);
}

// New Hosting Plan & Subscription Logic (Add this before Utility Functions)
const hostingConfig = {
    packages: {
        "basic": {
            name: "Basic",
            price: { "3month": 10, "6month": 18, "12month": 32 },
            limits: { articles: 200, images: 1000 },
            features: ['1,000 Images', '200 Articles', 'Email Support']
        },
        "professional": {
            name: "Professional",
            price: { "3month": 25, "6month": 45, "12month": 80 },
            limits: { articles: 600, images: 4000 },
            features: ['4,000 Images', '600 Articles', 'Priority Support']
        },
        "enterprise": {
            name: "Enterprise",
            price: { "3month": 50, "6month": 90, "12month": 160 },
            limits: { articles: 2000, images: 20000 },
            features: ['20,000 Images', '2,000 Articles', 'Dedicated Support']
        }
    }
};

let purchaseSelection = { plan: 'professional', duration: '3month' };

function selectPlan(planKey) {
    purchaseSelection.plan = planKey;
    document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('selected'));
    document.getElementById(`plan-${planKey}`)?.classList.add('selected');
    updatePriceDisplay();
}

function selectDuration(duration) {
    purchaseSelection.duration = duration;
    updatePriceDisplay();
}

function updatePriceDisplay() {
    if (!purchaseSelection.plan || !purchaseSelection.duration) return;
    const price = hostingConfig.packages[purchaseSelection.plan]?.price[purchaseSelection.duration];
    const priceDisplay = document.getElementById('price-display');
    if (priceDisplay) {
        priceDisplay.textContent = `$${price.toFixed(2)}`;
    }
}

async function purchasePlan() {
    if (!purchaseSelection.plan) {
        showToast("Please select a plan.", "error");
        return;
    }

    const payload = {
        package: purchaseSelection.plan,
        duration: purchaseSelection.duration,
        provider: document.getElementById('payment-provider').value,
        subscription: false,
        cancel_previous: true
    };

    try {
        const { data } = await api('/hosting/buy-package', {
            method: 'POST',
            body: JSON.stringify(payload)
        });
        showToast("Redirecting to payment...", "success");
        window.open(data.payment_url, '_blank');
    } catch (error) {
        console.error("Failed to initiate purchase", error);
        showToast('Failed to start purchase: ' + error.message, 'error');
    }
}

async function cancelSubscription() {
    if (confirm("Are you sure you want to cancel your subscription? Your plan will remain active until the end of the current billing period.")) {
        try {
            await api('/hosting/cancel-subscription');
            showToast('Subscription cancelled successfully.', 'success');
            loadBilling(); // Reload the billing page to show updated status
        } catch (error) {
            console.error('Failed to cancel subscription:', error);
            showToast('Failed to cancel subscription: ' + error.message, 'error');
        }
    }
}

// Utility Functions
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('Copied to clipboard', 'success');
    }).catch(() => {
        showToast('Failed to copy to clipboard', 'error');
    });
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function showSpinner() {
    document.getElementById('content').innerHTML = `
    <div style="display: flex; justify-content: center; align-items: center; height: 300px;">
    <div class="spinner"></div>
    </div>
    `;
}

function showErrorState(message) {
    document.getElementById('content').innerHTML = `
    <div class="empty-state">
    <div class="empty-state-icon">
    <i class="ri-error-warning-line"></i>
    </div>
    <div class="empty-state-title">Error Loading Data</div>
    <div class="empty-state-description">${message}</div>
    <button class="btn btn-primary" onclick="location.reload()">
    <i class="ri-refresh-line"></i> Retry
    </button>
    </div>
    `;
}

async function logout() {
    try {
        await api('/logout');
    } catch (error) {
        console.error('Logout error:', error);
    } finally {
        document.cookie = 'session_token=;path=/;expires=Thu, 01 Jan 1970 00:00:00 GMT';
        localStorage.removeItem('authToken');
        window.location.href = '/login.html';
    }
}

// Mobile responsiveness
window.addEventListener('resize', () => {
    const sidebarToggle = document.getElementById('sidebarToggle');
    if (window.innerWidth <= 768) {
        sidebarToggle.style.display = 'block';
    } else {
        sidebarToggle.style.display = 'none';
        document.getElementById('sidebar').classList.remove('active');
    }
});

// Initialize theme on page load
document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.body.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);
});
</script>
</body>
</html>
