<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard ‚Äì SEOTIZE</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #f5f7fa;
      --sidebar-bg: #ffffff;
      --card-bg: #ffffff;
      --text: #1f2937;
      --text-light: #4b5563;
      --border: #e5e7eb;
      --primary: #3b82f6;
      --primary-light: rgba(59, 130, 246, 0.1);
      --secondary: #10b981;
      --shadow: 0 4px 6px rgba(0,0,0,0.05);
      --radius: 0.5rem;
    }

    body.dark {
      --bg: #0f172a;
      --sidebar-bg: #1f2937;
      --card-bg: #1f2937;
      --text: #f9fafb;
      --text-light: #9ca3af;
      --border: #334155;
      --primary: #3b82f6;
      --primary-light: rgba(59, 130, 246, 0.15);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      height: 100vh;
      overflow: hidden;
      transition: background 0.3s, color 0.3s;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 2rem 1.5rem;
      transform: translateX(-100%);
    }
    .logo {
      font-size: 1.75rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 2rem;
      text-decoration: none;
      display: block;
    }
    .nav-links {
      list-style: none;
    }
    .nav-links a {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      border-radius: var(--radius);
      text-decoration: none;
      color: var(--text-light);
      font-weight: 500;
      transition: background 0.2s, transform 0.2s;
    }
    .nav-links a:hover {
      background: var(--primary-light);
      color: var(--primary);
      transform: translateX(4px);
    }
    .nav-links a.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
    }
    .sidebar-footer {
      margin-top: auto;
      border-top: 1px solid var(--border);
      padding-top: 1.5rem;
    }
    .user-profile {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      text-transform: uppercase;
    }
    .user-email {
      font-size: 0.875rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .btn {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: transparent;
      font-weight: 500;
      color: var(--text-light);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
    }
    .btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    /* Main Content */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 2rem;
      overflow: hidden;
    }
    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    .main-header h1 {
      font-size: 2rem;
      font-weight: 800;
    }
    .btn-primary {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px,1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .stat-card:hover {
      transform: translateY(-5px) scale(1.03);
      box-shadow: 0 10px 15px rgba(0,0,0,0.1);
    }
    .stat-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-light);
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 800;
    }
    .stat-desc {
      font-size: 0.875rem;
      color: var(--text-light);
    }

    /* Tasks Section */
    .tasks {
      flex: 1;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      margin-bottom: 2rem;
    }
    .tasks-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      font-size: 1.125rem;
      font-weight: 600;
    }
    .tasks-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }
    .task-item {
      display: grid;
      grid-template-columns: 3fr 1fr 1fr 1fr;
      align-items: center;
      padding: 1rem 1.5rem;
      border-radius: var(--radius);
      margin-bottom: 0.5rem;
      transition: background 0.2s;
    }
    .task-item:hover {
      background: var(--primary-light);
    }
    .task-url {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .task-stat {
      text-align: center;
      color: var(--text-light);
    }
    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--secondary), var(--primary));
      width: 0%;
      transition: width 1s ease-in-out;
    }

    /* Hosting & Billing Cards */
    .card-group {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .sub-card {
      flex: 1;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
    }
    .sub-card h3 {
      margin-bottom: 0.5rem;
      font-size: 1rem;
      color: var(--text-light);
    }
    .sub-card p,
    .sub-card small {
      font-weight: 600;
      margin: 0.25rem 0;
    }

    /* Usage Trends Charts */
    #usageTrends {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px,1fr));
      gap: 1.5rem;
    }
    canvas {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid var(--border);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateY(-100%);
        width: 100%;
        flex-direction: row;
        justify-content: space-between;
        padding: 1rem;
      }
      .nav-links, .sidebar-footer { display: none; }
      .main { padding: 1rem; }
      .stats-grid { grid-template-columns: 1fr 1fr; }
      .card-group { flex-direction: column; }
      .tasks { margin-bottom: 1.5rem; }
      .task-item { grid-template-columns: 1fr; text-align: center; gap: 0.5rem; }
      #usageTrends { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <a href="#" class="logo">SEOTIZE</a>
    <nav class="nav-links">
      <a href="#" class="active"><span>üè†</span> Dashboard</a>
      <a href="#"><span>üí≥</span> Billing</a>
      <a href="#"><span>üåê</span> Domains</a>
      <a href="#"><span>üìù</span> Articles</a>
      <a href="#"><span>‚öôÔ∏è</span> Settings</a>
    </nav>
    <div class="sidebar-footer">
      <div class="user-profile">
        <div class="user-avatar" id="userAvatar">A</div>
        <div class="user-email" id="userEmail">user@seotize.net</div>
      </div>
      <button class="btn" id="themeToggle"><span>üåô</span> Switch Theme</button>
      <button class="btn" id="logoutBtn"><span>üö™</span> Log Out</button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main">
    <!-- Header -->
    <div class="main-header">
      <h1 id="welcomeMessage">Welcome, User!</h1>
      <button class="btn-primary" id="addTaskBtn"><span>‚ûï</span> Add New Task</button>
    </div>

    <!-- Stats Cards -->
    <section class="stats-grid">
      <div class="stat-card">
        <div class="stat-header"><span>üëÄ</span>Total Views</div>
        <div class="stat-value" id="statTotalViews">0</div>
        <div class="stat-desc">Across all tasks</div>
      </div>
      <div class="stat-card">
        <div class="stat-header"><span>üîë</span>Total Keywords</div>
        <div class="stat-value" id="statTotalKeywords">0</div>
        <div class="stat-desc">Driving your traffic</div>
      </div>
      <div class="stat-card">
        <div class="stat-header"><span>‚ö°Ô∏è</span>Total Charge</div>
        <div class="stat-value" id="statTotalCharge">0</div>
        <div class="stat-desc">Total task value</div>
      </div>
      <div class="stat-card">
        <div class="stat-header"><span>üîã</span>Available Charge</div>
        <div class="stat-value" id="statAvailableCharge">0</div>
        <div class="stat-desc">Remaining credits</div>
      </div>
    </section>

    <!-- Active Tasks -->
    <section class="tasks">
      <div class="tasks-header">Your Active Tasks</div>
      <div class="tasks-list" id="tasksList">
        <p style="text-align:center; color:var(--text-light); padding:2rem;">
          No active tasks. Click ‚ÄúAdd New Task‚Äù to get started!
        </p>
      </div>
    </section>

    <!-- Hosting Usage -->
    <div class="card-group" id="hostingUsage">
      <div class="sub-card">
        <h3>Articles Uploaded</h3>
        <p id="hostArticles">‚Äî</p>
      </div>
      <div class="sub-card">
        <h3>Images Uploaded</h3>
        <p id="hostImages">‚Äî</p>
      </div>
      <div class="sub-card">
        <h3>Plan</h3>
        <p id="hostPlan">‚Äî</p>
        <small>Expires <span id="hostExpiry">‚Äî</span></small>
      </div>
    </div>

    <!-- Billing Summary -->
    <div class="card-group" id="billingSummary">
      <div class="sub-card">
        <h3>Current Plan</h3>
        <p id="billPlan">‚Äî</p>
      </div>
      <div class="sub-card">
        <h3>Next Invoice</h3>
        <p id="billNextDate">‚Äî</p>
        <p id="billNextAmount">‚Äî</p>
      </div>
      <div class="sub-card">
        <h3>Past Invoices</h3>
        <ul id="billHistory"><li>‚Äî</li></ul>
      </div>
    </div>

    <!-- Usage Trends Charts -->
    <section id="usageTrends">
      <div>
        <h3>Views Over Time</h3>
        <canvas id="viewsChart"></canvas>
      </div>
      <div>
        <h3>Tasks Created Over Time</h3>
        <canvas id="tasksChart"></canvas>
      </div>
    </section>
  </main>

  <script>
    const baseUrl = 'https://api.seotize.net';

    document.addEventListener('DOMContentLoaded', () => {
      const token = getCookie('session_token');
      if (!token) return window.location.href = 'login.html';

      loadTheme();
      setupListeners();

      // Fetch dashboard then animate
      fetchDashboard(token)
        .then(u => {
          populateDashboard(u);
          populateHosting(u.hosting);
        })
        .catch(e => console.error('Dashboard error', e))
        .finally(() => runAnimations());

      // Fetch billing summary
      fetchBilling(token)
        .then(b => populateBilling(b))
        .catch(e => console.error('Billing error', e));

      // Initialize empty charts
      initCharts([], []);
    });

    // Fetch /users/dashboard?page=1&page_size=10
    async function fetchDashboard(token) {
      const res = await fetch(`${baseUrl}/users/dashboard?page=1&page_size=10`, {
        headers: { 'Session-Token': token }
      });
      if (!res.ok) throw new Error(res.statusText);
      const { data } = await res.json();
      return data.user;
    }

    function populateDashboard(u) {
      const email = u.email;
      document.getElementById('userEmail').textContent = email;
      document.getElementById('userAvatar').textContent = email[0].toUpperCase();
      document.getElementById('welcomeMessage').textContent =
        `Welcome, ${email.split('@')[0]}!`;

      animateStat('statTotalViews', u.task_statistics.total_views);
      animateStat('statTotalKeywords', u.task_statistics.total_keywords);
      animateStat('statTotalCharge', u.task_statistics.total_charge);
      animateStat('statAvailableCharge', u.task_statistics.available_charge);

      const list = document.getElementById('tasksList');
      list.innerHTML = '';
      if (u.tasks.length) {
        u.tasks.forEach(t => {
          const div = document.createElement('div');
          div.className = 'task-item';
          div.innerHTML = `
            <div class="task-url">${t.url}</div>
            <div class="task-stat"><strong>${t.views_count}</strong> views</div>
            <div class="task-stat"><strong>${t.keywords_count}</strong> kw</div>
            <div class="task-stat">
              <div class="progress-bar">
                <div class="progress-fill" style="width:${t.remaining_percentage}%"></div>
              </div>
            </div>`;
          list.appendChild(div);
        });
      } else {
        list.innerHTML = `
          <p style="text-align:center; color:var(--text-light); padding:2rem;">
            No active tasks. Click ‚ÄúAdd New Task‚Äù to get started!
          </p>`;
      }
    }

    function populateHosting(h) {
      document.getElementById('hostArticles').textContent = h.article_uploads;
      document.getElementById('hostImages').textContent   = h.images_uploads;
      document.getElementById('hostPlan').textContent     = h.type;
      document.getElementById('hostExpiry').textContent   =
        new Date(h.expiry_date).toLocaleDateString();
    }

    // Fetch /dashboard/billings
    async function fetchBilling(token) {
      const res = await fetch(`${baseUrl}/dashboard/billings`, {
        headers: { 'Session-Token': token }
      });
      if (!res.ok) throw new Error(res.statusText);
      const { data } = await res.json();
      return data;
    }

    function populateBilling(b) {
      document.getElementById('billPlan').textContent       = b.current_plan;
      document.getElementById('billNextDate').textContent   =
        new Date(b.next_invoice.date).toLocaleDateString();
      document.getElementById('billNextAmount').textContent =
        `${b.next_invoice.amount} ${b.next_invoice.currency}`;
      document.getElementById('billHistory').innerHTML =
        b.history.map(inv =>
          `<li>${new Date(inv.date).toLocaleDateString()}: ${inv.amount} ${inv.currency}</li>`
        ).join('');
    }

    function initCharts(viewsData, tasksData) {
      new Chart(
        document.getElementById('viewsChart').getContext('2d'),
        {
          type: 'line',
          data: { labels: [], datasets: [{ label: 'Views', data: viewsData }] },
          options: { responsive: true }
        }
      );
      new Chart(
        document.getElementById('tasksChart').getContext('2d'),
        {
          type: 'bar',
          data: { labels: [], datasets: [{ label: 'Tasks', data: tasksData }] },
          options: { responsive: true }
        }
      );
    }

    function runAnimations() {
      const overlay = document.getElementById('loadingOverlay');
      gsap.timeline({ defaults: { ease: 'power3.out' } })
        .to('.sidebar', { x: '0%', duration: 0.8, delay: 0.2 })
        .from(
          '.main-header, .stat-card, .tasks-header',
          { opacity: 0, y: 30, duration: 0.6, stagger: 0.1 },
          '-=0.5'
        )
        .to(overlay, {
          opacity: 0,
          duration: 0.5,
          onComplete: () => (overlay.style.display = 'none')
        });
    }

    function animateStat(id, value) {
      gsap.to(`#${id}`, {
        duration: 1.5,
        textContent: value,
        roundProps: 'textContent',
        ease: 'power2.inOut'
      });
    }

    function setupListeners() {
      document.getElementById('themeToggle').onclick = toggleTheme;
      document.getElementById('logoutBtn').onclick   = logout;
      document.getElementById('addTaskBtn').onclick  = () =>
        alert('Open Add Task modal');
    }

    function toggleTheme() {
      document.body.classList.toggle('dark');
      localStorage.setItem(
        'theme',
        document.body.classList.contains('dark') ? 'dark' : 'light'
      );
    }

    function loadTheme() {
      if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark');
      }
    }

    function getCookie(name) {
      const v = `; ${document.cookie}`.split(`; ${name}=`);
      return v.length === 2 ? v.pop().split(';').shift() : '';
    }

    function logout() {
      const t = getCookie('session_token');
      if (t) fetch(`${baseUrl}/logout`, { headers: { 'Session-Token': t } });
      document.cookie =
        'session_token=;path=/;expires=Thu, 01 Jan 1970 00:00:00 GMT';
      window.location.href = 'login.html';
    }
  </script>
</body>
</html>
