<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEOTIZE Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<style>
:root{--radius:12px;--shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06)}
[data-theme="dark"]{--bg:#0f172a;--sidebar:#1e293b;--card:#1e293b;--text:#e2e8f0;--text-light:#94a3b8;--border:#334155;--primary:#3b82f6;--primary-hover:#2563eb;--secondary:#10b981;--error:#ef4444;--warning:#f59e0b;--success:#10b981;--input-bg:#0f172a}
[data-theme="light"]{--bg:#f8fafc;--sidebar:#ffffff;--card:#ffffff;--text:#1e293b;--text-light:#64748b;--border:#e2e8f0;--primary:#3b82f6;--primary-hover:#2563eb;--secondary:#10b981;--error:#ef4444;--warning:#f59e0b;--success:#10b981;--input-bg:#f1f5f9}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);display:flex;height:100vh;overflow:hidden;transition:all .3s}

/* Layout */
.sidebar{width:260px;background:var(--sidebar);padding:1.5rem;display:flex;flex-direction:column;border-right:1px solid var(--border);transition:transform .3s}
.main{flex:1;overflow-y:auto;padding:2rem}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem}

/* Components */
.logo{font-size:1.5rem;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:2rem}
.nav-item{display:flex;align-items:center;gap:.75rem;padding:.875rem 1rem;border-radius:var(--radius);color:var(--text-light);font-weight:500;transition:all .2s;margin-bottom:.5rem;cursor:pointer}
.nav-item:hover{background:rgba(59,130,246,0.1);color:var(--primary)}
.nav-item.active{background:var(--primary);color:white}
.nav-item.active:hover{background:var(--primary-hover)}

.theme-toggle{width:40px;height:40px;border-radius:var(--radius);background:var(--card);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s}
.theme-toggle:hover{border-color:var(--primary)}

.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:1.5rem}
.card-header{padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.card-body{padding:1.5rem}

.btn{padding:.5rem 1rem;border-radius:var(--radius);font-weight:500;cursor:pointer;transition:all .2s;border:1px solid var(--border);background:transparent;color:var(--text);display:inline-flex;align-items:center;gap:.5rem}
.btn:hover{border-color:var(--primary);color:var(--primary)}
.btn-primary{background:var(--primary);color:white;border:none}
.btn-primary:hover{background:var(--primary-hover)}
.btn-sm{padding:.375rem .75rem;font-size:.875rem}
.btn-icon{width:36px;height:36px;padding:0;justify-content:center}

.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1.5rem}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--primary),var(--secondary))}
.stat-value{font-size:1.75rem;font-weight:700;margin:.5rem 0}
.stat-label{font-size:.875rem;color:var(--text-light)}
.stat-change{font-size:.75rem;color:var(--success);margin-top:.25rem}

.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:.875rem;text-align:left;border-bottom:1px solid var(--border)}
.table th{background:var(--input-bg);font-weight:600;color:var(--text-light)}

.badge{padding:.25rem .75rem;border-radius:9999px;font-size:.75rem;font-weight:500}
.badge-primary{background:rgba(59,130,246,0.1);color:var(--primary)}
.badge-success{background:rgba(16,185,129,0.1);color:var(--success)}
.badge-warning{background:rgba(245,158,11,0.1);color:var(--warning)}
.badge-error{background:rgba(239,68,68,0.1);color:var(--error)}

.form-group{margin-bottom:1rem}
.form-label{display:block;margin-bottom:.5rem;font-weight:500}
.form-input,.form-select{width:100%;padding:.75rem;border:1px solid var(--border);border-radius:var(--radius);background:var(--input-bg);color:var(--text);transition:border-color .2s}
.form-input:focus,.form-select:focus{outline:none;border-color:var(--primary)}

.modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1000}
.modal.show{display:flex}
.modal-content{background:var(--card);border-radius:var(--radius);padding:2rem;max-width:600px;width:90%;max-height:90vh;overflow-y:auto}

.toast{position:fixed;top:1rem;right:1rem;padding:1rem 1.5rem;border-radius:var(--radius);color:white;transform:translateX(100%);transition:transform .3s;z-index:1001}
.toast.show{transform:translateX(0)}
.toast.success{background:var(--success)}
.toast.error{background:var(--error)}
.toast.warning{background:var(--warning)}

.section{display:none}
.section.active{display:block}

.empty-state{text-align:center;padding:3rem;color:var(--text-light)}

.loader{width:16px;height:16px;border:2px solid var(--primary);border-top:transparent;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

.image-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1rem}
.image-item{border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;position:relative}
.image-item img{width:100%;height:150px;object-fit:cover}
.image-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s}
.image-item:hover .image-overlay{opacity:1}

.article-item{border:1px solid var(--border);border-radius:var(--radius);padding:1rem;margin-bottom:1rem}
.article-meta{display:flex;gap:1rem;color:var(--text-light);font-size:.875rem;margin-top:.5rem}

.keyword-grid{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.5rem}
.keyword-item{padding:.5rem 1rem;background:var(--input-bg);border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;transition:all .2s}
.keyword-item:hover,.keyword-item.selected{background:var(--primary);color:white}

.location-preview{position:relative;height:400px;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.location-preview iframe{width:100%;height:100%;border:none}
.location-overlay{position:absolute;inset:0;z-index:1;cursor:crosshair}
.location-marker{position:absolute;width:12px;height:12px;background:var(--primary);border:2px solid white;border-radius:50%;transform:translate(-50%,-50%);z-index:2}

/* Responsive */
@media(max-width:768px){
.sidebar{position:fixed;transform:translateX(-100%);z-index:999}
.sidebar.show{transform:translateX(0)}
.main{padding:1rem}
.stat-grid{grid-template-columns:1fr}
}
</style>
</head>
<body data-theme="dark">
    <div class="sidebar">
        <div class="logo">SEOTIZE</div>
        <nav>
            <div class="nav-item active" data-section="dashboard">üìä Dashboard</div>
            <div class="nav-item" data-section="tasks">üéØ Tasks</div>
            <div class="nav-item" data-section="hosting">üåê Hosting</div>
            <div class="nav-item" data-section="images">üñºÔ∏è Images</div>
            <div class="nav-item" data-section="articles">üìù Articles</div>
            <div class="nav-item" data-section="domains">üîó Domains</div>
            <div class="nav-item" data-section="billing">üí≥ Billing</div>
            <div class="nav-item" data-section="tools">üîß SEO Tools</div>
        </nav>
        <div style="margin-top:auto">
            <div style="padding:1rem;border-top:1px solid var(--border)">
                <div id="userEmail" style="font-weight:600;margin-bottom:.5rem">Loading...</div>
                <div id="userSince" style="font-size:.875rem;color:var(--text-light)">Loading...</div>
                <button class="btn" style="width:100%;margin-top:1rem" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <div class="main">
        <div class="header">
            <div>
                <button class="btn btn-icon" onclick="toggleSidebar()" style="display:none;margin-right:1rem">‚ò∞</button>
                <h1 id="sectionTitle">Dashboard</h1>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()">üåì</button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="section active">
            <div id="dashboardStats" class="stat-grid"></div>
            <div class="card">
                <div class="card-header">
                    <h3>Recent Tasks</h3>
                    <button class="btn btn-primary" onclick="showTaskModal()">Create Task</button>
                </div>
                <div class="card-body">
                    <div id="recentTasks"></div>
                </div>
            </div>
        </div>

        <!-- Tasks Section -->
        <div id="tasks" class="section">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
                <h3>Task Management</h3>
                <button class="btn btn-primary" onclick="showTaskModal()">Create New Task</button>
            </div>
            <div id="tasksList"></div>
        </div>

        <!-- Hosting Section -->
        <div id="hosting" class="section">
            <div style="margin-bottom:1.5rem">
                <div class="nav-item hosting-nav-item active" onclick="showHostingContent('overview')">Overview</div>
            </div>
            <div id="hostingContent"></div>
        </div>

        <!-- Images Section -->
        <div id="images" class="section">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
                <h3>Image Management</h3>
                <button class="btn btn-primary" onclick="showImageUploadModal()">Upload Images</button>
            </div>
            <div id="imagesContent"></div>
        </div>

        <!-- Articles Section -->
        <div id="articles" class="section">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
                <h3>Article Management</h3>
                <button class="btn btn-primary" onclick="showArticleModal()">Create Article</button>
            </div>
            <div id="articlesContent"></div>
        </div>

        <!-- Domains Section -->
        <div id="domains" class="section">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
                <h3>Domain Management</h3>
                <button class="btn btn-primary" onclick="showDomainModal()">Add Domain</button>
            </div>
            <div id="domainsContent"></div>
        </div>

        <!-- Billing Section -->
        <div id="billing" class="section">
            <div id="billingStats" class="stat-grid"></div>
            <div class="card">
                <div class="card-header">
                    <h3>Transaction History</h3>
                    <select onchange="loadBilling(1,this.value)" class="btn">
                        <option value="all">All Transactions</option>
                        <option value="tasks">Tasks Only</option>
                        <option value="hosting">Hosting Only</option>
                    </select>
                </div>
                <div class="card-body">
                    <table class="table">
                        <thead>
                            <tr><th>Date</th><th>Type</th><th>Description</th><th>Amount</th><th>Status</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="billingTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SEO Tools Section -->
        <div id="tools" class="section">
            <div class="card">
                <div class="card-header"><h3>Keyword Analysis</h3></div>
                <div class="card-body">
                    <div class="form-group">
                        <input type="url" class="form-input" id="keywordUrl" placeholder="Enter website URL">
                        <button class="btn btn-primary" style="margin-top:.5rem" onclick="analyzeKeywords()">Analyze Keywords</button>
                    </div>
                    <div id="keywordResults"></div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><h3>SERP Position Checker</h3></div>
                <div class="card-body">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
                        <input type="text" class="form-input" id="serpKeyword" placeholder="Enter keyword">
                        <input type="url" class="form-input" id="serpUrl" placeholder="Enter website URL">
                    </div>
                    <button class="btn btn-primary" style="margin-top:1rem" onclick="checkSerpPosition()">Check Position</button>
                    <div id="serpResults"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
                <h3 id="modalTitle"></h3>
                <button class="btn btn-icon" onclick="closeModal()">√ó</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

<script>
const API_BASE = 'https://api.seotize.net';
let sessionToken = getCookie('session_token');
let currentData = {page:1,pageSize:10};

document.addEventListener('DOMContentLoaded', () => {
    if (!sessionToken) return window.location.href = '/login.html';
    setupNavigation();
    loadDashboard();
    gsap.from('.stat-card', {duration: 0.6, y: 20, opacity: 0, stagger: 0.1});
});

function setupNavigation() {
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => showSection(item.dataset.section));
    });
}

function showSection(section) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById(section).classList.add('active');
    document.querySelector(`[data-section="${section}"]`).classList.add('active');
    document.getElementById('sectionTitle').textContent = section.charAt(0).toUpperCase() + section.slice(1);
    gsap.from(`#${section}`, {duration: 0.5, opacity: 0, y: 20});
    
    const loaders = {
        dashboard: loadDashboard,
        tasks: loadTasks,
        hosting: loadHosting,
        images: loadImages,
        articles: loadArticles,
        domains: loadDomains,
        billing: () => loadBilling(1, 'all'),
        tools: () => {}
    };
    loaders[section]?.();
    
    if (window.innerWidth <= 768) document.querySelector('.sidebar').classList.remove('show');
}

function toggleTheme() {
    const theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
    document.body.dataset.theme = theme;
    localStorage.setItem('theme', theme);
}

function toggleSidebar() {
    document.querySelector('.sidebar').classList.toggle('show');
}

async function api(endpoint, options = {}) {
    try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
            ...options,
            headers: {
                'Session-Token': sessionToken,
                'Content-Type': 'application/json',
                ...(options.headers || {})
            }
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error?.message || data.message || 'API Error');
        return data;
    } catch (error) {
        showToast(error.message, 'error');
        throw error;
    }
}

// Dashboard
async function loadDashboard() {
    try {
        const { data } = await api(`/users/dashboard?page=1&page_size=10`);
        const user = data.user;
        
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('userSince').textContent = `Member since ${new Date(user.created_at).toLocaleDateString()}`;
        
        const stats = user.task_statistics;
        document.getElementById('dashboardStats').innerHTML = `
            <div class="stat-card">
                <div class="stat-label">Total Views</div>
                <div class="stat-value">${stats.total_views}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Keywords</div>
                <div class="stat-value">${stats.total_keywords}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Charge</div>
                <div class="stat-value">$${stats.total_charge.toFixed(2)}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Available Charge</div>
                <div class="stat-value">$${stats.available_charge.toFixed(2)}</div>
            </div>
        `;
        
        document.getElementById('recentTasks').innerHTML = user.tasks.length ? 
            user.tasks.slice(0, 5).map(task => `
                <div class="article-item">
                    <div style="display:flex;justify-content:space-between">
                        <div>
                            <strong>${task.url}</strong>
                            <div class="article-meta">
                                <span>Keywords: ${task.keywords_count}</span>
                                <span>Views: ${task.views_count}</span>
                                <span>Created: ${new Date(task.date_created).toLocaleDateString()}</span>
                            </div>
                        </div>
                        <div style="text-align:right">
                            <div class="stat-value" style="font-size:1rem">$${task.total_charge}</div>
                            <div style="color:var(--success)">${task.remaining_percentage}% remaining</div>
                        </div>
                    </div>
                    <div style="margin-top:1rem">
                        <button class="btn btn-sm" onclick="viewTaskDetails('${task._id}')">View Details</button>
                        <button class="btn btn-sm btn-primary" onclick="rechargeTask('${task._id}')">Recharge</button>
                    </div>
                </div>
            `).join('') : '<div class="empty-state">No tasks created yet</div>';
    } catch (error) {
        console.error('Dashboard error:', error);
    }
}

// Tasks
async function loadTasks() {
    try {
        const { data } = await api(`/users/dashboard?page=${currentData.page}&page_size=${currentData.pageSize}`);
        currentData.tasks = data.user.tasks;
        
        document.getElementById('tasksList').innerHTML = data.user.tasks.length ?
            data.user.tasks.map(task => `
                <div class="card">
                    <div class="card-body">
                        <div style="display:flex;justify-content:space-between">
                            <div>
                                <h4>${task.url}</h4>
                                <div class="article-meta">
                                    <span>Keywords: ${task.keywords_count}</span>
                                    <span>Views: ${task.views_count}</span>
                                    <span>Priority: ${task.task_priority}</span>
                                </div>
                            </div>
                            <div style="text-align:right">
                                <div class="stat-value">$${task.total_charge}</div>
                                <div class="stat-value" style="font-size:1rem;color:var(--success)">$${task.available_charge} left</div>
                            </div>
                        </div>
                        <div style="margin-top:1rem">
                            <button class="btn btn-sm" onclick="viewTaskDetails('${task._id}')">View Details</button>
                            <button class="btn btn-sm btn-primary" onclick="rechargeTask('${task._id}')">Recharge</button>
                        </div>
                    </div>
                </div>
            `).join('') : '<div class="empty-state">No tasks found</div>';
    } catch (error) {
        console.error('Tasks error:', error);
    }
}

async function viewTaskDetails(taskId) {
    try {
        const { data } = await api('/get-task-details', {
            method: 'POST',
            body: JSON.stringify({ task_id: taskId })
        });
        
        showModal('Task Details', `
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Views</div>
                    <div class="stat-value">${Object.values(data.country_visits).reduce((a,b) => a+b, 0)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Available Charge</div>
                    <div class="stat-value">$${data.available_charge}</div>
                </div>
            </div>
            <div style="margin-top:1rem">
                <h4>Keywords</h4>
                <div class="keyword-grid">${data.keywords.map(k => `<span class="badge badge-primary">${k}</span>`).join('')}</div>
            </div>
            <div style="margin-top:1rem">
                <h4>Country Visits</h4>
                ${Object.entries(data.country_visits).map(([country, count]) => 
                    `<div style="display:flex;justify-content:space-between;padding:.5rem 0"><span>${country}</span><span>${count}</span></div>`
                ).join('')}
            </div>
        `);
    } catch (error) {
        console.error('Task details error:', error);
    }
}

async function showTaskModal() {
    showModal('Create New SEO Task', `
        <div id="taskStep1">
            <div class="form-group">
                <label class="form-label">Website URL</label>
                <input type="url" class="form-input" id="taskUrl" placeholder="https://example.com" required>
            </div>
            <div class="form-group">
                <label class="form-label">Keywords (comma separated)</label>
                <input type="text" class="form-input" id="taskKeywords" placeholder="SEO, optimization, marketing">
                <button class="btn btn-sm" style="margin-top:.5rem" onclick="suggestKeywords()">ü§ñ AI Suggest</button>
                <div class="keyword-grid" id="keywordSuggestions"></div>
            </div>
            <div class="form-group">
                <label class="form-label">HTML Locations (XPath)</label>
                <textarea class="form-input" id="taskLocations" placeholder="/html/body/div[1]/a[1]&#10;/html/body/nav/a[2]" rows="3"></textarea>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select class="form-select" id="taskPriority">
                        <option value="basic">Basic ($0.10/click)</option>
                        <option value="standard" selected>Standard ($0.12/click)</option>
                        <option value="premium">Premium ($0.15/click)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Budget ($)</label>
                    <input type="number" class="form-input" id="taskBudget" min="10" value="150">
                </div>
            </div>
            <button class="btn btn-primary" style="width:100%;margin-top:1rem" onclick="createTask()">Create Task & Pay</button>
        </div>
    `);
    currentData.selectedKeywords = [];
}

async function suggestKeywords() {
    const url = document.getElementById('taskUrl').value;
    const btn = event.target;
    if (!url) return showToast('Enter URL first', 'error');
    
    btn.disabled = true;
    btn.innerHTML = '<span class="loader"></span> Loading...';
    
    try {
        const response = await fetch(`https://keywords.seotize.net?url=${encodeURIComponent(url)}`, {
            headers: { 'Session-Token': sessionToken }
        });
        const data = await response.json();
        
        document.getElementById('keywordSuggestions').innerHTML = data.keywords.map(keyword => 
            `<div class="keyword-item" onclick="toggleKeyword('${keyword}')">${keyword}</div>`
        ).join('');
        gsap.from('.keyword-item', {duration: 0.3, y: 10, opacity: 0, stagger: 0.05});
    } catch (error) {
        showToast('Failed to get suggestions', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'ü§ñ AI Suggest';
    }
}

function toggleKeyword(keyword) {
    const element = event.target;
    const idx = currentData.selectedKeywords.indexOf(keyword);
    
    if (idx === -1) {
        currentData.selectedKeywords.push(keyword);
        element.classList.add('selected');
    } else {
        currentData.selectedKeywords.splice(idx, 1);
        element.classList.remove('selected');
    }
    
    document.getElementById('taskKeywords').value = currentData.selectedKeywords.join(', ');
}

async function createTask() {
    const url = document.getElementById('taskUrl').value;
    const keywords = document.getElementById('taskKeywords').value.split(',').map(k => k.trim()).filter(k => k);
    const locations = document.getElementById('taskLocations').value.split('\n').filter(l => l.trim());
    const priority = document.getElementById('taskPriority').value;
    const budget = parseInt(document.getElementById('taskBudget').value);
    
    if (!url || !keywords.length || !locations.length) {
        return showToast('Please fill all fields', 'error');
    }
    
    try {
        const { data } = await api('/add-task', {
            method: 'POST',
            body: JSON.stringify({
                task_details: {
                    url: url,
                    keywords: keywords,
                    html_locations: locations
                },
                task_priority: priority,
                total_charge: budget,
                provider: 'stripe',
                is_subscription: false,
                cancel_previous: false
            })
        });
        
        window.open(data.payment_url, '_blank');
        closeModal();
        showToast('Redirecting to payment...', 'success');
        setTimeout(loadTasks, 2000);
    } catch (error) {
        console.error('Create task error:', error);
    }
}

async function rechargeTask(taskId) {
    const amount = prompt('Enter recharge amount ($):');
    if (!amount || isNaN(amount)) return;
    
    try {
        const { data } = await api('/recharge', {
            method: 'POST',
            body: JSON.stringify({
                task_ids: [taskId],
                payment_method: 'stripe',
                cancel_previous: false
            })
        });
        
        window.open(data.payment_url, '_blank');
        showToast('Redirecting to payment...', 'success');
    } catch (error) {
        console.error('Recharge error:', error);
    }
}

// Hosting
async function loadHosting() {
    try {
        const { data } = await api('/hosting/subscription-status');
        
        document.getElementById('hostingContent').innerHTML = `
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-label">Current Plan</div>
                    <div class="stat-value">${data.current_plan.toUpperCase()}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Images Used</div>
                    <div class="stat-value">${data.images_uploads}/${data.images_limit || 'Unlimited'}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Articles Used</div>
                    <div class="stat-value">${data.article_uploads}/${data.articles_limit || 'Unlimited'}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Expires</div>
                    <div class="stat-value">${data.expiry_date ? new Date(data.expiry_date).toLocaleDateString() : 'Never'}</div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3>Upgrade Plan</h3>
                    <button class="btn btn-primary" onclick="showUpgradeModal()">Upgrade</button>
                </div>
                <div class="card-body">
                    ${data.is_subscription ? `
                        <p>Current subscription: <strong>${data.subscription_status}</strong></p>
                        <button class="btn" onclick="cancelSubscription()">Cancel Subscription</button>
                    ` : '<p>No active subscription. Upgrade to get more features.</p>'}
                </div>
            </div>
        `;
    } catch (error) {
        console.error('Hosting error:', error);
    }
}

async function showUpgradeModal() {
    showModal('Upgrade Hosting Plan', `
        <div style="display:grid;gap:1rem">
            <div class="card" style="cursor:pointer;padding:1.5rem" onclick="buyPackage('basic','3month',9.99)">
                <h4>Basic Plan</h4>
                <div class="stat-value">$9.99/3mo</div>
                <p style="color:var(--text-light)">100 images, 50 articles</p>
            </div>
            <div class="card" style="cursor:pointer;border:2px solid var(--primary);padding:1.5rem" onclick="buyPackage('pro','3month',19.99)">
                <h4>Pro Plan</h4>
                <div class="stat-value">$19.99/3mo</div>
                <p style="color:var(--text-light)">500 images, 200 articles</p>
            </div>
            <div class="card" style="cursor:pointer;padding:1.5rem" onclick="buyPackage('enterprise','3month',49.99)">
                <h4>Enterprise Plan</h4>
                <div class="stat-value">$49.99/3mo</div>
                <p style="color:var(--text-light)">Unlimited everything</p>
            </div>
        </div>
    `);
}

async function buyPackage(pkg, duration, price) {
    try {
        const { data } = await api('/hosting/buy-package', {
            method: 'POST',
            body: JSON.stringify({
                package: pkg,
                provider: 'stripe',
                duration: duration,
                subscription: true,
                cancel_previous: false,
                cancel_current_plan: false
            })
        });
        
        window.open(data.payment_url, '_blank');
        closeModal();
        showToast('Redirecting to payment...', 'success');
    } catch (error) {
        console.error('Buy package error:', error);
    }
}

async function cancelSubscription() {
    if (!confirm('Are you sure you want to cancel your subscription?')) return;
    
    try {
        await api('/hosting/cancel-subscription');
        showToast('Subscription cancelled successfully', 'success');
        loadHosting();
    } catch (error) {
        console.error('Cancel subscription error:', error);
    }
}

// Images
async function loadImages() {
    try {
        const { data } = await api(`/images/dashboard?page=${currentData.page}&page_size=${currentData.pageSize}`);
        
        document.getElementById('imagesContent').innerHTML = `
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-label">Plan</div>
                    <div class="stat-value">${data.user.plan.toUpperCase()}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Uploaded</div>
                    <div class="stat-value">${data.user.uploaded}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Remaining</div>
                    <div class="stat-value">${data.user.remaining}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Expires</div>
                    <div class="stat-value">${new Date(data.user.expiry_date).toLocaleDateString()}</div>
                </div>
            </div>
            
            <div class="image-grid">
                ${data.images.map(img => `
                    <div class="image-item">
                        <img src="${img.cdn_url}" alt="${img.original_filename}">
                        <div class="image-overlay">
                            <button class="btn btn-sm" onclick="copyToClipboard('${img.cdn_url}')">Copy URL</button>
                            <button class="btn btn-sm" onclick="deleteImage('${img.image_id}')">Delete</button>
                        </div>
                        <div style="padding:.5rem">
                            <div style="font-size:.875rem;font-weight:500">${img.original_filename}</div>
                            <div style="font-size:.75rem;color:var(--text-light)">${img.total_views} views</div>
                        </div>
                    </div>
                `).join('')}
            </div>
        ` + (data.images.length === 0 ? '<div class="empty-state">No images uploaded yet</div>' : '');
    } catch (error) {
        console.error('Images error:', error);
    }
}

async function showImageUploadModal() {
    showModal('Upload Images', `
        <div class="form-group">
            <label class="form-label">Select Images (max 10 files, 5MB each)</label>
            <input type="file" id="imageFiles" multiple accept="image/*" class="form-input">
        </div>
        <button class="btn btn-primary" onclick="uploadImages()">Upload Images</button>
    `);
}

async function uploadImages() {
    const files = document.getElementById('imageFiles').files;
    if (!files.length) return showToast('Please select files', 'error');
    
    const formData = new FormData();
    Array.from(files).forEach(file => formData.append('file', file));
    
    try {
        const response = await fetch(`${API_BASE}/images/upload`, {
            method: 'POST',
            headers: { 'Session-Token': sessionToken },
            body: formData
        });
        const data = await response.json();
        
        if (!response.ok) throw new Error(data.error?.message || 'Upload failed');
        
        showToast(`${data.data.uploaded_images.length} images uploaded successfully`, 'success');
        closeModal();
        loadImages();
    } catch (error) {
        console.error('Upload error:', error);
    }
}

async function deleteImage(imageId) {
    if (!confirm('Delete this image?')) return;
    
    try {
        await api('/images', {
            method: 'DELETE',
            body: JSON.stringify({ image_ids: [imageId] })
        });
        showToast('Image deleted successfully', 'success');
        loadImages();
    } catch (error) {
        console.error('Delete image error:', error);
    }
}

// Articles
async function loadArticles() {
    try {
        const { data } = await api(`/dashboard/articles?page=${currentData.page}&page_size=${currentData.pageSize}`);
        
        document.getElementById('articlesContent').innerHTML = `
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-label">Plan</div>
                    <div class="stat-value">${data.user.plan.toUpperCase()}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Published</div>
                    <div class="stat-value">${data.user.uploaded}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Remaining</div>
                    <div class="stat-value">${data.user.remaining}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Domains</div>
                    <div class="stat-value">${data.user.total_domains}</div>
                </div>
            </div>
            
            ${data.articles.map(article => `
                <div class="article-item">
                    <h4>${article.subject}</h4>
                    <div class="article-meta">
                        <span>${article.url}</span>
                        <span>${article.total_views} views</span>
                        <span>${new Date(article.creation_date).toLocaleDateString()}</span>
                    </div>
                    <div style="margin-top:1rem">
                        <button class="btn btn-sm" onclick="editArticle('${article.article_id}')">Edit</button>
                        <button class="btn btn-sm" onclick="deleteArticle('${article.article_id}')">Delete</button>
                    </div>
                </div>
            `).join('')}
        ` + (data.articles.length === 0 ? '<div class="empty-state">No articles published yet</div>' : '');
    } catch (error) {
        console.error('Articles error:', error);
    }
}

async function showArticleModal() {
    showModal('Create Article', `
        <div class="form-group">
            <label class="form-label">Domain URL</label>
            <input type="url" class="form-input" id="articleUrl" placeholder="example.com/blog">
        </div>
        <div class="form-group">
            <label class="form-label">Article Title</label>
            <input type="text" class="form-input" id="articleSubject" placeholder="Enter article title">
        </div>
        <div class="form-group">
            <label class="form-label">Article Content (HTML)</label>
            <textarea class="form-input" id="articleBody" rows="8" placeholder="<p>Your article content...</p>"></textarea>
        </div>
        <div class="form-group">
            <label class="form-label">Images</label>
            <input type="file" id="articleImages" multiple accept="image/*" class="form-input">
        </div>
        <button class="btn btn-primary" onclick="createArticle()">Create Article</button>
    `);
}

async function createArticle() {
    const url = document.getElementById('articleUrl').value;
    const subject = document.getElementById('articleSubject').value;
    const body = document.getElementById('articleBody').value;
    const files = document.getElementById('articleImages').files;
    
    if (!url || !subject || !body || !files.length) {
        return showToast('Please fill all fields and select images', 'error');
    }
    
    const formData = new FormData();
    formData.append('url', url);
    formData.append('subject', subject);
    formData.append('body', body);
    Array.from(files).forEach(file => formData.append('image_data', file));
    
    try {
        const response = await fetch(`${API_BASE}/add-article`, {
            method: 'POST',
            headers: { 'Session-Token': sessionToken },
            body: formData
        });
        const data = await response.json();
        
        if (!response.ok) throw new Error(data.error?.message || 'Creation failed');
        
        showToast('Article created successfully', 'success');
        closeModal();
        loadArticles();
    } catch (error) {
        console.error('Create article error:', error);
    }
}

async function deleteArticle(articleId) {
    if (!confirm('Delete this article?')) return;
    
    try {
        await api(`/delete-article/${articleId}`, { method: 'DELETE' });
        showToast('Article deleted successfully', 'success');
        loadArticles();
    } catch (error) {
        console.error('Delete article error:', error);
    }
}

// Domains
async function loadDomains() {
    document.getElementById('domainsContent').innerHTML = `
        <div class="empty-state">
            <p>Domain management coming soon. Use the Add Domain feature to get started.</p>
        </div>
    `;
}

async function showDomainModal() {
    showModal('Add Domain', `
        <div class="form-group">
            <label class="form-label">Domain URL</label>
            <input type="url" class="form-input" id="domainUrl" placeholder="example.com/blog">
        </div>
        <button class="btn btn-primary" onclick="addDomain()">Add Domain</button>
        <div id="domainResult"></div>
    `);
}

async function addDomain() {
    const url = document.getElementById('domainUrl').value;
    if (!url) return showToast('Please enter a domain URL', 'error');
    
    try {
        const { data } = await api('/add-domain', {
            method: 'POST',
            body: JSON.stringify({ url: url })
        });
        
        document.getElementById('domainResult').innerHTML = `
            <div class="card" style="margin-top:1rem">
                <div class="card-body">
                    <h4>Domain Verification</h4>
                    <p>${data.message}</p>
                    ${data.txt_record ? `
                        <div style="margin-top:1rem">
                            <strong>Add this TXT record:</strong>
                            <code style="display:block;padding:.5rem;background:var(--input-bg);border-radius:var(--radius);margin-top:.5rem">${data.txt_record}</code>
                        </div>
                        <button class="btn btn-primary" style="margin-top:1rem" onclick="verifyDomain('${url}')">Verify Domain</button>
                    ` : ''}
                </div>
            </div>
        `;
    } catch (error) {
        console.error('Add domain error:', error);
    }
}

async function verifyDomain(url) {
    try {
        await api('/verify-domain', {
            method: 'POST',
            body: JSON.stringify({ url: url })
        });
        showToast('Domain verified successfully', 'success');
        closeModal();
    } catch (error) {
        console.error('Verify domain error:', error);
    }
}

// Billing
async function loadBilling(page = 1, type = 'all') {
    try {
        const { data } = await api(`/dashboard/billings?page=${page}&limit=50&type=${type}`);
        const allPayments = [...(data.tasks || []), ...(data.hosting || [])];
        
        const totalTransactions = allPayments.length;
        const paidCount = allPayments.filter(p => p.status === 'Paid').length;
        const totalAmount = allPayments.reduce((sum, p) => sum + (p.total_payment || 0), 0);
        
        document.getElementById('billingStats').innerHTML = `
            <div class="stat-card">
                <div class="stat-label">Total Transactions</div>
                <div class="stat-value">${totalTransactions}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Completed</div>
                <div class="stat-value">${paidCount}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Amount</div>
                <div class="stat-value">$${totalAmount.toFixed(2)}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Success Rate</div>
                <div class="stat-value">${totalTransactions ? Math.round((paidCount / totalTransactions) * 100) : 0}%</div>
            </div>
        `;
        
        document.getElementById('billingTable').innerHTML = allPayments.length ?
            allPayments.map(payment => `
                <tr>
                    <td>${new Date(payment.dates?.created).toLocaleDateString()}</td>
                    <td><span class="badge badge-${payment.method === 'create_task' ? 'primary' : payment.method === 'recharge' ? 'warning' : 'success'}">${payment.method}</span></td>
                    <td>${payment.details?.url || payment.details?.package || payment.method}</td>
                    <td>$${(payment.total_payment || 0).toFixed(2)}</td>
                    <td><span class="badge badge-${payment.status === 'Paid' ? 'success' : payment.status === 'cancelled' ? 'error' : 'warning'}">${payment.status}</span></td>
                    <td><button class="btn btn-sm" onclick="viewPayment('${payment.billing_id}')">View</button></td>
                </tr>
            `).join('') : '<tr><td colspan="6" style="text-align:center">No transactions found</td></tr>';
    } catch (error) {
        console.error('Billing error:', error);
    }
}

async function viewPayment(paymentId) {
    try {
        const { data } = await api(`/get-payment-status?payment_id=${paymentId}`);
        
        showModal('Payment Details', `
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-label">Amount</div>
                    <div class="stat-value">$${data.amount}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Status</div>
                    <div class="stat-value"><span class="badge badge-${data.status === 'Paid' ? 'success' : 'warning'}">${data.status}</span></div>
                </div>
            </div>
            <div style="margin-top:1rem">
                <div><strong>Type:</strong> ${data.type}</div>
                <div><strong>Date:</strong> ${new Date(data.date_of_payment).toLocaleString()}</div>
                <div><strong>Provider:</strong> ${data.payment_method}</div>
                <div><strong>Transaction ID:</strong> ${data.transaction_id}</div>
                ${data.task_id ? `<div><strong>Task ID:</strong> ${data.task_id}</div>` : ''}
            </div>
        `);
    } catch (error) {
        console.error('Payment details error:', error);
    }
}

// SEO Tools
async function analyzeKeywords() {
    const url = document.getElementById('keywordUrl').value;
    if (!url) return showToast('Please enter a URL', 'error');
    
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="loader"></span> Analyzing...';
    
    try {
        const response = await fetch(`https://keywords.seotize.net?url=${encodeURIComponent(url)}`, {
            headers: { 'Session-Token': sessionToken }
        });
        const data = await response.json();
        
        document.getElementById('keywordResults').innerHTML = `
            <div class="card" style="margin-top:1rem">
                <div class="card-body">
                    <h4>Analysis Results</h4>
                    <div class="keyword-grid">
                        ${data.keywords.map(kw => `<span class="badge badge-primary">${kw}</span>`).join('')}
                    </div>
                    ${data.density ? `
                        <div style="margin-top:1rem">
                            <h5>Keyword Density</h5>
                            ${Object.entries(data.density).map(([k,v]) => 
                                `<div style="display:flex;justify-content:space-between"><span>${k}</span><span>${v}%</span></div>`
                            ).join('')}
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    } catch (error) {
        showToast('Failed to analyze keywords', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'Analyze Keywords';
    }
}

async function checkSerpPosition() {
    const keyword = document.getElementById('serpKeyword').value;
    const url = document.getElementById('serpUrl').value;
    
    if (!keyword || !url) return showToast('Please enter both fields', 'error');
    
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="loader"></span> Checking...';
    
    try {
        const response = await fetch(`https://search.seotize.workers.dev/?keyword=${encodeURIComponent(keyword)}&url=${encodeURIComponent(url)}`, {
            headers: { 'Session-Token': sessionToken }
        });
        const data = await response.json();
        
        document.getElementById('serpResults').innerHTML = `
            <div class="card" style="margin-top:1rem">
                <div class="card-body">
                    <h4>SERP Results for "${keyword}"</h4>
                    <div class="stat-grid">
                        <div class="stat-card">
                            <div class="stat-label">Position</div>
                            <div class="stat-value">${data.position || 'Not Found'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Page</div>
                            <div class="stat-value">${data.page || 'N/A'}</div>
                        </div>
                    </div>
                    ${data.competitors ? `
                        <div style="margin-top:1rem">
                            <h5>Top Competitors</h5>
                            ${data.competitors.slice(0, 5).map(comp => 
                                `<div style="display:flex;justify-content:space-between;padding:.25rem 0">
                                    <span>${comp.url}</span><span>#${comp.position}</span>
                                </div>`
                            ).join('')}
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    } catch (error) {
        showToast('Failed to check position', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'Check Position';
    }
}

// Utilities
function showModal(title, content) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = content;
    document.getElementById('modal').classList.add('show');
    gsap.from('.modal-content', {duration: 0.3, scale: 0.9, opacity: 0, ease: "back.out(1.7)"});
}

function closeModal() {
    document.getElementById('modal').classList.remove('show');
}

function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast ${type} show`;
    setTimeout(() => toast.classList.remove('show'), 3000);
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => showToast('Copied to clipboard', 'success'));
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    return parts.length === 2 ? parts.pop().split(';').shift() : '';
}

async function logout() {
    try {
        await api('/logout');
    } finally {
        document.cookie = 'session_token=;path=/;expires=Thu, 01 Jan 1970 00:00:00 GMT';
        window.location.href = '/login.html';
    }
}

// Load theme
document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.body.dataset.theme = savedTheme;
});

// Modal events
document.getElementById('modal').addEventListener('click', e => {
    if (e.target === e.currentTarget) closeModal();
});
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeModal();
});

// Responsive
if (window.innerWidth <= 768) {
    document.querySelector('.btn-icon').style.display = 'block';
}
</script>
</body>
</html>
