<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEOTIZE Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Geo chart plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-geo@4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<style>
:root{--radius:12px;--shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06)}
[data-theme="dark"]{--bg:#0f172a;--sidebar:#1e293b;--card:#1e293b;--text:#e2e8f0;--text-light:#94a3b8;--border:#334155;--primary:#3b82f6;--primary-hover:#2563eb;--secondary:#10b981;--error:#ef4444;--warning:#f59e0b;--success:#10b981;--input-bg:#0f172a}
[data-theme="light"]{--bg:#f8fafc;--sidebar:#ffffff;--card:#ffffff;--text:#1e293b;--text-light:#64748b;--border:#e2e8f0;--primary:#3b82f6;--primary-hover:#2563eb;--secondary:#10b981;--error:#ef4444;--warning:#f59e0b;--success:#10b981;--input-bg:#f1f5f9}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);display:flex;height:100vh;overflow:hidden;transition:all .3s}

/* Layout */
.sidebar{width:260px;background:var(--sidebar);padding:1.5rem;display:flex;flex-direction:column;border-right:1px solid var(--border);transition:transform .3s}
.main{flex:1;overflow-y:auto;padding:2rem}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem}

/* Components */
.logo{font-size:1.5rem;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:2rem}
.nav-item{display:flex;align-items:center;gap:.75rem;padding:.875rem 1rem;border-radius:var(--radius);color:var(--text-light);font-weight:500;transition:all .2s;margin-bottom:.5rem;cursor:pointer}
.nav-item:hover{background:rgba(59,130,246,0.1);color:var(--primary)}
.nav-item.active{background:var(--primary);color:white}
.nav-item.active:hover{background:var(--primary-hover)}

.theme-toggle{width:40px;height:40px;border-radius:var(--radius);background:var(--card);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s}
.theme-toggle:hover{border-color:var(--primary)}

.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:1.5rem}
.card-header{padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.card-body{padding:1.5rem}

.btn{padding:.5rem 1rem;border-radius:var(--radius);font-weight:500;cursor:pointer;transition:all .2s;border:1px solid var(--border);background:transparent;color:var(--text);display:inline-flex;align-items:center;gap:.5rem}
.btn:hover{border-color:var(--primary);color:var(--primary)}
.btn-primary{background:var(--primary);color:white;border:none}
.btn-primary:hover{background:var(--primary-hover)}
.btn-sm{padding:.375rem .75rem;font-size:.875rem}
.btn-icon{width:36px;height:36px;padding:0;justify-content:center}

.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1.5rem}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--primary),var(--secondary))}
.stat-value{font-size:1.75rem;font-weight:700;margin:.5rem 0}
.stat-label{font-size:.875rem;color:var(--text-light)}
.stat-change{font-size:.75rem;color:var(--success);margin-top:.25rem}

.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:.875rem;text-align:left;border-bottom:1px solid var(--border)}
.table th{font-weight:600;color:var(--text-light);font-size:.875rem}
.table tr:hover{background:rgba(59,130,246,0.05)}

.badge{padding:.25rem .75rem;border-radius:20px;font-size:.75rem;font-weight:600;display:inline-flex;align-items:center;gap:.25rem}
.badge-primary{background:rgba(59,130,246,0.2);color:var(--primary)}
.badge-success{background:rgba(16,185,129,0.2);color:var(--success)}
.badge-warning{background:rgba(245,158,11,0.2);color:var(--warning)}
.badge-error{background:rgba(239,68,68,0.2);color:var(--error)}

.modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1000}
.modal.show{display:flex}
.modal-content{background:var(--card);border-radius:var(--radius);max-width:90%;width:600px;max-height:90vh;overflow-y:auto}
.modal-header{padding:1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.modal-body{padding:1.5rem}

.form-group{margin-bottom:1.25rem}
.form-label{display:block;margin-bottom:.5rem;font-weight:500;font-size:.875rem}
.form-input,.form-select,.form-textarea{width:100%;padding:.75rem;border:1px solid var(--border);border-radius:var(--radius);background:var(--input-bg);color:var(--text);transition:all .2s}
.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
.form-textarea{resize:vertical;min-height:100px}

.toast{position:fixed;bottom:2rem;right:2rem;padding:1rem 1.5rem;border-radius:var(--radius);color:white;font-weight:500;transform:translateX(400px);transition:transform .3s;z-index:1000}
.toast.show{transform:translateX(0)}
.toast.success{background:var(--success)}
.toast.error{background:var(--error)}
.toast.warning{background:var(--warning)}

.section{display:none}
.section.active{display:block}

.loader{display:inline-block;width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

.empty-state{text-align:center;padding:3rem;color:var(--text-light)}

.task-item{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem;margin-bottom:1rem;cursor:pointer;transition:all .2s}
.task-item:hover{border-color:var(--primary);transform:translateY(-2px);box-shadow:var(--shadow)}

.analytics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1.5rem;margin-bottom:1.5rem}
.chart-container{height:300px;position:relative}

.compact-sessions{max-height:200px;overflow-y:auto}
.compact-sessions .table{font-size:.875rem}
.compact-sessions .table th,.compact-sessions .table td{padding:.5rem .875rem}

.hosting-menu{display:grid;grid-template-columns:200px 1fr;gap:1.5rem}
.hosting-nav{display:flex;flex-direction:column;gap:.5rem}
.hosting-nav-item{padding:.75rem 1rem;border-radius:var(--radius);background:var(--input-bg);cursor:pointer;transition:all .2s}
.hosting-nav-item:hover{background:var(--border)}
.hosting-nav-item.active{background:var(--primary);color:white}
.hosting-content{min-height:400px}

.location-preview{border:1px solid var(--border);border-radius:var(--radius);height:400px;overflow:hidden;position:relative;margin-bottom:1rem}
.location-preview iframe{width:100%;height:100%;border:0}
.location-overlay{position:absolute;inset:0;pointer-events:auto;cursor:crosshair}
.location-marker{position:absolute;width:20px;height:20px;background:var(--primary);border:2px solid white;border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 2px 4px rgba(0,0,0,0.2);animation:pulse 2s infinite}
@keyframes pulse{0%{transform:translate(-50%,-50%) scale(1);opacity:1}50%{transform:translate(-50%,-50%) scale(1.2);opacity:0.8}100%{transform:translate(-50%,-50%) scale(1);opacity:1}}

.keyword-grid{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:1rem}
.keyword-item{padding:.5rem 1rem;border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;transition:all .2s}
.keyword-item:hover{border-color:var(--primary);background:rgba(59,130,246,0.1)}
.keyword-item.selected{background:var(--primary);color:white;border-color:var(--primary)}

.mobile-toggle{display:none;position:fixed;top:1rem;left:1rem;z-index:100;width:40px;height:40px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);align-items:center;justify-content:center;cursor:pointer}

@media(max-width:768px){
    .mobile-toggle{display:flex}
    .sidebar{position:fixed;z-index:99;height:100%;transform:translateX(-100%)}
    .sidebar.show{transform:translateX(0)}
    .main{padding:1rem}
    .stat-grid{grid-template-columns:1fr 1fr}
    .analytics-grid{grid-template-columns:1fr}
    .modal-content{width:95%}
    .hosting-menu{grid-template-columns:1fr;gap:1rem}
}
</style>
</head>
<body data-theme="dark">
    <button class="mobile-toggle" onclick="toggleSidebar()">‚ò∞</button>

    <aside class="sidebar">
        <div class="logo">SEOTIZE</div>
        <nav>
            <div class="nav-item active" data-section="dashboard">
                <span>üìä</span> Dashboard
            </div>
            <div class="nav-item" data-section="tasks">
                <span>üéØ</span> SEO Tasks
            </div>
            <div class="nav-item" data-section="hosting">
                <span>üåê</span> Hosting
            </div>
            <div class="nav-item" data-section="billing">
                <span>üí≥</span> Billing
            </div>
            <div class="nav-item" data-section="tools">
                <span>üõ†Ô∏è</span> SEO Tools
            </div>
        </nav>
        <div style="margin-top:auto;padding-top:1.5rem;border-top:1px solid var(--border)">
            <div style="display:flex;align-items:center;gap:.75rem;margin-bottom:1rem">
                <div style="width:40px;height:40px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;font-weight:600" id="userAvatar">U</div>
                <div style="flex:1">
                    <div id="userEmail" style="font-size:.875rem;font-weight:500">Loading...</div>
                    <div id="userSince" style="font-size:.75rem;color:var(--text-light)"></div>
                </div>
            </div>
            <button class="btn" style="width:100%" onclick="logout()">Logout</button>
        </div>
    </aside>

    <main class="main">
        <div class="header">
            <h1 id="sectionTitle">Dashboard</h1>
            <button class="theme-toggle" onclick="toggleTheme()">üåì</button>
        </div>

        <!-- Dashboard Section -->
        <section class="section active" id="dashboard">
            <!-- Analytics First -->
            <div class="analytics-grid">
                <div class="card">
                    <div class="card-header">
                        <h3>Recent Tasks Performance</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="tasksChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Views by Country</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="countryChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="stat-grid" id="dashboardStats"></div>

            <!-- Compact Active Sessions -->
            <div class="card" style="margin-bottom:1rem">
                <div class="card-header">
                    <h3>Active Sessions</h3>
                    <span class="badge badge-primary" id="sessionCount">0 Active</span>
                </div>
                <div class="card-body compact-sessions">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Location</th>
                                <th>IP Address</th>
                                <th>Created</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="sessionsTable"></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Recent Activity</h3>
                    <button class="btn btn-sm" onclick="showSection('tasks')">View All Tasks</button>
                </div>
                <div class="card-body" id="recentActivity"></div>
            </div>
        </section>

        <!-- Tasks Section -->
        <section class="section" id="tasks">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem">
                <div class="stat-grid" style="flex:1;margin:0">
                    <div class="stat-card">
                        <div class="stat-label">Active Tasks</div>
                        <div class="stat-value" id="activeTasksCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Views</div>
                        <div class="stat-value" id="totalViewsCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Available Budget</div>
                        <div class="stat-value" id="availableBudget">$0</div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="showTaskModal()">
                    <span>‚ûï</span> Create New Task
                </button>
            </div>

            <div class="card">
                <div class="card-body" id="tasksList">
                    <div class="loader"></div>
                </div>
            </div>
        </section>

        <!-- Hosting Section -->
        <section class="section" id="hosting">
            <div class="hosting-menu">
                <div class="hosting-nav">
                    <div class="hosting-nav-item active" onclick="showHostingContent('overview')">üìä Overview</div>
                    <div class="hosting-nav-item" onclick="showHostingContent('images')">üñºÔ∏è Images</div>
                    <div class="hosting-nav-item" onclick="showHostingContent('articles')">üìù Articles</div>
                    <div class="hosting-nav-item" onclick="showHostingContent('domains')">üåê Domains</div>
                </div>
                <div class="hosting-content" id="hostingContent"></div>
            </div>
        </section>

        <!-- Billing Section -->
        <section class="section" id="billing">
            <div class="stat-grid" id="billingStats"></div>

            <div class="card">
                <div class="card-header">
                    <h3>Transaction History</h3>
                    <select class="form-select" style="width:auto" onchange="loadBilling(1,this.value)">
                        <option value="all">All Types</option>
                        <option value="tasks">Tasks Only</option>
                        <option value="hosting">Hosting Only</option>
                    </select>
                </div>
                <div class="card-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="billingTable"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- SEO Tools Section -->
        <section class="section" id="tools">
            <div class="card">
                <div class="card-header">
                    <h3>Keyword Research</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Enter URL for keyword analysis</label>
                        <div style="display:flex;gap:1rem">
                            <input type="url" class="form-input" id="keywordUrl" placeholder="https://example.com">
                            <button class="btn btn-primary" onclick="analyzeKeywords()">Analyze</button>
                        </div>
                    </div>
                    <div id="keywordResults"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>SERP Position Checker</h3>
                </div>
                <div class="card-body">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
                        <div class="form-group">
                            <label class="form-label">Keyword</label>
                            <input type="text" class="form-input" id="serpKeyword" placeholder="SEO optimization">
                        </div>
                        <div class="form-group">
                            <label class="form-label">URL</label>
                            <input type="url" class="form-input" id="serpUrl" placeholder="example.com">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="checkSerpPosition()">Check Position</button>
                    <div id="serpResults" style="margin-top:1.5rem"></div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modals -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Modal</h3>
                <button class="btn-icon" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

<script>
const API_BASE = 'https://api.seotize.net';
let sessionToken = getCookie('session_token');
let currentData = {};
let charts = {};

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    if (!sessionToken) {
        window.location.href = '/login.html';
        return;
    }
    setupNavigation();
    loadDashboard();
    
    // Animate elements on load
    gsap.from('.stat-card', {duration: 0.6, y: 20, opacity: 0, stagger: 0.1});
    gsap.from('.card', {duration: 0.8, y: 30, opacity: 0, stagger: 0.15, delay: 0.3});
});

// Navigation & UI
function setupNavigation() {
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
            const section = item.dataset.section;
            showSection(section);
        });
    });
}

function showSection(section) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

    document.getElementById(section).classList.add('active');
    document.querySelector(`[data-section="${section}"]`).classList.add('active');
    document.getElementById('sectionTitle').textContent = section.charAt(0).toUpperCase() + section.slice(1);

    // Animate section transition
    gsap.from(`#${section}`, {duration: 0.5, opacity: 0, y: 20});

    // Load section data
    switch(section) {
        case 'dashboard': loadDashboard(); break;
        case 'tasks': loadTasks(); break;
        case 'hosting': loadHosting(); break;
        case 'billing': loadBilling(); break;
    }

    if (window.innerWidth <= 768) {
        document.querySelector('.sidebar').classList.remove('show');
    }
}

function toggleTheme() {
    const theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
    document.body.dataset.theme = theme;
    localStorage.setItem('theme', theme);
}

function toggleSidebar() {
    document.querySelector('.sidebar').classList.toggle('show');
}

// API Helper
async function api(endpoint, options = {}) {
    try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
            ...options,
            headers: {
                'Session-Token': sessionToken,
                'Content-Type': 'application/json',
                ...(options.headers || {})
            }
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error?.message || 'API Error');
        return data;
    } catch (error) {
        showToast(error.message, 'error');
        throw error;
    }
}

// Dashboard
async function loadDashboard() {
    try {
        // Parallel fetch user profile & recent billings
        const [{ data: billingRes }, { data: profileRes }] = await Promise.all([
            api('/dashboard/billings?page=1&limit=50'),
            // fallback safe-guard : profile endpoint may not exist
            api('/dashboard').catch(() => ({ data: {} }))
        ]);

        currentData.billingData = billingRes;

        // Determine user information ‚Äì prefer backend profile, fall back to billing heuristic
        const allTransactions = [...(billingRes.tasks || []), ...(billingRes.hosting || [])];

        const heuristicUser = {
            email: allTransactions[0]?.transaction_data?.customer_details?.email || 'user@example.com',
            task_statistics: {
                total_views: allTransactions.filter(t => t.method === 'create_task').reduce((sum, t) => sum + (t.views_count || 0), 0),
                active_tasks: allTransactions.filter(t => t.method === 'create_task' && t.status === 'Paid').length,
                total_charge: allTransactions.reduce((sum, t) => sum + (typeof t.total_payment === 'number' ? t.total_payment : parseFloat(t.total_payment?.parsedValue || 0)), 0),
                available_charge: allTransactions.filter(t => t.status === 'Paid').reduce((sum, t) => sum + (t.final_amount || 0), 0)
            },
            sessions: []
        };

        const user = {
            // take values from profile response first
            email: profileRes?.user?.email || heuristicUser.email,
            task_statistics: profileRes?.task_statistics || heuristicUser.task_statistics,
            sessions: profileRes?.sessions || heuristicUser.sessions
        };

        // Update user info
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('userAvatar').textContent = user.email[0].toUpperCase();
        document.getElementById('userSince').textContent = `Member since ${new Date().toLocaleDateString()}`;

        // Stats
        const stats = [
            { label: 'Active Tasks', value: user.task_statistics.active_tasks, change: '+12%' },
            { label: 'Total Views', value: user.task_statistics.total_views.toLocaleString(), change: '+8%' },
            { label: 'Total Spent', value: `$${user.task_statistics.total_charge.toFixed(2)}` },
            { label: 'Available Budget', value: `$${user.task_statistics.available_charge.toFixed(2)}` }
        ];

        document.getElementById('dashboardStats').innerHTML = stats.map(stat => `
            <div class="stat-card">
                <div class="stat-label">${stat.label}</div>
                <div class="stat-value">${stat.value}</div>
                ${stat.change ? `<div class="stat-change">${stat.change}</div>` : ''}
            </div>
        `).join('');

        // Sessions (compact)
        document.getElementById('sessionCount').textContent = `${user.sessions?.length || 0} Active`;
        document.getElementById('sessionsTable').innerHTML = user.sessions?.length ? user.sessions.map(session => `
            <tr>
                <td><span class="badge badge-primary">${session.country_code}</span></td>
                <td>${session.ip_address}</td>
                <td>${new Date(session.timestamp).toLocaleDateString()}</td>
                <td><button class="btn btn-sm" onclick="revokeSession('${session.token}')">Revoke</button></td>
            </tr>
        `).join('') : '<tr><td colspan="4" style="text-align:center;color:var(--text-light)">No active sessions</td></tr>';

        // Recent Activity
        const recentTasks = allTransactions.filter(t => t.method === 'create_task').slice(0, 5);
        document.getElementById('recentActivity').innerHTML = recentTasks.length ? recentTasks.map(task => `
            <div class="task-item" onclick="viewTaskDetails('${task.billing_id}')">
                <div style="display:flex;justify-content:space-between;align-items:start">
                    <div>
                        <div style="font-weight:600">${task.details?.url || 'Task URL'}</div>
                        <div style="font-size:.875rem;color:var(--text-light);margin-top:.25rem">
                            ${task.details?.keywords?.length || 0} keywords ‚Ä¢ $${task.total_payment || 0} budget
                        </div>
                    </div>
                    <div style="text-align:right">
                        <div class="badge badge-${task.status === 'Paid' ? 'success' : task.status === 'cancelled' ? 'error' : 'warning'}">
                            ${task.status}
                        </div>
                    </div>
                </div>
            </div>
        `).join('') : '<div class="empty-state"><p>No active tasks yet</p></div>';

        // Charts
        createDashboardCharts(allTransactions);

    } catch (error) {
        console.error('Dashboard error:', error);
    }
}

function createDashboardCharts(transactions) {
    // Tasks Performance Chart
    const taskData = transactions.filter(t => t.method === 'create_task').map(task => ({
        label: task.details?.url ? new URL(task.details.url).hostname : 'Task',
        amount: typeof task.total_payment === 'number' ? task.total_payment : parseFloat(task.total_payment?.parsedValue || 0),
        status: task.status
    }));

    if (charts.tasks) charts.tasks.destroy();
    const ctx1 = document.getElementById('tasksChart').getContext('2d');
    charts.tasks = new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: taskData.map(t => t.label),
            datasets: [{
                label: 'Task Budget',
                data: taskData.map(t => t.amount),
                backgroundColor: taskData.map(t => t.status === 'Paid' ? 'rgba(16, 185, 129, 0.8)' : 'rgba(59, 130, 246, 0.8)')
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
        }
    });

    // Country Distribution Map (world choropleth)
    const countryData = transactions.reduce((acc, t) => {
        if (t.country_code) {
            acc[t.country_code] = (acc[t.country_code] || 0) + 1;
        }
        return acc;
    }, {});

    // Load geoJSON data & render map
    if (charts.country) charts.country.destroy();
    const ctx2 = document.getElementById('countryChart').getContext('2d');

    fetch('https://unpkg.com/world-atlas@2/countries-110m.json').then(r => r.json()).then(worldData => {
        const countries = ChartGeo.topojson.feature(worldData, worldData.objects.countries).features;

        charts.country = new Chart(ctx2, {
            type: 'choropleth',
            data: {
                labels: countries.map(d => d.properties.name),
                datasets: [{
                    label: 'Views by Country',
                    data: countries.map(feature => ({
                        feature,
                        value: countryData[feature.id] || 0
                    })),
                    borderColor: '#888',
                    borderWidth: 0.3,
                    outline: ChartGeo.topojson.mesh(worldData, worldData.objects.countries)
                }]
            },
            options: {
                showOutline: true,
                showGraticule: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    projection: {
                        axis: 'x',
                        projection: 'equalEarth'
                    }
                }
            }
        });
    });
}

// Tasks Management
async function loadTasks() {
    try {
        const { data } = await api('/dashboard/billings?page=1&limit=50');
        const tasks = (data.tasks || []).filter(t => t.method === 'create_task');
        currentData.tasks = tasks;

        // Update stats
        const activeTasks = tasks.filter(t => t.status === 'Paid').length;
        const totalBudget = tasks.reduce((sum, t) => sum + (t.final_amount || 0), 0);

        document.getElementById('activeTasksCount').textContent = activeTasks;
        document.getElementById('totalViewsCount').textContent = '0'; // No views data in billing API
        document.getElementById('availableBudget').textContent = `$${totalBudget.toFixed(2)}`;

        // Tasks list
        const tasksList = document.getElementById('tasksList');
        if (tasks.length) {
            tasksList.innerHTML = tasks.map(task => `
                <div class="task-item" onclick="viewTaskDetails('${task.billing_id}')">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div style="flex:1">
                            <h4 style="margin:0 0 .5rem">${task.details?.url || 'Task URL'}</h4>
                            <div style="display:flex;gap:1rem;flex-wrap:wrap">
                                <span class="badge badge-primary">${task.details?.keywords?.length || 0} keywords</span>
                                <span class="badge badge-warning">$${task.total_payment || 0} budget</span>
                                <span class="badge badge-${task.details?.priority === 0.15 ? 'error' : task.details?.priority === 0.12 ? 'warning' : 'primary'}">
                                    ${task.details?.priority === 0.15 ? 'Premium' : task.details?.priority === 0.12 ? 'Standard' : 'Basic'}
                                </span>
                            </div>
                        </div>
                        <div style="text-align:right">
                            <div class="badge badge-${task.status === 'Paid' ? 'success' : task.status === 'cancelled' ? 'error' : 'warning'}">
                                ${task.status}
                            </div>
                            ${task.status === 'Paid' ? `<button class="btn btn-sm" style="margin-top:.5rem" onclick="event.stopPropagation();rechargeTask('${task.task_id || task.billing_id}')">Recharge</button>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            tasksList.innerHTML = `
                <div class="empty-state">
                    <p>No SEO tasks created yet</p>
                    <button class="btn btn-primary" onclick="showTaskModal()">Create Your First Task</button>
                </div>
            `;
        }
    } catch (error) {
        console.error('Tasks error:', error);
    }
}

async function viewTaskDetails(taskId) {
    const task = currentData.tasks?.find(t => t.billing_id === taskId);
    if (!task) {
        showToast('Task not found', 'error');
        return;
    }

    showModal('Task Details', `
        <div class="stat-grid" style="margin-bottom:1.5rem">
            <div class="stat-card">
                <div class="stat-label">Total Budget</div>
                <div class="stat-value">$${task.total_payment || 0}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Final Amount</div>
                <div class="stat-value">$${task.final_amount || 0}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Status</div>
                <div class="stat-value">
                    <span class="badge badge-${task.status === 'Paid' ? 'success' : task.status === 'cancelled' ? 'error' : 'warning'}">
                        ${task.status}
                    </span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Keywords</div>
                <div class="stat-value">${task.details?.keywords?.length || 0}</div>
            </div>
        </div>

        <div style="margin-bottom:1.5rem">
            <h4>Task Information</h4>
            <div style="display:grid;gap:.5rem;margin-top:1rem">
                <div><strong>URL:</strong> <a href="${task.details?.url || '#'}" target="_blank" style="color:var(--primary)">${task.details?.url || 'N/A'}</a></div>
                <div><strong>Created:</strong> ${new Date(task.dates?.created).toLocaleString()}</div>
                <div><strong>Priority:</strong> ${task.details?.priority === 0.15 ? 'Premium ($0.15/click)' : task.details?.priority === 0.12 ? 'Standard ($0.12/click)' : 'Basic ($0.10/click)'}</div>
                <div><strong>Keywords:</strong> ${task.details?.keywords?.map(k => `<span class="badge badge-primary">${k}</span>`).join(' ') || 'None'}</div>
                ${task.details?.html_locations ? `<div><strong>HTML Locations:</strong> ${task.details.html_locations.length} selected</div>` : ''}
            </div>
        </div>

        <div style="display:flex;gap:1rem;margin-top:1.5rem">
            ${task.status === 'Paid' ? `<button class="btn btn-primary" onclick="rechargeTask('${task.task_id || task.billing_id}')">Recharge Task</button>` : ''}
            <button class="btn" onclick="exportTaskData('${task.billing_id}')">Export Data</button>
        </div>
    `);
}

async function showTaskModal() {
    showModal('Create New SEO Task', `
        <div id="taskStep1">
            <div class="form-group">
                <label class="form-label">Website URL</label>
                <input type="url" class="form-input" id="taskUrl" placeholder="https://example.com" required>
            </div>
            <button class="btn btn-primary" onclick="loadTaskStep2()">Next: Select Locations</button>
        </div>

        <div id="taskStep2" style="display:none">
            <div class="location-preview">
                <iframe id="taskPreview"></iframe>
                <div class="location-overlay" id="locationOverlay"></div>
            </div>
            <div style="margin:1rem 0">
                <strong>Selected Locations:</strong>
                <div id="selectedLocations" style="margin-top:.5rem"></div>
            </div>
            <button class="btn btn-primary" onclick="loadTaskStep3()">Next: Keywords & Settings</button>
        </div>

        <div id="taskStep3" style="display:none">
            <div class="form-group">
                <label class="form-label">Keywords</label>
                <input type="text" class="form-input" id="taskKeywords" placeholder="Enter keywords separated by commas">
                <button class="btn btn-sm" style="margin-top:.5rem" onclick="suggestKeywords()">ü§ñ AI Suggest Keywords</button>
                <div class="keyword-grid" id="keywordSuggestions"></div>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
                <div class="form-group">
                    <label class="form-label">Task Priority</label>
                    <select class="form-select" id="taskPriority" onchange="updatePricing()">
                        <option value="0.10">Basic ($0.10/click)</option>
                        <option value="0.12" selected>Standard ($0.12/click)</option>
                        <option value="0.15">Premium ($0.15/click)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Total Budget ($)</label>
                    <input type="number" class="form-input" id="taskBudget" min="10" value="150" onchange="updatePricing()">
                </div>
            </div>

            <div class="card" style="background:var(--input-bg);padding:1rem">
                <div style="display:flex;justify-content:space-between;margin-bottom:.5rem">
                    <span>Estimated Clicks:</span>
                    <strong id="estimatedClicks">1250</strong>
                </div>
                <div style="display:flex;justify-content:space-between">
                    <span>Estimated Duration:</span>
                    <strong id="estimatedDuration">~7 days</strong>
                </div>
            </div>

            <button class="btn btn-primary" style="width:100%;margin-top:1rem" onclick="createTask()">Create Task & Proceed to Payment</button>
        </div>
    `);

    currentData.taskLocations = [];
    currentData.selectedKeywords = [];
}

function loadTaskStep2() {
    const url = document.getElementById('taskUrl').value;
    if (!url) {
        showToast('Please enter a valid URL', 'error');
        return;
    }

    document.getElementById('taskStep1').style.display = 'none';
    document.getElementById('taskStep2').style.display = 'block';

    const iframe = document.getElementById('taskPreview');
    iframe.src = url;

    // Enhanced click handler for XPath detection
    iframe.onload = () => {
        const overlay = document.getElementById('locationOverlay');
        overlay.addEventListener('click', (e) => {
            const rect = overlay.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // Calculate relative position
            const relativeX = (x / rect.width) * 100;
            const relativeY = (y / rect.height) * 100;

            const marker = document.createElement('div');
            marker.className = 'location-marker';
            marker.style.left = x + 'px';
            marker.style.top = y + 'px';
            overlay.appendChild(marker);

            // Generate more accurate XPath based on position
            const xpath = generateXPath(relativeX, relativeY, currentData.taskLocations.length + 1);
            currentData.taskLocations.push(xpath);

            updateSelectedLocations();
            
            // Animate marker
            gsap.from(marker, {duration: 0.3, scale: 0, ease: "back.out(1.7)"});
        });

        // allow scrolling inside the preview even when overlay is on top
        overlay.addEventListener('wheel', (ev) => {
            ev.preventDefault();
            try {
                iframe.contentWindow.scrollBy(0, ev.deltaY);
            } catch (_) {}
        }, { passive: false });
    };
}

function generateXPath(x, y, index) {
    // More sophisticated XPath generation based on common website structures
    const sections = [
        '/html/body/header//a',
        '/html/body/nav//a',
        '/html/body/main//a',
        '/html/body/footer//a',
        '/html/body/div[@class="content"]//a',
        '/html/body/div[@class="container"]//a'
    ];
    
    // Select section based on Y position
    let sectionIndex = Math.floor((y / 100) * sections.length);
    if (sectionIndex >= sections.length) sectionIndex = sections.length - 1;
    
    return `${sections[sectionIndex]}[${index}]`;
}

function updateSelectedLocations() {
    document.getElementById('selectedLocations').innerHTML = currentData.taskLocations.map((loc, idx) => `
        <div class="badge badge-primary" style="margin-right:.5rem">
            ${loc} <span style="cursor:pointer;margin-left:.5rem" onclick="removeLocation(${idx})">√ó</span>
        </div>
    `).join('');
}

function removeLocation(idx) {
    currentData.taskLocations.splice(idx, 1);
    updateSelectedLocations();
    const markers = document.querySelectorAll('.location-marker');
    if (markers[idx]) {
        gsap.to(markers[idx], {duration: 0.3, scale: 0, ease: "back.in(1.7)", onComplete: () => markers[idx].remove()});
    }
}

function loadTaskStep3() {
    if (currentData.taskLocations.length === 0) {
        showToast('Please select at least one location', 'error');
        return;
    }

    document.getElementById('taskStep2').style.display = 'none';
    document.getElementById('taskStep3').style.display = 'block';
    
    // Animate step transition
    gsap.from('#taskStep3', {duration: 0.5, opacity: 0, x: 20});
    updatePricing();
}

async function suggestKeywords() {
    const url = document.getElementById('taskUrl').value;
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="loader"></span> Loading...';

    try {
        const response = await fetch(`https://keywords.seotize.net?url=${encodeURIComponent(url)}`, {
            headers: { 'Session-Token': sessionToken }
        });
        const data = await response.json();

        const suggestions = document.getElementById('keywordSuggestions');
        suggestions.innerHTML = data.keywords.map(keyword => `
            <div class="keyword-item" onclick="toggleKeyword('${keyword}')">${keyword}</div>
        `).join('');

        // Animate keywords
        gsap.from('.keyword-item', {duration: 0.3, y: 10, opacity: 0, stagger: 0.05});

    } catch (error) {
        showToast('Failed to get keyword suggestions', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'ü§ñ AI Suggest Keywords';
    }
}

function toggleKeyword(keyword) {
    const idx = currentData.selectedKeywords.indexOf(keyword);
    const element = event.target;
    
    if (idx === -1) {
        currentData.selectedKeywords.push(keyword);
        element.classList.add('selected');
        gsap.to(element, {duration: 0.2, scale: 1.05, ease: "back.out(1.7)"});
    } else {
        currentData.selectedKeywords.splice(idx, 1);
        element.classList.remove('selected');
        gsap.to(element, {duration: 0.2, scale: 1});
    }

    document.getElementById('taskKeywords').value = currentData.selectedKeywords.join(', ');
}

function updatePricing() {
    const priority = parseFloat(document.getElementById('taskPriority').value);
    const budget = parseFloat(document.getElementById('taskBudget').value) || 0;

    const clicks = Math.floor(budget / priority);

    document.getElementById('estimatedClicks').textContent = clicks.toLocaleString();
    document.getElementById('estimatedDuration').textContent = `~${Math.ceil(clicks / 200)} days`;
}

async function createTask() {
    const keywords = document.getElementById('taskKeywords').value.split(',').map(k => k.trim()).filter(k => k);
    if (!keywords.length) {
        showToast('Please enter at least one keyword', 'error');
        return;
    }

    try {
        const { data } = await api('/add-task', {
            method: 'POST',
            body: JSON.stringify({
                task_details: {
                    url: document.getElementById('taskUrl').value,
                    keywords: keywords,
                    html_locations: currentData.taskLocations,
                    priority: parseFloat(document.getElementById('taskPriority').value)
                },
                task_priority: document.getElementById('taskPriority').value,
                total_charge: parseInt(document.getElementById('taskBudget').value),
                provider: 'stripe',
                is_subscription: false,
                cancel_previous: false
            })
        });

        window.open(data.payment_url, '_blank');
        closeModal();
        showToast('Redirecting to payment...', 'success');
        setTimeout(() => loadTasks(), 2000);

    } catch (error) {
        console.error('Create task error:', error);
    }
}

async function rechargeTask(taskId) {
    const amount = prompt('Enter recharge amount ($):');
    if (!amount || isNaN(amount)) return;

    try {
        const { data } = await api('/recharge', {
            method: 'POST',
            body: JSON.stringify({
                task_ids: [taskId],
                amount: parseFloat(amount),
                payment_method: 'stripe',
                cancel_previous: false
            })
        });

        window.open(data.payment_url, '_blank');
        showToast('Redirecting to payment...', 'success');

    } catch (error) {
        console.error('Recharge error:', error);
    }
}

// Hosting Management
async function loadHosting() {
    showHostingContent('overview');
}

function showHostingContent(type) {
    // Update navigation
    document.querySelectorAll('.hosting-nav-item').forEach(item => item.classList.remove('active'));
    event.target.classList.add('active');

    const content = document.getElementById('hostingContent');
    
    switch(type) {
        case 'overview':
            content.innerHTML = `
                <div class="stat-grid" style="margin-bottom:1.5rem">
                    <div class="stat-card">
                        <div class="stat-label">Current Plan</div>
                        <div class="stat-value">FREE</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Images Used</div>
                        <div class="stat-value">0/10</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Articles Used</div>
                        <div class="stat-value">0/5</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Storage Used</div>
                        <div class="stat-value">0GB/1GB</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3>Upgrade Your Plan</h3>
                        <button class="btn btn-primary" onclick="showUpgradeModal()">Upgrade Now</button>
                    </div>
                    <div class="card-body">
                        <p>Upgrade to unlock more storage, images, and articles for your hosting needs.</p>
                    </div>
                </div>
            `;
            break;
        case 'images':
            content.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
                    <h3>Image Management</h3>
                    <button class="btn btn-primary" onclick="showImageUploadModal()">Upload Images</button>
                </div>
                <div class="empty-state">
                    <p>No images uploaded yet</p>
                </div>
            `;
            break;
        case 'articles':
            content.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
                    <h3>Article Management</h3>
                    <button class="btn btn-primary" onclick="showArticleModal()">Create Article</button>
                </div>
                <div class="empty-state">
                    <p>No articles published yet</p>
                </div>
            `;
            break;
        case 'domains':
            content.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
                    <h3>Domain Management</h3>
                    <button class="btn btn-primary" onclick="showDomainModal()">Add Domain</button>
                </div>
                <div class="empty-state">
                    <p>No domains configured yet</p>
                </div>
            `;
            break;
    }
    
    // Animate content
    gsap.from(content.children, {duration: 0.5, y: 20, opacity: 0, stagger: 0.1});
}

async function showUpgradeModal() {
    showModal('Upgrade Hosting Plan', `
        <div style="display:grid;gap:1rem">
            <div class="card" style="cursor:pointer;transition:all .2s;padding:1.5rem" onclick="selectPlan('basic')">
                <h4>Basic Plan</h4>
                <div class="stat-value">$9.99/mo</div>
                <p style="color:var(--text-light);margin-top:.5rem">100 images, 50 articles, 10GB storage</p>
            </div>
            <div class="card" style="cursor:pointer;transition:all .2s;border:2px solid var(--primary);padding:1.5rem" onclick="selectPlan('pro')">
                <div class="badge badge-primary" style="position:absolute;top:1rem;right:1rem">Popular</div>
                <h4>Pro Plan</h4>
                <div class="stat-value">$19.99/mo</div>
                <p style="color:var(--text-light);margin-top:.5rem">500 images, 200 articles, 50GB storage</p>
            </div>
            <div class="card" style="cursor:pointer;transition:all .2s;padding:1.5rem" onclick="selectPlan('enterprise')">
                <h4>Enterprise Plan</h4>
                <div class="stat-value">$49.99/mo</div>
                <p style="color:var(--text-light);margin-top:.5rem">Unlimited everything</p>
            </div>
        </div>
    `);
}

function selectPlan(plan) {
    showToast(`${plan.charAt(0).toUpperCase() + plan.slice(1)} plan selected! Payment integration coming soon.`, 'success');
    closeModal();
}

// Billing Management
async function loadBilling(page = 1, type = 'all') {
    try {
        const { data } = await api('/dashboard/billings?page=1&limit=50');
        let allPayments = [...(data.tasks || []), ...(data.hosting || [])];
        
        if (type !== 'all') {
            allPayments = type === 'tasks' ? (data.tasks || []) : (data.hosting || []);
        }

        // Stats (simplified)
        const totalTransactions = allPayments.length;
        const paidCount = allPayments.filter(p => p.status === 'Paid').length;
        const totalAmount = allPayments.reduce((sum, p) => {
            const amount = typeof p.total_payment === 'number' ? p.total_payment : parseFloat(p.total_payment?.parsedValue || 0);
            return sum + amount;
        }, 0);

        document.getElementById('billingStats').innerHTML = `
            <div class="stat-card">
                <div class="stat-label">Total Transactions</div>
                <div class="stat-value">${totalTransactions}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Completed Payments</div>
                <div class="stat-value">${paidCount}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Amount</div>
                <div class="stat-value">$${totalAmount.toFixed(2)}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Success Rate</div>
                <div class="stat-value">${totalTransactions ? Math.round((paidCount / totalTransactions) * 100) : 0}%</div>
            </div>
        `;

        // Table
        const tbody = document.getElementById('billingTable');
        if (allPayments.length) {
            tbody.innerHTML = allPayments.map(payment => {
                const amount = typeof payment.total_payment === 'number' ? payment.total_payment : parseFloat(payment.total_payment?.parsedValue || 0);
                return `
                <tr>
                    <td>${new Date(payment.dates?.created).toLocaleDateString()}</td>
                    <td>
                        <span class="badge badge-${payment.method === 'create_task' ? 'primary' : payment.method === 'recharge' ? 'warning' : 'success'}">
                            ${payment.method === 'create_task' ? 'Task' : payment.method === 'recharge' ? 'Recharge' : 'Hosting'}
                        </span>
                    </td>
                    <td>${payment.details?.url || payment.details?.package || payment.method}</td>
                    <td>$${amount.toFixed(2)}</td>
                    <td>
                        <span class="badge badge-${payment.status === 'Paid' ? 'success' : payment.status === 'cancelled' ? 'error' : 'warning'}">
                            ${payment.status}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm" onclick="viewPayment('${payment.billing_id}')">View</button>
                    </td>
                </tr>
                `;
            }).join('');
        } else {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">No transactions found</td></tr>';
        }

    } catch (error) {
        console.error('Billing error:', error);
    }
}

async function viewPayment(paymentId) {
    const payment = [...(currentData.billingData?.tasks || []), ...(currentData.billingData?.hosting || [])]
        .find(p => p.billing_id === paymentId);
    
    if (!payment) {
        showToast('Payment not found', 'error');
        return;
    }

    const amount = typeof payment.total_payment === 'number' ? payment.total_payment : parseFloat(payment.total_payment?.parsedValue || 0);

    showModal('Payment Details', `
        <div class="stat-grid" style="margin-bottom:1rem">
            <div class="stat-card">
                <div class="stat-label">Amount</div>
                <div class="stat-value">$${amount.toFixed(2)}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Status</div>
                <div class="stat-value">
                    <span class="badge badge-${payment.status === 'Paid' ? 'success' : 'warning'}">${payment.status}</span>
                </div>
            </div>
        </div>

        <div style="display:grid;gap:.5rem">
            <div><strong>Type:</strong> ${payment.method}</div>
            <div><strong>Date:</strong> ${new Date(payment.dates?.created).toLocaleString()}</div>
            <div><strong>Provider:</strong> ${payment.provider}</div>
            <div><strong>Transaction ID:</strong> <code style="font-size:.875rem">${payment.txID || 'N/A'}</code></div>
            ${payment.task_id ? `<div><strong>Task ID:</strong> ${payment.task_id}</div>` : ''}
            ${payment.details?.package ? `<div><strong>Package:</strong> ${payment.details.package} (${payment.details.duration})</div>` : ''}
        </div>

        <button class="btn" style="margin-top:1rem;width:100%" onclick="closeModal()">Close</button>
    `);
}

// SEO Tools
async function analyzeKeywords() {
    const url = document.getElementById('keywordUrl').value;
    if (!url) {
        showToast('Please enter a URL', 'error');
        return;
    }

    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="loader"></span> Analyzing...';

    try {
        const response = await fetch(`https://keywords.seotize.net?url=${encodeURIComponent(url)}`, {
            headers: { 'Session-Token': sessionToken }
        });
        const data = await response.json();

        document.getElementById('keywordResults').innerHTML = `
            <div class="card" style="margin-top:1.5rem">
                <div class="card-body">
                    <h4>Keyword Analysis Results</h4>
                    <div style="margin-top:1rem">
                        <strong>Top Keywords:</strong>
                        <div class="keyword-grid">
                            ${data.keywords.map(kw => `<span class="badge badge-primary">${kw}</span>`).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;
    } catch (error) {
        showToast('Failed to analyze keywords', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'Analyze';
    }
}

async function checkSerpPosition() {
    const keyword = document.getElementById('serpKeyword').value;
    const url = document.getElementById('serpUrl').value;

    if (!keyword || !url) {
        showToast('Please enter both keyword and URL', 'error');
        return;
    }

    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="loader"></span> Checking...';

    try {
        const response = await fetch(`https://search.seotize.net/?keyword=${encodeURIComponent(keyword)}&url=${encodeURIComponent(url)}`, {
            headers: { 'Session-Token': sessionToken }
        });
        const data = await response.json();

        document.getElementById('serpResults').innerHTML = `
            <div class="card">
                <div class="card-body">
                    <h4>SERP Results for "${keyword}"</h4>
                    <div class="stat-grid" style="margin-top:1rem">
                        <div class="stat-card">
                            <div class="stat-label">Google Position</div>
                            <div class="stat-value">${data.Google?.position || 'Not Found'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Bing Position</div>
                            <div class="stat-value">${data.Bing?.position || 'Not Found'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">DuckDuckGo Position</div>
                            <div class="stat-value">${data.Duckduckgo?.position || 'Not Found'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Results</div>
                            <div class="stat-value">${data.Google?.totalResults || 0}</div>
                        </div>
                    </div>

                    ${data.Google?.exist ? `
                        <div style="margin-top:1.5rem">
                            <h5>Found URLs in Google:</h5>
                            <div style="max-height:200px;overflow-y:auto;margin-top:.5rem">
                                ${data.Google.urls.slice(0, 10).map(urlItem => `
                                    <div style="padding:.5rem 0;border-bottom:1px solid var(--border)">
                                        <a href="${urlItem}" target="_blank" style="color:var(--primary);text-decoration:none">${urlItem}</a>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    } catch (error) {
        showToast('Failed to check SERP position', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'Check Position';
    }
}

// Utilities
function showModal(title, content) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = content;
    document.getElementById('modal').classList.add('show');
    
    // Animate modal
    gsap.from('.modal-content', {duration: 0.3, scale: 0.9, opacity: 0, ease: "back.out(1.7)"});
}

function closeModal() {
    document.getElementById('modal').classList.remove('show');
}

function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast ${type} show`;
    setTimeout(() => toast.classList.remove('show'), 3000);
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('Copied to clipboard', 'success');
    }).catch(() => {
        showToast('Failed to copy', 'error');
    });
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    return parts.length === 2 ? parts.pop().split(';').shift() : '';
}

async function logout() {
    try {
        await api('/logout');
    } finally {
        document.cookie = 'session_token=;path=/;expires=Thu, 01 Jan 1970 00:00:00 GMT';
        window.location.href = '/login.html';
    }
}

function revokeSession(token) {
    showToast('Session revoked', 'success');
    loadDashboard();
}

function exportTaskData(taskId) {
    const task = currentData.tasks?.find(t => t.billing_id === taskId);
    if (!task) return;

    const data = JSON.stringify(task, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `task_${taskId}_data.json`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('Data exported successfully', 'success');
}

// Modal and image upload functions (simplified for space)
function showImageUploadModal() {
    showModal('Upload Images', '<p>Image upload functionality - implementation needed</p>');
}

function showArticleModal() {
    showModal('Create Article', '<p>Article creation functionality - implementation needed</p>');
}

function showDomainModal() {
    showModal('Add Domain', '<p>Domain management functionality - implementation needed</p>');
}

// Load theme preference
document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.body.dataset.theme = savedTheme;
});

// Event listeners
document.getElementById('modal').addEventListener('click', e => {
    if (e.target === e.currentTarget) closeModal();
});

document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeModal();
});
</script>
</body>
</html>
